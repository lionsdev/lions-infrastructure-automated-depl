---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - DÃ‰PLOIEMENT PRIMEREACT
# =========================================================================
# Description: DÃ©ploiement sÃ©curisÃ© d'applications PrimeReact sur Kubernetes
# Version: 5.0.0
# Auteur: LIONS DevOps Team
# Date: 2025-05-30
# Documentation: https://docs.lions.dev/components/primereact
# =========================================================================

# =========================================================================
# VALIDATION PRÃ‰-DÃ‰PLOIEMENT
# =========================================================================
- name: "ğŸ” Validation de la configuration PrimeReact"
  block:
    - name: "VÃ©rification de l'activation du service PrimeReact"
      assert:
        that:
          - primereact_config.enabled | default(false) | bool
        fail_msg: "âŒ Le service PrimeReact n'est pas activÃ© dans la configuration"
        success_msg: "âœ… Service PrimeReact activÃ©"

    - name: "Validation des variables d'environnement critiques"
      assert:
        that:
          - primereact_config.namespace is defined
          - primereact_config.app_name is defined
          - primereact_config.version is defined
          - primereact_config.port is defined
        fail_msg: "âŒ Variables de configuration PrimeReact manquantes"
        success_msg: "âœ… Configuration PrimeReact validÃ©e"

    - name: "VÃ©rification de la disponibilitÃ© du namespace"
      k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ primereact_config.namespace }}"
      register: namespace_check

    - name: "Validation de l'existence du namespace"
      assert:
        that:
          - namespace_check.resources | length > 0
        fail_msg: "âŒ Le namespace {{ primereact_config.namespace }} n'existe pas"
        success_msg: "âœ… Namespace {{ primereact_config.namespace }} disponible"

  tags:
    - validation
    - primereact

# =========================================================================
# PRÃ‰PARATION DU DÃ‰PLOIEMENT
# =========================================================================
- name: "ğŸ—ï¸  PrÃ©paration de l'environnement de dÃ©ploiement"
  block:
    - name: "GÃ©nÃ©ration des manifestes Kubernetes"
      include_tasks: prepare.yml
      vars:
        component_name: "{{ primereact_config.app_name }}"
        component_namespace: "{{ primereact_config.namespace }}"

    - name: "VÃ©rification de la gÃ©nÃ©ration des templates"
      stat:
        path: "{{ temp_dir.path }}/{{ item }}"
      register: template_files
      loop:
        - deployment.yml
        - service.yml
        - configmap.yml
        - serviceaccount.yml
      failed_when: not template_files.results | selectattr('stat.exists') | list

    - name: "Configuration des secrets pour PrimeReact"
      include_tasks: "{{ role_path }}/../common/tasks/setup-secrets.yml"
      vars:
        app_name: "{{ primereact_config.app_name }}"
        app_namespace: "{{ primereact_config.namespace }}"
        secrets_config: "{{ primereact_config.secrets | default({}) }}"
      when: primereact_config.secrets is defined

  tags:
    - preparation
    - primereact

# =========================================================================
# DÃ‰PLOIEMENT DES RESSOURCES KUBERNETES
# =========================================================================
- name: "ğŸš€ DÃ©ploiement des ressources PrimeReact"
  block:
    - name: "DÃ©ploiement du ServiceAccount"
      k8s:
        state: present
        src: "{{ temp_dir.path }}/serviceaccount.yml"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: "{{ lions_timeout_default | default(300) }}"
      register: serviceaccount_result

    - name: "DÃ©ploiement de la ConfigMap"
      k8s:
        state: present
        src: "{{ temp_dir.path }}/configmap.yml"
      register: configmap_result

    - name: "DÃ©ploiement du Service"
      k8s:
        state: present
        src: "{{ temp_dir.path }}/service.yml"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: "{{ lions_timeout_default | default(300) }}"
      register: service_result

    - name: "DÃ©ploiement de l'application PrimeReact"
      k8s:
        state: present
        src: "{{ temp_dir.path }}/deployment.yml"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: "{{ lions_timeout_deployment | default(1800) }}"
      register: deployment_result

    - name: "DÃ©ploiement de l'Ingress (si activÃ©)"
      k8s:
        state: present
        src: "{{ temp_dir.path }}/ingress.yml"
        wait: true
        wait_timeout: "{{ lions_timeout_default | default(300) }}"
      register: ingress_result
      when:
        - primereact_config.ingress.enabled | default(true) | bool
        - lions_environment != 'development' or primereact_config.ingress.force_dev | default(false) | bool

  rescue:
    - name: "âŒ Ã‰chec du dÃ©ploiement - Collecte des informations de debug"
      include_tasks: "{{ role_path }}/../common/tasks/debug-deployment.yml"
      vars:
        failed_app_name: "{{ primereact_config.app_name }}"
        failed_namespace: "{{ primereact_config.namespace }}"

    - name: "âŒ Ã‰chec critique du dÃ©ploiement PrimeReact"
      fail:
        msg: |
          Le dÃ©ploiement de PrimeReact a Ã©chouÃ©.
          VÃ©rifiez les logs ci-dessus pour plus de dÃ©tails.
          Namespace: {{ primereact_config.namespace }}
          Application: {{ primereact_config.app_name }}

  tags:
    - deployment
    - primereact

# =========================================================================
# DÃ‰PLOIEMENT DU MONITORING (SI ACTIVÃ‰)
# =========================================================================
- name: "ğŸ“Š Configuration du monitoring PrimeReact"
  block:
    - name: "DÃ©ploiement du ServiceMonitor"
      k8s:
        state: present
        src: "{{ temp_dir.path }}/servicemonitor.yml"
        wait: true
        wait_timeout: "{{ lions_timeout_default | default(300) }}"
      register: servicemonitor_result

    - name: "Configuration des alertes spÃ©cifiques"
      include_tasks: monitoring.yml
      vars:
        monitoring_component: "{{ primereact_config.app_name }}"
        monitoring_namespace: "{{ primereact_config.namespace }}"

  when:
    - lions_monitoring_enabled | default(true) | bool
    - primereact_config.monitoring.enabled | default(true) | bool
  tags:
    - monitoring
    - primereact

# =========================================================================
# VÃ‰RIFICATIONS POST-DÃ‰PLOIEMENT
# =========================================================================
- name: "ğŸ” VÃ©rifications post-dÃ©ploiement"
  block:
    - name: "VÃ©rification du statut du dÃ©ploiement"
      k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ primereact_config.namespace }}"
        name: "{{ primereact_config.app_name }}"
      register: deployment_status
      until:
        - deployment_status.resources | length > 0
        - deployment_status.resources[0].status.availableReplicas is defined
        - deployment_status.resources[0].status.availableReplicas == (deployment_status.resources[0].spec.replicas | int)
        - deployment_status.resources[0].status.readyReplicas is defined
        - deployment_status.resources[0].status.readyReplicas == (deployment_status.resources[0].spec.replicas | int)
      retries: "{{ (lions_timeout_deployment | default(1800) | int / 30) | int }}"
      delay: 30

    - name: "RÃ©cupÃ©ration des informations dÃ©taillÃ©es sur les pods"
      k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ primereact_config.namespace }}"
        label_selectors:
          - "app.kubernetes.io/name={{ primereact_config.app_name }}"
          - "app.kubernetes.io/component=frontend"
      register: pods_info

    - name: "Validation de l'Ã©tat des pods"
      assert:
        that:
          - pods_info.resources | length > 0
          - pods_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
        fail_msg: "âŒ Aucun pod PrimeReact n'est en cours d'exÃ©cution"
        success_msg: "âœ… Pods PrimeReact dÃ©ployÃ©s avec succÃ¨s"

    - name: "Affichage du statut des pods"
      debug:
        msg: |
          ğŸ“‹ Statut des pods PrimeReact:
          - Pod: {{ item.metadata.name }}
          - Ã‰tat: {{ item.status.phase }}
          - Node: {{ item.spec.nodeName | default('Non assignÃ©') }}
          - IP: {{ item.status.podIP | default('Non assignÃ©e') }}
          - RedÃ©marrages: {{ item.status.containerStatuses[0].restartCount | default(0) }}
      loop: "{{ pods_info.resources }}"
      loop_control:
        label: "{{ item.metadata.name }}"

  tags:
    - verification
    - primereact

# =========================================================================
# TESTS DE SANTÃ‰ DE L'APPLICATION
# =========================================================================
- name: "ğŸ¥ Tests de santÃ© de l'application"
  block:
    - name: "Attente de l'initialisation complÃ¨te"
      pause:
        seconds: "{{ primereact_config.init_delay | default(30) }}"

    - name: "Test de connectivitÃ© interne (service)"
      uri:
        url: "http://{{ primereact_config.app_name }}.{{ primereact_config.namespace }}.svc.cluster.local:{{ primereact_config.port }}/health"
        method: GET
        status_code: [200, 404]  # 404 acceptÃ© si pas d'endpoint health
        timeout: 30
      register: internal_health_check
      retries: 5
      delay: 10
      ignore_errors: true

    - name: "Test de disponibilitÃ© de l'interface utilisateur"
      uri:
        url: "http://{{ primereact_config.app_name }}.{{ primereact_config.namespace }}.svc.cluster.local:{{ primereact_config.port }}/"
        method: GET
        status_code: [200, 302]
        timeout: 30
      register: ui_availability_check
      retries: 5
      delay: 10

    - name: "Test de l'Ingress (si configurÃ©)"
      uri:
        url: "{{ primereact_config.ingress.protocol | default('https') }}://{{ primereact_config.ingress.host | default(primereact_config.app_name + '.' + lions_dns_full_domain) }}"
        method: GET
        status_code: [200, 302, 503]  # 503 temporaire acceptable
        timeout: 30
        validate_certs: "{{ not (lions_security_tls_staging | default(true) | bool) }}"
      register: external_access_check
      retries: 3
      delay: 15
      ignore_errors: true
      when:
        - primereact_config.ingress.enabled | default(true) | bool
        - lions_environment != 'development' or primereact_config.ingress.force_dev | default(false) | bool

  rescue:
    - name: "âš ï¸  Tests de santÃ© partiellement Ã©chouÃ©s"
      debug:
        msg: |
          âš ï¸  Certains tests de santÃ© ont Ã©chouÃ©, mais l'application peut Ãªtre fonctionnelle.
          VÃ©rifiez les dÃ©tails ci-dessous et les logs de l'application.

  tags:
    - health-check
    - primereact

# =========================================================================
# CONFIGURATION DE L'AUTOSCALING (SI ACTIVÃ‰)
# =========================================================================
- name: "âš–ï¸  Configuration de l'autoscaling"
  block:
    - name: "DÃ©ploiement du HorizontalPodAutoscaler"
      k8s:
        state: present
        definition:
          apiVersion: autoscaling/v2
          kind: HorizontalPodAutoscaler
          metadata:
            name: "{{ primereact_config.app_name }}-hpa"
            namespace: "{{ primereact_config.namespace }}"
            labels:
              app.kubernetes.io/name: "{{ primereact_config.app_name }}"
              app.kubernetes.io/component: frontend
              app.kubernetes.io/part-of: lions-infrastructure
              app.kubernetes.io/managed-by: ansible
          spec:
            scaleTargetRef:
              apiVersion: apps/v1
              kind: Deployment
              name: "{{ primereact_config.app_name }}"
            minReplicas: "{{ primereact_config.autoscaling.min_replicas | default(lions_autoscaling_min_replicas | default(1)) }}"
            maxReplicas: "{{ primereact_config.autoscaling.max_replicas | default(lions_autoscaling_max_replicas | default(10)) }}"
            metrics:
              - type: Resource
                resource:
                  name: cpu
                  target:
                    type: Utilization
                    averageUtilization: "{{ primereact_config.autoscaling.cpu_target | default(lions_autoscaling_cpu_target | default(70)) }}"
              - type: Resource
                resource:
                  name: memory
                  target:
                    type: Utilization
                    averageUtilization: "{{ primereact_config.autoscaling.memory_target | default(lions_autoscaling_memory_target | default(80)) }}"
        wait: true
        wait_timeout: "{{ lions_timeout_default | default(300) }}"

  when:
    - lions_autoscaling_enabled | default(true) | bool
    - primereact_config.autoscaling.enabled | default(false) | bool
  tags:
    - autoscaling
    - primereact

# =========================================================================
# RAPPORT DE DÃ‰PLOIEMENT
# =========================================================================
- name: "ğŸ“‹ GÃ©nÃ©ration du rapport de dÃ©ploiement"
  block:
    - name: "Collecte des informations finales"
      set_fact:
        deployment_report:
          application: "{{ primereact_config.app_name }}"
          namespace: "{{ primereact_config.namespace }}"
          version: "{{ primereact_config.version }}"
          environment: "{{ lions_environment }}"
          replicas: "{{ deployment_status.resources[0].status.availableReplicas | default(0) }}"
          pods_ready: "{{ pods_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}"
          service_type: "{{ service_result.result.spec.type | default('ClusterIP') }}"
          ingress_enabled: "{{ primereact_config.ingress.enabled | default(true) | bool }}"
          monitoring_enabled: "{{ primereact_config.monitoring.enabled | default(true) | bool }}"
          autoscaling_enabled: "{{ primereact_config.autoscaling.enabled | default(false) | bool }}"
          deployment_time: "{{ ansible_date_time.iso8601 }}"
          internal_url: "http://{{ primereact_config.app_name }}.{{ primereact_config.namespace }}.svc.cluster.local:{{ primereact_config.port }}"
          external_url: "{{ primereact_config.ingress.protocol | default('https') }}://{{ primereact_config.ingress.host | default(primereact_config.app_name + '.' + lions_dns_full_domain) }}"

    - name: "ğŸ“‹ Affichage du rapport de dÃ©ploiement"
      debug:
        msg: |
          =========================================================================
          ğŸ‰ DÃ‰PLOIEMENT PRIMEREACT TERMINÃ‰ AVEC SUCCÃˆS
          =========================================================================
          ğŸ“± Application: {{ deployment_report.application }}
          ğŸ·ï¸  Version: {{ deployment_report.version }}
          ğŸ  Namespace: {{ deployment_report.namespace }}
          ğŸŒ Environnement: {{ deployment_report.environment }}
          ğŸ“Š RÃ©plicas actives: {{ deployment_report.replicas }}
          ğŸŸ¢ Pods prÃªts: {{ deployment_report.pods_ready }}
          
          ğŸ”— ACCÃˆS:
          ğŸ“¡ URL interne: {{ deployment_report.internal_url }}
          {% if deployment_report.ingress_enabled %}
          ğŸŒ URL externe: {{ deployment_report.external_url }}
          {% endif %}
          
          ğŸ“Š FONCTIONNALITÃ‰S:
          ğŸ“ˆ Monitoring: {{ 'âœ…' if deployment_report.monitoring_enabled else 'âŒ' }}
          âš–ï¸  Autoscaling: {{ 'âœ…' if deployment_report.autoscaling_enabled else 'âŒ' }}
          ğŸ”’ Ingress: {{ 'âœ…' if deployment_report.ingress_enabled else 'âŒ' }}
          
          â° DÃ©ployÃ© le: {{ deployment_report.deployment_time }}
          =========================================================================

    - name: "ğŸ’¾ Sauvegarde du rapport de dÃ©ploiement"
      copy:
        content: "{{ deployment_report | to_nice_yaml }}"
        dest: "/tmp/lions-primereact-deployment-{{ ansible_date_time.epoch }}.yml"
        mode: '0644'
      delegate_to: localhost

  tags:
    - reporting
    - primereact

# =========================================================================
# NETTOYAGE POST-DÃ‰PLOIEMENT
# =========================================================================
- name: "ğŸ§¹ Nettoyage des ressources temporaires"
  block:
    - name: "Suppression des fichiers temporaires"
      file:
        path: "{{ temp_dir.path }}"
        state: absent
      when: temp_dir is defined

    - name: "Nettoyage du cache Ansible"
      meta: clear_facts

  always:
    - name: "ğŸ“ Log final du dÃ©ploiement"
      debug:
        msg: "âœ… DÃ©ploiement PrimeReact terminÃ© - {{ ansible_date_time.iso8601 }}"

  tags:
    - cleanup
    - primereact