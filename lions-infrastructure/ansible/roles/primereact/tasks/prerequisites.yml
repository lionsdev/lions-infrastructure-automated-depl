---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - PRIMEREACT PREREQUISITES
# =========================================================================
# Description: VÃ©rification complÃ¨te des prÃ©requis pour le dÃ©ploiement PrimeReact
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: 2025-05-30
# Documentation: https://docs.lions.dev/applications/primereact/prerequisites
# =========================================================================

- name: "ðŸ“‹ DÃ©marrage de la vÃ©rification des prÃ©requis PrimeReact"
  debug:
    msg: |
      ðŸš€ DÃ©but des vÃ©rifications pour PrimeReact
      ðŸ“¦ Namespace cible: {{ lions_primereact_namespace }}
      ðŸ·ï¸  Version: {{ lions_primereact_version | default('latest') }}
      ðŸŒ Environnement: {{ lions_environment }}

- name: "ðŸ“Š Collecte des informations systÃ¨me"
  set_fact:
    prerequisites_start_time: "{{ ansible_date_time.epoch }}"
    prerequisites_checks: []
    prerequisites_warnings: []
    prerequisites_errors: []

# =========================================================================
# VÃ‰RIFICATIONS INFRASTRUCTURE DE BASE
# =========================================================================

- name: "ðŸ” VÃ©rification de l'existence du namespace {{ lions_primereact_namespace }}"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ lions_primereact_namespace }}"
  register: primereact_namespace_info
  failed_when: false
  tags:
    - infrastructure
    - namespace

- name: "âœ… Validation du namespace"
  block:
    - name: "ðŸ“ Enregistrement du succÃ¨s"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['Namespace ' + lions_primereact_namespace + ' existe'] }}"
      when: primereact_namespace_info.resources | length > 0

    - name: "âŒ Ã‰chec si le namespace n'existe pas"
      fail:
        msg: |
          âŒ Le namespace '{{ lions_primereact_namespace }}' n'existe pas.
          
          Solutions possibles:
          1. CrÃ©er le namespace: kubectl create namespace {{ lions_primereact_namespace }}
          2. ExÃ©cuter le playbook d'initialisation des namespaces
          3. VÃ©rifier la variable 'lions_primereact_namespace' dans la configuration
      when: primereact_namespace_info.resources | length == 0
  tags:
    - infrastructure
    - namespace

- name: "ðŸ”’ VÃ©rification des permissions RBAC"
  block:
    - name: "ðŸ§ª Test de crÃ©ation d'un ConfigMap temporaire"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "lions-primereact-access-test-{{ ansible_date_time.epoch }}"
            namespace: "{{ lions_primereact_namespace }}"
            labels:
              app.kubernetes.io/name: primereact
              app.kubernetes.io/component: access-test
              lions.dev/managed-by: ansible
              lions.dev/environment: "{{ lions_environment }}"
          data:
            test: "permissions-check"
            timestamp: "{{ ansible_date_time.iso8601 }}"
      register: rbac_test_result
      failed_when: false

    - name: "ðŸ—‘ï¸ Nettoyage du ConfigMap de test"
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "lions-primereact-access-test-{{ ansible_date_time.epoch }}"
        namespace: "{{ lions_primereact_namespace }}"
      when: rbac_test_result is succeeded
      failed_when: false

    - name: "âœ… Enregistrement du succÃ¨s RBAC"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['Permissions RBAC suffisantes'] }}"
      when: rbac_test_result is succeeded

    - name: "âŒ Ã‰chec des permissions RBAC"
      fail:
        msg: |
          âŒ Permissions RBAC insuffisantes pour le namespace '{{ lions_primereact_namespace }}'
          
          Permissions requises:
          - get, list, watch, create, update, patch, delete sur: pods, services, deployments, configmaps, secrets
          - get, list, watch, create, update, patch, delete sur: ingresses (networking.k8s.io)
          
          Solutions:
          1. VÃ©rifier les ClusterRole et ClusterRoleBinding
          2. VÃ©rifier les Role et RoleBinding pour le namespace
          3. Contacter l'administrateur du cluster
      when: rbac_test_result is failed
  tags:
    - security
    - rbac

# =========================================================================
# VÃ‰RIFICATIONS SERVICES DÃ‰PENDANTS
# =========================================================================

- name: "ðŸ“¦ VÃ©rification du registre Docker"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: "{{ lions_registry_service_name }}"
    namespace: "{{ lions_registry_namespace }}"
  register: registry_service_info
  failed_when: false
  when: lions_registry_enabled | bool
  tags:
    - dependencies
    - registry

- name: "âœ… Validation du registre Docker"
  block:
    - name: "ðŸ“ Enregistrement du succÃ¨s du registre"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['Service registre disponible'] }}"
      when:
        - lions_registry_enabled | bool
        - registry_service_info.resources | length > 0

    - name: "âš ï¸ Avertissement registre manquant"
      set_fact:
        prerequisites_warnings: "{{ prerequisites_warnings + ['Service registre non disponible - dÃ©ploiement possible avec registre externe'] }}"
      when:
        - lions_registry_enabled | bool
        - registry_service_info.resources | length == 0

    - name: "â„¹ï¸ Registre dÃ©sactivÃ©"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['Registre dÃ©sactivÃ© - utilisation registre externe'] }}"
      when: not (lions_registry_enabled | bool)
  tags:
    - dependencies
    - registry

- name: "ðŸŒ VÃ©rification de l'ingress controller"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    label_selectors:
      - "app.kubernetes.io/name=traefik"
  register: ingress_controller_info
  failed_when: false
  tags:
    - networking
    - ingress

- name: "âœ… Validation de l'ingress controller"
  block:
    - name: "ðŸ“ Enregistrement du succÃ¨s ingress"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['Ingress controller Traefik disponible'] }}"
      when: ingress_controller_info.resources | length > 0

    - name: "âš ï¸ Avertissement ingress controller manquant"
      set_fact:
        prerequisites_warnings: "{{ prerequisites_warnings + ['Ingress controller non trouvÃ© - application accessible uniquement via NodePort/LoadBalancer'] }}"
      when: ingress_controller_info.resources | length == 0
  tags:
    - networking
    - ingress

# =========================================================================
# VÃ‰RIFICATIONS STOCKAGE
# =========================================================================

- name: "ðŸ’¾ VÃ©rification des StorageClass"
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: "{{ lions_storage_class_default }}"
  register: storage_class_info
  failed_when: false
  tags:
    - storage

- name: "âœ… Validation du stockage"
  block:
    - name: "ðŸ“ Enregistrement du succÃ¨s stockage"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['StorageClass ' + lions_storage_class_default + ' disponible'] }}"
      when: storage_class_info.resources | length > 0

    - name: "âŒ Ã‰chec StorageClass manquante"
      fail:
        msg: |
          âŒ StorageClass '{{ lions_storage_class_default }}' non trouvÃ©e
          
          Solutions:
          1. VÃ©rifier les StorageClass disponibles: kubectl get storageclass
          2. Mettre Ã  jour la variable 'lions_storage_class_default'
          3. CrÃ©er la StorageClass requise
      when: storage_class_info.resources | length == 0
  tags:
    - storage

# =========================================================================
# VÃ‰RIFICATIONS SPÃ‰CIFIQUES PRIMEREACT
# =========================================================================

- name: "âš›ï¸ VÃ©rifications spÃ©cifiques PrimeReact"
  debug:
    msg: |
      ðŸ” VÃ©rification des prÃ©requis spÃ©cifiques Ã  PrimeReact
      ðŸ“‹ Framework: React {{ lions_primereact_react_version | default('18.x') }}
      ðŸŽ¨ UI Library: PrimeReact {{ lions_primereact_version | default('latest') }}
      ðŸŒ Port: {{ lions_primereact_port }}

- name: "ðŸ”§ VÃ©rification des outils de build"
  block:
    - name: "ðŸ“¦ VÃ©rification de la disponibilitÃ© des images Node.js"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ lions_primereact_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=primereact"
      register: existing_primereact_pods
      failed_when: false

    - name: "ðŸ“ Enregistrement de l'Ã©tat des pods existants"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['Aucun pod PrimeReact en conflit dÃ©tectÃ©'] }}"
      when: existing_primereact_pods.resources | length == 0

    - name: "âš ï¸ Avertissement pods existants"
      set_fact:
        prerequisites_warnings: "{{ prerequisites_warnings + [existing_primereact_pods.resources | length | string + ' pod(s) PrimeReact existant(s) dÃ©tectÃ©(s)'] }}"
      when: existing_primereact_pods.resources | length > 0
  tags:
    - application
    - primereact

# =========================================================================
# VÃ‰RIFICATIONS SÃ‰CURITÃ‰
# =========================================================================

- name: "ðŸ”’ VÃ©rifications de sÃ©curitÃ©"
  block:
    - name: "ðŸ›¡ï¸ VÃ©rification des NetworkPolicies"
      kubernetes.core.k8s_info:
        api_version: networking.k8s.io/v1
        kind: NetworkPolicy
        namespace: "{{ lions_primereact_namespace }}"
      register: network_policies_info
      when: lions_security_network_policies | bool

    - name: "ðŸ“ Enregistrement NetworkPolicies"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['NetworkPolicies configurÃ©es'] }}"
      when:
        - lions_security_network_policies | bool
        - network_policies_info.resources | length > 0

    - name: "ðŸ” VÃ©rification des PodSecurityStandards"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ lions_primereact_namespace }}"
      register: namespace_security_info

    - name: "ðŸ“ Validation sÃ©curitÃ© namespace"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['Namespace configurÃ© avec les standards de sÃ©curitÃ©'] }}"
      when:
        - namespace_security_info.resources[0].metadata.labels is defined
        - "'pod-security.kubernetes.io/enforce' in namespace_security_info.resources[0].metadata.labels"
  tags:
    - security
    - network-policies

# =========================================================================
# VÃ‰RIFICATIONS MONITORING
# =========================================================================

- name: "ðŸ“Š VÃ©rifications monitoring"
  block:
    - name: "ðŸ” VÃ©rification de Prometheus"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: prometheus-server
        namespace: "{{ lions_monitoring_namespace }}"
      register: prometheus_info
      when: lions_monitoring_enabled | bool

    - name: "ðŸ“ Enregistrement monitoring"
      set_fact:
        prerequisites_checks: "{{ prerequisites_checks + ['Service Prometheus disponible pour monitoring'] }}"
      when:
        - lions_monitoring_enabled | bool
        - prometheus_info.resources | length > 0

    - name: "âš ï¸ Avertissement monitoring"
      set_fact:
        prerequisites_warnings: "{{ prerequisites_warnings + ['Monitoring Prometheus non disponible'] }}"
      when:
        - lions_monitoring_enabled | bool
        - prometheus_info.resources | length == 0
  tags:
    - monitoring
    - observability

# =========================================================================
# VÃ‰RIFICATIONS RESSOURCES
# =========================================================================

- name: "ðŸ’» VÃ©rification des ressources du cluster"
  block:
    - name: "ðŸ“Š Collecte des mÃ©triques de ressources"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: cluster_nodes_info

    - name: "ðŸ“ Calcul des ressources disponibles"
      set_fact:
        cluster_node_count: "{{ cluster_nodes_info.resources | length }}"
        prerequisites_checks: "{{ prerequisites_checks + ['Cluster avec ' + (cluster_nodes_info.resources | length | string) + ' nÅ“ud(s) disponible(s)'] }}"

    - name: "âš ï¸ Avertissement cluster minimal"
      set_fact:
        prerequisites_warnings: "{{ prerequisites_warnings + ['Cluster Ã  nÅ“ud unique dÃ©tectÃ© - considÃ©rer la haute disponibilitÃ©'] }}"
      when: cluster_nodes_info.resources | length == 1
  tags:
    - resources
    - capacity

# =========================================================================
# RAPPORT FINAL DES PRÃ‰REQUIS
# =========================================================================

- name: "ðŸ“Š GÃ©nÃ©ration du rapport final"
  set_fact:
    prerequisites_end_time: "{{ ansible_date_time.epoch }}"
    prerequisites_duration: "{{ (ansible_date_time.epoch | int) - (prerequisites_start_time | int) }}"

- name: "ðŸ“‹ Rapport des vÃ©rifications de prÃ©requis PrimeReact"
  debug:
    msg: |
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ðŸ“Š RAPPORT DE VÃ‰RIFICATION DES PRÃ‰REQUIS PRIMEREACT
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ðŸŽ¯ Application: PrimeReact
      ðŸ“¦ Namespace: {{ lions_primereact_namespace }}
      ðŸŒ Environnement: {{ lions_environment }}
      â±ï¸  DurÃ©e: {{ prerequisites_duration }}s
      
      âœ… VÃ‰RIFICATIONS RÃ‰USSIES ({{ prerequisites_checks | length }}):
      {% for check in prerequisites_checks %}
         âœ“ {{ check }}
      {% endfor %}
      
      {% if prerequisites_warnings | length > 0 %}
      âš ï¸  AVERTISSEMENTS ({{ prerequisites_warnings | length }}):
      {% for warning in prerequisites_warnings %}
         âš  {{ warning }}
      {% endfor %}
      {% endif %}
      
      {% if prerequisites_errors | length > 0 %}
      âŒ ERREURS ({{ prerequisites_errors | length }}):
      {% for error in prerequisites_errors %}
         âœ— {{ error }}
      {% endfor %}
      {% endif %}
      
      ðŸ Statut: {% if prerequisites_errors | length == 0 %}PRÃŠT POUR LE DÃ‰PLOIEMENT{% else %}PRÃ‰REQUIS NON SATISFAITS{% endif %}
      
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: "âœ… Validation finale des prÃ©requis"
  debug:
    msg: "ðŸš€ Tous les prÃ©requis pour PrimeReact sont satisfaits. DÃ©ploiement autorisÃ©."
  when: prerequisites_errors | length == 0

- name: "âŒ Ã‰chec des prÃ©requis"
  fail:
    msg: |
      âŒ Des prÃ©requis critiques ne sont pas satisfaits pour PrimeReact.
      Consultez le rapport ci-dessus pour les dÃ©tails.
  when: prerequisites_errors | length > 0

# =========================================================================
# COLLECTE DE MÃ‰TADONNÃ‰ES POUR DÃ‰BOGAGE
# =========================================================================

- name: "ðŸ“Š Collecte des mÃ©tadonnÃ©es de dÃ©bogage"
  set_fact:
    primereact_prerequisites_metadata:
      checks_completed: "{{ prerequisites_checks | length }}"
      warnings_count: "{{ prerequisites_warnings | length }}"
      errors_count: "{{ prerequisites_errors | length }}"
      duration_seconds: "{{ prerequisites_duration }}"
      namespace: "{{ lions_primereact_namespace }}"
      environment: "{{ lions_environment }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      version: "5.0.0"
  tags:
    - metadata
    - debugging