---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - R√îLE PRIMEREACT
# =========================================================================
# Description: Orchestrateur principal pour le d√©ploiement d'applications PrimeReact
# Version: 5.0.0
# Maintainer: DevOps Team <devops@lions.dev>
# Documentation: https://docs.lions.dev/infrastructure/applications/primereact
# =========================================================================

# =========================================================================
# M√âTADONN√âES ET CONFIGURATION
# =========================================================================
- name: "PrimeReact | Initialisation des m√©tadonn√©es de d√©ploiement"
  set_fact:
    primereact_deployment_metadata:
      role_name: "primereact"
      role_version: "5.0.0"
      deployment_id: "{{ ansible_date_time.epoch }}"
      environment: "{{ lions_environment | default('development') }}"
      namespace: "{{ lions_primereact_namespace | default('applications') }}"
      started_at: "{{ ansible_date_time.iso8601 }}"
      started_by: "{{ ansible_user_id | default('system') }}"
    primereact_deployment_config:
      dry_run: "{{ lions_dry_run | default(false) | bool }}"
      debug_mode: "{{ lions_debug_mode | default(false) | bool }}"
      skip_validation: "{{ primereact_skip_validation | default(false) | bool }}"
      force_recreate: "{{ primereact_force_recreate | default(false) | bool }}"
  tags:
    - primereact
    - metadata
    - always

- name: "PrimeReact | Affichage des informations de d√©ploiement"
  debug:
    msg:
      - "üöÄ D√©marrage du d√©ploiement PrimeReact"
      - "üìä Environnement: {{ primereact_deployment_metadata.environment }}"
      - "üè∑Ô∏è  Namespace: {{ primereact_deployment_metadata.namespace }}"
      - "üÜî ID de d√©ploiement: {{ primereact_deployment_metadata.deployment_id }}"
      - "‚è∞ D√©marr√© le: {{ primereact_deployment_metadata.started_at }}"
      - "üë§ Initi√© par: {{ primereact_deployment_metadata.started_by }}"
      - "üîß Mode debug: {{ primereact_deployment_config.debug_mode }}"
      - "üß™ Dry run: {{ primereact_deployment_config.dry_run }}"
  when: primereact_deployment_config.debug_mode | bool
  tags:
    - primereact
    - debug
    - always

# =========================================================================
# GESTION DES ERREURS ET ROLLBACK
# =========================================================================
- name: "PrimeReact | Configuration de la gestion d'erreurs"
  set_fact:
    primereact_error_handling:
      max_retries: "{{ primereact_max_retries | default(3) }}"
      retry_delay: "{{ primereact_retry_delay | default(10) }}"
      rollback_on_failure: "{{ primereact_rollback_on_failure | default(true) | bool }}"
      error_log_file: "/tmp/primereact-deployment-{{ primereact_deployment_metadata.deployment_id }}.log"
  tags:
    - primereact
    - error-handling
    - always

# =========================================================================
# V√âRIFICATIONS PR√âALABLES CRITIQUES
# =========================================================================
- name: "PrimeReact | V√©rification de l'√©tat de l'environnement"
  block:
    - name: "PrimeReact | V√©rification de l'accessibilit√© du cluster Kubernetes"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ primereact_deployment_metadata.namespace }}"
      register: primereact_namespace_check
      failed_when: false

    - name: "PrimeReact | V√©rification des variables d'environnement critiques"
      assert:
        that:
          - lions_primereact_enabled is defined
          - lions_primereact_enabled | bool
          - lions_primereact_version is defined
          - lions_primereact_version | length > 0
          - primereact_deployment_metadata.namespace is defined
        fail_msg: "Variables d'environnement PrimeReact manquantes ou incorrectes"
        success_msg: "Variables d'environnement PrimeReact valid√©es"

  rescue:
    - name: "PrimeReact | Gestion d'erreur - V√©rifications pr√©alables"
      fail:
        msg: "‚ùå √âchec des v√©rifications pr√©alables PrimeReact: {{ ansible_failed_result.msg | default('Erreur inconnue') }}"

  tags:
    - primereact
    - preflight
    - validation

# =========================================================================
# PHASE 1: PR√âREQUIS ET D√âPENDANCES
# =========================================================================
- name: "PrimeReact | Phase 1 - V√©rification des pr√©requis"
  block:
    - name: "PrimeReact | Inclusion des t√¢ches de pr√©requis"
      include_tasks: prerequisites.yml
      vars:
        current_phase: "prerequisites"
        phase_description: "V√©rification des pr√©requis syst√®me et Kubernetes"

  rescue:
    - name: "PrimeReact | √âchec Phase 1 - Pr√©requis"
      set_fact:
        primereact_deployment_failed: true
        primereact_failure_phase: "prerequisites"
        primereact_failure_reason: "{{ ansible_failed_result.msg | default('√âchec des pr√©requis') }}"

    - name: "PrimeReact | Log d'erreur Phase 1"
      lineinfile:
        path: "{{ primereact_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] ERREUR Phase 1 (Pr√©requis): {{ primereact_failure_reason }}"
        create: yes

    - name: "PrimeReact | Arr√™t du d√©ploiement - Phase 1"
      fail:
        msg: "‚ùå D√©ploiement PrimeReact interrompu en Phase 1 (Pr√©requis): {{ primereact_failure_reason }}"

  tags:
    - primereact
    - prerequisites
    - phase-1

# =========================================================================
# PHASE 2: PR√âPARATION DES RESSOURCES
# =========================================================================
- name: "PrimeReact | Phase 2 - Pr√©paration des ressources"
  block:
    - name: "PrimeReact | Inclusion des t√¢ches de pr√©paration"
      include_tasks: prepare.yml
      vars:
        current_phase: "preparation"
        phase_description: "Cr√©ation des ressources Kubernetes de base"

  rescue:
    - name: "PrimeReact | √âchec Phase 2 - Pr√©paration"
      set_fact:
        primereact_deployment_failed: true
        primereact_failure_phase: "preparation"
        primereact_failure_reason: "{{ ansible_failed_result.msg | default('√âchec de la pr√©paration') }}"

    - name: "PrimeReact | Log d'erreur Phase 2"
      lineinfile:
        path: "{{ primereact_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] ERREUR Phase 2 (Pr√©paration): {{ primereact_failure_reason }}"
        create: yes

    - name: "PrimeReact | Nettoyage partiel apr√®s √©chec Phase 2"
      include_tasks: cleanup.yml
      vars:
        cleanup_scope: "preparation"
      when: primereact_error_handling.rollback_on_failure | bool

    - name: "PrimeReact | Arr√™t du d√©ploiement - Phase 2"
      fail:
        msg: "‚ùå D√©ploiement PrimeReact interrompu en Phase 2 (Pr√©paration): {{ primereact_failure_reason }}"

  when: primereact_deployment_failed is not defined
  tags:
    - primereact
    - preparation
    - phase-2

# =========================================================================
# PHASE 3: D√âPLOIEMENT PRINCIPAL
# =========================================================================
- name: "PrimeReact | Phase 3 - D√©ploiement principal"
  block:
    - name: "PrimeReact | Inclusion des t√¢ches de d√©ploiement"
      include_tasks: deploy.yml
      vars:
        current_phase: "deployment"
        phase_description: "D√©ploiement des composants PrimeReact"

  rescue:
    - name: "PrimeReact | √âchec Phase 3 - D√©ploiement"
      set_fact:
        primereact_deployment_failed: true
        primereact_failure_phase: "deployment"
        primereact_failure_reason: "{{ ansible_failed_result.msg | default('√âchec du d√©ploiement') }}"

    - name: "PrimeReact | Log d'erreur Phase 3"
      lineinfile:
        path: "{{ primereact_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] ERREUR Phase 3 (D√©ploiement): {{ primereact_failure_reason }}"
        create: yes

    - name: "PrimeReact | Rollback complet apr√®s √©chec Phase 3"
      include_tasks: rollback.yml
      vars:
        rollback_reason: "√âchec du d√©ploiement principal"
      when: primereact_error_handling.rollback_on_failure | bool

    - name: "PrimeReact | Arr√™t du d√©ploiement - Phase 3"
      fail:
        msg: "‚ùå D√©ploiement PrimeReact interrompu en Phase 3 (D√©ploiement): {{ primereact_failure_reason }}"

  when: primereact_deployment_failed is not defined
  tags:
    - primereact
    - deployment
    - phase-3

# =========================================================================
# PHASE 4: CONFIGURATION DU MONITORING
# =========================================================================
- name: "PrimeReact | Phase 4 - Configuration du monitoring"
  block:
    - name: "PrimeReact | Inclusion des t√¢ches de monitoring"
      include_tasks: monitoring.yml
      vars:
        current_phase: "monitoring"
        phase_description: "Configuration des m√©triques et alertes PrimeReact"

  rescue:
    - name: "PrimeReact | Avertissement Phase 4 - Monitoring"
      debug:
        msg:
          - "‚ö†Ô∏è  √âchec de la configuration du monitoring PrimeReact"
          - "‚ÑπÔ∏è  Le d√©ploiement principal a r√©ussi, mais les m√©triques peuvent √™tre indisponibles"
          - "üîç Erreur: {{ ansible_failed_result.msg | default('Erreur de monitoring inconnue') }}"

    - name: "PrimeReact | Log d'avertissement Phase 4"
      lineinfile:
        path: "{{ primereact_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] AVERTISSEMENT Phase 4 (Monitoring): {{ ansible_failed_result.msg | default('Erreur de monitoring') }}"
        create: yes

    - name: "PrimeReact | Marquage du monitoring comme d√©faillant"
      set_fact:
        primereact_monitoring_failed: true

  when:
    - primereact_deployment_failed is not defined
    - lions_monitoring_enabled | default(true) | bool
  tags:
    - primereact
    - monitoring
    - phase-4

# =========================================================================
# PHASE 5: VALIDATION POST-D√âPLOIEMENT
# =========================================================================
- name: "PrimeReact | Phase 5 - Validation post-d√©ploiement"
  block:
    - name: "PrimeReact | Inclusion des t√¢ches de validation"
      include_tasks: validate.yml
      vars:
        current_phase: "validation"
        phase_description: "Validation de l'√©tat et des fonctionnalit√©s PrimeReact"

  rescue:
    - name: "PrimeReact | √âchec Phase 5 - Validation"
      set_fact:
        primereact_deployment_failed: true
        primereact_failure_phase: "validation"
        primereact_failure_reason: "{{ ansible_failed_result.msg | default('√âchec de la validation') }}"

    - name: "PrimeReact | Log d'erreur Phase 5"
      lineinfile:
        path: "{{ primereact_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] ERREUR Phase 5 (Validation): {{ primereact_failure_reason }}"
        create: yes

    - name: "PrimeReact | D√©cision sur le rollback apr√®s validation"
      debug:
        msg: "‚ö†Ô∏è  Validation √©chou√©e mais PrimeReact peut √™tre partiellement fonctionnel"

    - name: "PrimeReact | Arr√™t avec avertissement - Phase 5"
      fail:
        msg: "‚ö†Ô∏è  D√©ploiement PrimeReact termin√© avec des erreurs de validation: {{ primereact_failure_reason }}"

  when:
    - primereact_deployment_failed is not defined
    - not primereact_deployment_config.skip_validation | bool
  tags:
    - primereact
    - validation
    - phase-5

# =========================================================================
# PHASE 6: CONFIGURATION DE LA SAUVEGARDE
# =========================================================================
- name: "PrimeReact | Phase 6 - Configuration de la sauvegarde"
  block:
    - name: "PrimeReact | Inclusion des t√¢ches de sauvegarde"
      include_tasks: backup.yml
      vars:
        current_phase: "backup"
        phase_description: "Configuration des strat√©gies de sauvegarde PrimeReact"

  rescue:
    - name: "PrimeReact | Avertissement Phase 6 - Sauvegarde"
      debug:
        msg:
          - "‚ö†Ô∏è  √âchec de la configuration de sauvegarde PrimeReact"
          - "‚ÑπÔ∏è  PrimeReact fonctionne mais les sauvegardes automatiques sont d√©sactiv√©es"
          - "üîç Erreur: {{ ansible_failed_result.msg | default('Erreur de sauvegarde inconnue') }}"

    - name: "PrimeReact | Log d'avertissement Phase 6"
      lineinfile:
        path: "{{ primereact_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] AVERTISSEMENT Phase 6 (Sauvegarde): {{ ansible_failed_result.msg | default('Erreur de sauvegarde') }}"
        create: yes

    - name: "PrimeReact | Marquage de la sauvegarde comme d√©faillante"
      set_fact:
        primereact_backup_failed: true

  when:
    - primereact_deployment_failed is not defined
    - lions_backup_enabled | default(true) | bool
    - lions_primereact_backup_enabled | default(true) | bool
  tags:
    - primereact
    - backup
    - phase-6

# =========================================================================
# FINALISATION ET RAPPORT DE D√âPLOIEMENT
# =========================================================================
- name: "PrimeReact | G√©n√©ration du rapport de d√©ploiement"
  set_fact:
    primereact_deployment_report:
      status: "{{ 'FAILED' if primereact_deployment_failed | default(false) else 'SUCCESS' }}"
      environment: "{{ primereact_deployment_metadata.environment }}"
      namespace: "{{ primereact_deployment_metadata.namespace }}"
      deployment_id: "{{ primereact_deployment_metadata.deployment_id }}"
      started_at: "{{ primereact_deployment_metadata.started_at }}"
      completed_at: "{{ ansible_date_time.iso8601 }}"
      duration: "{{ (ansible_date_time.epoch | int) - (primereact_deployment_metadata.deployment_id | int) }}"
      failed_phase: "{{ primereact_failure_phase | default('N/A') }}"
      failure_reason: "{{ primereact_failure_reason | default('N/A') }}"
      monitoring_status: "{{ 'FAILED' if primereact_monitoring_failed | default(false) else 'OK' }}"
      backup_status: "{{ 'FAILED' if primereact_backup_failed | default(false) else 'OK' }}"
      primereact_version: "{{ lions_primereact_version }}"
      primereact_service_name: "{{ lions_primereact_service_name | default('primereact-app') }}"
      primereact_endpoint: "{{ lions_primereact_service_name | default('primereact-app') }}.{{ primereact_deployment_metadata.namespace }}.svc.cluster.local:{{ lions_primereact_port | default(3000) }}"
  tags:
    - primereact
    - report
    - always

- name: "PrimeReact | Affichage du rapport de d√©ploiement"
  debug:
    msg:
      - "=============================================="
      - "üìä RAPPORT DE D√âPLOIEMENT PRIMEREACT"
      - "=============================================="
      - "üìà Statut: {{ primereact_deployment_report.status }}"
      - "üåç Environnement: {{ primereact_deployment_report.environment }}"
      - "üè∑Ô∏è  Namespace: {{ primereact_deployment_report.namespace }}"
      - "üÜî ID de d√©ploiement: {{ primereact_deployment_report.deployment_id }}"
      - "‚è∞ Dur√©e: {{ primereact_deployment_report.duration }}s"
      - "üåê Version PrimeReact: {{ primereact_deployment_report.primereact_version }}"
      - "üîó Point de connexion: {{ primereact_deployment_report.primereact_endpoint }}"
      - "üìä Monitoring: {{ primereact_deployment_report.monitoring_status }}"
      - "üíæ Sauvegarde: {{ primereact_deployment_report.backup_status }}"
      - "{{ '‚ùå Phase d\'√©chec: ' + primereact_deployment_report.failed_phase if primereact_deployment_report.status == 'FAILED' else '‚úÖ D√©ploiement r√©ussi' }}"
      - "{{ 'üîç Raison: ' + primereact_deployment_report.failure_reason if primereact_deployment_report.status == 'FAILED' else '' }}"
      - "=============================================="
  tags:
    - primereact
    - report
    - always

- name: "PrimeReact | Sauvegarde du rapport de d√©ploiement"
  copy:
    content: "{{ primereact_deployment_report | to_nice_json }}"
    dest: "/tmp/primereact-deployment-report-{{ primereact_deployment_metadata.deployment_id }}.json"
  delegate_to: localhost
  tags:
    - primereact
    - report

# =========================================================================
# NETTOYAGE ET FINALISATION
# =========================================================================
- name: "PrimeReact | Nettoyage des fichiers temporaires"
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ primereact_error_handling.error_log_file }}"
  when:
    - primereact_deployment_report.status == "SUCCESS"
    - not primereact_deployment_config.debug_mode | bool
  ignore_errors: yes
  tags:
    - primereact
    - cleanup

- name: "PrimeReact | Message de finalisation"
  debug:
    msg: |
      {% if primereact_deployment_report.status == 'SUCCESS' %}
      üéâ D√©ploiement PrimeReact termin√© avec succ√®s !

      üìã Informations de connexion:
      - H√¥te: {{ primereact_deployment_report.primereact_endpoint }}
      - Port: {{ lions_primereact_port | default(3000) }}

      üìö Documentation disponible √†: https://docs.lions.dev/infrastructure/applications/primereact
      {% else %}
      üí• D√©ploiement PrimeReact √©chou√© en phase {{ primereact_deployment_report.failed_phase }}

      üîç Consultez les logs d'erreur pour plus de d√©tails:
      - Fichier d'erreur: {{ primereact_error_handling.error_log_file }}
      - Rapport JSON: /tmp/primereact-deployment-report-{{ primereact_deployment_metadata.deployment_id }}.json

      üõ†Ô∏è  Guide de d√©pannage: https://docs.lions.dev/infrastructure/troubleshooting/primereact
      {% endif %}
  tags:
    - primereact
    - always
