---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - PRÃ‰PARATION PRIMEREACT
# =========================================================================
# Description: PrÃ©pare les ressources nÃ©cessaires pour dÃ©ployer PrimeReact
# ResponsabilitÃ©: Provisioning et validation des prÃ©requis infrastructure
# Auteur: Ã‰quipe DevOps LIONS Infrastructure
# Version: 5.0.0
# Date: "{{ ansible_date_time.iso8601 }}"
# Documentation: https://docs.lions.dev/applications/primereact/preparation
# =========================================================================

# =========================================================================
# PHASE 1: VALIDATION DES PRÃ‰REQUIS CRITIQUES
# =========================================================================

- name: "ğŸ” Validation - VÃ©rification du statut d'activation de PrimeReact"
  assert:
    that:
      - primereact_enabled | default(lookup('env', 'LIONS_PRIMEREACT_ENABLED') | bool) | bool
    fail_msg: "âŒ PrimeReact n'est pas activÃ©. VÃ©rifiez LIONS_PRIMEREACT_ENABLED dans votre configuration."
    success_msg: "âœ… PrimeReact est activÃ© et prÃªt pour le dÃ©ploiement"
  tags: [validation, primereact, critical]

- name: "ğŸ” Validation - VÃ©rification de la disponibilitÃ© du namespace"
  k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ primereact_namespace }}"
  register: namespace_check
  failed_when: false
  tags: [validation, namespace]

- name: "ğŸ—ï¸  Provisioning - CrÃ©ation du namespace si nÃ©cessaire"
  k8s:
    name: "{{ primereact_namespace }}"
    api_version: v1
    kind: Namespace
    state: present
    definition:
      metadata:
        name: "{{ primereact_namespace }}"
        labels:
          app.kubernetes.io/name: primereact
          app.kubernetes.io/component: frontend
          app.kubernetes.io/part-of: lions-infrastructure
          app.kubernetes.io/managed-by: ansible
          lions.dev/environment: "{{ lions_environment }}"
          lions.dev/version: "{{ primereact_version }}"
        annotations:
          lions.dev/created-by: "ansible-lions-infrastructure"
          lions.dev/creation-timestamp: "{{ ansible_date_time.iso8601 }}"
  when: namespace_check.resources | length == 0
  register: namespace_creation
  tags: [provisioning, namespace]

# =========================================================================
# PHASE 2: PRÃ‰PARATION DE L'ENVIRONNEMENT DE TRAVAIL
# =========================================================================

- name: "ğŸ“ Workspace - CrÃ©ation du rÃ©pertoire temporaire sÃ©curisÃ©"
  tempfile:
    state: directory
    suffix: ".primereact-{{ ansible_date_time.epoch }}"
    prefix: "lions-deploy-"
  register: primereact_workspace
  changed_when: false
  tags: [workspace, security]

- name: "ğŸ”’ SÃ©curitÃ© - Configuration des permissions du workspace"
  file:
    path: "{{ primereact_workspace.path }}"
    mode: '0700'
    owner: "{{ ansible_user | default('root') }}"
  changed_when: false
  tags: [workspace, security]

- name: "ğŸ“ Debug - Affichage des informations de workspace"
  debug:
    msg:
      - "Workspace PrimeReact crÃ©Ã©: {{ primereact_workspace.path }}"
      - "Namespace cible: {{ primereact_namespace }}"
      - "Environnement: {{ lions_environment }}"
      - "Version PrimeReact: {{ primereact_version }}"
  when: primereact_debug_enabled | default(false) | bool
  tags: [debug, workspace]

# =========================================================================
# PHASE 3: GÃ‰NÃ‰RATION DES MANIFESTES KUBERNETES
# =========================================================================

- name: "ğŸ—ï¸  Template - GÃ©nÃ©ration des manifestes Kubernetes"
  template:
    src: "{{ item.template }}"
    dest: "{{ primereact_workspace.path }}/{{ item.manifest }}"
    mode: '0600'
    backup: no
  loop:
    - { template: "serviceaccount.yml.j2", manifest: "01-serviceaccount.yml" }
    - { template: "configmap.yml.j2", manifest: "02-configmap.yml" }
    - { template: "service.yml.j2", manifest: "03-service.yml" }
    - { template: "deployment.yml.j2", manifest: "04-deployment.yml" }
    - { template: "ingress.yml.j2", manifest: "05-ingress.yml" }
    - { template: "servicemonitor.yml.j2", manifest: "06-servicemonitor.yml" }
    - { template: "networkpolicy.yml.j2", manifest: "07-networkpolicy.yml" }
  register: primereact_templates_generated
  notify: "cleanup workspace"
  tags: [templating, kubernetes]

- name: "âœ… Validation - VÃ©rification de l'intÃ©gritÃ© des manifestes gÃ©nÃ©rÃ©s"
  stat:
    path: "{{ primereact_workspace.path }}/{{ item }}"
    get_checksum: yes
    checksum_algorithm: sha256
  loop:
    - "01-serviceaccount.yml"
    - "02-configmap.yml"
    - "03-service.yml"
    - "04-deployment.yml"
    - "05-ingress.yml"
    - "06-servicemonitor.yml"
    - "07-networkpolicy.yml"
  register: primereact_manifests_validation
  failed_when: not item.stat.exists
  tags: [validation, kubernetes]

- name: "ğŸ“Š Audit - Enregistrement des checksums des manifestes"
  set_fact:
    primereact_manifests_checksums: "{{ primereact_manifests_validation.results | map(attribute='stat.checksum') | list }}"
  tags: [audit, security]

# =========================================================================
# PHASE 4: VALIDATION DE LA SYNTAXE KUBERNETES
# =========================================================================

- name: "ğŸ” Validation - VÃ©rification de la syntaxe YAML des manifestes"
  k8s:
    state: present
    src: "{{ primereact_workspace.path }}/{{ item }}"
    dry_run: yes
    validate:
      fail_on_error: yes
      strict: yes
  loop:
    - "01-serviceaccount.yml"
    - "02-configmap.yml"
    - "03-service.yml"
    - "04-deployment.yml"
    - "05-ingress.yml"
    - "06-servicemonitor.yml"
    - "07-networkpolicy.yml"
  register: primereact_syntax_validation
  when: primereact_validate_syntax | default(true) | bool
  tags: [validation, syntax, kubernetes]

# =========================================================================
# PHASE 5: CRÃ‰ATION DES RESSOURCES DE BASE
# =========================================================================

- name: "ğŸ” SÃ©curitÃ© - CrÃ©ation du ServiceAccount avec permissions minimales"
  k8s:
    state: present
    src: "{{ primereact_workspace.path }}/01-serviceaccount.yml"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: "{{ primereact_timeout_short | default(60) }}"
  register: primereact_serviceaccount_creation
  tags: [security, rbac, kubernetes]

- name: "âš™ï¸  Configuration - CrÃ©ation du ConfigMap applicatif"
  k8s:
    state: present
    src: "{{ primereact_workspace.path }}/02-configmap.yml"
    wait: true
    wait_timeout: "{{ primereact_timeout_short | default(60) }}"
  register: primereact_configmap_creation
  tags: [configuration, kubernetes]

- name: "ğŸŒ RÃ©seau - CrÃ©ation du Service de communication"
  k8s:
    state: present
    src: "{{ primereact_workspace.path }}/03-service.yml"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: "{{ primereact_timeout_short | default(60) }}"
  register: primereact_service_creation
  tags: [networking, kubernetes]

- name: "ğŸ”’ SÃ©curitÃ© - Application des NetworkPolicies"
  k8s:
    state: present
    src: "{{ primereact_workspace.path }}/07-networkpolicy.yml"
    wait: true
    wait_timeout: "{{ primereact_timeout_short | default(60) }}"
  register: primereact_networkpolicy_creation
  when: primereact_network_policies_enabled | default(lookup('env', 'LIONS_SECURITY_NETWORK_POLICIES') | bool) | bool
  tags: [security, networking, kubernetes]

# =========================================================================
# PHASE 6: VALIDATION DES DÃ‰PENDANCES EXTERNES
# =========================================================================

- name: "ğŸ” DÃ©pendances - VÃ©rification de la disponibilitÃ© de Redis"
  k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ primereact_redis_namespace | default(redis_namespace | default('database')) }}"
    name: "{{ primereact_redis_service_name | default('redis') }}"
  register: primereact_redis_check
  failed_when: false
  when: primereact_redis_enabled | default(lookup('env', 'LIONS_REDIS_ENABLED') | bool) | bool
  tags: [dependencies, redis, validation]

- name: "âš ï¸  DÃ©pendances - Avertissement Redis indisponible"
  debug:
    msg:
      - "âš ï¸  ATTENTION: Service Redis non disponible"
      - "Namespace recherchÃ©: {{ primereact_redis_namespace | default(redis_namespace | default('database')) }}"
      - "Service recherchÃ©: {{ primereact_redis_service_name | default('redis') }}"
      - "Impact: Performances rÃ©duites pour le cache applicatif"
      - "Action recommandÃ©e: DÃ©ployez Redis avant PrimeReact ou dÃ©sactivez la dÃ©pendance"
  when:
    - primereact_redis_enabled | default(lookup('env', 'LIONS_REDIS_ENABLED') | bool) | bool
    - primereact_redis_check is defined
    - (primereact_redis_check is failed or primereact_redis_check.resources | length == 0)
  tags: [dependencies, redis, warning]

- name: "ğŸ” DÃ©pendances - VÃ©rification de la disponibilitÃ© de PostgreSQL"
  k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ primereact_postgres_namespace | default(postgres_namespace | default('database')) }}"
    name: "{{ primereact_postgres_service_name | default('postgresql') }}"
  register: primereact_postgres_check
  failed_when: false
  when: primereact_postgres_enabled | default(lookup('env', 'LIONS_POSTGRES_ENABLED') | bool) | bool
  tags: [dependencies, postgres, validation]

- name: "âŒ DÃ©pendances - Ã‰chec critique PostgreSQL"
  fail:
    msg:
      - "âŒ ERREUR CRITIQUE: Service PostgreSQL non disponible"
      - "Namespace recherchÃ©: {{ primereact_postgres_namespace | default(postgres_namespace | default('database')) }}"
      - "Service recherchÃ©: {{ primereact_postgres_service_name | default('postgresql') }}"
      - "Impact: Impossible de dÃ©marrer PrimeReact sans base de donnÃ©es"
      - "Action requise: DÃ©ployez PostgreSQL avant de continuer"
  when:
    - primereact_postgres_enabled | default(lookup('env', 'LIONS_POSTGRES_ENABLED') | bool) | bool
    - primereact_postgres_check is defined
    - (primereact_postgres_check is failed or primereact_postgres_check.resources | length == 0)
    - primereact_fail_on_missing_deps | default(true) | bool
  tags: [dependencies, postgres, critical]

# =========================================================================
# PHASE 7: VALIDATION DES SECRETS APPLICATIFS
# =========================================================================

- name: "ğŸ” Secrets - VÃ©rification de l'existence des secrets applicatifs"
  k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ primereact_namespace }}"
    name: "{{ item }}"
  register: primereact_secrets_check
  failed_when: false
  loop: "{{ primereact_required_secrets }}"
  tags: [security, secrets, validation]

- name: "ğŸ” Secrets - Compilation des secrets manquants"
  set_fact:
    primereact_missing_secrets: >-
      {{
        primereact_secrets_check.results |
        selectattr('failed', 'defined') |
        selectattr('failed', 'equalto', true) |
        map(attribute='item') |
        list +
        primereact_secrets_check.results |
        selectattr('resources', 'defined') |
        selectattr('resources', 'equalto', []) |
        map(attribute='item') |
        list
      }}
  tags: [security, secrets]

- name: "âš ï¸  Secrets - Avertissement secrets manquants"
  debug:
    msg:
      - "âš ï¸  ATTENTION: Secrets manquants dÃ©tectÃ©s"
      - "Secrets manquants: {{ primereact_missing_secrets | join(', ') }}"
      - "Namespace: {{ primereact_namespace }}"
      - "Impact: L'application peut ne pas dÃ©marrer correctement"
      - "Action recommandÃ©e: CrÃ©ez les secrets avant le dÃ©ploiement"
      - "Commande exemple: kubectl create secret generic <nom> --from-literal=<clÃ©>=<valeur> -n {{ primereact_namespace }}"
  when: primereact_missing_secrets | length > 0
  tags: [security, secrets, warning]

- name: "âŒ Secrets - Ã‰chec critique secrets manquants"
  fail:
    msg:
      - "âŒ ERREUR CRITIQUE: Secrets obligatoires manquants"
      - "Secrets manquants: {{ primereact_missing_secrets | join(', ') }}"
      - "Action requise: CrÃ©ez tous les secrets avant de continuer"
  when:
    - primereact_missing_secrets | length > 0
    - primereact_fail_on_missing_secrets | default(false) | bool
  tags: [security, secrets, critical]

# =========================================================================
# PHASE 8: PRÃ‰PARATION DU MONITORING
# =========================================================================

- name: "ğŸ“Š Monitoring - VÃ©rification de la disponibilitÃ© de Prometheus"
  k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ monitoring_namespace | default('monitoring') }}"
    name: "prometheus-server"
  register: primereact_prometheus_check
  failed_when: false
  when: primereact_monitoring_enabled | default(lookup('env', 'LIONS_MONITORING_ENABLED') | bool) | bool
  tags: [monitoring, prometheus, validation]

- name: "ğŸ“Š Monitoring - PrÃ©paration du ServiceMonitor"
  debug:
    msg:
      - "ServiceMonitor sera crÃ©Ã© pour: {{ primereact_app_name }}"
      - "Namespace monitoring: {{ monitoring_namespace | default('monitoring') }}"
      - "MÃ©triques exposÃ©es sur le port: {{ primereact_metrics_port | default(9090) }}"
  when:
    - primereact_monitoring_enabled | default(lookup('env', 'LIONS_MONITORING_ENABLED') | bool) | bool
    - primereact_prometheus_check is defined
    - not (primereact_prometheus_check is failed or primereact_prometheus_check.resources | length == 0)
  tags: [monitoring, preparation]

# =========================================================================
# PHASE 9: RÃ‰SUMÃ‰ ET Ã‰TAT FINAL
# =========================================================================

- name: "ğŸ“‹ RÃ©sumÃ© - Compilation du statut de prÃ©paration"
  set_fact:
    primereact_preparation_summary:
      status: "ready"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      workspace: "{{ primereact_workspace.path }}"
      namespace: "{{ primereact_namespace }}"
      environment: "{{ lions_environment }}"
      version: "{{ primereact_version }}"
      manifests_generated: "{{ primereact_templates_generated.results | length }}"
      manifests_validated: "{{ primereact_manifests_validation.results | length }}"
      dependencies:
        redis:
          enabled: "{{ primereact_redis_enabled | default(lookup('env', 'LIONS_REDIS_ENABLED') | bool) | bool }}"
          available: "{{ primereact_redis_check is defined and not (primereact_redis_check is failed or primereact_redis_check.resources | length == 0) }}"
        postgres:
          enabled: "{{ primereact_postgres_enabled | default(lookup('env', 'LIONS_POSTGRES_ENABLED') | bool) | bool }}"
          available: "{{ primereact_postgres_check is defined and not (primereact_postgres_check is failed or primereact_postgres_check.resources | length == 0) }}"
        monitoring:
          enabled: "{{ primereact_monitoring_enabled | default(lookup('env', 'LIONS_MONITORING_ENABLED') | bool) | bool }}"
          available: "{{ primereact_prometheus_check is defined and not (primereact_prometheus_check is failed or primereact_prometheus_check.resources | length == 0) }}"
      security:
        network_policies: "{{ primereact_network_policies_enabled | default(lookup('env', 'LIONS_SECURITY_NETWORK_POLICIES') | bool) | bool }}"
        missing_secrets: "{{ primereact_missing_secrets | default([]) | length }}"
      warnings: "{{ (primereact_missing_secrets | default([]) | length > 0) or (primereact_redis_enabled | default(false) and primereact_redis_check is defined and (primereact_redis_check is failed or primereact_redis_check.resources | length == 0)) }}"
  tags: [summary, audit]

- name: "âœ… RÃ©sumÃ© - Affichage du statut final de prÃ©paration"
  debug:
    msg:
      - "ğŸ¯ PRÃ‰PARATION PRIMEREACT TERMINÃ‰E"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ğŸ“Š Statut: {{ primereact_preparation_summary.status | upper }}"
      - "ğŸ• Timestamp: {{ primereact_preparation_summary.timestamp }}"
      - "ğŸ“ Workspace: {{ primereact_preparation_summary.workspace }}"
      - "ğŸ·ï¸  Namespace: {{ primereact_preparation_summary.namespace }}"
      - "ğŸŒ Environnement: {{ primereact_preparation_summary.environment }}"
      - "ğŸ”– Version: {{ primereact_preparation_summary.version }}"
      - "ğŸ“ Manifestes gÃ©nÃ©rÃ©s: {{ primereact_preparation_summary.manifests_generated }}"
      - "âœ… Manifestes validÃ©s: {{ primereact_preparation_summary.manifests_validated }}"
      - "âš ï¸  Avertissements: {{ primereact_preparation_summary.warnings | ternary('OUI', 'AUCUN') }}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ğŸš€ PrÃªt pour le dÃ©ploiement: {{ not primereact_preparation_summary.warnings or primereact_ignore_warnings | default(false) }}"
  tags: [summary, final]

# =========================================================================
# HANDLERS DE NETTOYAGE
# =========================================================================

- name: "ğŸ§¹ Cleanup - Enregistrement du workspace pour nettoyage"
  set_fact:
    workspaces_to_cleanup: "{{ workspaces_to_cleanup | default([]) + [primereact_workspace.path] }}"
  changed_when: false
  tags: [cleanup, always]