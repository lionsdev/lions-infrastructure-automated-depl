---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - SERVICEACCOUNT PRIMEREACT
# =========================================================================
# Description: Template Kubernetes ServiceAccount pour application PrimeReact
# Version: 5.0.0
# Date: {{ ansible_date_time.iso8601 }}
# Maintainer: {{ lions_config_maintainer | default('devops@lions.dev') }}
# Documentation: https://docs.lions.dev/infrastructure/kubernetes/rbac
# =========================================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  name: "{{ lions_primereact_service_name | default('primereact') }}"
  namespace: "{{ lions_primereact_namespace | default('applications') }}"
  labels:
    # Labels standards LIONS
    app.kubernetes.io/name: "{{ lions_primereact_service_name | default('primereact') }}"
    app.kubernetes.io/instance: "{{ lions_primereact_service_name | default('primereact') }}-{{ lions_environment | default('development') }}"
    app.kubernetes.io/version: "{{ lions_primereact_version | default('latest') }}"
    app.kubernetes.io/component: frontend
    app.kubernetes.io/part-of: lions-platform
    app.kubernetes.io/managed-by: ansible

    # Labels LIONS spécifiques
    lions.dev/environment: "{{ lions_environment | default('development') }}"
    lions.dev/tier: application
    lions.dev/technology: primereact
    lions.dev/framework: react
    lions.dev/category: frontend
    lions.dev/deployment-mode: "{{ lions_deployment_mode | default('single') }}"

    # Labels pour le monitoring et observabilité
    monitoring.lions.dev/enabled: "{{ lions_monitoring_enabled | default('true') | string }}"
    monitoring.lions.dev/scrape: "{{ primereact_monitoring_enabled | default('true') | string }}"

    # Labels pour les politiques de sécurité
    security.lions.dev/pod-security-standard: "{{ lions_security_pod_security_standards | default('restricted') }}"
    security.lions.dev/network-policy: "{{ lions_security_network_policies | default('true') | string }}"

    # Labels pour la gestion des ressources
    resources.lions.dev/profile: "{{ primereact_resource_profile | default('medium') }}"
    backup.lions.dev/enabled: "{{ lions_backup_enabled | default('true') | string }}"

  annotations:
    # Annotations de description
    description: "ServiceAccount pour l'application PrimeReact {{ lions_primereact_service_name | default('primereact') }} (v{{ lions_primereact_version | default('latest') }}) en environnement {{ lions_environment | default('development') }}"
    lions.dev/service-description: "Application frontend PrimeReact pour l'interface utilisateur moderne"

    # Annotations de configuration
    lions.dev/config-version: "{{ lions_config_version | default('5.0.0') }}"
    lions.dev/deployment-timestamp: "{{ ansible_date_time.iso8601 }}"
    lions.dev/deployed-by: "{{ ansible_user | default('ansible') }}"

    # Annotations de sécurité
    security.lions.dev/rbac-required: "true"
    security.lions.dev/service-mesh-injection: "{{ primereact_service_mesh_enabled | default('false') | string }}"
    security.lions.dev/tls-required: "{{ lions_security_tls_enabled | default('true') | string }}"

    # Annotations pour le monitoring
    prometheus.io/scrape: "{{ primereact_monitoring_enabled | default('true') | string }}"
    prometheus.io/port: "{{ lions_primereact_port | default('3000') | string }}"
    prometheus.io/path: "{{ primereact_metrics_path | default('/metrics') }}"

    # Annotations pour la gestion du cycle de vie
    deployment.lions.dev/strategy: "{{ primereact_deployment_strategy | default('RollingUpdate') }}"
    deployment.lions.dev/max-unavailable: "{{ primereact_max_unavailable | default('25%') }}"
    deployment.lions.dev/max-surge: "{{ primereact_max_surge | default('25%') }}"

    # Annotations pour la haute disponibilité (si activée)
{% if lions_k8s_ha_enabled | default('false') | bool %}
    ha.lions.dev/enabled: "true"
    ha.lions.dev/anti-affinity: "{{ primereact_anti_affinity | default('preferred') }}"
    ha.lions.dev/spread-topology: "{{ primereact_topology_spread | default('zone') }}"
{% endif %}

    # Annotations pour les ressources
    resources.lions.dev/cpu-request: "{{ primereact_cpu_request | default(lions_resources_medium_cpu_request) | default('200m') }}"
    resources.lions.dev/cpu-limit: "{{ primereact_cpu_limit | default(lions_resources_medium_cpu_limit) | default('1000m') }}"
    resources.lions.dev/memory-request: "{{ primereact_memory_request | default(lions_resources_medium_memory_request) | default('512Mi') }}"
    resources.lions.dev/memory-limit: "{{ primereact_memory_limit | default(lions_resources_medium_memory_limit) | default('2Gi') }}"

    # Annotations pour l'autoscaling
{% if lions_autoscaling_enabled | default('true') | bool %}
    autoscaling.lions.dev/enabled: "true"
    autoscaling.lions.dev/min-replicas: "{{ primereact_autoscaling_min_replicas | default(lions_autoscaling_min_replicas) | default('1') }}"
    autoscaling.lions.dev/max-replicas: "{{ primereact_autoscaling_max_replicas | default(lions_autoscaling_max_replicas) | default('10') }}"
    autoscaling.lions.dev/cpu-target: "{{ primereact_autoscaling_cpu_target | default(lions_autoscaling_cpu_target) | default('70') }}"
    autoscaling.lions.dev/memory-target: "{{ primereact_autoscaling_memory_target | default(lions_autoscaling_memory_target) | default('80') }}"
{% endif %}

    # Annotations pour le backup
{% if lions_backup_enabled | default('true') | bool %}
    backup.lions.dev/schedule: "{{ primereact_backup_schedule | default(lions_backup_schedule) | default('0 2 * * *') }}"
    backup.lions.dev/retention: "{{ primereact_backup_retention | default(lions_backup_retention_days) | default('30') }}d"
    backup.lions.dev/storage-class: "{{ lions_backup_storage_class | default(lions_storage_class_default) | default('local-path') }}"
{% endif %}

    # Annotations pour le logging
    logging.lions.dev/level: "{{ primereact_log_level | default(lions_log_level) | default('INFO') }}"
    logging.lions.dev/format: "{{ primereact_log_format | default(lions_log_format) | default('json') }}"
    logging.lions.dev/retention: "{{ primereact_log_retention | default(lions_log_retention_days) | default('7') }}d"

    # Annotations spécifiques à l'environnement
{% if lions_environment == 'development' %}
    development.lions.dev/debug-enabled: "{{ lions_debug_mode | default('true') | string }}"
    development.lions.dev/hot-reload: "{{ primereact_hot_reload | default('true') | string }}"
    development.lions.dev/source-maps: "{{ primereact_source_maps | default('true') | string }}"
{% elif lions_environment == 'staging' %}
    staging.lions.dev/testing-enabled: "{{ primereact_testing_enabled | default('true') | string }}"
    staging.lions.dev/performance-monitoring: "{{ primereact_performance_monitoring | default('true') | string }}"
{% elif lions_environment == 'production' %}
    production.lions.dev/optimized: "true"
    production.lions.dev/minified: "true"
    production.lions.dev/cdn-enabled: "{{ primereact_cdn_enabled | default('false') | string }}"
    production.lions.dev/caching-strategy: "{{ primereact_caching_strategy | default('aggressive') }}"
{% endif %}

    # Annotations pour l'intégration continue
    ci.lions.dev/pipeline-id: "{{ ci_pipeline_id | default('') }}"
    ci.lions.dev/commit-sha: "{{ ci_commit_sha | default('') }}"
    ci.lions.dev/build-number: "{{ ci_build_number | default('') }}"
    ci.lions.dev/source-branch: "{{ ci_source_branch | default('') }}"

    # Annotations pour les dépendances
    dependencies.lions.dev/postgres: "{{ 'required' if lions_postgres_enabled | default('true') | bool else 'optional' }}"
    dependencies.lions.dev/redis: "{{ 'required' if lions_redis_enabled | default('true') | bool else 'optional' }}"
    dependencies.lions.dev/keycloak: "{{ 'required' if lions_keycloak_enabled | default('true') | bool else 'optional' }}"
    dependencies.lions.dev/vault: "{{ 'required' if lions_vault_enabled | default('true') | bool else 'optional' }}"

# Spécification du ServiceAccount
automountServiceAccountToken: {{ primereact_automount_sa_token | default('false') | bool }}

# Secrets associés (si nécessaire)
{% if primereact_image_pull_secrets is defined and primereact_image_pull_secrets | length > 0 %}
imagePullSecrets:
{% for secret in primereact_image_pull_secrets %}
  - name: {{ secret }}
{% endfor %}
{% elif lions_registry_enabled | default('true') | bool %}
imagePullSecrets:
  - name: "{{ lions_registry_service_name | default('registry') }}-secret"
{% endif %}

# Secrets additionnels pour l'application
{% if primereact_additional_secrets is defined and primereact_additional_secrets | length > 0 %}
secrets:
{% for secret in primereact_additional_secrets %}
  - name: {{ secret.name }}
    namespace: {{ secret.namespace | default(lions_primereact_namespace | default('applications')) }}
{% endfor %}
{% endif %}