---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - TEMPLATE SERVICE KUBERNETES PRIMEREACT
# =========================================================================
# Description: Template Jinja2 pour la création du service Kubernetes PrimeReact
# Version: 5.0.0
# Date: {{ ansible_date_time.iso8601 }}
# Maintainer: {{ lions_config_maintainer | default('devops@lions.dev') }}
# Environnement: {{ lions_environment | upper }}
# =========================================================================
# Documentation: https://docs.lions.dev/infrastructure/templates/services
# Support: https://support.lions.dev/primereact
# =========================================================================

apiVersion: v1
kind: Service
metadata:
  name: "{{ primereact_service_name | default('primereact') }}"
  namespace: "{{ primereact_namespace | default('applications') }}"
  labels:
    # Labels de base obligatoires LIONS
    app.kubernetes.io/name: "{{ primereact_service_name | default('primereact') }}"
    app.kubernetes.io/instance: "{{ primereact_instance_name | default(primereact_service_name) }}"
    app.kubernetes.io/version: "{{ primereact_version | default('latest') }}"
    app.kubernetes.io/component: "frontend"
    app.kubernetes.io/part-of: "lions-platform"
    app.kubernetes.io/managed-by: "ansible"

    # Labels LIONS spécifiques
    lions.dev/environment: "{{ lions_environment }}"
    lions.dev/team: "{{ primereact_team | default('frontend') }}"
    lions.dev/technology: "primereact"
    lions.dev/tier: "presentation"
    lions.dev/deployment-mode: "{{ lions_deployment_mode | default('single') }}"

    # Labels pour le monitoring
    monitoring.lions.dev/enabled: "{{ primereact_monitoring_enabled | default('true') | string | lower }}"
    monitoring.lions.dev/tier: "application"

    # Labels pour la sécurité
    security.lions.dev/network-policy: "{{ primereact_network_policy_enabled | default('true') | string | lower }}"
    security.lions.dev/tls-required: "{{ primereact_tls_required | default('true') | string | lower }}"

    # Labels métier
    business.lions.dev/criticality: "{{ primereact_business_criticality | default('medium') }}"
    business.lions.dev/cost-center: "{{ primereact_cost_center | default('development') }}"

{% if primereact_custom_labels is defined and primereact_custom_labels %}
    # Labels personnalisés
{% for key, value in primereact_custom_labels.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

  annotations:
    # Annotations de base
    description: "Service Kubernetes pour l'application PrimeReact {{ primereact_service_name }} v{{ primereact_version }}"
    documentation: "https://docs.lions.dev/applications/primereact"
    contact: "{{ primereact_maintainer_email | default('frontend-team@lions.dev') }}"

    # Annotations de déploiement
    deployment.lions.dev/created-by: "ansible-{{ ansible_version.full }}"
    deployment.lions.dev/created-at: "{{ ansible_date_time.iso8601 }}"
    deployment.lions.dev/playbook: "{{ ansible_playbook_python | default('unknown') }}"
    deployment.lions.dev/inventory: "{{ inventory_hostname }}"

    # Annotations de configuration
    config.lions.dev/config-hash: "{{ primereact_config_hash | default('') }}"
    config.lions.dev/secrets-hash: "{{ primereact_secrets_hash | default('') }}"

    # Annotations Prometheus/Monitoring
    prometheus.io/scrape: "{{ primereact_prometheus_scrape | default('true') | string | lower }}"
    prometheus.io/path: "{{ primereact_prometheus_path | default('/metrics') }}"
    prometheus.io/port: "{{ primereact_prometheus_port | default('3000') | string }}"
    prometheus.io/scheme: "{{ primereact_prometheus_scheme | default('http') }}"
    prometheus.io/interval: "{{ primereact_prometheus_interval | default('30s') }}"

    # Annotations de healthcheck
    healthcheck.lions.dev/enabled: "{{ primereact_healthcheck_enabled | default('true') | string | lower }}"
    healthcheck.lions.dev/path: "{{ primereact_healthcheck_path | default('/health') }}"
    healthcheck.lions.dev/port: "{{ primereact_healthcheck_port | default('3000') | string }}"

    # Annotations de sécurité
    security.lions.dev/scan-date: "{{ ansible_date_time.date }}"
    security.lions.dev/compliance: "{{ primereact_compliance_standard | default('baseline') }}"

    # Annotations de mise en réseau
    networking.lions.dev/ingress-class: "{{ primereact_ingress_class | default('traefik') }}"
    networking.lions.dev/load-balancer: "{{ primereact_load_balancer_type | default('traefik') }}"

{% if primereact_custom_annotations is defined and primereact_custom_annotations %}
    # Annotations personnalisées
{% for key, value in primereact_custom_annotations.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

spec:
  # Type de service
  type: {{ primereact_service_type | default('ClusterIP') }}

{% if primereact_service_type == 'LoadBalancer' and primereact_load_balancer_ip is defined %}
  loadBalancerIP: "{{ primereact_load_balancer_ip }}"
{% endif %}

{% if primereact_service_type == 'LoadBalancer' and primereact_load_balancer_source_ranges is defined %}
  loadBalancerSourceRanges:
{% for range in primereact_load_balancer_source_ranges %}
    - "{{ range }}"
{% endfor %}
{% endif %}

{% if primereact_external_ips is defined and primereact_external_ips %}
  externalIPs:
{% for ip in primereact_external_ips %}
    - "{{ ip }}"
{% endfor %}
{% endif %}

{% if primereact_service_type == 'ExternalName' and primereact_external_name is defined %}
  externalName: "{{ primereact_external_name }}"
{% endif %}

  # Configuration des ports
  ports:
    # Port HTTP principal
    - name: http
      port: {{ primereact_service_port | default(80) }}
      targetPort: {{ primereact_container_port_name | default('http') }}
      protocol: TCP
{% if primereact_service_type in ['NodePort', 'LoadBalancer'] and primereact_node_port is defined %}
      nodePort: {{ primereact_node_port }}
{% endif %}

{% if primereact_https_enabled | default(false) %}
    # Port HTTPS
    - name: https
      port: {{ primereact_service_https_port | default(443) }}
      targetPort: {{ primereact_container_https_port_name | default('https') }}
      protocol: TCP
{% if primereact_service_type in ['NodePort', 'LoadBalancer'] and primereact_node_port_https is defined %}
      nodePort: {{ primereact_node_port_https }}
{% endif %}
{% endif %}

{% if primereact_monitoring_enabled | default(true) %}
    # Port monitoring/metrics
    - name: metrics
      port: {{ primereact_metrics_port | default(9090) }}
      targetPort: {{ primereact_container_metrics_port_name | default('metrics') }}
      protocol: TCP
{% endif %}

{% if primereact_debug_enabled | default(false) and lions_environment in ['development', 'staging'] %}
    # Port debug (environnements non-production uniquement)
    - name: debug
      port: {{ primereact_debug_port | default(9229) }}
      targetPort: {{ primereact_container_debug_port_name | default('debug') }}
      protocol: TCP
{% endif %}

{% if primereact_custom_ports is defined and primereact_custom_ports %}
    # Ports personnalisés
{% for port in primereact_custom_ports %}
    - name: "{{ port.name }}"
      port: {{ port.port }}
      targetPort: {{ port.target_port | default(port.name) }}
      protocol: {{ port.protocol | default('TCP') }}
{% if primereact_service_type in ['NodePort', 'LoadBalancer'] and port.node_port is defined %}
      nodePort: {{ port.node_port }}
{% endif %}
{% endfor %}
{% endif %}

  # Sélecteur de pods
  selector:
    app.kubernetes.io/name: "{{ primereact_service_name | default('primereact') }}"
    app.kubernetes.io/instance: "{{ primereact_instance_name | default(primereact_service_name) }}"
{% if primereact_additional_selectors is defined and primereact_additional_selectors %}
{% for key, value in primereact_additional_selectors.items() %}
    {{ key }}: "{{ value }}"
{% endfor %}
{% endif %}

{% if primereact_session_affinity_enabled | default(false) %}
  # Configuration de l'affinité de session
  sessionAffinity: {{ primereact_session_affinity_type | default('ClientIP') }}
{% if primereact_session_affinity_type == 'ClientIP' and primereact_session_affinity_timeout is defined %}
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: {{ primereact_session_affinity_timeout }}
{% endif %}
{% endif %}

{% if primereact_external_traffic_policy is defined and primereact_service_type in ['NodePort', 'LoadBalancer'] %}
  externalTrafficPolicy: "{{ primereact_external_traffic_policy }}"
{% endif %}

{% if primereact_internal_traffic_policy is defined %}
  internalTrafficPolicy: "{{ primereact_internal_traffic_policy }}"
{% endif %}

{% if primereact_ip_families is defined and primereact_ip_families %}
  ipFamilies:
{% for family in primereact_ip_families %}
    - {{ family }}
{% endfor %}
  ipFamilyPolicy: {{ primereact_ip_family_policy | default('SingleStack') }}
{% endif %}

{% if primereact_publish_not_ready_addresses | default(false) %}
  publishNotReadyAddresses: true
{% endif %}

---
{% if primereact_headless_service_enabled | default(false) %}
# =========================================================================
# SERVICE HEADLESS POUR PRIMEREACT (DÉCOUVERTE DE SERVICES)
# =========================================================================
apiVersion: v1
kind: Service
metadata:
  name: "{{ primereact_service_name | default('primereact') }}-headless"
  namespace: "{{ primereact_namespace | default('applications') }}"
  labels:
    app.kubernetes.io/name: "{{ primereact_service_name | default('primereact') }}"
    app.kubernetes.io/instance: "{{ primereact_instance_name | default(primereact_service_name) }}"
    app.kubernetes.io/version: "{{ primereact_version | default('latest') }}"
    app.kubernetes.io/component: "frontend"
    app.kubernetes.io/part-of: "lions-platform"
    app.kubernetes.io/managed-by: "ansible"
    lions.dev/environment: "{{ lions_environment }}"
    lions.dev/service-type: "headless"
  annotations:
    description: "Service headless pour la découverte de services PrimeReact"
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
spec:
  type: ClusterIP
  clusterIP: None
  publishNotReadyAddresses: true
  ports:
    - name: http
      port: {{ primereact_container_port | default(3000) }}
      targetPort: {{ primereact_container_port_name | default('http') }}
      protocol: TCP
  selector:
    app.kubernetes.io/name: "{{ primereact_service_name | default('primereact') }}"
    app.kubernetes.io/instance: "{{ primereact_instance_name | default(primereact_service_name) }}"
{% endif %}

{% if primereact_monitoring_enabled | default(true) and primereact_separate_metrics_service | default(false) %}
---
# =========================================================================
# SERVICE DÉDIÉ POUR LES MÉTRIQUES PRIMEREACT
# =========================================================================
apiVersion: v1
kind: Service
metadata:
  name: "{{ primereact_service_name | default('primereact') }}-metrics"
  namespace: "{{ primereact_namespace | default('applications') }}"
  labels:
    app.kubernetes.io/name: "{{ primereact_service_name | default('primereact') }}"
    app.kubernetes.io/instance: "{{ primereact_instance_name | default(primereact_service_name) }}"
    app.kubernetes.io/version: "{{ primereact_version | default('latest') }}"
    app.kubernetes.io/component: "metrics"
    app.kubernetes.io/part-of: "lions-platform"
    app.kubernetes.io/managed-by: "ansible"
    lions.dev/environment: "{{ lions_environment }}"
    lions.dev/service-type: "metrics"
    monitoring.lions.dev/enabled: "true"
  annotations:
    description: "Service dédié aux métriques pour l'application PrimeReact"
    prometheus.io/scrape: "true"
    prometheus.io/path: "{{ primereact_prometheus_path | default('/metrics') }}"
    prometheus.io/port: "{{ primereact_metrics_port | default(9090) | string }}"
spec:
  type: ClusterIP
  ports:
    - name: metrics
      port: {{ primereact_metrics_port | default(9090) }}
      targetPort: {{ primereact_container_metrics_port_name | default('metrics') }}
      protocol: TCP
  selector:
    app.kubernetes.io/name: "{{ primereact_service_name | default('primereact') }}"
    app.kubernetes.io/instance: "{{ primereact_instance_name | default(primereact_service_name) }}"
{% endif %}

# =========================================================================
# VALIDATION ET CONTRÔLES DE QUALITÉ
# =========================================================================
# Ce template est validé pour:
# - Conformité Kubernetes v{{ k8s_version | default('1.30') }}
# - Standards LIONS Infrastructure 5.0
# - Sécurité et observabilité
# - Multi-environnements (dev/staging/prod)
# - Haute disponibilité et résilience
# =========================================================================