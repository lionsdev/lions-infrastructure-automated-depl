---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - POSTGRESQL PREPARATION TASKS
# =========================================================================
# Description: PrÃ©pare les ressources nÃ©cessaires pour dÃ©ployer PostgreSQL
# Auteur: DevOps Team - LIONS Infrastructure
# Date: "{{ ansible_date_time.date }}"
# Version: 5.0.0
# Documentation: https://docs.lions.dev/infrastructure/postgres/preparation
# =========================================================================

# =========================================================================
# VALIDATION DES PRÃ‰REQUIS
# =========================================================================
- name: "ğŸ” [POSTGRES-PREP] Validation des variables d'environnement critiques"
  assert:
    that:
      - lions_postgres_enabled is defined
      - lions_postgres_namespace is defined
      - lions_postgres_service_name is defined
      - lions_postgres_version is defined
      - lions_postgres_storage_size is defined
      - lions_environment is defined
    fail_msg: "âŒ Variables d'environnement LIONS PostgreSQL manquantes"
    success_msg: "âœ… Variables d'environnement PostgreSQL validÃ©es"
  tags:
    - validation
    - postgres
    - preparation

- name: "ğŸ” [POSTGRES-PREP] VÃ©rification de l'Ã©tat du cluster Kubernetes"
  k8s_info:
    api_version: v1
    kind: Node
  register: k8s_cluster_status
  failed_when: false
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - validation
    - k8s

- name: "âŒ [POSTGRES-PREP] Ã‰chec - Cluster Kubernetes inaccessible"
  fail:
    msg: "Le cluster Kubernetes n'est pas accessible. VÃ©rifiez la configuration."
  when: k8s_cluster_status.failed
  tags:
    - validation
    - k8s

- name: "âœ… [POSTGRES-PREP] Cluster Kubernetes opÃ©rationnel ({{ k8s_cluster_status.resources | length }} nÅ“uds)"
  debug:
    msg: "Cluster K8s accessible avec {{ k8s_cluster_status.resources | length }} nÅ“ud(s)"
  tags:
    - validation
    - k8s

# =========================================================================
# CRÃ‰ATION DU NAMESPACE ET VÃ‰RIFICATIONS
# =========================================================================
- name: "ğŸ—ï¸ [POSTGRES-PREP] CrÃ©ation/VÃ©rification du namespace {{ lions_postgres_namespace }}"
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ lions_postgres_namespace }}"
        labels:
          name: "{{ lions_postgres_namespace }}"
          app.kubernetes.io/name: postgresql
          app.kubernetes.io/component: database
          app.kubernetes.io/part-of: lions-infrastructure
          app.kubernetes.io/managed-by: ansible
          lions.dev/environment: "{{ lions_environment }}"
          lions.dev/version: "{{ lions_config_version | default('5.0.0') }}"
        annotations:
          lions.dev/description: "Namespace pour les services de base de donnÃ©es PostgreSQL"
          lions.dev/created-by: "lions-infrastructure-ansible"
          lions.dev/creation-date: "{{ ansible_date_time.iso8601 }}"
  register: postgres_namespace_result
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - namespace
    - postgres

- name: "ğŸ” [POSTGRES-PREP] VÃ©rification des ressources systÃ¨me requises"
  k8s_info:
    api_version: v1
    kind: Node
  register: cluster_nodes
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - validation
    - resources

- name: "âš ï¸ [POSTGRES-PREP] Avertissement - Ressources systÃ¨me limitÃ©es"
  debug:
    msg: |
      AVERTISSEMENT: Cluster Ã  nÅ“ud unique dÃ©tectÃ©.
      Pour la production, considÃ©rez un dÃ©ploiement multi-nÅ“uds pour PostgreSQL HA.
  when: cluster_nodes.resources | length == 1 and lions_environment == 'production'
  tags:
    - validation
    - resources

# =========================================================================
# PRÃ‰PARATION DES RÃ‰PERTOIRES DE TRAVAIL
# =========================================================================
- name: "ğŸ“ [POSTGRES-PREP] CrÃ©ation du rÃ©pertoire de travail temporaire"
  tempfile:
    state: directory
    suffix: ".lions-postgres-{{ lions_environment }}"
    prefix: "postgres-deploy-"
  register: postgres_temp_dir
  changed_when: false
  tags:
    - preparation
    - filesystem

- name: "ğŸ“‹ [POSTGRES-PREP] Enregistrement du rÃ©pertoire de travail"
  set_fact:
    postgres_work_dir: "{{ postgres_temp_dir.path }}"
    postgres_manifest_files:
      - name: serviceaccount
        template: serviceaccount.yml.j2
        required: true
      - name: configmap
        template: configmap.yml.j2
        required: true
      - name: persistentvolumeclaim
        template: persistentvolumeclaim.yml.j2
        required: true
      - name: service
        template: service.yml.j2
        required: true
      - name: statefulset
        template: statefulset.yml.j2
        required: true
      - name: servicemonitor
        template: servicemonitor.yml.j2
        required: "{{ lions_monitoring_enabled | default(false) | bool }}"
  tags:
    - preparation

# =========================================================================
# GÃ‰NÃ‰RATION DES MANIFESTES KUBERNETES
# =========================================================================
- name: "ğŸ”§ [POSTGRES-PREP] GÃ©nÃ©ration des manifestes Kubernetes"
  template:
    src: "{{ item.template }}"
    dest: "{{ postgres_work_dir }}/{{ item.name }}.yml"
    mode: '0644'
    backup: false
  loop: "{{ postgres_manifest_files }}"
  when: item.required | bool
  register: postgres_templates_generated
  tags:
    - templates
    - manifests

- name: "ğŸ” [POSTGRES-PREP] Validation des manifestes gÃ©nÃ©rÃ©s"
  stat:
    path: "{{ postgres_work_dir }}/{{ item.name }}.yml"
  loop: "{{ postgres_manifest_files }}"
  when: item.required | bool
  register: postgres_manifest_validation
  tags:
    - validation
    - manifests

- name: "âŒ [POSTGRES-PREP] Ã‰chec - Manifestes manquants"
  fail:
    msg: "Le manifeste {{ item.item.name }}.yml n'a pas Ã©tÃ© gÃ©nÃ©rÃ© correctement"
  loop: "{{ postgres_manifest_validation.results }}"
  when:
    - item.item.required | bool
    - not item.stat.exists
  tags:
    - validation
    - manifests

- name: "âœ… [POSTGRES-PREP] Manifestes Kubernetes gÃ©nÃ©rÃ©s avec succÃ¨s"
  debug:
    msg: "Tous les manifestes requis ont Ã©tÃ© gÃ©nÃ©rÃ©s dans {{ postgres_work_dir }}"
  tags:
    - manifests

# =========================================================================
# GESTION DES SECRETS - INTÃ‰GRATION VAULT
# =========================================================================
- name: "ğŸ” [POSTGRES-PREP] VÃ©rification de l'intÃ©gration Vault"
  uri:
    url: "{{ lions_vault_addr | default('http://localhost:8200') }}/v1/sys/health"
    method: GET
    status_code: [200, 429, 472, 473, 501, 503]
    timeout: 10
  register: vault_health_check
  failed_when: false
  when: lions_vault_enabled | default(false) | bool
  tags:
    - vault
    - secrets

- name: "ğŸ” [POSTGRES-PREP] Configuration de la rÃ©cupÃ©ration des secrets via Vault"
  set_fact:
    postgres_use_vault: "{{ lions_vault_enabled | default(false) | bool and not vault_health_check.failed }}"
    postgres_admin_secret_name: "{{ lions_postgres_service_name }}-admin-credentials"
    postgres_user_secret_name: "{{ lions_postgres_service_name }}-user-credentials"
    postgres_replication_secret_name: "{{ lions_postgres_service_name }}-replication-credentials"
  tags:
    - secrets
    - configuration

# =========================================================================
# GESTION DES SECRETS ADMINISTRATEUR
# =========================================================================
- name: "ğŸ” [POSTGRES-PREP] VÃ©rification du secret administrateur existant"
  k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ lions_postgres_namespace }}"
    name: "{{ postgres_admin_secret_name }}"
  register: postgres_admin_secret_check
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - secrets
    - validation

- name: "ğŸ” [POSTGRES-PREP] RÃ©cupÃ©ration du mot de passe administrateur depuis Vault"
  vault_secret:
    vault_addr: "{{ lions_vault_addr }}"
    vault_token: "{{ vault_token | default(lookup('env', 'VAULT_TOKEN')) }}"
    secret_path: "secret/data/postgres/admin"
    secret_key: "password"
  register: postgres_admin_password_from_vault
  when:
    - postgres_use_vault | bool
    - postgres_admin_secret_check.resources | length == 0
  failed_when: false
  no_log: true
  tags:
    - vault
    - secrets

- name: "ğŸ” [POSTGRES-PREP] GÃ©nÃ©ration sÃ©curisÃ©e du mot de passe administrateur"
  set_fact:
    postgres_admin_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits,!@#$%^&*') }}"
  when:
    - postgres_admin_secret_check.resources | length == 0
    - not postgres_use_vault | bool or postgres_admin_password_from_vault.failed | default(false)
  no_log: true
  tags:
    - secrets
    - security

- name: "ğŸ” [POSTGRES-PREP] Utilisation du mot de passe depuis Vault"
  set_fact:
    postgres_admin_password: "{{ postgres_admin_password_from_vault.secret_value }}"
  when:
    - postgres_use_vault | bool
    - not postgres_admin_password_from_vault.failed | default(true)
  no_log: true
  tags:
    - vault
    - secrets

- name: "ğŸ” [POSTGRES-PREP] CrÃ©ation du secret administrateur PostgreSQL"
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ postgres_admin_secret_name }}"
        namespace: "{{ lions_postgres_namespace }}"
        labels:
          app.kubernetes.io/name: postgresql
          app.kubernetes.io/component: database
          app.kubernetes.io/part-of: lions-infrastructure
          app.kubernetes.io/managed-by: ansible
          lions.dev/environment: "{{ lions_environment }}"
          lions.dev/secret-type: database-credentials
        annotations:
          lions.dev/description: "Credentials pour l'administrateur PostgreSQL"
          lions.dev/created-by: "lions-infrastructure-ansible"
          lions.dev/creation-date: "{{ ansible_date_time.iso8601 }}"
          lions.dev/vault-managed: "{{ postgres_use_vault | string }}"
      type: Opaque
      stringData:
        username: "{{ lions_postgres_admin_user | default('postgres') }}"
        password: "{{ postgres_admin_password }}"
        database: "{{ lions_postgres_database }}"
  when: postgres_admin_secret_check.resources | length == 0
  register: postgres_admin_secret_created
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  no_log: true
  tags:
    - secrets
    - creation

# =========================================================================
# GESTION DES SECRETS RÃ‰PLICATION (HAUTE DISPONIBILITÃ‰)
# =========================================================================
- name: "ğŸ” [POSTGRES-PREP] VÃ©rification des besoins de rÃ©plication"
  set_fact:
    postgres_requires_replication: "{{ lions_postgres_ha_enabled | default(false) | bool or lions_environment == 'production' }}"
  tags:
    - ha
    - replication

- name: "ğŸ” [POSTGRES-PREP] VÃ©rification du secret de rÃ©plication existant"
  k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ lions_postgres_namespace }}"
    name: "{{ postgres_replication_secret_name }}"
  register: postgres_replication_secret_check
  when: postgres_requires_replication | bool
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - secrets
    - replication

- name: "ğŸ” [POSTGRES-PREP] RÃ©cupÃ©ration du mot de passe de rÃ©plication depuis Vault"
  vault_secret:
    vault_addr: "{{ lions_vault_addr }}"
    vault_token: "{{ vault_token | default(lookup('env', 'VAULT_TOKEN')) }}"
    secret_path: "secret/data/postgres/replication"
    secret_key: "password"
  register: postgres_replication_password_from_vault
  when:
    - postgres_requires_replication | bool
    - postgres_use_vault | bool
    - postgres_replication_secret_check.resources | length == 0
  failed_when: false
  no_log: true
  tags:
    - vault
    - secrets
    - replication

- name: "ğŸ” [POSTGRES-PREP] GÃ©nÃ©ration sÃ©curisÃ©e du mot de passe de rÃ©plication"
  set_fact:
    postgres_replication_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits,!@#$%^&*') }}"
  when:
    - postgres_requires_replication | bool
    - postgres_replication_secret_check.resources | length == 0
    - not postgres_use_vault | bool or postgres_replication_password_from_vault.failed | default(false)
  no_log: true
  tags:
    - secrets
    - replication

- name: "ğŸ” [POSTGRES-PREP] CrÃ©ation du secret de rÃ©plication PostgreSQL"
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ postgres_replication_secret_name }}"
        namespace: "{{ lions_postgres_namespace }}"
        labels:
          app.kubernetes.io/name: postgresql
          app.kubernetes.io/component: database
          app.kubernetes.io/part-of: lions-infrastructure
          app.kubernetes.io/managed-by: ansible
          lions.dev/environment: "{{ lions_environment }}"
          lions.dev/secret-type: replication-credentials
        annotations:
          lions.dev/description: "Credentials pour la rÃ©plication PostgreSQL"
          lions.dev/created-by: "lions-infrastructure-ansible"
          lions.dev/creation-date: "{{ ansible_date_time.iso8601 }}"
          lions.dev/vault-managed: "{{ postgres_use_vault | string }}"
      type: Opaque
      stringData:
        username: "replicator"
        password: "{{ postgres_replication_password }}"
  when:
    - postgres_requires_replication | bool
    - postgres_replication_secret_check.resources | length == 0
  register: postgres_replication_secret_created
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  no_log: true
  tags:
    - secrets
    - replication

# =========================================================================
# CRÃ‰ATION DES RESSOURCES DE BASE
# =========================================================================
- name: "ğŸ‘¤ [POSTGRES-PREP] CrÃ©ation du ServiceAccount PostgreSQL"
  k8s:
    state: present
    src: "{{ postgres_work_dir }}/serviceaccount.yml"
  register: postgres_serviceaccount_result
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - serviceaccount
    - rbac

- name: "ğŸ“‹ [POSTGRES-PREP] CrÃ©ation du ConfigMap de configuration"
  k8s:
    state: present
    src: "{{ postgres_work_dir }}/configmap.yml"
  register: postgres_configmap_result
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - configmap
    - configuration

# =========================================================================
# GESTION DU STOCKAGE PERSISTANT
# =========================================================================
- name: "ğŸ—„ï¸ [POSTGRES-PREP] VÃ©rification de la classe de stockage"
  k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: "{{ lions_storage_class_default }}"
  register: postgres_storage_class_check
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - storage
    - validation

- name: "âš ï¸ [POSTGRES-PREP] Avertissement - Classe de stockage manquante"
  debug:
    msg: |
      AVERTISSEMENT: La classe de stockage '{{ lions_storage_class_default }}' n'existe pas.
      Le PVC utilisera la classe de stockage par dÃ©faut du cluster.
  when: postgres_storage_class_check.resources | length == 0
  tags:
    - storage
    - warning

- name: "ğŸ’¾ [POSTGRES-PREP] CrÃ©ation du PVC pour PostgreSQL"
  k8s:
    state: present
    src: "{{ postgres_work_dir }}/persistentvolumeclaim.yml"
  register: postgres_pvc_result
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - storage
    - pvc

- name: "ğŸ” [POSTGRES-PREP] VÃ©rification du statut du PVC"
  k8s_info:
    api_version: v1
    kind: PersistentVolumeClaim
    namespace: "{{ lions_postgres_namespace }}"
    name: "{{ lions_postgres_service_name }}-data"
  register: postgres_pvc_status
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - storage
    - validation

- name: "â³ [POSTGRES-PREP] Attente de la liaison du PVC"
  k8s_info:
    api_version: v1
    kind: PersistentVolumeClaim
    namespace: "{{ lions_postgres_namespace }}"
    name: "{{ lions_postgres_service_name }}-data"
    wait: true
    wait_condition:
      type: Bound
      status: "True"
    wait_timeout: 300
  register: postgres_pvc_bound
  failed_when: false
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file | default('/home/' + ansible_user + '/.kube/config') }}"
  tags:
    - storage
    - waiting

- name: "âš ï¸ [POSTGRES-PREP] Avertissement - PVC non liÃ©"
  debug:
    msg: |
      AVERTISSEMENT: Le PVC PostgreSQL n'est pas encore liÃ© Ã  un PV.
      Cela peut indiquer un problÃ¨me de provisioning de stockage.
      Statut actuel: {{ postgres_pvc_status.resources[0].status.phase | default('Unknown') }}
  when: postgres_pvc_bound.failed | default(false)
  tags:
    - storage
    - warning

# =========================================================================
# RÃ‰SUMÃ‰ DE LA PRÃ‰PARATION
# =========================================================================
- name: "ğŸ“Š [POSTGRES-PREP] RÃ©capitulatif de la prÃ©paration"
  debug:
    msg: |
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ˜ PRÃ‰PARATION POSTGRESQL TERMINÃ‰E
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ“ Environnement: {{ lions_environment }}
      ğŸ·ï¸  Namespace: {{ lions_postgres_namespace }}
      ğŸ”§ Version PostgreSQL: {{ lions_postgres_version }}
      ğŸ’¾ Taille de stockage: {{ lions_postgres_storage_size }}
      ğŸ” Gestion des secrets: {{ 'Vault' if postgres_use_vault else 'Kubernetes' }}
      ğŸ”„ RÃ©plication HA: {{ 'ActivÃ©e' if postgres_requires_replication else 'DÃ©sactivÃ©e' }}
      ğŸ“ RÃ©pertoire de travail: {{ postgres_work_dir }}
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tags:
    - summary

# =========================================================================
# NETTOYAGE CONDITIONNEL
# =========================================================================
- name: "ğŸ§¹ [POSTGRES-PREP] Nettoyage du rÃ©pertoire temporaire"
  file:
    path: "{{ postgres_work_dir }}"
    state: absent
  when:
    - lions_debug_mode | default(false) | bool == false
    - postgres_cleanup_temp_files | default(true) | bool
  changed_when: false
  tags:
    - cleanup

- name: "ğŸ› [POSTGRES-PREP] Conservation des fichiers temporaires (mode debug)"
  debug:
    msg: "Mode debug activÃ© - Fichiers temporaires conservÃ©s dans: {{ postgres_work_dir }}"
  when: lions_debug_mode | default(false) | bool
  tags:
    - debug
    - cleanup