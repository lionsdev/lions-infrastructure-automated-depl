# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - PRIMEFACES SERVICEACCOUNT TEMPLATE
# =========================================================================
# Description: Template Kubernetes avancé pour le ServiceAccount PrimeFaces
# Composant: PrimeFaces Application ServiceAccount
# Version: 5.0.0
# Maintainer: DevOps LIONS Team
# Documentation: https://docs.lions.dev/infrastructure/primefaces/serviceaccount
# =========================================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  name: "{{ lions_primefaces_service_account | default(lions_primefaces_app_name | default(lions_primefaces_service_name)) }}"
  namespace: "{{ lions_primefaces_namespace }}"
  labels:
    # Labels Kubernetes standards
    app.kubernetes.io/name: "{{ lions_primefaces_app_name | default(lions_primefaces_service_name) }}"
    app.kubernetes.io/instance: "{{ lions_primefaces_app_name | default(lions_primefaces_service_name) }}-{{ lions_environment }}"
    app.kubernetes.io/version: "{{ lions_primefaces_app_version | default('latest') }}"
    app.kubernetes.io/component: "serviceaccount"
    app.kubernetes.io/part-of: "lions-infrastructure"
    app.kubernetes.io/managed-by: "lions-infrastructure-ansible"
    
    # Labels LIONS spécifiques
    lions.dev/environment: "{{ lions_environment }}"
    lions.dev/technology: "primefaces"
    lions.dev/tier: "frontend"
    lions.dev/rbac-profile: "{{ lions_primefaces_rbac_profile | default('restricted') }}"
    lions.dev/data-classification: "{{ lions_primefaces_data_classification | default('internal') }}"
    lions.dev/business-unit: "{{ lions_business_unit | default('infrastructure') }}"
    lions.dev/cost-center: "{{ lions_cost_center | default('devops') }}"
    
    # Labels pour l'observabilité
    app: "{{ lions_primefaces_app_name | default(lions_primefaces_service_name) }}"
    version: "{{ lions_primefaces_app_version | default('latest') }}"
    environment: "{{ lions_environment }}"
    
  annotations:
    # Annotations standards
    description: "ServiceAccount enterprise LIONS 5.0 pour l'application PrimeFaces {{ lions_primefaces_app_name | default(lions_primefaces_service_name) }} ({{ lions_primefaces_app_version | default('latest') }}) en environnement {{ lions_environment }}"
    
    # Annotations LIONS de gestion
    lions.dev/created-by: "lions-infrastructure-ansible"
    lions.dev/last-updated: "{{ ansible_date_time.iso8601 }}"
    lions.dev/serviceaccount-purpose: "{{ lions_primefaces_serviceaccount_purpose | default('Authentification et autorisation pour l application PrimeFaces avec privilèges minimal') }}"
    lions.dev/support-contact: "{{ lions_support_contact | default('devops@lions.dev') }}"
    lions.dev/documentation-url: "https://docs.lions.dev/infrastructure/primefaces/serviceaccount"
    lions.dev/rbac-documentation: "https://docs.lions.dev/infrastructure/rbac/primefaces"
    
    # Configuration de sécurité RBAC
    lions.dev/rbac-principle: "{{ lions_primefaces_rbac_principle | default('least-privilege') }}"
    lions.dev/security-level: "{{ lions_primefaces_security_level | default('standard') }}"
    lions.dev/audit-required: "{{ lions_primefaces_audit_required | default('true') }}"
    
    # Configuration cloud provider spécifique
    {% if lions_cloud_provider == 'aws' %}
    # Configuration AWS IAM (si utilisation d'IRSA)
    {% if lions_primefaces_aws_irsa_enabled | default(false) | bool %}
    eks.amazonaws.com/role-arn: "{{ lions_primefaces_aws_iam_role_arn }}"
    eks.amazonaws.com/audience: "{{ lions_primefaces_aws_irsa_audience | default('sts.amazonaws.com') }}"
    {% endif %}
    {% if lions_primefaces_aws_pod_identity_enabled | default(false) | bool %}
    eks.amazonaws.com/pod-identity-association-role-arn: "{{ lions_primefaces_aws_pod_identity_role_arn }}"
    {% endif %}
    {% endif %}
    
    {% if lions_cloud_provider == 'azure' %}
    # Configuration Azure AD Workload Identity
    {% if lions_primefaces_azure_workload_identity_enabled | default(false) | bool %}
    azure.workload.identity/client-id: "{{ lions_primefaces_azure_client_id }}"
    azure.workload.identity/tenant-id: "{{ lions_primefaces_azure_tenant_id }}"
    azure.workload.identity/use: "true"
    {% endif %}
    {% endif %}
    
    {% if lions_cloud_provider == 'gcp' %}
    # Configuration GCP Workload Identity
    {% if lions_primefaces_gcp_workload_identity_enabled | default(false) | bool %}
    iam.gke.io/gcp-service-account: "{{ lions_primefaces_gcp_service_account }}@{{ lions_gcp_project_id }}.iam.gserviceaccount.com"
    {% endif %}
    {% endif %}
    
    # Configuration Vault (si activé)
    {% if lions_vault_enabled | default(false) | bool %}
    vault.hashicorp.com/agent-inject: "{{ lions_primefaces_vault_agent_inject | default('true') }}"
    vault.hashicorp.com/role: "{{ lions_primefaces_vault_role | default('primefaces-' + lions_environment) }}"
    vault.hashicorp.com/agent-run-as-user: "{{ lions_primefaces_security_user_id | default('10001') }}"
    vault.hashicorp.com/agent-run-as-group: "{{ lions_primefaces_security_group_id | default('10001') }}"
    {% if lions_primefaces_vault_secrets | default([]) | length > 0 %}
    {% for secret in lions_primefaces_vault_secrets %}
    vault.hashicorp.com/agent-inject-secret-{{ secret.name }}: "{{ secret.path }}"
    vault.hashicorp.com/agent-inject-template-{{ secret.name }}: |
      {{ secret.template | default('{{- with secret "' + secret.path + '" -}}{{ .Data.data.' + secret.key + ' }}{{- end -}}') }}
    {% endfor %}
    {% endif %}
    {% endif %}
    
    # Configuration Istio (si activé)
    {% if lions_istio_enabled | default(false) | bool %}
    sidecar.istio.io/inject: "{{ lions_primefaces_istio_injection | default('true') }}"
    {% endif %}

# Configuration de montage automatique des tokens
automountServiceAccountToken: {{ lions_primefaces_automount_sa_token | default('false') }}

# Secrets d'image pull associés au ServiceAccount
{% if lions_primefaces_image_pull_secrets | default([]) | length > 0 %}
imagePullSecrets:
  {% for secret in lions_primefaces_image_pull_secrets %}
  - name: "{{ secret }}"
  {% endfor %}
{% elif lions_image_pull_secret_required | default(false) | bool %}
imagePullSecrets:
  - name: "{{ lions_image_pull_secret_name | default('regcred') }}"
{% endif %}

# Secrets associés au ServiceAccount
{% if lions_primefaces_serviceaccount_secrets | default([]) | length > 0 %}
secrets:
  {% for secret in lions_primefaces_serviceaccount_secrets %}
  - name: "{{ secret }}"
  {% endfor %}
{% endif %}