---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - REDIS PREPARATION TASKS
# =========================================================================
# Description: Pr√©pare les ressources n√©cessaires pour d√©ployer Redis
# Auteur: √âquipe LIONS Infrastructure DevOps
# Date: 2025-05-27
# Version: 5.0.0
# Documentation: https://docs.lions.dev/infrastructure/services/redis
# =========================================================================

# =========================================================================
# VALIDATION DE LA CONFIGURATION
# =========================================================================
- name: "üîç Validation de la configuration Redis"
  block:
    - name: "V√©rification des variables requises"
      assert:
        that:
          - lions_redis_enabled is defined
          - lions_redis_namespace is defined
          - lions_redis_service_name is defined
          - lions_redis_version is defined
          - lions_redis_storage_size is defined
        fail_msg: "‚ùå Variables Redis manquantes. V√©rifiez votre configuration."
        success_msg: "‚úÖ Variables Redis valid√©es avec succ√®s"

    - name: "Validation de la version Redis"
      assert:
        that:
          - lions_redis_version is match('^[0-9]+\.[0-9]+(\.[0-9]+)?$')
        fail_msg: "‚ùå Format de version Redis invalide: {{ lions_redis_version }}"
        success_msg: "‚úÖ Version Redis {{ lions_redis_version }} valid√©e"

    - name: "Validation de la taille de stockage"
      assert:
        that:
          - lions_redis_storage_size is match('^[0-9]+[KMG]i$')
        fail_msg: "‚ùå Format de taille de stockage invalide: {{ lions_redis_storage_size }}"
        success_msg: "‚úÖ Taille de stockage {{ lions_redis_storage_size }} valid√©e"

  tags:
    - validation
    - redis

# =========================================================================
# PR√âPARATION DE L'ENVIRONNEMENT
# =========================================================================
- name: "üèóÔ∏è Pr√©paration de l'environnement Redis"
  block:
    - name: "V√©rification de l'existence du namespace Redis"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ lions_redis_namespace }}"
      register: redis_namespace_info
      failed_when: false

    - name: "Cr√©ation du namespace Redis si n√©cessaire"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ lions_redis_namespace }}"
            labels:
              app.kubernetes.io/name: redis
              app.kubernetes.io/component: database
              app.kubernetes.io/part-of: lions-infrastructure
              app.kubernetes.io/managed-by: ansible
              environment: "{{ lions_environment }}"
              lions.dev/service-type: database
            annotations:
              description: "Namespace pour les services de base de donn√©es Redis"
              lions.dev/managed-by: "lions-infrastructure-5.0"
              lions.dev/created-date: "{{ ansible_date_time.iso8601 }}"
      when: redis_namespace_info.resources | length == 0
      register: namespace_creation

    - name: "Cr√©ation du r√©pertoire temporaire pour les templates"
      ansible.builtin.tempfile:
        state: directory
        suffix: ".redis-deploy"
        prefix: "lions-"
      register: redis_temp_dir
      changed_when: false

    - name: "Attribution des permissions s√©curis√©es au r√©pertoire temporaire"
      ansible.builtin.file:
        path: "{{ redis_temp_dir.path }}"
        mode: '0700'
        owner: "{{ ansible_user | default('root') }}"
      changed_when: false

  rescue:
    - name: "‚ùå √âchec de la pr√©paration de l'environnement"
      ansible.builtin.fail:
        msg: "√âchec lors de la pr√©paration de l'environnement Redis: {{ ansible_failed_result.msg | default('Erreur inconnue') }}"

  tags:
    - preparation
    - environment
    - redis

# =========================================================================
# G√âN√âRATION DES TEMPLATES KUBERNETES
# =========================================================================
- name: "üìù G√©n√©ration des templates Kubernetes Redis"
  block:
    - name: "G√©n√©ration des fichiers de configuration Kubernetes"
      ansible.builtin.template:
        src: "{{ item.src }}"
        dest: "{{ redis_temp_dir.path }}/{{ item.dest }}"
        mode: '0600'
        backup: false
      loop:
        - { src: "statefulset.yml.j2", dest: "statefulset.yml" }
        - { src: "service.yml.j2", dest: "service.yml" }
        - { src: "configmap.yml.j2", dest: "configmap.yml" }
        - { src: "serviceaccount.yml.j2", dest: "serviceaccount.yml" }
        - { src: "persistentvolumeclaim.yml.j2", dest: "persistentvolumeclaim.yml" }
        - { src: "servicemonitor.yml.j2", dest: "servicemonitor.yml" }
      register: redis_templates_generated

    - name: "Validation de la g√©n√©ration des templates"
      ansible.builtin.stat:
        path: "{{ redis_temp_dir.path }}/{{ item }}"
      loop:
        - "statefulset.yml"
        - "service.yml"
        - "configmap.yml"
        - "serviceaccount.yml"
        - "persistentvolumeclaim.yml"
        - "servicemonitor.yml"
      register: redis_files_validation
      failed_when: not item.stat.exists

    - name: "‚úÖ Confirmation de la g√©n√©ration des templates"
      ansible.builtin.debug:
        msg: "Tous les templates Kubernetes Redis ont √©t√© g√©n√©r√©s avec succ√®s"
      when: redis_files_validation is succeeded

  rescue:
    - name: "‚ùå √âchec de la g√©n√©ration des templates"
      ansible.builtin.fail:
        msg: "√âchec lors de la g√©n√©ration des templates Redis: {{ ansible_failed_result.msg | default('Erreur inconnue') }}"

  tags:
    - templates
    - kubernetes
    - redis

# =========================================================================
# GESTION DES SECRETS REDIS
# =========================================================================
- name: "üîê Gestion des secrets Redis"
  block:
    - name: "V√©rification de l'existence du secret Redis"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Secret
        namespace: "{{ lions_redis_namespace }}"
        name: "{{ lions_redis_service_name }}-auth"
      register: redis_secret_info
      failed_when: false

    - name: "G√©n√©ration d'un mot de passe s√©curis√© pour Redis"
      ansible.builtin.set_fact:
        redis_generated_password: "{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}"
      when:
        - redis_secret_info.resources | length == 0
        - lions_environment in ['development', 'staging']
      no_log: true

    - name: "Cr√©ation du secret Redis pour les environnements de d√©veloppement"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ lions_redis_service_name }}-auth"
            namespace: "{{ lions_redis_namespace }}"
            labels:
              app.kubernetes.io/name: redis
              app.kubernetes.io/component: auth
              app.kubernetes.io/part-of: lions-infrastructure
              app.kubernetes.io/managed-by: ansible
              environment: "{{ lions_environment }}"
              lions.dev/secret-type: auth
            annotations:
              description: "Secret d'authentification pour Redis"
              lions.dev/managed-by: "lions-infrastructure-5.0"
              lions.dev/created-date: "{{ ansible_date_time.iso8601 }}"
              lions.dev/rotation-required: "true"
          type: Opaque
          stringData:
            password: "{{ redis_generated_password }}"
            username: "default"
      when:
        - redis_secret_info.resources | length == 0
        - lions_environment in ['development', 'staging']
        - redis_generated_password is defined
      register: redis_secret_creation
      no_log: true

    - name: "‚ö†Ô∏è Avertissement pour l'environnement de production"
      ansible.builtin.debug:
        msg: |
          ‚ö†Ô∏è  ATTENTION - ENVIRONNEMENT DE PRODUCTION ‚ö†Ô∏è
          Le secret Redis doit √™tre cr√©√© manuellement avec HashiCorp Vault ou votre gestionnaire de secrets.
          Nom du secret requis: {{ lions_redis_service_name }}-auth
          Namespace: {{ lions_redis_namespace }}
          Cl√©s requises: password, username
      when:
        - redis_secret_info.resources | length == 0
        - lions_environment == 'production'

    - name: "√âchec en production si le secret n'existe pas"
      ansible.builtin.fail:
        msg: |
          ‚ùå SECRET REDIS MANQUANT EN PRODUCTION
          Le secret '{{ lions_redis_service_name }}-auth' doit exister dans le namespace '{{ lions_redis_namespace }}'.
          Veuillez cr√©er ce secret via HashiCorp Vault ou votre gestionnaire de secrets.
      when:
        - redis_secret_info.resources | length == 0
        - lions_environment == 'production'

    - name: "‚úÖ Confirmation de la disponibilit√© du secret"
      ansible.builtin.debug:
        msg: "Secret Redis disponible: {{ lions_redis_service_name }}-auth"
      when: redis_secret_info.resources | length > 0 or redis_secret_creation is succeeded

  rescue:
    - name: "‚ùå √âchec de la gestion des secrets"
      ansible.builtin.fail:
        msg: "√âchec lors de la gestion des secrets Redis: {{ ansible_failed_result.msg | default('Erreur inconnue') }}"

  tags:
    - secrets
    - security
    - redis

# =========================================================================
# CR√âATION DES RESSOURCES FONDAMENTALES
# =========================================================================
- name: "üèóÔ∏è Cr√©ation des ressources fondamentales Redis"
  block:
    - name: "Cr√©ation du ServiceAccount Redis"
      kubernetes.core.k8s:
        state: present
        src: "{{ redis_temp_dir.path }}/serviceaccount.yml"
        wait: true
        wait_condition:
          type: "Ready"
          status: "True"
        wait_timeout: 60
      register: redis_serviceaccount_result

    - name: "Cr√©ation du ConfigMap Redis"
      kubernetes.core.k8s:
        state: present
        src: "{{ redis_temp_dir.path }}/configmap.yml"
        wait: true
        wait_timeout: 60
      register: redis_configmap_result

    - name: "Validation de la cr√©ation du ConfigMap"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: ConfigMap
        namespace: "{{ lions_redis_namespace }}"
        name: "{{ lions_redis_service_name }}-config"
      register: redis_configmap_validation
      failed_when: redis_configmap_validation.resources | length == 0

    - name: "‚úÖ Confirmation de la cr√©ation des ressources fondamentales"
      ansible.builtin.debug:
        msg: |
          Ressources fondamentales Redis cr√©√©es avec succ√®s:
          - ServiceAccount: {{ lions_redis_service_name }}
          - ConfigMap: {{ lions_redis_service_name }}-config
          - Namespace: {{ lions_redis_namespace }}

  rescue:
    - name: "‚ùå √âchec de la cr√©ation des ressources fondamentales"
      ansible.builtin.fail:
        msg: "√âchec lors de la cr√©ation des ressources fondamentales Redis: {{ ansible_failed_result.msg | default('Erreur inconnue') }}"

  tags:
    - resources
    - kubernetes
    - redis

# =========================================================================
# V√âRIFICATIONS FINALES ET NETTOYAGE
# =========================================================================
- name: "üßπ V√©rifications finales et nettoyage"
  block:
    - name: "V√©rification de l'√©tat du cluster Kubernetes"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: cluster_nodes
      failed_when: cluster_nodes.resources | length == 0

    - name: "Validation de la connectivit√© au namespace Redis"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ lions_redis_namespace }}"
      register: final_namespace_check
      failed_when: final_namespace_check.resources | length == 0

    - name: "Stockage des informations de d√©ploiement"
      ansible.builtin.set_fact:
        redis_preparation_info:
          namespace: "{{ lions_redis_namespace }}"
          service_name: "{{ lions_redis_service_name }}"
          version: "{{ lions_redis_version }}"
          storage_size: "{{ lions_redis_storage_size }}"
          secret_name: "{{ lions_redis_service_name }}-auth"
          temp_directory: "{{ redis_temp_dir.path }}"
          preparation_time: "{{ ansible_date_time.iso8601 }}"

    - name: "‚úÖ Pr√©paration Redis termin√©e avec succ√®s"
      ansible.builtin.debug:
        msg: |
          üéâ PR√âPARATION REDIS TERMIN√âE AVEC SUCC√àS
          
          üìä Informations de d√©ploiement:
          - Environnement: {{ lions_environment }}
          - Namespace: {{ lions_redis_namespace }}
          - Service: {{ lions_redis_service_name }}
          - Version: {{ lions_redis_version }}
          - Stockage: {{ lions_redis_storage_size }}
          
          üîß Pr√™t pour le d√©ploiement de Redis

  rescue:
    - name: "‚ùå √âchec des v√©rifications finales"
      ansible.builtin.debug:
        msg: "Avertissement: Certaines v√©rifications finales ont √©chou√©, mais la pr√©paration peut continuer"

  always:
    - name: "Nettoyage du r√©pertoire temporaire (optionnel)"
      ansible.builtin.file:
        path: "{{ redis_temp_dir.path }}"
        state: absent
      when:
        - redis_temp_dir is defined
        - lions_debug_mode | default(false) | bool == false
      changed_when: false

  tags:
    - validation
    - cleanup
    - redis

# =========================================================================
# RAPPORT DE PR√âPARATION
# =========================================================================
- name: "üìã G√©n√©ration du rapport de pr√©paration Redis"
  ansible.builtin.debug:
    var: redis_preparation_info
  when: redis_preparation_info is defined
  tags:
    - report
    - redis