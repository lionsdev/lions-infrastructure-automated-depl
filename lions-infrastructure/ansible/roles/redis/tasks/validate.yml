---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - VALIDATION REDIS
# =========================================================================
# Description: Validation post-d√©ploiement compl√®te pour Redis
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: 2025-05-27
# Documentation: https://docs.lions.dev/infrastructure/redis/validation
# =========================================================================

# =========================================================================
# VARIABLES ET PR√âREQUIS
# =========================================================================
- name: "{{ lions_log_prefix }} Initialisation des variables de validation Redis"
  set_fact:
    redis_validation_start_time: "{{ ansible_date_time.epoch }}"
    redis_validation_errors: []
    redis_validation_warnings: []
    redis_validation_success: true
    redis_validation_report: {}
  tags:
    - redis
    - validation
    - health-check

- name: "{{ lions_log_prefix }} V√©rification des variables d'environnement requises"
  assert:
    that:
      - lions_redis_namespace is defined
      - lions_redis_service_name is defined
      - lions_redis_version is defined
      - lions_environment is defined
    fail_msg: "Variables d'environnement Redis manquantes - v√©rifiez la configuration"
    success_msg: "Variables d'environnement Redis valid√©es"
  tags:
    - redis
    - validation
    - prerequisites

# =========================================================================
# VALIDATION DE L'√âTAT DES RESSOURCES KUBERNETES
# =========================================================================
- name: "{{ lions_log_prefix }} V√©rification de l'existence du namespace Redis"
  k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ lions_redis_namespace }}"
  register: redis_namespace_check
  failed_when: redis_namespace_check.resources | length == 0
  tags:
    - redis
    - validation
    - namespace

- name: "{{ lions_log_prefix }} V√©rification de l'√©tat des pods Redis"
  k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ lions_redis_namespace }}"
    label_selectors:
      - "app={{ lions_redis_service_name }}"
      - "environment={{ lions_environment }}"
  register: redis_pods_status
  until: >
    redis_pods_status.resources | length > 0 and
    redis_pods_status.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
  retries: "{{ (lions_timeout_deployment | int / 30) | round | int }}"
  delay: 30
  tags:
    - redis
    - validation
    - pods

- name: "{{ lions_log_prefix }} Analyse d√©taill√©e des pods Redis"
  set_fact:
    redis_pods_running: "{{ redis_pods_status.resources | selectattr('status.phase', 'equalto', 'Running') | list | length }}"
    redis_pods_total: "{{ redis_pods_status.resources | length }}"
    redis_pods_details: "{{ redis_pods_status.resources | map(attribute='metadata.name') | list }}"
  tags:
    - redis
    - validation
    - analysis

- name: "{{ lions_log_prefix }} Validation du nombre de r√©plicas Redis"
  assert:
    that:
      - redis_pods_running | int >= 1
      - redis_pods_running | int == redis_pods_total | int
    fail_msg: "Pods Redis non disponibles - {{ redis_pods_running }}/{{ redis_pods_total }} en cours d'ex√©cution"
    success_msg: "Tous les pods Redis sont op√©rationnels ({{ redis_pods_running }}/{{ redis_pods_total }})"
  tags:
    - redis
    - validation
    - replicas

# =========================================================================
# VALIDATION DES SERVICES KUBERNETES
# =========================================================================
- name: "{{ lions_log_prefix }} V√©rification de l'√©tat du service Redis"
  k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ lions_redis_namespace }}"
    name: "{{ lions_redis_service_name }}"
  register: redis_service_status
  failed_when: redis_service_status.resources | length == 0
  tags:
    - redis
    - validation
    - service

- name: "{{ lions_log_prefix }} Validation des endpoints du service Redis"
  k8s_info:
    api_version: v1
    kind: Endpoints
    namespace: "{{ lions_redis_namespace }}"
    name: "{{ lions_redis_service_name }}"
  register: redis_endpoints_status
  tags:
    - redis
    - validation
    - endpoints

- name: "{{ lions_log_prefix }} V√©rification de la disponibilit√© des endpoints"
  assert:
    that:
      - redis_endpoints_status.resources | length > 0
      - redis_endpoints_status.resources[0].subsets is defined
      - redis_endpoints_status.resources[0].subsets | length > 0
    fail_msg: "Aucun endpoint disponible pour le service Redis"
    success_msg: "Endpoints Redis disponibles et configur√©s"
  tags:
    - redis
    - validation
    - endpoints

# =========================================================================
# VALIDATION DE LA CONNECTIVIT√â REDIS
# =========================================================================
- name: "{{ lions_log_prefix }} Test de connectivit√© Redis (PING)"
  kubernetes.core.k8s_exec:
    namespace: "{{ lions_redis_namespace }}"
    pod: "{{ redis_pods_details[0] }}"
    command: |
      timeout 10 redis-cli -h localhost -p {{ lions_redis_port }} ping
  register: redis_ping_test
  retries: 3
  delay: 5
  until: redis_ping_test.stdout is defined and "PONG" in redis_ping_test.stdout
  tags:
    - redis
    - validation
    - connectivity

- name: "{{ lions_log_prefix }} Validation de la connectivit√© Redis"
  set_fact:
    redis_connectivity_ok: "{{ redis_ping_test.stdout is defined and 'PONG' in redis_ping_test.stdout }}"
  tags:
    - redis
    - validation
    - connectivity

# =========================================================================
# VALIDATION DE LA CONFIGURATION REDIS
# =========================================================================
- name: "{{ lions_log_prefix }} R√©cup√©ration des informations de configuration Redis"
  kubernetes.core.k8s_exec:
    namespace: "{{ lions_redis_namespace }}"
    pod: "{{ redis_pods_details[0] }}"
    command: |
      timeout 10 redis-cli -h localhost -p {{ lions_redis_port }} INFO server
  register: redis_info_server
  ignore_errors: true
  tags:
    - redis
    - validation
    - configuration

- name: "{{ lions_log_prefix }} V√©rification de la version Redis"
  set_fact:
    redis_version_deployed: "{{ redis_info_server.stdout | regex_search('redis_version:([0-9.]+)', '\\1') | first if redis_info_server.stdout is defined else 'unknown' }}"
    redis_config_ok: "{{ redis_info_server.rc == 0 if redis_info_server.rc is defined else false }}"
  tags:
    - redis
    - validation
    - version

- name: "{{ lions_log_prefix }} Validation de la version Redis d√©ploy√©e"
  debug:
    msg: |
      Version Redis attendue: {{ lions_redis_version }}
      Version Redis d√©ploy√©e: {{ redis_version_deployed }}
      √âtat de la configuration: {{ 'OK' if redis_config_ok else 'ERREUR' }}
  tags:
    - redis
    - validation
    - version

# =========================================================================
# VALIDATION DU STOCKAGE PERSISTANT
# =========================================================================
- name: "{{ lions_log_prefix }} V√©rification du stockage persistant Redis"
  kubernetes.core.k8s_exec:
    namespace: "{{ lions_redis_namespace }}"
    pod: "{{ redis_pods_details[0] }}"
    command: |
      timeout 10 redis-cli -h localhost -p {{ lions_redis_port }} CONFIG GET dir
  register: redis_storage_dir
  ignore_errors: true
  when: lions_redis_storage_size is defined and lions_redis_storage_size != "0"
  tags:
    - redis
    - validation
    - storage

- name: "{{ lions_log_prefix }} Test d'√©criture/lecture sur le stockage persistant"
  kubernetes.core.k8s_exec:
    namespace: "{{ lions_redis_namespace }}"
    pod: "{{ redis_pods_details[0] }}"
    command: |
      timeout 10 bash -c '
        redis-cli -h localhost -p {{ lions_redis_port }} SET lions:test:validation "$(date)" &&
        redis-cli -h localhost -p {{ lions_redis_port }} GET lions:test:validation &&
        redis-cli -h localhost -p {{ lions_redis_port }} DEL lions:test:validation
      '
  register: redis_storage_test
  ignore_errors: true
  when: lions_redis_storage_size is defined and lions_redis_storage_size != "0"
  tags:
    - redis
    - validation
    - storage

# =========================================================================
# VALIDATION DU MONITORING ET DES M√âTRIQUES
# =========================================================================
- name: "{{ lions_log_prefix }} V√©rification du ServiceMonitor Prometheus"
  k8s_info:
    api_version: monitoring.coreos.com/v1
    kind: ServiceMonitor
    namespace: "{{ lions_redis_namespace }}"
    name: "{{ lions_redis_service_name }}-monitor"
  register: redis_servicemonitor_status
  ignore_errors: true
  when: lions_monitoring_enabled | default(true) | bool
  tags:
    - redis
    - validation
    - monitoring

- name: "{{ lions_log_prefix }} Test des m√©triques Prometheus Redis"
  kubernetes.core.k8s_exec:
    namespace: "{{ lions_redis_namespace }}"
    pod: "{{ redis_pods_details[0] }}"
    command: |
      timeout 10 curl -s http://localhost:9121/metrics | head -20
  register: redis_metrics_test
  ignore_errors: true
  when: lions_monitoring_enabled | default(true) | bool
  tags:
    - redis
    - validation
    - metrics

# =========================================================================
# VALIDATION DES PERFORMANCES
# =========================================================================
- name: "{{ lions_log_prefix }} V√©rification des ressources utilis√©es par Redis"
  shell: |
    kubectl top pod -n {{ lions_redis_namespace }} {{ redis_pods_details[0] }} --no-headers 2>/dev/null || echo "N/A N/A"
  register: redis_resources_usage
  ignore_errors: true
  changed_when: false
  tags:
    - redis
    - validation
    - performance

- name: "{{ lions_log_prefix }} Test de performance basique Redis"
  kubernetes.core.k8s_exec:
    namespace: "{{ lions_redis_namespace }}"
    pod: "{{ redis_pods_details[0] }}"
    command: |
      timeout 30 redis-cli -h localhost -p {{ lions_redis_port }} --latency-history -i 1 | head -5
  register: redis_performance_test
  ignore_errors: true
  tags:
    - redis
    - validation
    - performance

# =========================================================================
# VALIDATION DE LA HAUTE DISPONIBILIT√â (SI ACTIV√âE)
# =========================================================================
- name: "{{ lions_log_prefix }} V√©rification de la configuration HA Redis"
  kubernetes.core.k8s_exec:
    namespace: "{{ lions_redis_namespace }}"
    pod: "{{ redis_pods_details[0] }}"
    command: |
      timeout 10 redis-cli -h localhost -p {{ lions_redis_port }} INFO replication
  register: redis_ha_status
  ignore_errors: true
  when:
    - lions_deployment_mode is defined
    - lions_deployment_mode in ['cluster', 'ha']
  tags:
    - redis
    - validation
    - ha

# =========================================================================
# COMPILATION DU RAPPORT DE VALIDATION
# =========================================================================
- name: "{{ lions_log_prefix }} Compilation du rapport de validation Redis"
  set_fact:
    redis_validation_report:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      environment: "{{ lions_environment }}"
      namespace: "{{ lions_redis_namespace }}"
      service_name: "{{ lions_redis_service_name }}"
      version_expected: "{{ lions_redis_version }}"
      version_deployed: "{{ redis_version_deployed }}"
      validation_duration: "{{ (ansible_date_time.epoch | int) - (redis_validation_start_time | int) }}"
      pods:
        total: "{{ redis_pods_total }}"
        running: "{{ redis_pods_running }}"
        names: "{{ redis_pods_details }}"
      connectivity:
        status: "{{ 'OK' if redis_connectivity_ok else 'FAILED' }}"
        ping_response: "{{ redis_ping_test.stdout | default('N/A') }}"
      service:
        available: "{{ redis_service_status.resources | length > 0 }}"
        endpoints: "{{ redis_endpoints_status.resources[0].subsets | length if redis_endpoints_status.resources | length > 0 else 0 }}"
      storage:
        enabled: "{{ lions_redis_storage_size is defined and lions_redis_storage_size != '0' }}"
        test_result: "{{ 'OK' if redis_storage_test.rc is defined and redis_storage_test.rc == 0 else 'N/A' }}"
      monitoring:
        enabled: "{{ lions_monitoring_enabled | default(true) | bool }}"
        servicemonitor: "{{ redis_servicemonitor_status.resources | length > 0 if redis_servicemonitor_status.resources is defined else false }}"
        metrics_available: "{{ 'OK' if redis_metrics_test.rc is defined and redis_metrics_test.rc == 0 else 'N/A' }}"
      performance:
        resources_usage: "{{ redis_resources_usage.stdout | default('N/A') }}"
        latency_test: "{{ 'OK' if redis_performance_test.rc is defined and redis_performance_test.rc == 0 else 'N/A' }}"
      high_availability:
        mode: "{{ lions_deployment_mode | default('single') }}"
        replication_info: "{{ 'OK' if redis_ha_status.rc is defined and redis_ha_status.rc == 0 else 'N/A' }}"
  tags:
    - redis
    - validation
    - reporting

# =========================================================================
# D√âTERMINATION DU STATUT FINAL
# =========================================================================
- name: "{{ lions_log_prefix }} √âvaluation du statut final de validation"
  set_fact:
    redis_validation_success: "{{
      redis_connectivity_ok and
      redis_pods_running | int > 0 and
      redis_pods_running | int == redis_pods_total | int and
      redis_service_status.resources | length > 0 and
      redis_config_ok
    }}"
  tags:
    - redis
    - validation
    - final-status

# =========================================================================
# AFFICHAGE DU RAPPORT FINAL
# =========================================================================
- name: "{{ lions_log_prefix }} Affichage du rapport de validation Redis"
  debug:
    msg: |
      =========================================================================
      üîç RAPPORT DE VALIDATION REDIS - LIONS INFRASTRUCTURE 5.0
      =========================================================================
      üìä Informations g√©n√©rales:
        ‚Ä¢ Environnement: {{ redis_validation_report.environment }}
        ‚Ä¢ Namespace: {{ redis_validation_report.namespace }}
        ‚Ä¢ Service: {{ redis_validation_report.service_name }}
        ‚Ä¢ Version attendue: {{ redis_validation_report.version_expected }}
        ‚Ä¢ Version d√©ploy√©e: {{ redis_validation_report.version_deployed }}
        ‚Ä¢ Dur√©e de validation: {{ redis_validation_report.validation_duration }}s
      
      üöÄ √âtat des Pods:
        ‚Ä¢ Total: {{ redis_validation_report.pods.total }}
        ‚Ä¢ En cours d'ex√©cution: {{ redis_validation_report.pods.running }}
        ‚Ä¢ Noms: {{ redis_validation_report.pods.names | join(', ') }}
      
      üåê Connectivit√©:
        ‚Ä¢ Statut: {{ redis_validation_report.connectivity.status }}
        ‚Ä¢ R√©ponse PING: {{ redis_validation_report.connectivity.ping_response }}
      
      ‚öôÔ∏è Service Kubernetes:
        ‚Ä¢ Disponible: {{ 'Oui' if redis_validation_report.service.available else 'Non' }}
        ‚Ä¢ Endpoints: {{ redis_validation_report.service.endpoints }}
      
      üíæ Stockage:
        ‚Ä¢ Persistant: {{ 'Oui' if redis_validation_report.storage.enabled else 'Non' }}
        ‚Ä¢ Test E/L: {{ redis_validation_report.storage.test_result }}
      
      üìà Monitoring:
        ‚Ä¢ Activ√©: {{ 'Oui' if redis_validation_report.monitoring.enabled else 'Non' }}
        ‚Ä¢ ServiceMonitor: {{ 'Oui' if redis_validation_report.monitoring.servicemonitor else 'Non' }}
        ‚Ä¢ M√©triques: {{ redis_validation_report.monitoring.metrics_available }}
      
      ‚ö° Performance:
        ‚Ä¢ Utilisation: {{ redis_validation_report.performance.resources_usage }}
        ‚Ä¢ Test latence: {{ redis_validation_report.performance.latency_test }}
      
      üèóÔ∏è Haute Disponibilit√©:
        ‚Ä¢ Mode: {{ redis_validation_report.high_availability.mode }}
        ‚Ä¢ R√©plication: {{ redis_validation_report.high_availability.replication_info }}
      
      =========================================================================
      üéØ STATUT FINAL: {{ '‚úÖ SUCC√àS' if redis_validation_success else '‚ùå √âCHEC' }}
      =========================================================================
      ‚è∞ Validation termin√©e le: {{ redis_validation_report.timestamp }}
      =========================================================================
  tags:
    - redis
    - validation
    - reporting

# =========================================================================
# SAUVEGARDE DU RAPPORT (SI ACTIV√âE)
# =========================================================================
- name: "{{ lions_log_prefix }} Sauvegarde du rapport de validation"
  copy:
    content: "{{ redis_validation_report | to_nice_json }}"
    dest: "/tmp/lions-redis-validation-{{ ansible_date_time.epoch }}.json"
    mode: '0644'
  when: lions_debug_mode | default(false) | bool
  tags:
    - redis
    - validation
    - reporting

# =========================================================================
# GESTION DES √âCHECS
# =========================================================================
- name: "{{ lions_log_prefix }} √âchec de la validation Redis"
  fail:
    msg: |
      ‚ùå La validation du d√©ploiement Redis a √©chou√© !
      
      Probl√®mes d√©tect√©s:
      ‚Ä¢ Connectivit√©: {{ 'OK' if redis_connectivity_ok else '√âCHEC' }}
      ‚Ä¢ Pods: {{ redis_pods_running }}/{{ redis_pods_total }} op√©rationnels
      ‚Ä¢ Service: {{ 'OK' if redis_service_status.resources | length > 0 else '√âCHEC' }}
      ‚Ä¢ Configuration: {{ 'OK' if redis_config_ok else '√âCHEC' }}
      
      Consultez les logs pour plus de d√©tails:
      kubectl logs -n {{ redis_validation_report.namespace }} -l app={{ redis_validation_report.service_name }} --tail=100
      
      Rapport d√©taill√© sauvegard√© dans: /tmp/lions-redis-validation-{{ ansible_date_time.epoch }}.json
  when: not redis_validation_success
  tags:
    - redis
    - validation
    - failure

# =========================================================================
# NOTIFICATION DE SUCC√àS
# =========================================================================
- name: "{{ lions_log_prefix }} Validation Redis r√©ussie"
  debug:
    msg: |
      ‚úÖ Validation Redis termin√©e avec succ√®s !
      
      Redis est pleinement op√©rationnel dans l'environnement {{ lions_environment }}.
      Tous les tests de validation ont √©t√© pass√©s avec succ√®s.
      
      Prochaines √©tapes recommand√©es:
      1. V√©rifier les m√©triques dans Grafana
      2. Configurer les alertes Prometheus
      3. Planifier les sauvegardes r√©guli√®res
  when: redis_validation_success
  tags:
    - redis
    - validation
    - success