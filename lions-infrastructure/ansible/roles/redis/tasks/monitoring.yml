---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - REDIS MONITORING CONFIGURATION
# =========================================================================
# Description: Configuration du monitoring pour Redis avec Prometheus/Grafana
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Documentation: https://docs.lions.dev/infrastructure/monitoring/redis
# =========================================================================

# =========================================================================
# INITIALISATION ET VALIDATION
# =========================================================================
- name: "ğŸ” [MONITORING] Validation de la configuration du monitoring Redis"
  assert:
    that:
      - lions_monitoring_enabled is defined
      - lions_redis_monitoring_enabled is defined
      - app_namespace is defined
      - app_name is defined
    fail_msg: "âŒ Variables de monitoring Redis manquantes. VÃ©rifiez la configuration."
    success_msg: "âœ… Configuration du monitoring Redis validÃ©e"
  tags:
    - monitoring
    - validation

- name: "ğŸ“Š [MONITORING] Affichage de la configuration du monitoring Redis"
  debug:
    msg:
      - "ğŸ”§ Monitoring global: {{ lions_monitoring_enabled | default('false') }}"
      - "ğŸ“ˆ Monitoring Redis: {{ lions_redis_monitoring_enabled | default('true') }}"
      - "ğŸ·ï¸  Namespace: {{ app_namespace }}"
      - "ğŸ“› Service: {{ app_name }}"
      - "ğŸ¯ Prometheus scraping: {{ lions_redis_prometheus_scrape | default('true') }}"
  when: lions_debug_mode | default(false) | bool
  tags:
    - monitoring
    - debug

# =========================================================================
# VÃ‰RIFICATION DES PRÃ‰REQUIS PROMETHEUS
# =========================================================================
- name: "ğŸ” [PROMETHEUS] VÃ©rification de l'installation de Prometheus Operator"
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: servicemonitors.monitoring.coreos.com
  register: lions_prometheus_operator_check
  failed_when: false
  tags:
    - monitoring
    - prometheus
    - validation

- name: "ğŸ“Š [PROMETHEUS] Statut de Prometheus Operator"
  set_fact:
    lions_prometheus_available: "{{ lions_prometheus_operator_check.resources | default([]) | length > 0 }}"
  tags:
    - monitoring
    - prometheus

- name: "âš ï¸  [PROMETHEUS] Avertissement - Prometheus Operator non disponible"
  debug:
    msg:
      - "âŒ Prometheus Operator n'est pas installÃ© ou inaccessible"
      - "ğŸ”§ Le monitoring Redis via ServiceMonitor ne sera pas configurÃ©"
      - "ğŸ’¡ Installez Prometheus Operator pour activer le monitoring"
  when: not lions_prometheus_available
  tags:
    - monitoring
    - prometheus

- name: "âœ… [PROMETHEUS] Prometheus Operator dÃ©tectÃ©"
  debug:
    msg: "ğŸ¯ Prometheus Operator disponible - Configuration du monitoring Redis"
  when:
    - lions_prometheus_available
    - lions_debug_mode | default(false) | bool
  tags:
    - monitoring
    - prometheus

# =========================================================================
# VÃ‰RIFICATION DES PRÃ‰REQUIS GRAFANA
# =========================================================================
- name: "ğŸ” [GRAFANA] VÃ©rification de l'installation de Grafana"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"
    name: "{{ lions_grafana_service_name | default('grafana') }}"
  register: lions_grafana_check
  failed_when: false
  tags:
    - monitoring
    - grafana
    - validation

- name: "ğŸ“Š [GRAFANA] Statut de Grafana"
  set_fact:
    lions_grafana_available: "{{ lions_grafana_check.resources | default([]) | length > 0 }}"
  tags:
    - monitoring
    - grafana

- name: "âš ï¸  [GRAFANA] Avertissement - Grafana non disponible"
  debug:
    msg:
      - "âŒ Grafana n'est pas installÃ© ou inaccessible"
      - "ğŸ“Š Les dashboards Redis ne seront pas configurÃ©s"
      - "ğŸ’¡ Installez Grafana pour activer les dashboards"
  when: not lions_grafana_available
  tags:
    - monitoring
    - grafana

# =========================================================================
# CONFIGURATION DU SERVICEMONITOR PROMETHEUS
# =========================================================================
- name: "ğŸ¯ [SERVICEMONITOR] GÃ©nÃ©ration du ServiceMonitor Redis"
  template:
    src: servicemonitor.yml.j2
    dest: "{{ temp_dir.path }}/redis-servicemonitor.yml"
    mode: '0644'
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - servicemonitor

- name: "ğŸš€ [SERVICEMONITOR] DÃ©ploiement du ServiceMonitor Redis"
  kubernetes.core.k8s:
    state: present
    src: "{{ temp_dir.path }}/redis-servicemonitor.yml"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_redis_servicemonitor_result
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - servicemonitor

- name: "âœ… [SERVICEMONITOR] VÃ©rification du dÃ©ploiement du ServiceMonitor"
  kubernetes.core.k8s_info:
    api_version: monitoring.coreos.com/v1
    kind: ServiceMonitor
    namespace: "{{ app_namespace }}"
    name: "{{ app_name }}-{{ lions_redis_service_name | default('redis') }}"
  register: lions_redis_servicemonitor_check
  failed_when: false
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - validation

- name: "ğŸ‰ [SERVICEMONITOR] ServiceMonitor Redis configurÃ© avec succÃ¨s"
  debug:
    msg:
      - "âœ… ServiceMonitor '{{ app_name }}-{{ lions_redis_service_name | default('redis') }}' crÃ©Ã©"
      - "ğŸ“ Namespace: {{ app_namespace }}"
      - "ğŸ¯ Prometheus va scraper les mÃ©triques Redis"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
    - lions_redis_servicemonitor_check.resources | default([]) | length > 0
  tags:
    - monitoring
    - prometheus

- name: "âŒ [SERVICEMONITOR] Erreur lors de la crÃ©ation du ServiceMonitor"
  debug:
    msg:
      - "âš ï¸  Le ServiceMonitor Redis n'a pas pu Ãªtre crÃ©Ã©"
      - "ğŸ” VÃ©rifiez les logs et les permissions RBAC"
      - "ğŸ“ Namespace: {{ app_namespace }}"
      - "ğŸ·ï¸  Nom: {{ app_name }}-{{ lions_redis_service_name | default('redis') }}"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
    - lions_redis_servicemonitor_check.resources | default([]) | length == 0
  tags:
    - monitoring
    - prometheus

# =========================================================================
# CONFIGURATION DES DASHBOARDS GRAFANA
# =========================================================================
- name: "ğŸ“Š [DASHBOARD] GÃ©nÃ©ration du dashboard Grafana Redis"
  template:
    src: grafana-dashboard.json.j2
    dest: "{{ temp_dir.path }}/redis-dashboard.json"
    mode: '0644'
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
  tags:
    - monitoring
    - grafana
    - dashboard

- name: "ğŸ¨ [DASHBOARD] CrÃ©ation du ConfigMap pour le dashboard Redis"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "{{ app_name }}-{{ lions_redis_service_name | default('redis') }}-dashboard"
        namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"
        labels:
          app: "{{ app_name }}"
          component: "{{ lions_redis_service_name | default('redis') }}"
          app.kubernetes.io/name: "{{ app_name }}"
          app.kubernetes.io/component: monitoring
          app.kubernetes.io/part-of: lions-infrastructure
          app.kubernetes.io/version: "{{ lions_config_version | default('5.0.0') }}"
          grafana_dashboard: "1"
          lions.dev/service: redis
          lions.dev/monitoring: enabled
          lions.dev/environment: "{{ lions_environment | default('development') }}"
        annotations:
          lions.dev/description: "Dashboard Grafana pour le monitoring Redis"
          lions.dev/documentation: "https://docs.lions.dev/monitoring/redis"
      data:
        redis-dashboard.json: "{{ lookup('file', temp_dir.path + '/redis-dashboard.json') }}"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_redis_dashboard_result
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
  tags:
    - monitoring
    - grafana
    - dashboard

- name: "âœ… [DASHBOARD] VÃ©rification du dashboard Grafana"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"
    name: "{{ app_name }}-{{ lions_redis_service_name | default('redis') }}-dashboard"
  register: lions_redis_dashboard_check
  failed_when: false
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
  tags:
    - monitoring
    - grafana
    - validation

- name: "ğŸ‰ [DASHBOARD] Dashboard Redis configurÃ© avec succÃ¨s"
  debug:
    msg:
      - "âœ… Dashboard '{{ app_name }}-{{ lions_redis_service_name | default('redis') }}-dashboard' crÃ©Ã©"
      - "ğŸ“ Namespace: {{ lions_monitoring_namespace | default('monitoring') }}"
      - "ğŸ¨ Dashboard disponible dans Grafana"
      - "ğŸ”— URL: {{ lions_grafana_url | default('http://grafana.' + lions_dns_full_domain) }}"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
    - lions_redis_dashboard_check.resources | default([]) | length > 0
  tags:
    - monitoring
    - grafana

- name: "âŒ [DASHBOARD] Erreur lors de la crÃ©ation du dashboard"
  debug:
    msg:
      - "âš ï¸  Le dashboard Grafana Redis n'a pas pu Ãªtre crÃ©Ã©"
      - "ğŸ” VÃ©rifiez les logs et les permissions"
      - "ğŸ“ Namespace: {{ lions_monitoring_namespace | default('monitoring') }}"
      - "ğŸ·ï¸  Nom: {{ app_name }}-{{ lions_redis_service_name | default('redis') }}-dashboard"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
    - lions_redis_dashboard_check.resources | default([]) | length == 0
  tags:
    - monitoring
    - grafana

# =========================================================================
# CONFIGURATION DES ALERTES PROMETHEUS
# =========================================================================
- name: "ğŸš¨ [ALERTES] GÃ©nÃ©ration des rÃ¨gles d'alerte Redis"
  template:
    src: alert-rules.yml.j2
    dest: "{{ temp_dir.path }}/redis-alert-rules.yml"
    mode: '0644'
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_alerts_enabled | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - alerts

- name: "ğŸ”” [ALERTES] DÃ©ploiement des rÃ¨gles d'alerte Redis"
  kubernetes.core.k8s:
    state: present
    src: "{{ temp_dir.path }}/redis-alert-rules.yml"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_redis_alerts_result
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_alerts_enabled | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - alerts

- name: "âœ… [ALERTES] RÃ¨gles d'alerte Redis configurÃ©es"
  debug:
    msg:
      - "âœ… RÃ¨gles d'alerte Redis dÃ©ployÃ©es avec succÃ¨s"
      - "ğŸš¨ Alertes actives pour les mÃ©triques critiques"
      - "ğŸ“§ Notifications configurÃ©es selon la configuration Alertmanager"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_alerts_enabled | default(true) | bool
    - lions_redis_alerts_result is succeeded
  tags:
    - monitoring
    - prometheus
    - alerts

# =========================================================================
# NETTOYAGE DES FICHIERS TEMPORAIRES
# =========================================================================
- name: "ğŸ§¹ [CLEANUP] Nettoyage des fichiers temporaires de monitoring"
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ temp_dir.path }}/redis-servicemonitor.yml"
    - "{{ temp_dir.path }}/redis-dashboard.json"
    - "{{ temp_dir.path }}/redis-alert-rules.yml"
  when: lions_cleanup_temp_files | default(true) | bool
  tags:
    - monitoring
    - cleanup

# =========================================================================
# RÃ‰SUMÃ‰ DE LA CONFIGURATION
# =========================================================================
- name: "ğŸ“‹ [RÃ‰SUMÃ‰] Configuration du monitoring Redis terminÃ©e"
  debug:
    msg:
      - "ğŸ¯ === RÃ‰SUMÃ‰ MONITORING REDIS ==="
      - "âœ… Monitoring global: {{ lions_monitoring_enabled | default(false) }}"
      - "ğŸ“ˆ Monitoring Redis: {{ lions_redis_monitoring_enabled | default(false) }}"
      - "ğŸ¯ Prometheus disponible: {{ lions_prometheus_available | default(false) }}"
      - "ğŸ“Š Grafana disponible: {{ lions_grafana_available | default(false) }}"
      - "ğŸ” ServiceMonitor: {{ 'ConfigurÃ©' if lions_prometheus_available and lions_redis_prometheus_scrape | default(true) else 'Non configurÃ©' }}"
      - "ğŸ¨ Dashboard: {{ 'ConfigurÃ©' if lions_grafana_available and lions_redis_dashboard_enabled | default(true) else 'Non configurÃ©' }}"
      - "ğŸš¨ Alertes: {{ 'ConfigurÃ©es' if lions_prometheus_available and lions_redis_alerts_enabled | default(true) else 'Non configurÃ©es' }}"
      - "ğŸ·ï¸  Service: {{ app_name }}-{{ lions_redis_service_name | default('redis') }}"
      - "ğŸ“ Namespace: {{ app_namespace }}"
      - "ğŸŒ Environnement: {{ lions_environment | default('development') }}"
  tags:
    - monitoring
    - summary