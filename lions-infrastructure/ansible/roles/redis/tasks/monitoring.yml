---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - REDIS MONITORING CONFIGURATION
# =========================================================================
# Description: Configuration du monitoring pour Redis avec Prometheus/Grafana
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Documentation: https://docs.lions.dev/infrastructure/monitoring/redis
# =========================================================================

# =========================================================================
# INITIALISATION ET VALIDATION
# =========================================================================
- name: "üîç [MONITORING] Validation de la configuration du monitoring Redis"
  assert:
    that:
      - lions_monitoring_enabled is defined
      - lions_redis_monitoring_enabled is defined
      - app_namespace is defined
      - app_name is defined
    fail_msg: "‚ùå Variables de monitoring Redis manquantes. V√©rifiez la configuration."
    success_msg: "‚úÖ Configuration du monitoring Redis valid√©e"
  tags:
    - monitoring
    - validation

- name: "üìä [MONITORING] Affichage de la configuration du monitoring Redis"
  debug:
    msg:
      - "üîß Monitoring global: {{ lions_monitoring_enabled | default('false') }}"
      - "üìà Monitoring Redis: {{ lions_redis_monitoring_enabled | default('true') }}"
      - "üè∑Ô∏è  Namespace: {{ app_namespace }}"
      - "üìõ Service: {{ app_name }}"
      - "üéØ Prometheus scraping: {{ lions_redis_prometheus_scrape | default('true') }}"
  when: lions_debug_mode | default(false) | bool
  tags:
    - monitoring
    - debug

# =========================================================================
# V√âRIFICATION DES PR√âREQUIS PROMETHEUS
# =========================================================================
- name: "üîç [PROMETHEUS] V√©rification de l'installation de Prometheus Operator"
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: servicemonitors.monitoring.coreos.com
  register: lions_prometheus_operator_check
  failed_when: false
  tags:
    - monitoring
    - prometheus
    - validation

- name: "üìä [PROMETHEUS] Statut de Prometheus Operator"
  set_fact:
    lions_prometheus_available: "{{ lions_prometheus_operator_check.resources | default([]) | length > 0 }}"
  tags:
    - monitoring
    - prometheus

- name: "‚ö†Ô∏è  [PROMETHEUS] Avertissement - Prometheus Operator non disponible"
  debug:
    msg:
      - "‚ùå Prometheus Operator n'est pas install√© ou inaccessible"
      - "üîß Le monitoring Redis via ServiceMonitor ne sera pas configur√©"
      - "üí° Installez Prometheus Operator pour activer le monitoring"
  when: not lions_prometheus_available
  tags:
    - monitoring
    - prometheus

- name: "‚úÖ [PROMETHEUS] Prometheus Operator d√©tect√©"
  debug:
    msg: "üéØ Prometheus Operator disponible - Configuration du monitoring Redis"
  when:
    - lions_prometheus_available
    - lions_debug_mode | default(false) | bool
  tags:
    - monitoring
    - prometheus

# =========================================================================
# V√âRIFICATION DES PR√âREQUIS GRAFANA
# =========================================================================
- name: "üîç [GRAFANA] V√©rification de l'installation de Grafana"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"
    name: "{{ lions_grafana_service_name | default('grafana') }}"
  register: lions_grafana_check
  failed_when: false
  tags:
    - monitoring
    - grafana
    - validation

- name: "üìä [GRAFANA] Statut de Grafana"
  set_fact:
    lions_grafana_available: "{{ lions_grafana_check.resources | default([]) | length > 0 }}"
  tags:
    - monitoring
    - grafana

- name: "‚ö†Ô∏è  [GRAFANA] Avertissement - Grafana non disponible"
  debug:
    msg:
      - "‚ùå Grafana n'est pas install√© ou inaccessible"
      - "üìä Les dashboards Redis ne seront pas configur√©s"
      - "üí° Installez Grafana pour activer les dashboards"
  when: not lions_grafana_available
  tags:
    - monitoring
    - grafana

# =========================================================================
# CONFIGURATION DU SERVICEMONITOR PROMETHEUS
# =========================================================================
- name: "üéØ [SERVICEMONITOR] G√©n√©ration du ServiceMonitor Redis"
  template:
    src: servicemonitor.yml.j2
    dest: "{{ temp_dir.path }}/redis-servicemonitor.yml"
    mode: '0644'
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - servicemonitor

- name: "üöÄ [SERVICEMONITOR] D√©ploiement du ServiceMonitor Redis"
  kubernetes.core.k8s:
    state: present
    src: "{{ temp_dir.path }}/redis-servicemonitor.yml"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_redis_servicemonitor_result
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - servicemonitor

- name: "‚úÖ [SERVICEMONITOR] V√©rification du d√©ploiement du ServiceMonitor"
  kubernetes.core.k8s_info:
    api_version: monitoring.coreos.com/v1
    kind: ServiceMonitor
    namespace: "{{ app_namespace }}"
    name: "{{ app_name }}-{{ lions_redis_service_name | default('redis') }}"
  register: lions_redis_servicemonitor_check
  failed_when: false
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - validation

- name: "üéâ [SERVICEMONITOR] ServiceMonitor Redis configur√© avec succ√®s"
  debug:
    msg:
      - "‚úÖ ServiceMonitor '{{ app_name }}-{{ lions_redis_service_name | default('redis') }}' cr√©√©"
      - "üìç Namespace: {{ app_namespace }}"
      - "üéØ Prometheus va scraper les m√©triques Redis"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
    - lions_redis_servicemonitor_check.resources | default([]) | length > 0
  tags:
    - monitoring
    - prometheus

- name: "‚ùå [SERVICEMONITOR] Erreur lors de la cr√©ation du ServiceMonitor"
  debug:
    msg:
      - "‚ö†Ô∏è  Le ServiceMonitor Redis n'a pas pu √™tre cr√©√©"
      - "üîç V√©rifiez les logs et les permissions RBAC"
      - "üìù Namespace: {{ app_namespace }}"
      - "üè∑Ô∏è  Nom: {{ app_name }}-{{ lions_redis_service_name | default('redis') }}"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_prometheus_scrape | default(true) | bool
    - lions_redis_servicemonitor_check.resources | default([]) | length == 0
  tags:
    - monitoring
    - prometheus

# =========================================================================
# CONFIGURATION DES DASHBOARDS GRAFANA
# =========================================================================
- name: "üìä [DASHBOARD] G√©n√©ration du dashboard Grafana Redis"
  template:
    src: grafana-dashboard.json.j2
    dest: "{{ temp_dir.path }}/redis-dashboard.json"
    mode: '0644'
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
  tags:
    - monitoring
    - grafana
    - dashboard

- name: "üé® [DASHBOARD] Cr√©ation du ConfigMap pour le dashboard Redis"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "{{ app_name }}-{{ lions_redis_service_name | default('redis') }}-dashboard"
        namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"
        labels:
          app: "{{ app_name }}"
          component: "{{ lions_redis_service_name | default('redis') }}"
          app.kubernetes.io/name: "{{ app_name }}"
          app.kubernetes.io/component: monitoring
          app.kubernetes.io/part-of: lions-infrastructure
          app.kubernetes.io/version: "{{ lions_config_version | default('5.0.0') }}"
          grafana_dashboard: "1"
          lions.dev/service: redis
          lions.dev/monitoring: enabled
          lions.dev/environment: "{{ lions_environment | default('development') }}"
        annotations:
          lions.dev/description: "Dashboard Grafana pour le monitoring Redis"
          lions.dev/documentation: "https://docs.lions.dev/monitoring/redis"
      data:
        redis-dashboard.json: "{{ lookup('file', temp_dir.path + '/redis-dashboard.json') }}"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_redis_dashboard_result
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
  tags:
    - monitoring
    - grafana
    - dashboard

- name: "‚úÖ [DASHBOARD] V√©rification du dashboard Grafana"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ConfigMap
    namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"
    name: "{{ app_name }}-{{ lions_redis_service_name | default('redis') }}-dashboard"
  register: lions_redis_dashboard_check
  failed_when: false
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
  tags:
    - monitoring
    - grafana
    - validation

- name: "üéâ [DASHBOARD] Dashboard Redis configur√© avec succ√®s"
  debug:
    msg:
      - "‚úÖ Dashboard '{{ app_name }}-{{ lions_redis_service_name | default('redis') }}-dashboard' cr√©√©"
      - "üìç Namespace: {{ lions_monitoring_namespace | default('monitoring') }}"
      - "üé® Dashboard disponible dans Grafana"
      - "üîó URL: {{ lions_grafana_url | default('http://grafana.' + lions_dns_full_domain) }}"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
    - lions_redis_dashboard_check.resources | default([]) | length > 0
  tags:
    - monitoring
    - grafana

- name: "‚ùå [DASHBOARD] Erreur lors de la cr√©ation du dashboard"
  debug:
    msg:
      - "‚ö†Ô∏è  Le dashboard Grafana Redis n'a pas pu √™tre cr√©√©"
      - "üîç V√©rifiez les logs et les permissions"
      - "üìù Namespace: {{ lions_monitoring_namespace | default('monitoring') }}"
      - "üè∑Ô∏è  Nom: {{ app_name }}-{{ lions_redis_service_name | default('redis') }}-dashboard"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_grafana_available
    - lions_redis_dashboard_enabled | default(true) | bool
    - lions_redis_dashboard_check.resources | default([]) | length == 0
  tags:
    - monitoring
    - grafana

# =========================================================================
# CONFIGURATION DES ALERTES PROMETHEUS
# =========================================================================
- name: "üö® [ALERTES] G√©n√©ration des r√®gles d'alerte Redis"
  template:
    src: alert-rules.yml.j2
    dest: "{{ temp_dir.path }}/redis-alert-rules.yml"
    mode: '0644'
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_alerts_enabled | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - alerts

- name: "üîî [ALERTES] D√©ploiement des r√®gles d'alerte Redis"
  kubernetes.core.k8s:
    state: present
    src: "{{ temp_dir.path }}/redis-alert-rules.yml"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_redis_alerts_result
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_alerts_enabled | default(true) | bool
  tags:
    - monitoring
    - prometheus
    - alerts

- name: "‚úÖ [ALERTES] R√®gles d'alerte Redis configur√©es"
  debug:
    msg:
      - "‚úÖ R√®gles d'alerte Redis d√©ploy√©es avec succ√®s"
      - "üö® Alertes actives pour les m√©triques critiques"
      - "üìß Notifications configur√©es selon la configuration Alertmanager"
  when:
    - lions_monitoring_enabled | default(true) | bool
    - lions_redis_monitoring_enabled | default(true) | bool
    - lions_prometheus_available
    - lions_redis_alerts_enabled | default(true) | bool
    - lions_redis_alerts_result is succeeded
  tags:
    - monitoring
    - prometheus
    - alerts

# =========================================================================
# NETTOYAGE DES FICHIERS TEMPORAIRES
# =========================================================================
- name: "üßπ [CLEANUP] Nettoyage des fichiers temporaires de monitoring"
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ temp_dir.path }}/redis-servicemonitor.yml"
    - "{{ temp_dir.path }}/redis-dashboard.json"
    - "{{ temp_dir.path }}/redis-alert-rules.yml"
  when: lions_cleanup_temp_files | default(true) | bool
  tags:
    - monitoring
    - cleanup

# =========================================================================
# R√âSUM√â DE LA CONFIGURATION
# =========================================================================
- name: "üìã [R√âSUM√â] Configuration du monitoring Redis termin√©e"
  debug:
    msg:
      - "üéØ === R√âSUM√â MONITORING REDIS ==="
      - "‚úÖ Monitoring global: {{ lions_monitoring_enabled | default(false) }}"
      - "üìà Monitoring Redis: {{ lions_redis_monitoring_enabled | default(false) }}"
      - "üéØ Prometheus disponible: {{ lions_prometheus_available | default(false) }}"
      - "üìä Grafana disponible: {{ lions_grafana_available | default(false) }}"
      - "üîç ServiceMonitor: {{ 'Configur√©' if lions_prometheus_available and lions_redis_prometheus_scrape | default(true) else 'Non configur√©' }}"
      - "üé® Dashboard: {{ 'Configur√©' if lions_grafana_available and lions_redis_dashboard_enabled | default(true) else 'Non configur√©' }}"
      - "üö® Alertes: {{ 'Configur√©es' if lions_prometheus_available and lions_redis_alerts_enabled | default(true) else 'Non configur√©es' }}"
      - "üè∑Ô∏è  Service: {{ app_name }}-{{ lions_redis_service_name | default('redis') }}"
      - "üìç Namespace: {{ app_namespace }}"
      - "üåê Environnement: {{ lions_environment | default('development') }}"
  tags:
    - monitoring
    - summary