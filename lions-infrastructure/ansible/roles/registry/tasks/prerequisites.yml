---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - PR√âREQUIS REGISTRY
# =========================================================================
# Description: Validation et pr√©paration des pr√©requis pour le d√©ploiement de la registry de conteneurs
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: "{{ ansible_date_time.date }}"
# Documentation: https://docs.lions.dev/infrastructure/registry/prerequisites
# =========================================================================

# =========================================================================
# CONFIGURATION ET VARIABLES
# =========================================================================
- name: "Registry Prerequisites | Configuration des variables par d√©faut"
  set_fact:
    registry_config:
      namespace: "{{ lions_registry_namespace | default(lookup('env', 'LIONS_REGISTRY_NAMESPACE') | default('development', true)) }}"
      service_name: "{{ lions_registry_service_name | default(lookup('env', 'LIONS_REGISTRY_SERVICE_NAME') | default('registry', true)) }}"
      storage_class: "{{ lions_storage_class_default | default(lookup('env', 'LIONS_STORAGE_CLASS_DEFAULT') | default('local-path', true)) }}"
      storage_size: "{{ lions_registry_storage_size | default(lookup('env', 'LIONS_REGISTRY_STORAGE_SIZE') | default('50Gi', true)) }}"
      version: "{{ lions_registry_version | default(lookup('env', 'LIONS_REGISTRY_VERSION') | default('2.8', true)) }}"
      port: "{{ lions_registry_port | default(lookup('env', 'LIONS_REGISTRY_PORT') | default('5000', true)) }}"
      environment: "{{ lions_environment | default(lookup('env', 'LIONS_ENVIRONMENT') | default('development', true)) }}"
      domain: "{{ lions_dns_full_domain | default(lookup('env', 'LIONS_DNS_FULL_DOMAIN') | default('lions.local', true)) }}"
      tls_enabled: "{{ lions_security_tls_enabled | default(lookup('env', 'LIONS_SECURITY_TLS_ENABLED') | default('true', true)) | bool }}"
      rbac_enabled: "{{ lions_security_rbac_enabled | default(lookup('env', 'LIONS_SECURITY_RBAC_ENABLED') | default('true', true)) | bool }}"
      monitoring_enabled: "{{ lions_monitoring_enabled | default(lookup('env', 'LIONS_MONITORING_ENABLED') | default('true', true)) | bool }}"
      debug_mode: "{{ lions_debug_mode | default(lookup('env', 'LIONS_DEBUG_MODE') | default('false', true)) | bool }}"
  tags:
    - registry
    - prerequisites
    - configuration

- name: "Registry Prerequisites | Affichage de la configuration en mode debug"
  debug:
    var: registry_config
    verbosity: 1
  when: registry_config.debug_mode | bool
  tags:
    - registry
    - prerequisites
    - debug

# =========================================================================
# VALIDATION DE L'ENVIRONNEMENT KUBERNETES
# =========================================================================
- name: "Registry Prerequisites | V√©rification de la connectivit√© Kubernetes"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: k8s_connectivity_check
  failed_when: false
  tags:
    - registry
    - prerequisites
    - connectivity

- name: "Registry Prerequisites | √âchec si Kubernetes n'est pas accessible"
  fail:
    msg: |
      ‚ùå ERREUR CRITIQUE: Impossible de se connecter au cluster Kubernetes.
      
      Causes possibles:
      - kubectl n'est pas configur√© correctement
      - Le cluster K3s n'est pas d√©marr√©
      - Permissions insuffisantes
      - KUBECONFIG incorrect
      
      Actions recommand√©es:
      1. V√©rifiez que K3s est d√©marr√©: sudo systemctl status k3s
      2. V√©rifiez votre KUBECONFIG: kubectl cluster-info
      3. Testez la connectivit√©: kubectl get nodes
  when: k8s_connectivity_check.failed | default(false)
  tags:
    - registry
    - prerequisites
    - connectivity

- name: "Registry Prerequisites | Validation de la version Kubernetes"
  set_fact:
    k8s_version_info: "{{ k8s_connectivity_check.resources[0].status.nodeInfo.kubeletVersion | default('unknown') }}"
  when: not k8s_connectivity_check.failed | default(false)
  tags:
    - registry
    - prerequisites
    - version-check

- name: "Registry Prerequisites | Avertissement version Kubernetes"
  debug:
    msg: |
      ‚ö†Ô∏è  AVERTISSEMENT: Version Kubernetes d√©tect√©e: {{ k8s_version_info }}
      Version recommand√©e: v1.30+
      Certaines fonctionnalit√©s pourraient ne pas √™tre disponibles avec des versions ant√©rieures.
  when:
    - not k8s_connectivity_check.failed | default(false)
    - k8s_version_info is version('v1.30.0', '<')
  tags:
    - registry
    - prerequisites
    - version-check

# =========================================================================
# GESTION DU NAMESPACE
# =========================================================================
- name: "Registry Prerequisites | V√©rification de l'existence du namespace {{ registry_config.namespace }}"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ registry_config.namespace }}"
  register: registry_namespace_check
  failed_when: false
  tags:
    - registry
    - prerequisites
    - namespace

- name: "Registry Prerequisites | Cr√©ation du namespace {{ registry_config.namespace }}"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ registry_config.namespace }}"
        labels:
          name: "{{ registry_config.namespace }}"
          app.kubernetes.io/name: "{{ registry_config.service_name }}"
          app.kubernetes.io/component: "registry"
          app.kubernetes.io/part-of: "lions-infrastructure"
          app.kubernetes.io/managed-by: "ansible"
          lions.dev/environment: "{{ registry_config.environment }}"
          lions.dev/version: "{{ registry_config.version }}"
        annotations:
          lions.dev/created-by: "ansible-{{ ansible_user | default('unknown') }}"
          lions.dev/created-at: "{{ ansible_date_time.iso8601 }}"
          lions.dev/description: "Namespace pour la registry de conteneurs LIONS"
    wait: true
    wait_condition:
      type: Complete
      status: "True"
    wait_timeout: 60
  when: registry_namespace_check.resources | length == 0
  register: namespace_creation
  tags:
    - registry
    - prerequisites
    - namespace

- name: "Registry Prerequisites | Validation de la cr√©ation du namespace"
  debug:
    msg: "‚úÖ Namespace {{ registry_config.namespace }} cr√©√© avec succ√®s"
  when:
    - registry_namespace_check.resources | length == 0
    - namespace_creation is succeeded
  tags:
    - registry
    - prerequisites
    - namespace

# =========================================================================
# VALIDATION DU STOCKAGE
# =========================================================================
- name: "Registry Prerequisites | V√©rification de la classe de stockage {{ registry_config.storage_class }}"
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: "{{ registry_config.storage_class }}"
  register: storage_class_check
  failed_when: false
  tags:
    - registry
    - prerequisites
    - storage

- name: "Registry Prerequisites | √âchec si la classe de stockage n'existe pas"
  fail:
    msg: |
      ‚ùå ERREUR CRITIQUE: Classe de stockage '{{ registry_config.storage_class }}' introuvable.
      
      Classes de stockage disponibles:
      {% for sc in available_storage_classes.resources | default([]) %}
      - {{ sc.metadata.name }}{% if sc.metadata.annotations['storageclass.kubernetes.io/is-default-class'] | default('false') == 'true' %} (par d√©faut){% endif %}
      {% endfor %}
      
      Actions recommand√©es:
      1. Utilisez une classe de stockage existante
      2. Cr√©ez la classe de stockage requise
      3. D√©finissez LIONS_STORAGE_CLASS_DEFAULT dans votre configuration
  when: storage_class_check.resources | length == 0
  vars:
    available_storage_classes: "{{ lookup('kubernetes.core.k8s', api_version='storage.k8s.io/v1', kind='StorageClass') | default({'resources': []}) }}"
  tags:
    - registry
    - prerequisites
    - storage

- name: "Registry Prerequisites | Validation de la classe de stockage"
  debug:
    msg: |
      ‚úÖ Classe de stockage valid√©e: {{ registry_config.storage_class }}
      Provisioner: {{ storage_class_check.resources[0].provisioner | default('unknown') }}
      Politique de r√©cup√©ration: {{ storage_class_check.resources[0].reclaimPolicy | default('unknown') }}
  when: storage_class_check.resources | length > 0
  tags:
    - registry
    - prerequisites
    - storage

# =========================================================================
# VALIDATION DU CONTR√îLEUR D'INGRESS
# =========================================================================
- name: "Registry Prerequisites | V√©rification du contr√¥leur d'ingress Traefik"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: kube-system
    label_selectors:
      - "app.kubernetes.io/name=traefik"
  register: traefik_check
  failed_when: false
  tags:
    - registry
    - prerequisites
    - ingress

- name: "Registry Prerequisites | V√©rification alternative du contr√¥leur d'ingress"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: kube-system
    label_selectors:
      - "app=traefik"
  register: traefik_legacy_check
  failed_when: false
  when: traefik_check.resources | length == 0
  tags:
    - registry
    - prerequisites
    - ingress

- name: "Registry Prerequisites | Validation du contr√¥leur d'ingress"
  set_fact:
    ingress_controller_available: "{{ (traefik_check.resources | length > 0) or (traefik_legacy_check.resources | default([]) | length > 0) }}"
  tags:
    - registry
    - prerequisites
    - ingress

- name: "Registry Prerequisites | Avertissement si contr√¥leur d'ingress indisponible"
  debug:
    msg: |
      ‚ö†Ô∏è  AVERTISSEMENT: Aucun contr√¥leur d'ingress Traefik d√©tect√© dans kube-system.
      
      Impact:
      - La registry ne sera pas accessible depuis l'ext√©rieur du cluster
      - L'ingress ne pourra pas √™tre configur√© automatiquement
      
      Solutions:
      1. Installez Traefik: kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/master/docs/content/getting-started/install-traefik.yaml
      2. V√©rifiez que K3s est install√© avec Traefik activ√©
      3. Utilisez un service NodePort ou LoadBalancer comme alternative
  when: not ingress_controller_available | bool
  tags:
    - registry
    - prerequisites
    - ingress

# =========================================================================
# VALIDATION RBAC ET S√âCURIT√â
# =========================================================================
- name: "Registry Prerequisites | V√©rification des ServiceAccounts existants"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ServiceAccount
    name: "{{ registry_config.service_name }}"
    namespace: "{{ registry_config.namespace }}"
  register: service_account_check
  failed_when: false
  when: registry_config.rbac_enabled | bool
  tags:
    - registry
    - prerequisites
    - rbac

- name: "Registry Prerequisites | V√©rification des r√¥les RBAC"
  kubernetes.core.k8s_info:
    api_version: rbac.authorization.k8s.io/v1
    kind: Role
    name: "{{ registry_config.service_name }}-role"
    namespace: "{{ registry_config.namespace }}"
  register: rbac_role_check
  failed_when: false
  when: registry_config.rbac_enabled | bool
  tags:
    - registry
    - prerequisites
    - rbac

- name: "Registry Prerequisites | Information RBAC"
  debug:
    msg: |
      üìã √âtat RBAC pour {{ registry_config.service_name }}:
      - ServiceAccount: {{ 'pr√©sent' if service_account_check.resources | default([]) | length > 0 else '√† cr√©er' }}
      - Role: {{ 'pr√©sent' if rbac_role_check.resources | default([]) | length > 0 else '√† cr√©er' }}
      
      Les ressources RBAC manquantes seront cr√©√©es automatiquement lors du d√©ploiement.
  when: registry_config.rbac_enabled | bool
  tags:
    - registry
    - prerequisites
    - rbac

# =========================================================================
# VALIDATION DES RESSOURCES SYST√àME
# =========================================================================
- name: "Registry Prerequisites | Collecte des informations sur les n≈ìuds"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
  register: nodes_info
  tags:
    - registry
    - prerequisites
    - resources

- name: "Registry Prerequisites | Analyse des ressources disponibles"
  set_fact:
    cluster_resources:
      node_count: "{{ nodes_info.resources | length }}"
      total_cpu: "{{ nodes_info.resources | map(attribute='status.capacity.cpu') | map('int') | sum }}"
      total_memory: "{{ nodes_info.resources | map(attribute='status.capacity.memory') | map('regex_replace', 'Ki$', '') | map('int') | sum }}"
      schedulable_nodes: "{{ nodes_info.resources | selectattr('spec.unschedulable', 'undefined') | list | length }}"
  tags:
    - registry
    - prerequisites
    - resources

- name: "Registry Prerequisites | Validation des ressources minimales"
  debug:
    msg: |
      üìä Ressources du cluster:
      - N≈ìuds: {{ cluster_resources.node_count }} ({{ cluster_resources.schedulable_nodes }} planifiables)
      - CPU total: {{ cluster_resources.total_cpu }} cores
      - M√©moire totale: {{ (cluster_resources.total_memory / 1024 / 1024) | round(2) }} Gi
      
      Ressources requises pour Registry:
      - CPU: 500m (recommand√©)
      - M√©moire: 1Gi (recommand√©)
      - Stockage: {{ registry_config.storage_size }}
      
      {% if cluster_resources.total_cpu | int < 1 %}
      ‚ö†Ô∏è  AVERTISSEMENT: CPU disponible potentiellement insuffisant
      {% endif %}
      {% if (cluster_resources.total_memory / 1024 / 1024) < 2 %}
      ‚ö†Ô∏è  AVERTISSEMENT: M√©moire disponible potentiellement insuffisante
      {% endif %}
  tags:
    - registry
    - prerequisites
    - resources

# =========================================================================
# VALIDATION DU MONITORING (OPTIONNEL)
# =========================================================================
- name: "Registry Prerequisites | V√©rification de Prometheus (optionnel)"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"
    name: prometheus-server
  register: prometheus_check
  failed_when: false
  when: registry_config.monitoring_enabled | bool
  tags:
    - registry
    - prerequisites
    - monitoring

- name: "Registry Prerequisites | Information monitoring"
  debug:
    msg: |
      üìà √âtat du monitoring:
      - Prometheus: {{ 'disponible' if prometheus_check.resources | default([]) | length > 0 else 'non d√©tect√©' }}
      
      {% if prometheus_check.resources | default([]) | length == 0 %}
      ‚ÑπÔ∏è  Le monitoring de la registry sera configur√© mais Prometheus n'est pas encore d√©ploy√©.
      Les m√©triques seront disponibles une fois Prometheus install√©.
      {% endif %}
  when: registry_config.monitoring_enabled | bool
  tags:
    - registry
    - prerequisites
    - monitoring

# =========================================================================
# VALIDATION DE LA CONNECTIVIT√â R√âSEAU
# =========================================================================
- name: "Registry Prerequisites | Test de r√©solution DNS interne"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Pod
      metadata:
        name: "{{ registry_config.service_name }}-dns-test"
        namespace: "{{ registry_config.namespace }}"
        labels:
          app: dns-test
          component: registry-prerequisites
      spec:
        restartPolicy: Never
        containers:
          - name: dns-test
            image: busybox:1.35
            command:
              - /bin/sh
              - -c
              - |
                echo "Test de r√©solution DNS..."
                nslookup kubernetes.default.svc.cluster.local
                echo "DNS test completed"
        terminationGracePeriodSeconds: 0
    wait: true
    wait_condition:
      type: PodReadyCondition
      status: "True"
    wait_timeout: 30
  register: dns_test_pod
  failed_when: false
  tags:
    - registry
    - prerequisites
    - network

- name: "Registry Prerequisites | Nettoyage du pod de test DNS"
  kubernetes.core.k8s:
    state: absent
    api_version: v1
    kind: Pod
    name: "{{ registry_config.service_name }}-dns-test"
    namespace: "{{ registry_config.namespace }}"
    wait: true
    wait_timeout: 30
  when: dns_test_pod is not failed
  tags:
    - registry
    - prerequisites
    - network

# =========================================================================
# R√âSUM√â DES PR√âREQUIS
# =========================================================================
- name: "Registry Prerequisites | G√©n√©ration du rapport de validation"
  set_fact:
    prerequisites_report:
      status: "success"
      kubernetes_connectivity: "{{ not k8s_connectivity_check.failed | default(false) }}"
      namespace_ready: "{{ (registry_namespace_check.resources | length > 0) or (namespace_creation is succeeded) }}"
      storage_class_available: "{{ storage_class_check.resources | length > 0 }}"
      ingress_controller_available: "{{ ingress_controller_available | bool }}"
      sufficient_resources: "{{ cluster_resources.total_cpu | int >= 1 and (cluster_resources.total_memory / 1024 / 1024) >= 2 }}"
      monitoring_available: "{{ prometheus_check.resources | default([]) | length > 0 if registry_config.monitoring_enabled | bool else true }}"
      dns_functional: "{{ dns_test_pod is not failed }}"
  tags:
    - registry
    - prerequisites
    - summary

- name: "Registry Prerequisites | Affichage du rapport final"
  debug:
    msg: |
      
      ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
      ‚ïë                    RAPPORT DE VALIDATION REGISTRY                ‚ïë
      ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
      ‚ïë Composant                    ‚îÇ √âtat                              ‚ïë
      ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
      ‚ïë Connectivit√© Kubernetes      ‚îÇ {{ '‚úÖ OK' if prerequisites_report.kubernetes_connectivity else '‚ùå √âCHEC' }}                           ‚ïë
      ‚ïë Namespace {{ registry_config.namespace | ljust(15) }} ‚îÇ {{ '‚úÖ OK' if prerequisites_report.namespace_ready else '‚ùå √âCHEC' }}                           ‚ïë
      ‚ïë Classe de stockage           ‚îÇ {{ '‚úÖ OK' if prerequisites_report.storage_class_available else '‚ùå √âCHEC' }}                           ‚ïë
      ‚ïë Contr√¥leur d'ingress         ‚îÇ {{ '‚úÖ OK' if prerequisites_report.ingress_controller_available else '‚ö†Ô∏è  MANQUANT' }}                      ‚ïë
      ‚ïë Ressources suffisantes       ‚îÇ {{ '‚úÖ OK' if prerequisites_report.sufficient_resources else '‚ö†Ô∏è  LIMIT√âES' }}                     ‚ïë
      ‚ïë Monitoring disponible        ‚îÇ {{ '‚úÖ OK' if prerequisites_report.monitoring_available else '‚ö†Ô∏è  OPTIONNEL' }}                    ‚ïë
      ‚ïë DNS fonctionnel              ‚îÇ {{ '‚úÖ OK' if prerequisites_report.dns_functional else '‚ùå √âCHEC' }}                           ‚ïë
      ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
      
      Configuration:
      - Namespace: {{ registry_config.namespace }}
      - Service: {{ registry_config.service_name }}
      - Domaine: registry.{{ registry_config.domain }}
      - Version: {{ registry_config.version }}
      - Stockage: {{ registry_config.storage_size }} ({{ registry_config.storage_class }})
      
      {% if not prerequisites_report.kubernetes_connectivity or not prerequisites_report.namespace_ready or not prerequisites_report.storage_class_available or not prerequisites_report.dns_functional %}
      ‚ùå PR√âREQUIS CRITIQUES NON SATISFAITS - Le d√©ploiement √©chouera
      {% elif not prerequisites_report.ingress_controller_available or not prerequisites_report.sufficient_resources %}
      ‚ö†Ô∏è  PR√âREQUIS PARTIELS - Le d√©ploiement peut continuer avec des limitations
      {% else %}
      ‚úÖ TOUS LES PR√âREQUIS SONT SATISFAITS - Pr√™t pour le d√©ploiement
      {% endif %}
  tags:
    - registry
    - prerequisites
    - summary

- name: "Registry Prerequisites | √âchec si pr√©requis critiques non satisfaits"
  fail:
    msg: |
      ‚ùå √âCHEC DE VALIDATION: Des pr√©requis critiques ne sont pas satisfaits.
      
      Veuillez corriger les probl√®mes signal√©s ci-dessus avant de continuer le d√©ploiement.
      
      Pour obtenir de l'aide:
      - Documentation: https://docs.lions.dev/infrastructure/registry/troubleshooting
      - Support: devops@lions.dev
  when: >
    not prerequisites_report.kubernetes_connectivity or
    not prerequisites_report.namespace_ready or
    not prerequisites_report.storage_class_available or
    not prerequisites_report.dns_functional
  tags:
    - registry
    - prerequisites
    - validation