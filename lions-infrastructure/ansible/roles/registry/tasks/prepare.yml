---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - REGISTRY CONTAINER PREPARATION
# =========================================================================
# Description: PrÃ©paration sÃ©curisÃ©e et robuste des ressources pour la registry de conteneurs
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: 2025-05-28
# Documentation: https://docs.lions.dev/infrastructure/registry/preparation
#
# SÃ©curitÃ©: Ce playbook NE CRÃ‰E JAMAIS de secrets avec des credentials par dÃ©faut
# PrÃ©requis: Les secrets doivent Ãªtre crÃ©Ã©s via Vault ou kubectl avant l'exÃ©cution
# =========================================================================

# =========================================================================
# VALIDATION DES PRÃ‰REQUIS CRITIQUES
# =========================================================================
- name: "ğŸ” Validation - VÃ©rification des variables d'environnement LIONS requises"
  assert:
    that:
      - lions_registry_enabled is defined
      - lions_registry_namespace is defined
      - lions_registry_service_name is defined
      - lions_registry_version is defined
      - lions_dns_full_domain is defined
      - lions_storage_class_default is defined
    fail_msg: "âŒ Variables d'environnement LIONS manquantes. VÃ©rifiez le fichier .env"
    success_msg: "âœ… Variables d'environnement LIONS validÃ©es"
  tags:
    - validation
    - registry
    - preparation

- name: "ğŸ” Validation - VÃ©rification de l'activation du registre"
  assert:
    that:
      - lions_registry_enabled | bool
    fail_msg: "âŒ Le registre n'est pas activÃ© (LIONS_REGISTRY_ENABLED=false)"
    success_msg: "âœ… Le registre est activÃ© pour le dÃ©ploiement"
  tags:
    - validation
    - registry

- name: "ğŸ” Validation - VÃ©rification de la connectivitÃ© Kubernetes"
  k8s_info:
    api_version: v1
    kind: Namespace
  register: k8s_connectivity_check
  failed_when: false
  tags:
    - validation
    - kubernetes

- name: "âŒ Ã‰chec - ConnectivitÃ© Kubernetes indisponible"
  fail:
    msg: |
      Impossible de se connecter au cluster Kubernetes.
      VÃ©rifiez que kubectl est configurÃ© et que le cluster est accessible.
  when: k8s_connectivity_check is failed
  tags:
    - validation
    - kubernetes

# =========================================================================
# PRÃ‰PARATION DE L'ENVIRONNEMENT
# =========================================================================
- name: "ğŸ“ Environnement - CrÃ©ation du rÃ©pertoire temporaire sÃ©curisÃ©"
  tempfile:
    state: directory
    suffix: "registry-{{ ansible_date_time.epoch }}"
  register: lions_registry_temp_dir
  changed_when: false
  tags:
    - environment
    - security

- name: "ğŸ”’ SÃ©curitÃ© - Configuration des permissions du rÃ©pertoire temporaire"
  file:
    path: "{{ lions_registry_temp_dir.path }}"
    mode: '0750'
    owner: "{{ ansible_user_id }}"
  changed_when: false
  tags:
    - environment
    - security

# =========================================================================
# VÃ‰RIFICATION DES SECRETS ET SÃ‰CURITÃ‰
# =========================================================================
- name: "ğŸ” SÃ©curitÃ© - VÃ©rification de l'existence du secret d'authentification"
  k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ lions_registry_namespace }}"
    name: "{{ lions_registry_service_name }}-auth"
  register: lions_registry_auth_secret_check
  failed_when: false
  tags:
    - security
    - validation

- name: "âŒ Ã‰chec critique - Secret d'authentification manquant"
  fail:
    msg: |
      ERREUR CRITIQUE DE SÃ‰CURITÃ‰:
      Le secret d'authentification '{{ lions_registry_service_name }}-auth' 
      n'existe pas dans le namespace '{{ lions_registry_namespace }}'.
      
      Pour crÃ©er le secret d'authentification:
      
      1. Via kubectl:
      kubectl create secret generic {{ lions_registry_service_name }}-auth \
        --namespace={{ lions_registry_namespace }} \
        --from-literal=REGISTRY_HTTP_SECRET="$(openssl rand -hex 32)" \
        --from-literal=REGISTRY_AUTH_HTPASSWD_REALM="LIONS Registry" \
        --from-file=htpasswd=/path/to/htpasswd/file
      
      2. Via Vault (recommandÃ©):
      vault kv put secret/registry/auth \
        http_secret="$(openssl rand -hex 32)" \
        htpasswd_realm="LIONS Registry" \
        htpasswd_content="@/path/to/htpasswd/file"
      
      3. GÃ©nÃ©rer un fichier htpasswd:
      htpasswd -Bc /tmp/htpasswd admin
      
      Le dÃ©ploiement s'arrÃªte ici pour des raisons de sÃ©curitÃ©.
  when:
    - lions_registry_auth_secret_check is failed or
      lions_registry_auth_secret_check.resources | length == 0
  tags:
    - security
    - validation

- name: "ğŸ” SÃ©curitÃ© - VÃ©rification du secret TLS"
  k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ lions_registry_namespace }}"
    name: "{{ lions_registry_service_name }}-tls"
  register: lions_registry_tls_secret_check
  failed_when: false
  when: lions_security_tls_enabled | bool
  tags:
    - security
    - tls

- name: "âš ï¸  Avertissement - Secret TLS manquant"
  debug:
    msg: |
      AVERTISSEMENT: Le secret TLS '{{ lions_registry_service_name }}-tls' n'existe pas.
      Le registre utilisera HTTP au lieu de HTTPS.
      
      Pour activer HTTPS, crÃ©ez le secret TLS:
      kubectl create secret tls {{ lions_registry_service_name }}-tls \
        --namespace={{ lions_registry_namespace }} \
        --cert=/path/to/registry.crt \
        --key=/path/to/registry.key
  when:
    - lions_security_tls_enabled | bool
    - lions_registry_tls_secret_check is failed or
      lions_registry_tls_secret_check.resources | length == 0
  tags:
    - security
    - tls

# =========================================================================
# GÃ‰NÃ‰RATION DES TEMPLATES KUBERNETES
# =========================================================================
- name: "ğŸ“‹ Templates - GÃ©nÃ©ration des manifests Kubernetes"
  template:
    src: "{{ item }}.yml.j2"
    dest: "{{ lions_registry_temp_dir.path }}/{{ item }}.yml"
    mode: '0640'
  loop:
    - namespace
    - configmap
    - serviceaccount
    - role
    - rolebinding
    - persistentvolumeclaim
    - service
    - deployment
    - ingress
    - servicemonitor
    - networkpolicy
  register: lions_registry_templates_result
  changed_when: false
  tags:
    - templates
    - kubernetes

- name: "ğŸ” Validation - VÃ©rification de la syntaxe des templates"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/{{ item }}.yml"
    dry_run: true
    validate:
      fail_on_error: true
      strict: true
  loop:
    - namespace
    - configmap
    - serviceaccount
    - role
    - rolebinding
    - persistentvolumeclaim
    - service
    - deployment
    - ingress
    - servicemonitor
    - networkpolicy
  register: lions_registry_validation_result
  changed_when: false
  tags:
    - validation
    - templates

# =========================================================================
# CRÃ‰ATION DES RESSOURCES KUBERNETES
# =========================================================================
- name: "ğŸ—ï¸  Infrastructure - CrÃ©ation/VÃ©rification du namespace"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/namespace.yml"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_registry_namespace_result
  tags:
    - infrastructure
    - namespace

- name: "âš™ï¸  Configuration - CrÃ©ation du ConfigMap"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/configmap.yml"
    wait: true
    wait_condition:
      type: "Ready"
      status: "True"
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_registry_configmap_result
  tags:
    - configuration
    - configmap

- name: "ğŸ‘¤ RBAC - CrÃ©ation du ServiceAccount"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/serviceaccount.yml"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_registry_serviceaccount_result
  tags:
    - rbac
    - serviceaccount

- name: "ğŸ”‘ RBAC - CrÃ©ation du Role"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/role.yml"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_registry_role_result
  tags:
    - rbac
    - role

- name: "ğŸ”— RBAC - CrÃ©ation du RoleBinding"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/rolebinding.yml"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_registry_rolebinding_result
  tags:
    - rbac
    - rolebinding

- name: "ğŸ’¾ Stockage - CrÃ©ation du PersistentVolumeClaim"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/persistentvolumeclaim.yml"
    wait: true
    wait_condition:
      type: "Bound"
      status: "True"
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_registry_pvc_result
  when: lions_registry_storage_size is defined and lions_registry_storage_size != ""
  tags:
    - storage
    - persistence

- name: "ğŸŒ RÃ©seau - CrÃ©ation du Service"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/service.yml"
    wait: true
    wait_condition:
      type: "Ready"
      status: "True"
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_registry_service_result
  tags:
    - networking
    - service

- name: "ğŸ”’ SÃ©curitÃ© - CrÃ©ation des NetworkPolicies"
  k8s:
    state: present
    src: "{{ lions_registry_temp_dir.path }}/networkpolicy.yml"
    wait: true
    wait_timeout: "{{ lions_timeout_default | default(300) }}"
  register: lions_registry_networkpolicy_result
  when: lions_security_network_policies | bool
  tags:
    - security
    - networking

# =========================================================================
# VÃ‰RIFICATION DE L'Ã‰TAT DES RESSOURCES
# =========================================================================
- name: "ğŸ” VÃ©rification - Ã‰tat des ressources crÃ©Ã©es"
  k8s_info:
    api_version: "{{ item.api_version }}"
    kind: "{{ item.kind }}"
    namespace: "{{ lions_registry_namespace }}"
    name: "{{ item.name }}"
  loop:
    - api_version: v1
      kind: Namespace
      name: "{{ lions_registry_namespace }}"
    - api_version: v1
      kind: ConfigMap
      name: "{{ lions_registry_service_name }}-config"
    - api_version: v1
      kind: ServiceAccount
      name: "{{ lions_registry_service_name }}"
    - api_version: v1
      kind: Service
      name: "{{ lions_registry_service_name }}"
  register: lions_registry_resources_status
  tags:
    - verification
    - status

- name: "ğŸ“Š RÃ©sultats - Affichage du statut des ressources"
  debug:
    msg: |
      ğŸ“‹ RÃ‰SUMÃ‰ DE LA PRÃ‰PARATION DU REGISTRE:
      
      ğŸ—ï¸  Namespace: {{ lions_registry_namespace }} - {{ 'CRÃ‰Ã‰' if lions_registry_namespace_result.changed else 'EXISTANT' }}
      âš™ï¸  ConfigMap: {{ 'CRÃ‰Ã‰' if lions_registry_configmap_result.changed else 'EXISTANT' }}
      ğŸ‘¤ ServiceAccount: {{ 'CRÃ‰Ã‰' if lions_registry_serviceaccount_result.changed else 'EXISTANT' }}
      ğŸ”‘ Role: {{ 'CRÃ‰Ã‰' if lions_registry_role_result.changed else 'EXISTANT' }}
      ğŸ”— RoleBinding: {{ 'CRÃ‰Ã‰' if lions_registry_rolebinding_result.changed else 'EXISTANT' }}
      ğŸŒ Service: {{ 'CRÃ‰Ã‰' if lions_registry_service_result.changed else 'EXISTANT' }}
      ğŸ’¾ PVC: {{ 'CRÃ‰Ã‰' if lions_registry_pvc_result.changed else 'EXISTANT' if lions_registry_storage_size is defined else 'NON REQUIS' }}
      ğŸ”’ NetworkPolicy: {{ 'CRÃ‰Ã‰E' if lions_registry_networkpolicy_result.changed else 'EXISTANTE' if lions_security_network_policies | bool else 'DÃ‰SACTIVÃ‰E' }}
      
      âœ… PrÃ©paration terminÃ©e avec succÃ¨s!
      ğŸš€ PrÃªt pour le dÃ©ploiement de l'application.
  tags:
    - results
    - summary

# =========================================================================
# NETTOYAGE SÃ‰CURISÃ‰
# =========================================================================
- name: "ğŸ§¹ Nettoyage - Suppression du rÃ©pertoire temporaire"
  file:
    path: "{{ lions_registry_temp_dir.path }}"
    state: absent
  changed_when: false
  tags:
    - cleanup
    - security

# =========================================================================
# COLLECTE DES MÃ‰TRIQUES DE DÃ‰PLOIEMENT
# =========================================================================
- name: "ğŸ“Š MÃ©triques - Enregistrement des informations de dÃ©ploiement"
  set_fact:
    lions_registry_preparation_metrics:
      completion_time: "{{ ansible_date_time.iso8601 }}"
      namespace: "{{ lions_registry_namespace }}"
      service_name: "{{ lions_registry_service_name }}"
      version: "{{ lions_registry_version }}"
      tls_enabled: "{{ lions_security_tls_enabled | bool }}"
      persistent_storage: "{{ lions_registry_storage_size is defined and lions_registry_storage_size != '' }}"
      network_policies: "{{ lions_security_network_policies | bool }}"
      resources_created:
        namespace: "{{ lions_registry_namespace_result.changed }}"
        configmap: "{{ lions_registry_configmap_result.changed }}"
        serviceaccount: "{{ lions_registry_serviceaccount_result.changed }}"
        role: "{{ lions_registry_role_result.changed }}"
        rolebinding: "{{ lions_registry_rolebinding_result.changed }}"
        service: "{{ lions_registry_service_result.changed }}"
        pvc: "{{ lions_registry_pvc_result.changed if lions_registry_storage_size is defined else false }}"
        networkpolicy: "{{ lions_registry_networkpolicy_result.changed if lions_security_network_policies | bool else false }}"
  tags:
    - metrics
    - reporting

# =========================================================================
# VALIDATION FINALE
# =========================================================================
- name: "âœ… Validation finale - VÃ©rification de la prÃ©paration"
  assert:
    that:
      - lions_registry_namespace_result is succeeded
      - lions_registry_configmap_result is succeeded
      - lions_registry_serviceaccount_result is succeeded
      - lions_registry_service_result is succeeded
    fail_msg: "âŒ La prÃ©paration du registre a Ã©chouÃ©. VÃ©rifiez les logs ci-dessus."
    success_msg: "âœ… PrÃ©paration du registre terminÃ©e avec succÃ¨s!"
  tags:
    - validation
    - final