---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - OLLAMA SERVICE ACCOUNT TEMPLATE
# =========================================================================
# Description: Template ServiceAccount sécurisé pour Ollama avec RBAC
# Version: 5.0.0
# Maintainer: {{ lions_config.maintainer | default('devops@lions.dev') }}
# Documentation: https://docs.lions.dev/infrastructure/ollama/security
# =========================================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ lions_ollama.service_account_name | default(lions_ollama.service_name + '-sa') }}
  namespace: {{ lions_ollama.namespace }}
  labels:
    # Labels standards LIONS
    app.kubernetes.io/name: {{ lions_ollama.service_name }}
    app.kubernetes.io/instance: {{ lions_ollama.service_name }}-{{ lions_environment }}
    app.kubernetes.io/version: {{ lions_ollama.version }}
    app.kubernetes.io/component: ai-engine
    app.kubernetes.io/part-of: lions-infrastructure
    app.kubernetes.io/managed-by: ansible

    # Labels métier LIONS
    lions.dev/service: ollama
    lions.dev/environment: {{ lions_environment }}
    lions.dev/tier: ai
    lions.dev/criticality: {{ lions_ollama.criticality | default('medium') }}
    lions.dev/owner: {{ lions_ollama.owner | default('ai-team') }}
    lions.dev/cost-center: {{ lions_ollama.cost_center | default('infrastructure') }}

    # Labels techniques
    technology: ollama
    deployment-mode: {{ lions_deployment_mode }}
    monitoring: {{ 'enabled' if lions_monitoring_enabled else 'disabled' }}
    backup: {{ 'enabled' if lions_backup_enabled else 'disabled' }}

    # Labels de sécurité
    security.lions.dev/rbac-enabled: "{{ lions_security_rbac_enabled | string | lower }}"
    security.lions.dev/network-policy: "{{ lions_security_network_policies | string | lower }}"
    security.lions.dev/pod-security-standard: {{ lions_security_pod_security_standards }}

  annotations:
    # Annotations de documentation
    description: "ServiceAccount sécurisé pour Ollama AI Engine v{{ lions_ollama.version }} - Environnement {{ lions_environment }}"
    documentation: "https://docs.lions.dev/infrastructure/ollama"
    support-contact: "{{ lions_ollama.support_contact | default('support@lions.dev') }}"

    # Annotations de déploiement
    deployment.lions.dev/deployed-by: "ansible"
    deployment.lions.dev/deployed-at: "{{ ansible_date_time.iso8601 }}"
    deployment.lions.dev/config-version: "{{ lions_config_version }}"
    deployment.lions.dev/last-updated: "{{ ansible_date_time.iso8601 }}"

    # Annotations de monitoring
    {% if lions_monitoring_enabled %}
    monitoring.lions.dev/scrape: "true"
    monitoring.lions.dev/port: "{{ lions_ollama.metrics_port | default('2112') }}"
    monitoring.lions.dev/path: "{{ lions_ollama.metrics_path | default('/metrics') }}"
    {% endif %}

    # Annotations de sécurité
    {% if lions_security_rbac_enabled %}
    security.lions.dev/rbac-version: "v1"
    security.lions.dev/principle: "least-privilege"
    security.lions.dev/audit-required: "{{ lions_audit_enabled | string | lower }}"
    {% endif %}

    # Annotations spécifiques à l'environnement
    {% if lions_environment == 'production' %}
    production.lions.dev/sla: "99.9"
    production.lions.dev/backup-tier: "critical"
    production.lions.dev/monitoring-tier: "enhanced"
    {% elif lions_environment == 'staging' %}
    staging.lions.dev/auto-cleanup: "false"
    staging.lions.dev/testing-allowed: "true"
    {% elif lions_environment == 'development' %}
    development.lions.dev/debug-mode: "{{ lions_debug_mode | string | lower }}"
    development.lions.dev/auto-cleanup: "true"
    {% endif %}

    # Annotations de ressources et performances
    {% if lions_ollama.gpu_enabled %}
    resources.lions.dev/gpu-required: "true"
    resources.lions.dev/gpu-type: "{{ lions_ollama.gpu_type | default('nvidia') }}"
    {% endif %}
    resources.lions.dev/storage-size: "{{ lions_ollama.storage_size }}"
    resources.lions.dev/cpu-profile: "{{ lions_ollama.cpu_profile | default('medium') }}"
    resources.lions.dev/memory-profile: "{{ lions_ollama.memory_profile | default('large') }}"

# Configuration de sécurité du ServiceAccount
{% if lions_security_rbac_enabled %}
# Désactiver l'auto-mount du token par défaut pour la sécurité
# Le token sera monté uniquement si nécessaire via des volumes spécifiques
automountServiceAccountToken: {{ lions_ollama.auto_mount_token | default(false) | string | lower }}
{% else %}
# RBAC désactivé - autoriser l'auto-mount (non recommandé en production)
automountServiceAccountToken: true
{% endif %}

# Secrets associés (si nécessaire)
{% if lions_ollama.image_pull_secrets is defined and lions_ollama.image_pull_secrets | length > 0 %}
imagePullSecrets:
{% for secret in lions_ollama.image_pull_secrets %}
  - name: {{ secret }}
{% endfor %}
{% endif %}

---
{% if lions_security_rbac_enabled %}
# =========================================================================
# RBAC - ROLE SPÉCIFIQUE À OLLAMA
# =========================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ lions_ollama.service_name }}-role
  namespace: {{ lions_ollama.namespace }}
  labels:
    app.kubernetes.io/name: {{ lions_ollama.service_name }}
    app.kubernetes.io/component: rbac
    lions.dev/service: ollama
    lions.dev/environment: {{ lions_environment }}
rules:
  # Permissions minimales pour Ollama
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
    resourceNames: []

  # Permissions pour les ConfigMaps (configuration uniquement)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]
    resourceNames:
      - {{ lions_ollama.service_name }}-config
      {% if lions_ollama.additional_configmaps is defined %}
      {% for cm in lions_ollama.additional_configmaps %}
      - {{ cm }}
      {% endfor %}
      {% endif %}

      # Permissions pour les Secrets (lecture seule)
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get"]
    resourceNames:
      {% if lions_ollama.secrets is defined %}
      {% for secret in lions_ollama.secrets %}
      - {{ secret }}
      {% endfor %}
      {% endif %}

      # Permissions pour les Services (découverte)
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list"]
    resourceNames: []

  {% if lions_ollama.gpu_enabled %}
  # Permissions spécifiques pour GPU
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]
  {% endif %}

  {% if lions_monitoring_enabled %}
  # Permissions pour les métriques
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list"]
  {% endif %}

---
# =========================================================================
# RBAC - ROLEBINDING
# =========================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ lions_ollama.service_name }}-binding
  namespace: {{ lions_ollama.namespace }}
  labels:
    app.kubernetes.io/name: {{ lions_ollama.service_name }}
    app.kubernetes.io/component: rbac
    lions.dev/service: ollama
    lions.dev/environment: {{ lions_environment }}
subjects:
  - kind: ServiceAccount
    name: {{ lions_ollama.service_account_name | default(lions_ollama.service_name + '-sa') }}
    namespace: {{ lions_ollama.namespace }}
roleRef:
  kind: Role
  name: {{ lions_ollama.service_name }}-role
  apiGroup: rbac.authorization.k8s.io

{% if lions_environment == 'production' and lions_ollama.cluster_role_required | default(false) %}
---
# =========================================================================
# RBAC - CLUSTER ROLE (Production uniquement si requis)
# =========================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ lions_ollama.service_name }}-cluster-role
  labels:
    app.kubernetes.io/name: {{ lions_ollama.service_name }}
    app.kubernetes.io/component: rbac
    lions.dev/service: ollama
    lions.dev/environment: {{ lions_environment }}
rules:
  # Permissions cluster minimales pour Ollama en production
  - apiGroups: ["metrics.k8s.io"]
    resources: ["nodes", "pods"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ lions_ollama.service_name }}-cluster-binding
  labels:
    app.kubernetes.io/name: {{ lions_ollama.service_name }}
    app.kubernetes.io/component: rbac
    lions.dev/service: ollama
    lions.dev/environment: {{ lions_environment }}
subjects:
  - kind: ServiceAccount
    name: {{ lions_ollama.service_account_name | default(lions_ollama.service_name + '-sa') }}
    namespace: {{ lions_ollama.namespace }}
roleRef:
  kind: ClusterRole
  name: {{ lions_ollama.service_name }}-cluster-role
  apiGroup: rbac.authorization.k8s.io
{% endif %}
{% endif %}

{% if lions_security_network_policies %}
---
# =========================================================================
# NETWORK POLICY - SÉCURITÉ RÉSEAU POUR OLLAMA
# =========================================================================
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ lions_ollama.service_name }}-netpol
  namespace: {{ lions_ollama.namespace }}
  labels:
    app.kubernetes.io/name: {{ lions_ollama.service_name }}
    app.kubernetes.io/component: security
    lions.dev/service: ollama
    lions.dev/environment: {{ lions_environment }}
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: {{ lions_ollama.service_name }}
  policyTypes:
    - Ingress
    - Egress

  # Trafic entrant autorisé
  ingress:
    # Applications autorisées à communiquer avec Ollama
    - from:
        - namespaceSelector:
            matchLabels:
              name: {{ lions_ollama.allowed_namespaces | default(['applications', 'development']) | join('", "') | replace('", "', '\\n            matchExpressions:\\n              - key: name\\n                operator: In\\n                values:\\n                  - ') }}
        - podSelector:
            matchLabels:
              lions.dev/allowed-ollama: "true"
      ports:
        - protocol: TCP
          port: {{ lions_ollama.port }}

    {% if lions_monitoring_enabled %}
    # Monitoring (Prometheus)
    - from:
        - namespaceSelector:
            matchLabels:
              name: {{ lions_monitoring_namespace }}
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - protocol: TCP
          port: {{ lions_ollama.metrics_port | default('2112') }}
    {% endif %}

  # Trafic sortant autorisé
  egress:
    # DNS
    - to: []
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # HTTPS pour téléchargement de modèles
    - to: []
      ports:
        - protocol: TCP
          port: 443

    # Communication vers les bases de données si nécessaire
    {% if lions_postgres_enabled %}
    - to:
        - namespaceSelector:
            matchLabels:
              name: {{ lions_postgres_namespace }}
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: postgresql
      ports:
        - protocol: TCP
          port: {{ lions_postgres_port }}
    {% endif %}

    {% if lions_redis_enabled %}
    - to:
        - namespaceSelector:
            matchLabels:
              name: {{ lions_redis_namespace }}
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: {{ lions_redis_port }}
    {% endif %}
{% endif %}
