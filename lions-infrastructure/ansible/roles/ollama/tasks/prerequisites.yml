# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - OLLAMA PREREQUISITES
# =========================================================================
# Description: V√©rification compl√®te des pr√©requis pour le d√©ploiement Ollama
# Version: 5.0.0
# Date: 2025-05-29
# Maintainer: DevOps Team LIONS
# Documentation: https://docs.lions.dev/infrastructure/ollama/prerequisites
# =========================================================================

---
- name: "[{{ lions_component_name | upper }}] üîç D√©but de la v√©rification des pr√©requis"
  ansible.builtin.debug:
    msg: |
      ========================================
      V√âRIFICATION DES PR√âREQUIS OLLAMA
      ========================================
      Environnement: {{ lions_environment | upper }}
      Namespace: {{ lions_ollama_namespace }}
      Version cible: {{ lions_ollama_version }}
      ========================================
  tags:
    - prerequisites
    - ollama
    - validation

# =========================================================================
# V√âRIFICATION DE L'INFRASTRUCTURE KUBERNETES
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üèóÔ∏è V√©rification de la connectivit√© du cluster Kubernetes"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_k8s_nodes_info
  failed_when: lions_k8s_nodes_info.resources | length == 0
  tags:
    - prerequisites
    - cluster
    - connectivity

- name: "[{{ lions_component_name | upper }}] üìä Collecte des informations sur les n≈ìuds"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_k8s_nodes_status
  tags:
    - prerequisites
    - cluster
    - resources

- name: "[{{ lions_component_name | upper }}] üñ•Ô∏è Analyse des ressources disponibles par n≈ìud"
  ansible.builtin.debug:
    msg: |
      N≈ìud: {{ item.metadata.name }}
      CPU Disponible: {{ item.status.capacity.cpu }}
      M√©moire Disponible: {{ item.status.capacity.memory }}
      Stockage Disponible: {{ item.status.capacity['ephemeral-storage'] | default('N/A') }}
      GPU Disponible: {{ item.status.capacity['nvidia.com/gpu'] | default('0') }}
      Statut: {{ item.status.conditions | selectattr('type', 'equalto', 'Ready') | map(attribute='status') | first }}
  loop: "{{ lions_k8s_nodes_status.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  tags:
    - prerequisites
    - cluster
    - resources

# =========================================================================
# V√âRIFICATION DES RESSOURCES SYST√àME
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üíæ V√©rification des exigences m√©moire"
  ansible.builtin.assert:
    that:
      - item.status.capacity.memory | regex_replace('Ki$', '') | int >= lions_ollama_memory_min_required
    fail_msg: |
      ‚ùå ERREUR: M√©moire insuffisante sur le n≈ìud {{ item.metadata.name }}
      Requis: {{ lions_ollama_memory_min_required }}Ki
      Disponible: {{ item.status.capacity.memory }}
    success_msg: |
      ‚úÖ M√©moire suffisante sur le n≈ìud {{ item.metadata.name }}
  loop: "{{ lions_k8s_nodes_status.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when: lions_ollama_enabled | bool
  tags:
    - prerequisites
    - resources
    - memory

- name: "[{{ lions_component_name | upper }}] üöÄ V√©rification des exigences CPU"
  ansible.builtin.assert:
    that:
      - item.status.capacity.cpu | int >= lions_ollama_cpu_min_required
    fail_msg: |
      ‚ùå ERREUR: CPU insuffisant sur le n≈ìud {{ item.metadata.name }}
      Requis: {{ lions_ollama_cpu_min_required }} cores
      Disponible: {{ item.status.capacity.cpu }}
    success_msg: |
      ‚úÖ CPU suffisant sur le n≈ìud {{ item.metadata.name }}
  loop: "{{ lions_k8s_nodes_status.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when: lions_ollama_enabled | bool
  tags:
    - prerequisites
    - resources
    - cpu

- name: "[{{ lions_component_name | upper }}] üéÆ V√©rification de la disponibilit√© GPU (si activ√©)"
  ansible.builtin.debug:
    msg: |
      GPU d√©tect√© sur le n≈ìud {{ item.metadata.name }}: {{ item.status.capacity['nvidia.com/gpu'] | default('0') }}
  loop: "{{ lions_k8s_nodes_status.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when:
    - lions_ollama_gpu_enabled | bool
    - item.status.capacity['nvidia.com/gpu'] is defined
  tags:
    - prerequisites
    - resources
    - gpu

- name: "[{{ lions_component_name | upper }}] ‚ö†Ô∏è V√©rification des exigences GPU"
  ansible.builtin.assert:
    that:
      - lions_k8s_nodes_status.resources | selectattr('status.capacity.nvidia.com/gpu', 'defined') | list | length > 0
    fail_msg: |
      ‚ùå ERREUR: GPU requis mais aucun GPU d√©tect√© dans le cluster
      Configuration: GPU activ√© ({{ lions_ollama_gpu_enabled }})
    success_msg: |
      ‚úÖ GPU disponible dans le cluster
  when: lions_ollama_gpu_enabled | bool
  tags:
    - prerequisites
    - resources
    - gpu

# =========================================================================
# V√âRIFICATION DU STOCKAGE
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üíΩ V√©rification de la classe de stockage"
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: "{{ lions_storage_class_default }}"
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_storage_class_info
  tags:
    - prerequisites
    - storage
    - validation

- name: "[{{ lions_component_name | upper }}] üì¶ Validation de la classe de stockage"
  ansible.builtin.assert:
    that:
      - lions_storage_class_info.resources | length > 0
    fail_msg: |
      ‚ùå ERREUR: Classe de stockage '{{ lions_storage_class_default }}' non trouv√©e
      V√©rifiez la configuration du stockage dans le cluster
    success_msg: |
      ‚úÖ Classe de stockage '{{ lions_storage_class_default }}' disponible
  tags:
    - prerequisites
    - storage
    - validation

- name: "[{{ lions_component_name | upper }}] üìÅ V√©rification de l'espace de stockage requis"
  ansible.builtin.debug:
    msg: |
      Stockage requis pour Ollama: {{ lions_ollama_storage_size }}
      Classe de stockage: {{ lions_storage_class_default }}
      Politique de r√©cup√©ration: {{ lions_storage_reclaim_policy }}
  tags:
    - prerequisites
    - storage
    - planning

# =========================================================================
# V√âRIFICATION DU NAMESPACE
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üìã V√©rification du namespace cible"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ lions_ollama_namespace }}"
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_namespace_info
  tags:
    - prerequisites
    - namespace
    - validation

- name: "[{{ lions_component_name | upper }}] üè∑Ô∏è Validation du namespace"
  ansible.builtin.assert:
    that:
      - lions_namespace_info.resources | length > 0
      - lions_namespace_info.resources[0].status.phase == "Active"
    fail_msg: |
      ‚ùå ERREUR: Namespace '{{ lions_ollama_namespace }}' non disponible
      Statut: {{ lions_namespace_info.resources[0].status.phase | default('N/A') }}
    success_msg: |
      ‚úÖ Namespace '{{ lions_ollama_namespace }}' disponible et actif
  tags:
    - prerequisites
    - namespace
    - validation

# =========================================================================
# V√âRIFICATION DES D√âPENDANCES R√âSEAU
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üåê V√©rification de la connectivit√© r√©seau"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: kube-system
    name: kube-dns
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_dns_service_info
  tags:
    - prerequisites
    - network
    - dns

- name: "[{{ lions_component_name | upper }}] üîç Validation du service DNS"
  ansible.builtin.assert:
    that:
      - lions_dns_service_info.resources | length > 0
    fail_msg: |
      ‚ùå ERREUR: Service DNS Kubernetes non disponible
      V√©rifiez la configuration r√©seau du cluster
    success_msg: |
      ‚úÖ Service DNS Kubernetes op√©rationnel
  tags:
    - prerequisites
    - network
    - dns

# =========================================================================
# V√âRIFICATION DES POLITIQUES DE S√âCURIT√â
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üîí V√©rification des politiques de s√©curit√© du namespace"
  kubernetes.core.k8s_info:
    api_version: networking.k8s.io/v1
    kind: NetworkPolicy
    namespace: "{{ lions_ollama_namespace }}"
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_network_policies_info
  when: lions_security_network_policies | bool
  tags:
    - prerequisites
    - security
    - network-policies

- name: "[{{ lions_component_name | upper }}] üõ°Ô∏è Analyse des politiques r√©seau"
  ansible.builtin.debug:
    msg: |
      Politiques r√©seau dans {{ lions_ollama_namespace }}: {{ lions_network_policies_info.resources | length }}
      Politiques de s√©curit√© activ√©es: {{ lions_security_network_policies }}
  when: lions_security_network_policies | bool
  tags:
    - prerequisites
    - security
    - network-policies

# =========================================================================
# V√âRIFICATION DES CERTIFICATS TLS
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üîê V√©rification de la configuration TLS"
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: ClusterIssuer
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_cert_issuers_info
  when: lions_security_tls_enabled | bool
  tags:
    - prerequisites
    - security
    - tls

- name: "[{{ lions_component_name | upper }}] üìú Validation des √©metteurs de certificats"
  ansible.builtin.assert:
    that:
      - lions_cert_issuers_info.resources | length > 0
    fail_msg: |
      ‚ùå ERREUR: Aucun ClusterIssuer cert-manager trouv√©
      TLS activ√© mais cert-manager non configur√©
    success_msg: |
      ‚úÖ √âmetteurs de certificats disponibles: {{ lions_cert_issuers_info.resources | map(attribute='metadata.name') | join(', ') }}
  when: lions_security_tls_enabled | bool
  tags:
    - prerequisites
    - security
    - tls

# =========================================================================
# V√âRIFICATION DU MONITORING
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üìä V√©rification des composants de monitoring"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ lions_monitoring_namespace }}"
    name: prometheus-server
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_prometheus_service_info
  when: lions_monitoring_enabled | bool
  tags:
    - prerequisites
    - monitoring
    - prometheus

- name: "[{{ lions_component_name | upper }}] üìà Validation du service Prometheus"
  ansible.builtin.debug:
    msg: |
      Service Prometheus: {{ 'Disponible' if lions_prometheus_service_info.resources | length > 0 else 'Non disponible' }}
      Monitoring activ√©: {{ lions_monitoring_enabled }}
  when: lions_monitoring_enabled | bool
  tags:
    - prerequisites
    - monitoring
    - prometheus

# =========================================================================
# V√âRIFICATION DES CONFIGURATIONS SP√âCIALES
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ‚öôÔ∏è V√©rification de la configuration des mod√®les IA"
  ansible.builtin.debug:
    msg: |
      Mod√®les par d√©faut √† d√©ployer: {{ lions_ollama_default_models | join(', ') }}
      Taille de stockage allou√©e: {{ lions_ollama_storage_size }}
      GPU activ√©: {{ lions_ollama_gpu_enabled }}
  tags:
    - prerequisites
    - configuration
    - models

- name: "[{{ lions_component_name | upper }}] üéØ Validation des limites de ressources"
  ansible.builtin.debug:
    msg: |
      Ressources CPU - Request: {{ lions_ollama_cpu_request }} | Limit: {{ lions_ollama_cpu_limit }}
      Ressources M√©moire - Request: {{ lions_ollama_memory_request }} | Limit: {{ lions_ollama_memory_limit }}
  tags:
    - prerequisites
    - resources
    - limits

# =========================================================================
# V√âRIFICATION DE LA COMPATIBILIT√â DE VERSION
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üîÑ V√©rification de la compatibilit√© des versions"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_k8s_version_info
  tags:
    - prerequisites
    - compatibility
    - version

- name: "[{{ lions_component_name | upper }}] ‚úÖ Validation des versions Kubernetes"
  ansible.builtin.debug:
    msg: |
      Version Kubernetes cluster: {{ lions_k8s_version_info.resources[0].status.nodeInfo.kubeletVersion }}
      Version K3s cible: {{ lions_k8s_version }}
      Version Ollama cible: {{ lions_ollama_version }}
  tags:
    - prerequisites
    - compatibility
    - version

# =========================================================================
# R√âSUM√â DE LA V√âRIFICATION
# =========================================================================

- name: "[{{ lions_component_name | upper }}] üìã G√©n√©ration du rapport de pr√©requis"
  ansible.builtin.set_fact:
    lions_ollama_prerequisites_report:
      cluster_status: "{{ 'OK' if lions_k8s_nodes_info.resources | length > 0 else 'FAILED' }}"
      storage_status: "{{ 'OK' if lions_storage_class_info.resources | length > 0 else 'FAILED' }}"
      namespace_status: "{{ 'OK' if lions_namespace_info.resources | length > 0 else 'FAILED' }}"
      dns_status: "{{ 'OK' if lions_dns_service_info.resources | length > 0 else 'FAILED' }}"
      tls_status: "{{ 'OK' if not lions_security_tls_enabled or lions_cert_issuers_info.resources | length > 0 else 'FAILED' }}"
      monitoring_status: "{{ 'OK' if not lions_monitoring_enabled or lions_prometheus_service_info.resources | length > 0 else 'FAILED' }}"
      total_checks: 6
      passed_checks: "{{ [cluster_status, storage_status, namespace_status, dns_status, tls_status, monitoring_status] | select('equalto', 'OK') | list | length }}"
  tags:
    - prerequisites
    - report
    - summary

- name: "[{{ lions_component_name | upper }}] üéØ Affichage du rapport final"
  ansible.builtin.debug:
    msg: |
      =========================================
      RAPPORT DE V√âRIFICATION DES PR√âREQUIS
      =========================================
      Composant: {{ lions_component_name | upper }}
      Environnement: {{ lions_environment | upper }}
      
      üìä R√âSULTATS:
      - Cluster Kubernetes: {{ lions_ollama_prerequisites_report.cluster_status }}
      - Stockage: {{ lions_ollama_prerequisites_report.storage_status }}
      - Namespace: {{ lions_ollama_prerequisites_report.namespace_status }}
      - DNS: {{ lions_ollama_prerequisites_report.dns_status }}
      - TLS/Certificats: {{ lions_ollama_prerequisites_report.tls_status }}
      - Monitoring: {{ lions_ollama_prerequisites_report.monitoring_status }}
      
      ‚úÖ V√©rifications r√©ussies: {{ lions_ollama_prerequisites_report.passed_checks }}/{{ lions_ollama_prerequisites_report.total_checks }}
      
      {% if lions_ollama_prerequisites_report.passed_checks == lions_ollama_prerequisites_report.total_checks %}
      üöÄ STATUT: PR√äT POUR LE D√âPLOIEMENT
      {% else %}
      ‚ö†Ô∏è  STATUT: PR√âREQUIS INCOMPLETS
      {% endif %}
      =========================================
  tags:
    - prerequisites
    - report
    - summary

- name: "[{{ lions_component_name | upper }}] ‚ùå √âchec si pr√©requis incomplets"
  ansible.builtin.fail:
    msg: |
      ‚ùå √âCHEC DE LA V√âRIFICATION DES PR√âREQUIS
      
      Veuillez corriger les probl√®mes identifi√©s avant de proc√©der au d√©ploiement.
      Consultez la documentation: https://docs.lions.dev/infrastructure/ollama/troubleshooting
  when: lions_ollama_prerequisites_report.passed_checks != lions_ollama_prerequisites_report.total_checks
  tags:
    - prerequisites
    - validation
    - failure

- name: "[{{ lions_component_name | upper }}] ‚úÖ Fin de la v√©rification des pr√©requis"
  ansible.builtin.debug:
    msg: |
      ========================================
      PR√âREQUIS VALID√âS AVEC SUCC√àS
      ========================================
      Le d√©ploiement peut maintenant proc√©der.
      Timestamp: {{ ansible_date_time.iso8601 }}
      ========================================
  tags:
    - prerequisites
    - success
    - completion