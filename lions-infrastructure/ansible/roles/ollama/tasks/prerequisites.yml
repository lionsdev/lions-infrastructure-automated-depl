# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - OLLAMA PREREQUISITES
# =========================================================================
# Description: VÃ©rification complÃ¨te des prÃ©requis pour le dÃ©ploiement Ollama
# Version: 5.0.0
# Date: 2025-05-29
# Maintainer: DevOps Team LIONS
# Documentation: https://docs.lions.dev/infrastructure/ollama/prerequisites
# =========================================================================

---
- name: "[{{ lions_component_name | upper }}] ğŸ” DÃ©but de la vÃ©rification des prÃ©requis"
  ansible.builtin.debug:
    msg: |
      ========================================
      VÃ‰RIFICATION DES PRÃ‰REQUIS OLLAMA
      ========================================
      Environnement: {{ lions_environment | upper }}
      Namespace: {{ lions_ollama_namespace }}
      Version cible: {{ lions_ollama_version }}
      ========================================
  tags:
    - prerequisites
    - ollama
    - validation

# =========================================================================
# VÃ‰RIFICATION DE L'INFRASTRUCTURE KUBERNETES
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ—ï¸ VÃ©rification de la connectivitÃ© du cluster Kubernetes"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_k8s_nodes_info
  failed_when: lions_k8s_nodes_info.resources | length == 0
  tags:
    - prerequisites
    - cluster
    - connectivity

- name: "[{{ lions_component_name | upper }}] ğŸ“Š Collecte des informations sur les nÅ“uds"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_k8s_nodes_status
  tags:
    - prerequisites
    - cluster
    - resources

- name: "[{{ lions_component_name | upper }}] ğŸ–¥ï¸ Analyse des ressources disponibles par nÅ“ud"
  ansible.builtin.debug:
    msg: |
      NÅ“ud: {{ item.metadata.name }}
      CPU Disponible: {{ item.status.capacity.cpu }}
      MÃ©moire Disponible: {{ item.status.capacity.memory }}
      Stockage Disponible: {{ item.status.capacity['ephemeral-storage'] | default('N/A') }}
      GPU Disponible: {{ item.status.capacity['nvidia.com/gpu'] | default('0') }}
      Statut: {{ item.status.conditions | selectattr('type', 'equalto', 'Ready') | map(attribute='status') | first }}
  loop: "{{ lions_k8s_nodes_status.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  tags:
    - prerequisites
    - cluster
    - resources

# =========================================================================
# VÃ‰RIFICATION DES RESSOURCES SYSTÃˆME
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ’¾ VÃ©rification des exigences mÃ©moire"
  ansible.builtin.assert:
    that:
      - item.status.capacity.memory | regex_replace('Ki$', '') | int >= lions_ollama_memory_min_required
    fail_msg: |
      âŒ ERREUR: MÃ©moire insuffisante sur le nÅ“ud {{ item.metadata.name }}
      Requis: {{ lions_ollama_memory_min_required }}Ki
      Disponible: {{ item.status.capacity.memory }}
    success_msg: |
      âœ… MÃ©moire suffisante sur le nÅ“ud {{ item.metadata.name }}
  loop: "{{ lions_k8s_nodes_status.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when: lions_ollama_enabled | bool
  tags:
    - prerequisites
    - resources
    - memory

- name: "[{{ lions_component_name | upper }}] ğŸš€ VÃ©rification des exigences CPU"
  ansible.builtin.assert:
    that:
      - item.status.capacity.cpu | int >= lions_ollama_cpu_min_required
    fail_msg: |
      âŒ ERREUR: CPU insuffisant sur le nÅ“ud {{ item.metadata.name }}
      Requis: {{ lions_ollama_cpu_min_required }} cores
      Disponible: {{ item.status.capacity.cpu }}
    success_msg: |
      âœ… CPU suffisant sur le nÅ“ud {{ item.metadata.name }}
  loop: "{{ lions_k8s_nodes_status.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when: lions_ollama_enabled | bool
  tags:
    - prerequisites
    - resources
    - cpu

- name: "[{{ lions_component_name | upper }}] ğŸ® VÃ©rification de la disponibilitÃ© GPU (si activÃ©)"
  ansible.builtin.debug:
    msg: |
      GPU dÃ©tectÃ© sur le nÅ“ud {{ item.metadata.name }}: {{ item.status.capacity['nvidia.com/gpu'] | default('0') }}
  loop: "{{ lions_k8s_nodes_status.resources }}"
  loop_control:
    label: "{{ item.metadata.name }}"
  when:
    - lions_ollama_gpu_enabled | bool
    - item.status.capacity['nvidia.com/gpu'] is defined
  tags:
    - prerequisites
    - resources
    - gpu

- name: "[{{ lions_component_name | upper }}] âš ï¸ VÃ©rification des exigences GPU"
  ansible.builtin.assert:
    that:
      - lions_k8s_nodes_status.resources | selectattr('status.capacity.nvidia.com/gpu', 'defined') | list | length > 0
    fail_msg: |
      âŒ ERREUR: GPU requis mais aucun GPU dÃ©tectÃ© dans le cluster
      Configuration: GPU activÃ© ({{ lions_ollama_gpu_enabled }})
    success_msg: |
      âœ… GPU disponible dans le cluster
  when: lions_ollama_gpu_enabled | bool
  tags:
    - prerequisites
    - resources
    - gpu

# =========================================================================
# VÃ‰RIFICATION DU STOCKAGE
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ’½ VÃ©rification de la classe de stockage"
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: "{{ lions_storage_class_default }}"
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_storage_class_info
  tags:
    - prerequisites
    - storage
    - validation

- name: "[{{ lions_component_name | upper }}] ğŸ“¦ Validation de la classe de stockage"
  ansible.builtin.assert:
    that:
      - lions_storage_class_info.resources | length > 0
    fail_msg: |
      âŒ ERREUR: Classe de stockage '{{ lions_storage_class_default }}' non trouvÃ©e
      VÃ©rifiez la configuration du stockage dans le cluster
    success_msg: |
      âœ… Classe de stockage '{{ lions_storage_class_default }}' disponible
  tags:
    - prerequisites
    - storage
    - validation

- name: "[{{ lions_component_name | upper }}] ğŸ“ VÃ©rification de l'espace de stockage requis"
  ansible.builtin.debug:
    msg: |
      Stockage requis pour Ollama: {{ lions_ollama_storage_size }}
      Classe de stockage: {{ lions_storage_class_default }}
      Politique de rÃ©cupÃ©ration: {{ lions_storage_reclaim_policy }}
  tags:
    - prerequisites
    - storage
    - planning

# =========================================================================
# VÃ‰RIFICATION DU NAMESPACE
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ“‹ VÃ©rification du namespace cible"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ lions_ollama_namespace }}"
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_namespace_info
  tags:
    - prerequisites
    - namespace
    - validation

- name: "[{{ lions_component_name | upper }}] ğŸ·ï¸ Validation du namespace"
  ansible.builtin.assert:
    that:
      - lions_namespace_info.resources | length > 0
      - lions_namespace_info.resources[0].status.phase == "Active"
    fail_msg: |
      âŒ ERREUR: Namespace '{{ lions_ollama_namespace }}' non disponible
      Statut: {{ lions_namespace_info.resources[0].status.phase | default('N/A') }}
    success_msg: |
      âœ… Namespace '{{ lions_ollama_namespace }}' disponible et actif
  tags:
    - prerequisites
    - namespace
    - validation

# =========================================================================
# VÃ‰RIFICATION DES DÃ‰PENDANCES RÃ‰SEAU
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸŒ VÃ©rification de la connectivitÃ© rÃ©seau"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: kube-system
    name: kube-dns
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_dns_service_info
  tags:
    - prerequisites
    - network
    - dns

- name: "[{{ lions_component_name | upper }}] ğŸ” Validation du service DNS"
  ansible.builtin.assert:
    that:
      - lions_dns_service_info.resources | length > 0
    fail_msg: |
      âŒ ERREUR: Service DNS Kubernetes non disponible
      VÃ©rifiez la configuration rÃ©seau du cluster
    success_msg: |
      âœ… Service DNS Kubernetes opÃ©rationnel
  tags:
    - prerequisites
    - network
    - dns

# =========================================================================
# VÃ‰RIFICATION DES POLITIQUES DE SÃ‰CURITÃ‰
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ”’ VÃ©rification des politiques de sÃ©curitÃ© du namespace"
  kubernetes.core.k8s_info:
    api_version: networking.k8s.io/v1
    kind: NetworkPolicy
    namespace: "{{ lions_ollama_namespace }}"
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_network_policies_info
  when: lions_security_network_policies | bool
  tags:
    - prerequisites
    - security
    - network-policies

- name: "[{{ lions_component_name | upper }}] ğŸ›¡ï¸ Analyse des politiques rÃ©seau"
  ansible.builtin.debug:
    msg: |
      Politiques rÃ©seau dans {{ lions_ollama_namespace }}: {{ lions_network_policies_info.resources | length }}
      Politiques de sÃ©curitÃ© activÃ©es: {{ lions_security_network_policies }}
  when: lions_security_network_policies | bool
  tags:
    - prerequisites
    - security
    - network-policies

# =========================================================================
# VÃ‰RIFICATION DES CERTIFICATS TLS
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ” VÃ©rification de la configuration TLS"
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: ClusterIssuer
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_cert_issuers_info
  when: lions_security_tls_enabled | bool
  tags:
    - prerequisites
    - security
    - tls

- name: "[{{ lions_component_name | upper }}] ğŸ“œ Validation des Ã©metteurs de certificats"
  ansible.builtin.assert:
    that:
      - lions_cert_issuers_info.resources | length > 0
    fail_msg: |
      âŒ ERREUR: Aucun ClusterIssuer cert-manager trouvÃ©
      TLS activÃ© mais cert-manager non configurÃ©
    success_msg: |
      âœ… Ã‰metteurs de certificats disponibles: {{ lions_cert_issuers_info.resources | map(attribute='metadata.name') | join(', ') }}
  when: lions_security_tls_enabled | bool
  tags:
    - prerequisites
    - security
    - tls

# =========================================================================
# VÃ‰RIFICATION DU MONITORING
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ“Š VÃ©rification des composants de monitoring"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ lions_monitoring_namespace }}"
    name: prometheus-server
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_prometheus_service_info
  when: lions_monitoring_enabled | bool
  tags:
    - prerequisites
    - monitoring
    - prometheus

- name: "[{{ lions_component_name | upper }}] ğŸ“ˆ Validation du service Prometheus"
  ansible.builtin.debug:
    msg: |
      Service Prometheus: {{ 'Disponible' if lions_prometheus_service_info.resources | length > 0 else 'Non disponible' }}
      Monitoring activÃ©: {{ lions_monitoring_enabled }}
  when: lions_monitoring_enabled | bool
  tags:
    - prerequisites
    - monitoring
    - prometheus

# =========================================================================
# VÃ‰RIFICATION DES CONFIGURATIONS SPÃ‰CIALES
# =========================================================================

- name: "[{{ lions_component_name | upper }}] âš™ï¸ VÃ©rification de la configuration des modÃ¨les IA"
  ansible.builtin.debug:
    msg: |
      ModÃ¨les par dÃ©faut Ã  dÃ©ployer: {{ lions_ollama_default_models | join(', ') }}
      Taille de stockage allouÃ©e: {{ lions_ollama_storage_size }}
      GPU activÃ©: {{ lions_ollama_gpu_enabled }}
  tags:
    - prerequisites
    - configuration
    - models

- name: "[{{ lions_component_name | upper }}] ğŸ¯ Validation des limites de ressources"
  ansible.builtin.debug:
    msg: |
      Ressources CPU - Request: {{ lions_ollama_cpu_request }} | Limit: {{ lions_ollama_cpu_limit }}
      Ressources MÃ©moire - Request: {{ lions_ollama_memory_request }} | Limit: {{ lions_ollama_memory_limit }}
  tags:
    - prerequisites
    - resources
    - limits

# =========================================================================
# VÃ‰RIFICATION DE LA COMPATIBILITÃ‰ DE VERSION
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ”„ VÃ©rification de la compatibilitÃ© des versions"
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ lions_k8s_config_file }}"
  register: lions_k8s_version_info
  tags:
    - prerequisites
    - compatibility
    - version

- name: "[{{ lions_component_name | upper }}] âœ… Validation des versions Kubernetes"
  ansible.builtin.debug:
    msg: |
      Version Kubernetes cluster: {{ lions_k8s_version_info.resources[0].status.nodeInfo.kubeletVersion }}
      Version K3s cible: {{ lions_k8s_version }}
      Version Ollama cible: {{ lions_ollama_version }}
  tags:
    - prerequisites
    - compatibility
    - version

# =========================================================================
# RÃ‰SUMÃ‰ DE LA VÃ‰RIFICATION
# =========================================================================

- name: "[{{ lions_component_name | upper }}] ğŸ“‹ GÃ©nÃ©ration du rapport de prÃ©requis"
  ansible.builtin.set_fact:
    lions_ollama_prerequisites_report:
      cluster_status: "{{ 'OK' if lions_k8s_nodes_info.resources | length > 0 else 'FAILED' }}"
      storage_status: "{{ 'OK' if lions_storage_class_info.resources | length > 0 else 'FAILED' }}"
      namespace_status: "{{ 'OK' if lions_namespace_info.resources | length > 0 else 'FAILED' }}"
      dns_status: "{{ 'OK' if lions_dns_service_info.resources | length > 0 else 'FAILED' }}"
      tls_status: "{{ 'OK' if not lions_security_tls_enabled or lions_cert_issuers_info.resources | length > 0 else 'FAILED' }}"
      monitoring_status: "{{ 'OK' if not lions_monitoring_enabled or lions_prometheus_service_info.resources | length > 0 else 'FAILED' }}"
      total_checks: 6
      passed_checks: "{{ [cluster_status, storage_status, namespace_status, dns_status, tls_status, monitoring_status] | select('equalto', 'OK') | list | length }}"
  tags:
    - prerequisites
    - report
    - summary

- name: "[{{ lions_component_name | upper }}] ğŸ¯ Affichage du rapport final"
  ansible.builtin.debug:
    msg: |
      =========================================
      RAPPORT DE VÃ‰RIFICATION DES PRÃ‰REQUIS
      =========================================
      Composant: {{ lions_component_name | upper }}
      Environnement: {{ lions_environment | upper }}
      
      ğŸ“Š RÃ‰SULTATS:
      - Cluster Kubernetes: {{ lions_ollama_prerequisites_report.cluster_status }}
      - Stockage: {{ lions_ollama_prerequisites_report.storage_status }}
      - Namespace: {{ lions_ollama_prerequisites_report.namespace_status }}
      - DNS: {{ lions_ollama_prerequisites_report.dns_status }}
      - TLS/Certificats: {{ lions_ollama_prerequisites_report.tls_status }}
      - Monitoring: {{ lions_ollama_prerequisites_report.monitoring_status }}
      
      âœ… VÃ©rifications rÃ©ussies: {{ lions_ollama_prerequisites_report.passed_checks }}/{{ lions_ollama_prerequisites_report.total_checks }}
      
      {% if lions_ollama_prerequisites_report.passed_checks == lions_ollama_prerequisites_report.total_checks %}
      ğŸš€ STATUT: PRÃŠT POUR LE DÃ‰PLOIEMENT
      {% else %}
      âš ï¸  STATUT: PRÃ‰REQUIS INCOMPLETS
      {% endif %}
      =========================================
  tags:
    - prerequisites
    - report
    - summary

- name: "[{{ lions_component_name | upper }}] âŒ Ã‰chec si prÃ©requis incomplets"
  ansible.builtin.fail:
    msg: |
      âŒ Ã‰CHEC DE LA VÃ‰RIFICATION DES PRÃ‰REQUIS
      
      Veuillez corriger les problÃ¨mes identifiÃ©s avant de procÃ©der au dÃ©ploiement.
      Consultez la documentation: https://docs.lions.dev/infrastructure/ollama/troubleshooting
  when: lions_ollama_prerequisites_report.passed_checks != lions_ollama_prerequisites_report.total_checks
  tags:
    - prerequisites
    - validation
    - failure

- name: "[{{ lions_component_name | upper }}] âœ… Fin de la vÃ©rification des prÃ©requis"
  ansible.builtin.debug:
    msg: |
      ========================================
      PRÃ‰REQUIS VALIDÃ‰S AVEC SUCCÃˆS
      ========================================
      Le dÃ©ploiement peut maintenant procÃ©der.
      Timestamp: {{ ansible_date_time.iso8601 }}
      ========================================
  tags:
    - prerequisites
    - success
    - completion