---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - T√ÇCHES DE D√âPLOIEMENT GITEA
# =========================================================================
# Description: T√¢ches avanc√©es de d√©ploiement Gitea avec gestion d'erreurs compl√®te
# Version: 5.0.0
# Auteur: √âquipe DevOps LIONS
# Date: 2025-05-28
# D√©pendances: PostgreSQL, Redis (optionnel), Vault
# =========================================================================

# =========================================================================
# VALIDATION PR√â-D√âPLOIEMENT
# =========================================================================
- name: "[GITEA-DEPLOY] Valider les pr√©requis de d√©ploiement"
  block:
    - name: "V√©rifier l'existence du namespace"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ lions_gitea_namespace }}"
      register: namespace_check
      failed_when: namespace_check.resources | length == 0

    - name: "Valider les variables d'environnement requises"
      assert:
        that:
          - lions_gitea_enabled | default(false) | bool
          - lions_gitea_namespace is defined
          - lions_gitea_service_name is defined
          - lions_gitea_version is defined
          - lions_dns_full_domain is defined
        fail_msg: "Les variables d'environnement Gitea requises ne sont pas correctement configur√©es"
        success_msg: "‚úÖ Variables d'environnement Gitea valid√©es"

    - name: "V√©rifier la d√©pendance PostgreSQL"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: StatefulSet
        namespace: "{{ lions_postgres_namespace }}"
        name: "{{ lions_postgres_service_name }}"
      register: postgres_check
      when: lions_postgres_enabled | default(true) | bool
      failed_when:
        - lions_postgres_enabled | default(true) | bool
        - postgres_check.resources | length == 0 or postgres_check.resources[0].status.readyReplicas != postgres_check.resources[0].spec.replicas

  rescue:
    - name: "Journaliser l'√©chec de validation des pr√©requis"
      debug:
        msg: "‚ùå Les pr√©requis de d√©ploiement Gitea ne sont pas satisfaits. Abandon du d√©ploiement."
    - fail:
        msg: "La validation des pr√©requis de d√©ploiement Gitea a √©chou√©"

  tags: [gitea, deploy, validation]

# =========================================================================
# CONFIGURATION DE D√âPLOIEMENT
# =========================================================================
- name: "[GITEA-DEPLOY] G√©n√©rer la configuration de d√©ploiement"
  block:
    - name: "D√©finir les variables de d√©ploiement"
      set_fact:
        gitea_deployment_config:
          name: "{{ lions_gitea_service_name }}"
          namespace: "{{ lions_gitea_namespace }}"
          version: "{{ lions_gitea_version }}"
          replicas: "{{ lions_gitea_replicas | default(1) }}"
          domain: "{{ lions_gitea_service_name }}.{{ lions_dns_full_domain }}"
          internal_url: "http://{{ lions_gitea_service_name }}.{{ lions_gitea_namespace }}.svc.cluster.local:{{ lions_gitea_port }}"
          storage_size: "{{ lions_gitea_storage_size }}"
          resources:
            requests:
              cpu: "{{ lions_resources_medium_cpu_request }}"
              memory: "{{ lions_resources_medium_memory_request }}"
            limits:
              cpu: "{{ lions_resources_medium_cpu_limit }}"
              memory: "{{ lions_resources_medium_memory_limit }}"

    - name: "G√©n√©rer l'horodatage de d√©ploiement"
      set_fact:
        deployment_timestamp: "{{ ansible_date_time.epoch }}"
        deployment_id: "{{ ansible_date_time.iso8601_basic_short }}-{{ ansible_hostname | hash('md5') | truncate(8, True, '') }}"

  tags: [gitea, deploy, config]

# =========================================================================
# GESTION DES SECRETS
# =========================================================================
- name: "[GITEA-DEPLOY] G√©rer les secrets et la configuration"
  block:
    - name: "R√©cup√©rer les identifiants de base de donn√©es depuis Vault"
      lions_vault_secret:
        vault_url: "{{ lions_vault_addr }}"
        vault_token: "{{ vault_token | default(omit) }}"
        path: "secret/gitea/database"
        key: "credentials"
      register: gitea_db_credentials
      when: lions_vault_enabled | default(true) | bool
      no_log: true

    - name: "G√©n√©rer un mot de passe administrateur al√©atoire s'il n'existe pas"
      set_fact:
        gitea_admin_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
      when: gitea_admin_password is not defined
      no_log: true

    - name: "Stocker les identifiants administrateur dans Vault"
      lions_vault_secret:
        vault_url: "{{ lions_vault_addr }}"
        vault_token: "{{ vault_token | default(omit) }}"
        path: "secret/gitea/admin"
        data:
          username: "{{ gitea_admin_username | default('admin') }}"
          password: "{{ gitea_admin_password }}"
          email: "{{ gitea_admin_email | default('admin@' + lions_dns_domain_base) }}"
        state: present
      when: lions_vault_enabled | default(true) | bool
      no_log: true

  rescue:
    - name: "G√©rer l'√©chec de gestion des secrets"
      debug:
        msg: "‚ö†Ô∏è  Avertissement : La gestion des secrets a √©chou√©. Utilisation de la configuration de secours."
    - set_fact:
        gitea_db_credentials:
          username: "{{ gitea_db_username | default('gitea') }}"
          password: "{{ gitea_db_password | default(lookup('password', '/dev/null length=16 chars=ascii_letters,digits')) }}"
          database: "{{ gitea_db_name | default('gitea') }}"

  tags: [gitea, deploy, secrets]

# =========================================================================
# D√âPLOIEMENT DES RESSOURCES KUBERNETES
# =========================================================================
- name: "[GITEA-DEPLOY] D√©ployer les ressources Kubernetes"
  block:
    # ServiceAccount
    - name: "D√©ployer le ServiceAccount"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: "{{ gitea_deployment_config.name }}"
            namespace: "{{ gitea_deployment_config.namespace }}"
            labels:
              app.kubernetes.io/name: gitea
              app.kubernetes.io/instance: "{{ gitea_deployment_config.name }}"
              app.kubernetes.io/version: "{{ gitea_deployment_config.version }}"
              app.kubernetes.io/component: vcs
              app.kubernetes.io/part-of: lions-infrastructure
              lions.dev/environment: "{{ lions_environment }}"
              lions.dev/deployment-id: "{{ deployment_id }}"
            annotations:
              lions.dev/deployed-at: "{{ ansible_date_time.iso8601 }}"
              lions.dev/deployed-by: "{{ ansible_user | default('ansible') }}"
        wait: true
        wait_condition:
          type: Complete
          status: "True"
        wait_timeout: 60
      register: serviceaccount_result

    # ConfigMap
    - name: "D√©ployer la ConfigMap"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'configmap.yml.j2') | from_yaml }}"
        wait: true
        wait_timeout: 60
      register: configmap_result

    # PersistentVolumeClaim
    - name: "D√©ployer le PersistentVolumeClaim"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'persistentvolumeclaim.yml.j2') | from_yaml }}"
        wait: true
        wait_condition:
          type: Bound
          status: "True"
        wait_timeout: 300
      register: pvc_result

    # Secret pour la base de donn√©es
    - name: "Cr√©er le secret de base de donn√©es"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ gitea_deployment_config.name }}-db-secret"
            namespace: "{{ gitea_deployment_config.namespace }}"
            labels:
              app.kubernetes.io/name: gitea
              app.kubernetes.io/instance: "{{ gitea_deployment_config.name }}"
              lions.dev/environment: "{{ lions_environment }}"
          type: Opaque
          data:
            username: "{{ gitea_db_credentials.username | b64encode }}"
            password: "{{ gitea_db_credentials.password | b64encode }}"
            database: "{{ gitea_db_credentials.database | default('gitea') | b64encode }}"
            host: "{{ lions_postgres_service_name + '.' + lions_postgres_namespace + '.svc.cluster.local' | b64encode }}"
            port: "{{ lions_postgres_port | string | b64encode }}"
        wait: true
        wait_timeout: 60
      register: secret_result
      no_log: true

    # Service
    - name: "D√©ployer le Service"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'service.yml.j2') | from_yaml }}"
        wait: true
        wait_timeout: 60
      register: service_result

    # Deployment
    - name: "D√©ployer l'application Gitea"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'deployment.yml.j2') | from_yaml }}"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 600
      register: deployment_result

  rescue:
    - name: "Journaliser l'√©chec de d√©ploiement"
      debug:
        msg: "‚ùå Le d√©ploiement des ressources Kubernetes Gitea a √©chou√© √† {{ ansible_date_time.iso8601 }}"
    - name: "Collecter les logs de d√©ploiement pour le d√©pannage"
      include_tasks: "../utils/collect_logs.yml"
      vars:
        component_name: "gitea"
        log_collection_reason: "deployment_failure"
    - fail:
        msg: "Le d√©ploiement des ressources Kubernetes Gitea a √©chou√©"

  tags: [gitea, deploy, kubernetes]

# =========================================================================
# CONFIGURATION INGRESS
# =========================================================================
- name: "[GITEA-DEPLOY] Configurer l'ingress"
  block:
    - name: "D√©ployer la ressource Ingress"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'ingress.yml.j2') | from_yaml }}"
        wait: true
        wait_timeout: 120
      register: ingress_result
      when:
        - lions_environment != 'development' or (gitea_create_ingress | default(true) | bool)
        - lions_security_tls_enabled | default(true) | bool

    - name: "Attendre le provisionnement du certificat TLS"
      kubernetes.core.k8s_info:
        api_version: cert-manager.io/v1
        kind: Certificate
        namespace: "{{ gitea_deployment_config.namespace }}"
        name: "{{ gitea_deployment_config.name }}-tls"
      register: certificate_status
      until:
        - certificate_status.resources | length > 0
        - certificate_status.resources[0].status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
      retries: 30
      delay: 10
      when:
        - ingress_result is not skipped
        - lions_security_tls_enabled | default(true) | bool

  rescue:
    - name: "G√©rer l'√©chec de configuration de l'ingress"
      debug:
        msg: "‚ö†Ô∏è  Avertissement : La configuration de l'ingress a √©chou√©. Le service ne sera accessible qu'en interne."

  tags: [gitea, deploy, ingress]

# =========================================================================
# V√âRIFICATION POST-D√âPLOIEMENT
# =========================================================================
- name: "[GITEA-DEPLOY] V√©rifier la sant√© du d√©ploiement"
  block:
    - name: "Attendre la disponibilit√© du d√©ploiement"
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ gitea_deployment_config.namespace }}"
        name: "{{ gitea_deployment_config.name }}"
      register: deployment_status
      until:
        - deployment_status.resources | length > 0
        - deployment_status.resources[0].status.availableReplicas is defined
        - deployment_status.resources[0].status.availableReplicas == deployment_status.resources[0].spec.replicas
      retries: 30
      delay: 10

    - name: "Obtenir les informations des pods"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ gitea_deployment_config.namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=gitea"
          - "app.kubernetes.io/instance={{ gitea_deployment_config.name }}"
      register: pods_info

    - name: "V√©rifier la sant√© des pods"
      assert:
        that:
          - pods_info.resources | length > 0
          - pods_info.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == pods_info.resources | length
        fail_msg: "‚ùå Tous les pods Gitea ne fonctionnent pas correctement"
        success_msg: "‚úÖ Tous les pods Gitea sont en cours d'ex√©cution et en bonne sant√©"

    - name: "V√©rifier la disponibilit√© de l'application"
      uri:
        url: "{{ gitea_deployment_config.internal_url }}/api/v1/version"
        method: GET
        status_code: 200
        timeout: 30
      register: health_check
      retries: 10
      delay: 15
      until: health_check is succeeded

    - name: "V√©rifier la connectivit√© √† la base de donn√©es"
      uri:
        url: "{{ gitea_deployment_config.internal_url }}/api/v1/settings/api"
        method: GET
        status_code: [200, 401]  # 401 est OK si l'authentification est requise
        timeout: 30
      register: db_connectivity_check
      retries: 5
      delay: 10
      until: db_connectivity_check is succeeded

  rescue:
    - name: "G√©rer l'√©chec de v√©rification post-d√©ploiement"
      debug:
        msg: "‚ùå La v√©rification post-d√©ploiement a √©chou√©"

    - name: "Collecter les logs des pods pour le d√©pannage"
      kubernetes.core.k8s_log:
        namespace: "{{ gitea_deployment_config.namespace }}"
        name: "{{ item.metadata.name }}"
        tail_lines: 50
      register: pod_logs
      loop: "{{ pods_info.resources | default([]) }}"
      when: pods_info.resources is defined

    - name: "Afficher les logs des pods"
      debug:
        msg: |
          Logs du pod {{ item.item.metadata.name }} :
          {{ item.log | default('Aucun log disponible') }}
      loop: "{{ pod_logs.results | default([]) }}"
      when: pod_logs.results is defined

    - fail:
        msg: "La v√©rification du d√©ploiement Gitea a √©chou√©"

  tags: [gitea, deploy, verification]

# =========================================================================
# CONFIGURATION DU MONITORING
# =========================================================================
- name: "[GITEA-DEPLOY] Configurer le monitoring"
  block:
    - name: "D√©ployer le ServiceMonitor pour Prometheus"
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'servicemonitor.yml.j2') | from_yaml }}"
        wait: true
        wait_timeout: 60
      register: servicemonitor_result
      when: lions_monitoring_enabled | default(true) | bool

    - name: "Cr√©er la ConfigMap du tableau de bord Grafana"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ gitea_deployment_config.name }}-dashboard"
            namespace: "{{ lions_monitoring_namespace }}"
            labels:
              grafana_dashboard: "1"
              app.kubernetes.io/name: gitea
              lions.dev/environment: "{{ lions_environment }}"
          data:
            gitea-dashboard.json: "{{ lookup('file', '../../../monitoring/dashboards/gitea/application-dashboard.json') }}"
      when: lions_monitoring_enabled | default(true) | bool

  rescue:
    - name: "G√©rer l'√©chec de configuration du monitoring"
      debug:
        msg: "‚ö†Ô∏è  Avertissement : La configuration du monitoring a √©chou√©. L'application est d√©ploy√©e mais le monitoring pourrait ne pas √™tre disponible."

  tags: [gitea, deploy, monitoring]

# =========================================================================
# FINALISATION DU D√âPLOIEMENT
# =========================================================================
- name: "[GITEA-DEPLOY] Finaliser le d√©ploiement"
  block:
    - name: "Mettre √† jour le statut de d√©ploiement dans Vault"
      lions_vault_secret:
        vault_url: "{{ lions_vault_addr }}"
        vault_token: "{{ vault_token | default(omit) }}"
        path: "secret/gitea/deployment"
        data:
          status: "deployed"
          version: "{{ gitea_deployment_config.version }}"
          deployment_id: "{{ deployment_id }}"
          deployed_at: "{{ ansible_date_time.iso8601 }}"
          internal_url: "{{ gitea_deployment_config.internal_url }}"
          external_url: "https://{{ gitea_deployment_config.domain }}"
          namespace: "{{ gitea_deployment_config.namespace }}"
        state: present
      when: lions_vault_enabled | default(true) | bool

    - name: "Journaliser le d√©ploiement r√©ussi"
      debug:
        msg: |
          ‚úÖ D√©ploiement Gitea termin√© avec succ√®s !
          
          üìä R√©sum√© du d√©ploiement :
          - Nom : {{ gitea_deployment_config.name }}
          - Namespace : {{ gitea_deployment_config.namespace }}
          - Version : {{ gitea_deployment_config.version }}
          - ID de d√©ploiement : {{ deployment_id }}
          - URL interne : {{ gitea_deployment_config.internal_url }}
          - URL externe : https://{{ gitea_deployment_config.domain }}
          - D√©ploy√© le : {{ ansible_date_time.iso8601 }}
          
          üîó Informations d'acc√®s :
          - Interface Web : https://{{ gitea_deployment_config.domain }}
          - Point d'acc√®s API : https://{{ gitea_deployment_config.domain }}/api/v1
          - V√©rification de sant√© : {{ gitea_deployment_config.internal_url }}/api/v1/version
          
          üìà Monitoring :
          - M√©triques : Disponibles via ServiceMonitor
          - Tableau de bord Grafana : D√©ploy√© dans le namespace monitoring
          - Logs : kubectl logs -n {{ gitea_deployment_config.namespace }} -l app.kubernetes.io/name=gitea

    - name: "D√©finir les variables de r√©sultat de d√©ploiement"
      set_fact:
        gitea_deployment_result:
          status: "success"
          deployment_id: "{{ deployment_id }}"
          internal_url: "{{ gitea_deployment_config.internal_url }}"
          external_url: "https://{{ gitea_deployment_config.domain }}"
          namespace: "{{ gitea_deployment_config.namespace }}"
          version: "{{ gitea_deployment_config.version }}"
          deployed_at: "{{ ansible_date_time.iso8601 }}"

  tags: [gitea, deploy, completion]

# =========================================================================
# GESTION D'ERREURS ET ROLLBACK
# =========================================================================
- name: "[GITEA-DEPLOY] G√©rer l'√©chec de d√©ploiement"
  block:
    - name: "Initier la proc√©dure de rollback"
      include_tasks: "rollback.yml"
      vars:
        rollback_reason: "deployment_failure"
        deployment_id: "{{ deployment_id }}"
      when: gitea_auto_rollback | default(true) | bool

    - name: "Mettre √† jour le statut de d√©ploiement comme √©chou√©"
      lions_vault_secret:
        vault_url: "{{ lions_vault_addr }}"
        vault_token: "{{ vault_token | default(omit) }}"
        path: "secret/gitea/deployment"
        data:
          status: "failed"
          deployment_id: "{{ deployment_id }}"
          failed_at: "{{ ansible_date_time.iso8601 }}"
          error_message: "{{ ansible_failed_result.msg | default('Erreur inconnue') }}"
        state: present
      when: lions_vault_enabled | default(true) | bool

    - name: "D√©finir les variables de r√©sultat d'√©chec"
      set_fact:
        gitea_deployment_result:
          status: "failed"
          deployment_id: "{{ deployment_id }}"
          failed_at: "{{ ansible_date_time.iso8601 }}"
          error_message: "{{ ansible_failed_result.msg | default('Erreur inconnue') }}"

  when: ansible_failed_task is defined
  tags: [gitea, deploy, error-handling]