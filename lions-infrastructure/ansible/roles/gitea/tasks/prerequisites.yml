---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - GITEA PREREQUISITES
# =========================================================================
# Description: VÃ©rification et prÃ©paration des prÃ©requis pour le dÃ©ploiement de Gitea
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: "{{ ansible_date_time.iso8601 }}"
# Documentation: https://docs.lions.dev/services/gitea/prerequisites
# =========================================================================

# =========================================================================
# VALIDATION DES VARIABLES REQUISES
# =========================================================================
- name: "ğŸ“‹ Validation des variables d'environnement critiques"
  block:
    - name: "ğŸ” VÃ©rification des variables obligatoires pour Gitea"
      ansible.builtin.assert:
        that:
          - lions_gitea_namespace is defined and lions_gitea_namespace != ""
          - lions_gitea_service_name is defined and lions_gitea_service_name != ""
          - lions_gitea_version is defined and lions_gitea_version != ""
          - lions_dns_full_domain is defined and lions_dns_full_domain != ""
          - lions_environment is defined and lions_environment != ""
        fail_msg: "âŒ Variables d'environnement critiques manquantes pour Gitea"
        success_msg: "âœ… Variables d'environnement critiques validÃ©es"

    - name: "ğŸ“Š Affichage de la configuration Gitea"
      ansible.builtin.debug:
        msg:
          - "ğŸ·ï¸  Service: {{ lions_gitea_service_name }}"
          - "ğŸ“¦ Version: {{ lions_gitea_version }}"
          - "ğŸ  Namespace: {{ lions_gitea_namespace }}"
          - "ğŸŒ Domaine: {{ lions_dns_full_domain }}"
          - "ğŸ”§ Environnement: {{ lions_environment }}"
      when: lions_debug_mode | default(false) | bool

  tags:
    - gitea
    - prerequisites
    - validation

# =========================================================================
# VÃ‰RIFICATION ET CRÃ‰ATION DU NAMESPACE
# =========================================================================
- name: "ğŸ—ï¸  Gestion du namespace Gitea"
  block:
    - name: "ğŸ” VÃ©rification de l'existence du namespace {{ lions_gitea_namespace }}"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ lions_gitea_namespace }}"
      register: _gitea_namespace_info
      failed_when: false

    - name: "ğŸ“ Information sur le namespace existant"
      ansible.builtin.debug:
        msg: "âœ… Namespace {{ lions_gitea_namespace }} existe dÃ©jÃ "
      when:
        - _gitea_namespace_info.resources is defined
        - _gitea_namespace_info.resources | length > 0

    - name: "ğŸš€ CrÃ©ation du namespace {{ lions_gitea_namespace }}"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ lions_gitea_namespace }}"
            labels:
              app.kubernetes.io/name: "{{ lions_gitea_service_name }}"
              app.kubernetes.io/component: "development"
              app.kubernetes.io/part-of: "lions-infrastructure"
              app.kubernetes.io/managed-by: "ansible"
              app.kubernetes.io/version: "{{ lions_gitea_version }}"
              environment: "{{ lions_environment }}"
              tier: "development"
            annotations:
              lions.dev/created-by: "ansible-playbook"
              lions.dev/creation-date: "{{ ansible_date_time.iso8601 }}"
              lions.dev/description: "Namespace pour les services Gitea"
      when:
        - _gitea_namespace_info.resources is not defined or _gitea_namespace_info.resources | length == 0
      register: _gitea_namespace_creation

    - name: "âœ… Confirmation de crÃ©ation du namespace"
      ansible.builtin.debug:
        msg: "ğŸ‰ Namespace {{ lions_gitea_namespace }} crÃ©Ã© avec succÃ¨s"
      when: _gitea_namespace_creation is changed

  tags:
    - gitea
    - prerequisites
    - namespace

# =========================================================================
# VÃ‰RIFICATION DES DROITS D'ACCÃˆS KUBERNETES
# =========================================================================
- name: "ğŸ” VÃ©rification des droits d'accÃ¨s Kubernetes"
  block:
    - name: "ğŸ§ª Test des droits d'Ã©criture dans le namespace"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "lions-gitea-access-check"
            namespace: "{{ lions_gitea_namespace }}"
            labels:
              app.kubernetes.io/name: "access-check"
              app.kubernetes.io/component: "test"
              temporary: "true"
          data:
            test: "access-verification"
            timestamp: "{{ ansible_date_time.iso8601 }}"
      register: _gitea_access_test
      failed_when: false

    - name: "ğŸ—‘ï¸  Nettoyage du ConfigMap de test"
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "lions-gitea-access-check"
        namespace: "{{ lions_gitea_namespace }}"
      when: _gitea_access_test is succeeded
      failed_when: false

    - name: "âŒ Ã‰chec de la vÃ©rification des droits d'accÃ¨s"
      ansible.builtin.fail:
        msg: |
          ğŸš« Droits d'accÃ¨s insuffisants pour dÃ©ployer Gitea dans le namespace {{ lions_gitea_namespace }}
          ğŸ’¡ VÃ©rifiez que le ServiceAccount a les permissions RBAC appropriÃ©es
      when: _gitea_access_test is failed

    - name: "âœ… Droits d'accÃ¨s validÃ©s"
      ansible.builtin.debug:
        msg: "ğŸ”“ Droits d'accÃ¨s au namespace {{ lions_gitea_namespace }} confirmÃ©s"
      when: _gitea_access_test is succeeded

  tags:
    - gitea
    - prerequisites
    - rbac

# =========================================================================
# VÃ‰RIFICATION DES DÃ‰PENDANCES INFRASTRUCTURE
# =========================================================================
- name: "ğŸ—ï¸  VÃ©rification des dÃ©pendances infrastructure"
  block:
    # VÃ©rification du registre Docker si activÃ©
    - name: "ğŸ³ VÃ©rification du registre Docker"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_registry_service_name | default('registry') }}"
        namespace: "{{ lions_registry_namespace | default('development') }}"
      register: _gitea_registry_info
      failed_when: false
      when: lions_registry_enabled | default(false) | bool

    - name: "âš ï¸  Avertissement registre Docker manquant"
      ansible.builtin.debug:
        msg: |
          âš ï¸  AVERTISSEMENT: Registre Docker non disponible
          ğŸ“ Service: {{ lions_registry_service_name | default('registry') }}
          ğŸ“ Namespace: {{ lions_registry_namespace | default('development') }}
          ğŸ’¡ Impact: Les fonctionnalitÃ©s de CI/CD intÃ©grÃ©es pourraient Ãªtre limitÃ©es
      when:
        - lions_registry_enabled | default(false) | bool
        - _gitea_registry_info is failed or (_gitea_registry_info.resources | default([]) | length == 0)

    # VÃ©rification de l'ingress controller (Traefik pour K3s)
    - name: "ğŸŒ VÃ©rification de l'ingress controller"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "traefik"
        namespace: "kube-system"
      register: _gitea_ingress_info
      failed_when: false

    - name: "âŒ Ingress controller critique manquant"
      ansible.builtin.fail:
        msg: |
          ğŸš« ERREUR CRITIQUE: Ingress controller Traefik non trouvÃ©
          ğŸ“ Service attendu: traefik dans kube-system
          ğŸ’¡ Solution: VÃ©rifiez que K3s est correctement installÃ© avec Traefik
      when:
        - _gitea_ingress_info is failed or (_gitea_ingress_info.resources | default([]) | length == 0)
        - not (lions_dry_run | default(false) | bool)

    - name: "âœ… Ingress controller validÃ©"
      ansible.builtin.debug:
        msg: "ğŸ¯ Ingress controller Traefik disponible pour Gitea"
      when: _gitea_ingress_info.resources | default([]) | length > 0

  tags:
    - gitea
    - prerequisites
    - infrastructure

# =========================================================================
# VÃ‰RIFICATION DE LA BASE DE DONNÃ‰ES
# =========================================================================
- name: "ğŸ—„ï¸  VÃ©rification de la base de donnÃ©es PostgreSQL"
  block:
    - name: "ğŸ” Recherche du service PostgreSQL"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_postgres_service_name | default('postgresql') }}"
        namespace: "{{ lions_postgres_namespace | default('database') }}"
      register: _gitea_postgres_info
      failed_when: false
      when: lions_postgres_enabled | default(true) | bool

    - name: "âŒ Base de donnÃ©es critique manquante"
      ansible.builtin.fail:
        msg: |
          ğŸš« ERREUR CRITIQUE: Service PostgreSQL non trouvÃ©
          ğŸ“ Service attendu: {{ lions_postgres_service_name | default('postgresql') }}
          ğŸ“ Namespace: {{ lions_postgres_namespace | default('database') }}
          ğŸ’¡ Solution: DÃ©ployez PostgreSQL avant Gitea ou configurez une base externe
      when:
        - lions_postgres_enabled | default(true) | bool
        - _gitea_postgres_info is failed or (_gitea_postgres_info.resources | default([]) | length == 0)
        - not (lions_dry_run | default(false) | bool)

    - name: "âœ… Base de donnÃ©es PostgreSQL validÃ©e"
      ansible.builtin.debug:
        msg: |
          âœ… Service PostgreSQL disponible
          ğŸ“ Service: {{ lions_postgres_service_name | default('postgresql') }}
          ğŸ“ Namespace: {{ lions_postgres_namespace | default('database') }}
      when:
        - lions_postgres_enabled | default(true) | bool
        - _gitea_postgres_info.resources | default([]) | length > 0

    - name: "â„¹ï¸  PostgreSQL dÃ©sactivÃ©"
      ansible.builtin.debug:
        msg: "â„¹ï¸  PostgreSQL dÃ©sactivÃ© - utilisation d'une base de donnÃ©es externe"
      when: not (lions_postgres_enabled | default(true) | bool)

  tags:
    - gitea
    - prerequisites
    - database

# =========================================================================
# VÃ‰RIFICATION DU STOCKAGE
# =========================================================================
- name: "ğŸ’¾ VÃ©rification du stockage"
  block:
    - name: "ğŸ” VÃ©rification de la StorageClass"
      kubernetes.core.k8s_info:
        api_version: storage.k8s.io/v1
        kind: StorageClass
        name: "{{ lions_storage_class_default | default('local-path') }}"
      register: _gitea_storage_info
      failed_when: false

    - name: "âŒ StorageClass critique manquante"
      ansible.builtin.fail:
        msg: |
          ğŸš« ERREUR CRITIQUE: StorageClass non trouvÃ©e
          ğŸ“ StorageClass attendue: {{ lions_storage_class_default | default('local-path') }}
          ğŸ’¡ Solution: VÃ©rifiez la configuration du provisioner de stockage K3s
      when:
        - _gitea_storage_info is failed or (_gitea_storage_info.resources | default([]) | length == 0)
        - not (lions_dry_run | default(false) | bool)

    - name: "âœ… StorageClass validÃ©e"
      ansible.builtin.debug:
        msg: |
          âœ… StorageClass disponible pour Gitea
          ğŸ“ StorageClass: {{ lions_storage_class_default | default('local-path') }}
          ğŸ“ Provisioner: {{ _gitea_storage_info.resources[0].provisioner | default('unknown') }}
      when: _gitea_storage_info.resources | default([]) | length > 0

  tags:
    - gitea
    - prerequisites
    - storage

# =========================================================================
# VÃ‰RIFICATION DE LA SÃ‰CURITÃ‰
# =========================================================================
- name: "ğŸ”’ VÃ©rification de la configuration sÃ©curitÃ©"
  block:
    - name: "ğŸ›¡ï¸  VÃ©rification des Network Policies"
      kubernetes.core.k8s_info:
        api_version: networking.k8s.io/v1
        kind: NetworkPolicy
        namespace: "{{ lions_gitea_namespace }}"
      register: _gitea_netpol_info
      failed_when: false
      when: lions_security_network_policies | default(true) | bool

    - name: "â„¹ï¸  Network Policies status"
      ansible.builtin.debug:
        msg: |
          {% if lions_security_network_policies | default(true) | bool %}
          ğŸ›¡ï¸  Network Policies activÃ©es ({{ _gitea_netpol_info.resources | default([]) | length }} politiques trouvÃ©es)
          {% else %}
          âš ï¸  Network Policies dÃ©sactivÃ©es - sÃ©curitÃ© rÃ©seau rÃ©duite
          {% endif %}

    - name: "ğŸ” VÃ©rification TLS/SSL"
      ansible.builtin.debug:
        msg: |
          {% if lions_security_tls_enabled | default(true) | bool %}
          ğŸ” TLS activÃ© - communications chiffrÃ©es
          ğŸ“ Provider: {{ lions_security_tls_provider | default('letsencrypt') }}
          {% if lions_security_tls_staging | default(true) | bool %}
          âš ï¸  Mode staging activÃ© - certificats de test
          {% endif %}
          {% else %}
          âš ï¸  TLS dÃ©sactivÃ© - communications non chiffrÃ©es
          {% endif %}

  tags:
    - gitea
    - prerequisites
    - security

# =========================================================================
# VÃ‰RIFICATION DU MONITORING
# =========================================================================
- name: "ğŸ“Š VÃ©rification du monitoring"
  block:
    - name: "ğŸ” VÃ©rification de Prometheus"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "prometheus-server"
        namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"
      register: _gitea_prometheus_info
      failed_when: false
      when: lions_monitoring_enabled | default(true) | bool

    - name: "ğŸ“ˆ Status monitoring"
      ansible.builtin.debug:
        msg: |
          {% if lions_monitoring_enabled | default(true) | bool %}
          {% if _gitea_prometheus_info.resources | default([]) | length > 0 %}
          âœ… Monitoring Prometheus disponible - mÃ©triques Gitea activÃ©es
          {% else %}
          âš ï¸  Prometheus non trouvÃ© - mÃ©triques limitÃ©es
          {% endif %}
          {% else %}
          â„¹ï¸  Monitoring dÃ©sactivÃ©
          {% endif %}

  tags:
    - gitea
    - prerequisites
    - monitoring

# =========================================================================
# RÃ‰SUMÃ‰ DES PRÃ‰REQUIS
# =========================================================================
- name: "ğŸ“‹ RÃ©sumÃ© de la vÃ©rification des prÃ©requis Gitea"
  ansible.builtin.debug:
    msg:
      - "ğŸ¯ === RÃ‰SUMÃ‰ PRÃ‰REQUIS GITEA ==="
      - "âœ… Namespace: {{ lions_gitea_namespace }}"
      - "âœ… Droits d'accÃ¨s: ValidÃ©s"
      - "{% if _gitea_ingress_info.resources | default([]) | length > 0 %}âœ…{% else %}âŒ{% endif %} Ingress Controller: {% if _gitea_ingress_info.resources | default([]) | length > 0 %}Disponible{% else %}Manquant{% endif %}"
      - "{% if _gitea_postgres_info.resources | default([]) | length > 0 or not lions_postgres_enabled | default(true) | bool %}âœ…{% else %}âŒ{% endif %} Base de donnÃ©es: {% if _gitea_postgres_info.resources | default([]) | length > 0 %}PostgreSQL OK{% elif not lions_postgres_enabled | default(true) | bool %}Externe{% else %}Manquante{% endif %}"
      - "{% if _gitea_storage_info.resources | default([]) | length > 0 %}âœ…{% else %}âŒ{% endif %} Stockage: {% if _gitea_storage_info.resources | default([]) | length > 0 %}{{ lions_storage_class_default | default('local-path') }}{% else %}Manquant{% endif %}"
      - "ğŸ”’ SÃ©curitÃ©: TLS {% if lions_security_tls_enabled | default(true) | bool %}âœ…{% else %}âŒ{% endif %} | NetPol {% if lions_security_network_policies | default(true) | bool %}âœ…{% else %}âŒ{% endif %}"
      - "ğŸ“Š Monitoring: {% if lions_monitoring_enabled | default(true) | bool and _gitea_prometheus_info.resources | default([]) | length > 0 %}âœ… ActivÃ©{% elif lions_monitoring_enabled | default(true) | bool %}âš ï¸ Partiel{% else %}âŒ DÃ©sactivÃ©{% endif %}"
      - "ğŸš€ PrÃªt pour le dÃ©ploiement: {% if not (lions_dry_run | default(false) | bool) %}OUI{% else %}MODE DRY-RUN{% endif %}"
  tags:
    - gitea
    - prerequisites
    - summary