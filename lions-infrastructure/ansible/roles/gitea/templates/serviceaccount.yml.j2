{#
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - GITEA SERVICEACCOUNT TEMPLATE
# =========================================================================
# Description: Template Kubernetes ServiceAccount pour Gitea
# Version: 5.0.0
# Auteur: LIONS DevOps Team
# Date de création: {{ ansible_date_time.iso8601 }}
# Documentation: https://docs.lions.dev/infrastructure/services/gitea
# =========================================================================
#}

---
apiVersion: v1
kind: ServiceAccount
metadata:
  # Nom du ServiceAccount basé sur les variables d'environnement
  name: "{{ lions_gitea_service_name | default('gitea') }}"
  namespace: "{{ lions_gitea_namespace | default('development') }}"

  # Labels standardisés LIONS Infrastructure
  labels:
    # Labels de base pour l'application
    app.kubernetes.io/name: "{{ lions_gitea_service_name | default('gitea') }}"
    app.kubernetes.io/instance: "{{ lions_gitea_service_name | default('gitea') }}-{{ lions_environment | default('development') }}"
    app.kubernetes.io/version: "{{ lions_gitea_version | default('1.20.5') }}"
    app.kubernetes.io/component: "git-service"
    app.kubernetes.io/part-of: "lions-infrastructure"
    app.kubernetes.io/managed-by: "ansible"

    # Labels d'environnement et déploiement
    lions.dev/environment: "{{ lions_environment | default('development') }}"
    lions.dev/tier: "development"
    lions.dev/category: "devtools"
    lions.dev/deployment-mode: "{{ lions_deployment_mode | default('single') }}"

    # Labels de versioning et maintenance
    lions.dev/config-version: "{{ lions_config_version | default('5.0.0') }}"
    lions.dev/deployed-by: "{{ ansible_user | default('ansible') }}"
    lions.dev/deployment-timestamp: "{{ ansible_date_time.epoch }}"

    # Labels de monitoring et observabilité
    lions.dev/monitoring: "{{ lions_monitoring_enabled | default('true') | string }}"
    lions.dev/backup: "{{ lions_backup_enabled | default('true') | string }}"
    lions.dev/service-mesh: "{{ lions_service_mesh_enabled | default('false') | string }}"

    # Labels de sécurité
    lions.dev/rbac: "{{ lions_security_rbac_enabled | default('true') | string }}"
    lions.dev/network-policy: "{{ lions_security_network_policies | default('true') | string }}"
    lions.dev/pod-security-standard: "{{ lions_security_pod_security_standards | default('restricted') }}"

  # Annotations pour métadonnées et configuration
  annotations:
    # Métadonnées de base
    lions.dev/description: "ServiceAccount pour Gitea - Service de gestion de dépôts Git pour l'environnement {{ lions_environment | default('development') }}"
    lions.dev/maintainer: "{{ lions_config_maintainer | default('devops@lions.dev') }}"
    lions.dev/documentation: "https://docs.lions.dev/infrastructure/services/gitea"
    lions.dev/support-channel: "#gitea-support"

    # Informations de déploiement
    lions.dev/deployed-at: "{{ ansible_date_time.iso8601 }}"
    lions.dev/ansible-playbook: "{{ ansible_playbook_python | default('unknown') }}"
    lions.dev/ansible-version: "{{ ansible_version.full | default('unknown') }}"
    lions.dev/deployment-id: "{{ deployment_id | default(ansible_date_time.epoch + '_' + inventory_hostname) }}"

    # Configuration technique
    lions.dev/service-type: "git-repository"
    lions.dev/data-classification: "internal"
    lions.dev/service-level: "{{ lions_service_level | default('standard') }}"
    lions.dev/high-availability: "{{ lions_k8s_ha_enabled | default('false') | string }}"

    # Informations de ressources
    lions.dev/resource-profile: "{{ lions_gitea_resource_profile | default('medium') }}"
    lions.dev/storage-class: "{{ lions_storage_class_default | default('local-path') }}"
    lions.dev/storage-size: "{{ lions_gitea_storage_size | default('10Gi') }}"

    # Configuration de sécurité
    lions.dev/tls-enabled: "{{ lions_security_tls_enabled | default('true') | string }}"
    lions.dev/encryption-at-rest: "{{ lions_security_encryption_at_rest | default('true') | string }}"
    lions.dev/secrets-management: "{{ lions_vault_enabled | default('true') | string }}"

    # Configuration de backup
    lions.dev/backup-schedule: "{{ lions_backup_schedule | default('0 2 * * *') }}"
    lions.dev/backup-retention: "{{ lions_backup_retention_days | default('30') }}d"
    lions.dev/backup-encryption: "{{ lions_backup_encryption | default('true') | string }}"

    # Monitoring et alerting
    lions.dev/prometheus-scrape: "{{ lions_prometheus_enabled | default('true') | string }}"
    lions.dev/grafana-dashboard: "{{ lions_grafana_enabled | default('true') | string }}"
    lions.dev/log-level: "{{ lions_log_level | default('INFO') }}"

    # Conformité et audit
    lions.dev/compliance-level: "{{ lions_compliance_level | default('standard') }}"
    lions.dev/audit-enabled: "{{ lions_audit_enabled | default('true') | string }}"
    lions.dev/data-retention: "{{ lions_data_retention_days | default('365') }}d"

    # Configuration spécifique Gitea
    gitea.lions.dev/admin-user: "{{ lions_gitea_admin_user | default('git-admin') }}"
    gitea.lions.dev/ssh-enabled: "{{ lions_gitea_ssh_enabled | default('true') | string }}"
    gitea.lions.dev/lfs-enabled: "{{ lions_gitea_lfs_enabled | default('true') | string }}"
    gitea.lions.dev/webhook-enabled: "{{ lions_gitea_webhook_enabled | default('true') | string }}"

    # Intégrations externes
    {% if lions_keycloak_enabled | default('false') | bool %}
    gitea.lions.dev/oidc-provider: "keycloak"
    gitea.lions.dev/oidc-endpoint: "https://keycloak.{{ lions_dns_full_domain }}/realms/{{ lions_keycloak_realm | default('lions') }}"
    {% endif %}

    {% if lions_registry_enabled | default('false') | bool %}
    gitea.lions.dev/container-registry: "registry.{{ lions_dns_full_domain }}"
    {% endif %}

    # Configuration réseau et exposition
    {% if lions_dns_wildcard_enabled | default('true') | bool %}
    gitea.lions.dev/external-url: "https://gitea.{{ lions_dns_full_domain }}"
    {% else %}
    gitea.lions.dev/external-url: "https://{{ lions_dns_full_domain }}/gitea"
    {% endif %}

    # Gestion des certificats
    {% if lions_security_tls_enabled | default('true') | bool %}
    gitea.lions.dev/tls-issuer: "{{ lions_security_tls_provider | default('letsencrypt') }}"
    gitea.lions.dev/cert-manager: "{{ lions_cert_manager_enabled | default('true') | string }}"
    {% endif %}

# Configuration automatique des permissions RBAC si activé
{% if lions_security_rbac_enabled | default('true') | bool %}
automountServiceAccountToken: true
{% else %}
automountServiceAccountToken: false
{% endif %}

# Secrets associés automatiquement montés
{% if lions_vault_enabled | default('true') | bool %}
secrets:
  - name: "{{ lions_gitea_service_name | default('gitea') }}-vault-secrets"
{% endif %}

# Configuration d'image pull secrets si registry privé activé
{% if lions_registry_enabled | default('true') | bool and lions_registry_auth_required | default('false') | bool %}
imagePullSecrets:
  - name: "{{ lions_registry_service_name | default('registry') }}-credentials"
{% endif %}