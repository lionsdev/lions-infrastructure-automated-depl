---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - V√âRIFICATION PR√âREQUIS QUARKUS
# =========================================================================
# Description: V√©rification compl√®te des pr√©requis pour le d√©ploiement Quarkus
# R√¥le: quarkus
# Composant: prerequisites
# Version: 5.0.0
# Maintainer: DevOps Team <devops@lions.dev>
# Documentation: https://docs.lions.dev/infrastructure/roles/quarkus
# =========================================================================

# =========================================================================
# VALIDATION DE LA CONFIGURATION QUARKUS
# =========================================================================
- name: "üìã [QUARKUS] Validation de la configuration des variables"
  block:
    - name: "üîç V√©rification des variables obligatoires"
      assert:
        that:
          - lions_quarkus_namespace is defined
          - lions_quarkus_namespace | length > 0
          - lions_quarkus_service_name is defined
          - lions_quarkus_service_name | length > 0
          - lions_dns_full_domain is defined
          - lions_dns_full_domain | length > 0
        fail_msg: "‚ùå Variables obligatoires manquantes pour Quarkus"
        success_msg: "‚úÖ Variables obligatoires Quarkus valid√©es"

    - name: "üìä Affichage de la configuration Quarkus"
      debug:
        msg:
          - "üè∑Ô∏è  Namespace: {{ lions_quarkus_namespace }}"
          - "üîß Service: {{ lions_quarkus_service_name }}"
          - "üåê Domaine: {{ lions_dns_full_domain }}"
          - "üö¢ Port: {{ lions_quarkus_port }}"
          - "üì¶ Version: {{ lions_quarkus_version | default('latest') }}"
      when: lions_debug_mode | default(false) | bool

  tags: [prerequisites, config, validation]

# =========================================================================
# V√âRIFICATION DE L'INFRASTRUCTURE KUBERNETES
# =========================================================================
- name: "üèóÔ∏è [INFRASTRUCTURE] V√©rification de l'infrastructure Kubernetes"
  block:
    - name: "üîç V√©rification de la connectivit√© au cluster K8s"
      k8s_info:
        api_version: v1
        kind: Namespace
        name: kube-system
      register: k8s_connectivity
      failed_when: k8s_connectivity.resources | length == 0
      retries: 3
      delay: 5

    - name: "‚úÖ Confirmation de la connectivit√© K8s"
      debug:
        msg: "üéØ Connexion au cluster Kubernetes √©tablie avec succ√®s"

    - name: "üîç V√©rification de la version Kubernetes"
      k8s_info:
        api_version: v1
        kind: Node
      register: k8s_nodes
      failed_when: k8s_nodes.resources | length == 0

    - name: "üìä Information sur les n≈ìuds Kubernetes"
      debug:
        msg:
          - "üñ•Ô∏è  Nombre de n≈ìuds: {{ k8s_nodes.resources | length }}"
          - "üìã Versions K8s: {{ k8s_nodes.resources | map(attribute='status.nodeInfo.kubeletVersion') | unique | list }}"
      when: lions_debug_mode | default(false) | bool

  rescue:
    - name: "‚ùå √âchec de la v√©rification Kubernetes"
      fail:
        msg: |
          üö® ERREUR CRITIQUE: Impossible de se connecter au cluster Kubernetes
          
          üìã Actions recommand√©es:
          1. V√©rifier que kubectl est configur√© correctement
          2. V√©rifier la connectivit√© r√©seau au cluster
          3. V√©rifier que le cluster K3s est d√©marr√©
          4. Consulter les logs: kubectl get nodes -o wide

  tags: [prerequisites, kubernetes, connectivity]

# =========================================================================
# V√âRIFICATION DU NAMESPACE CIBLE
# =========================================================================
- name: "üìÅ [NAMESPACE] V√©rification du namespace {{ lions_quarkus_namespace }}"
  block:
    - name: "üîç V√©rification de l'existence du namespace"
      k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ lions_quarkus_namespace }}"
      register: quarkus_namespace_info

    - name: "üìã Cr√©ation du namespace si n√©cessaire"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ lions_quarkus_namespace }}"
            labels:
              name: "{{ lions_quarkus_namespace }}"
              component: "application"
              managed-by: "lions-infrastructure"
              environment: "{{ lions_environment }}"
              version: "{{ lions_config_version }}"
            annotations:
              description: "Namespace pour les applications Quarkus"
              contact: "{{ lions_config_maintainer }}"
              created-by: "ansible-lions-infrastructure"
      when: quarkus_namespace_info.resources | length == 0
      register: namespace_creation

    - name: "‚úÖ Confirmation du namespace"
      debug:
        msg: "üéØ Namespace '{{ lions_quarkus_namespace }}' {% if namespace_creation.changed %}cr√©√©{% else %}existant{% endif %} et accessible"

  tags: [prerequisites, namespace, creation]

# =========================================================================
# V√âRIFICATION DES DROITS D'ACC√àS
# =========================================================================
- name: "üîê [PERMISSIONS] V√©rification des droits d'acc√®s"
  block:
    - name: "üß™ Test de cr√©ation d'une ressource temporaire"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "lions-quarkus-access-test"
            namespace: "{{ lions_quarkus_namespace }}"
            labels:
              test: "access-verification"
              component: "quarkus"
              temporary: "true"
          data:
            test: "access-granted"
            timestamp: "{{ ansible_date_time.iso8601 }}"
      register: access_test_creation

    - name: "üß™ Test de lecture de la ressource"
      k8s_info:
        api_version: v1
        kind: ConfigMap
        name: "lions-quarkus-access-test"
        namespace: "{{ lions_quarkus_namespace }}"
      register: access_test_read

    - name: "üß™ Test de modification de la ressource"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "lions-quarkus-access-test"
            namespace: "{{ lions_quarkus_namespace }}"
          data:
            test: "access-granted"
            timestamp: "{{ ansible_date_time.iso8601 }}"
            modified: "true"
      register: access_test_update

    - name: "üßπ Nettoyage de la ressource de test"
      k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "lions-quarkus-access-test"
        namespace: "{{ lions_quarkus_namespace }}"
      register: access_test_cleanup

    - name: "‚úÖ Validation des permissions compl√®tes"
      debug:
        msg: "üéØ Droits d'acc√®s complets valid√©s (CRUD) sur le namespace {{ lions_quarkus_namespace }}"

  rescue:
    - name: "üßπ Nettoyage en cas d'erreur"
      k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "lions-quarkus-access-test"
        namespace: "{{ lions_quarkus_namespace }}"
      ignore_errors: true

    - name: "‚ùå √âchec des permissions"
      fail:
        msg: |
          üö® ERREUR CRITIQUE: Droits d'acc√®s insuffisants
          
          üìã Permissions requises sur le namespace '{{ lions_quarkus_namespace }}':
          - Cr√©er des ressources (ConfigMaps, Deployments, Services)
          - Lire les ressources existantes
          - Modifier les ressources
          - Supprimer les ressources
          
          üîß Actions recommand√©es:
          1. V√©rifier les ClusterRoles et RoleBindings
          2. Consulter: kubectl auth can-i --list --namespace={{ lions_quarkus_namespace }}
          3. V√©rifier la configuration RBAC

  tags: [prerequisites, permissions, rbac]

# =========================================================================
# V√âRIFICATION DU REGISTRE DE CONTENEURS
# =========================================================================
- name: "üì¶ [REGISTRY] V√©rification du registre de conteneurs"
  block:
    - name: "üîç V√©rification du service registre"
      k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_registry_service_name }}"
        namespace: "{{ lions_registry_namespace }}"
      register: registry_service_info
      when: lions_registry_enabled | default(true) | bool

    - name: "üîç V√©rification du d√©ploiement registre"
      k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ lions_registry_service_name }}"
        namespace: "{{ lions_registry_namespace }}"
      register: registry_deployment_info
      when: lions_registry_enabled | default(true) | bool

    - name: "‚úÖ Registre de conteneurs disponible"
      debug:
        msg: "üéØ Registre de conteneurs '{{ lions_registry_service_name }}' accessible"
      when:
        - lions_registry_enabled | default(true) | bool
        - registry_service_info.resources | length > 0
        - registry_deployment_info.resources | length > 0

    - name: "‚ö†Ô∏è Avertissement registre non disponible"
      debug:
        msg: "‚ö†Ô∏è  ATTENTION: Registre de conteneurs non disponible - utilisation d'un registre externe requis"
      when:
        - lions_registry_enabled | default(true) | bool
        - (registry_service_info.resources | length == 0 or registry_deployment_info.resources | length == 0)

  tags: [prerequisites, registry, containers]

# =========================================================================
# V√âRIFICATION DE L'INGRESS CONTROLLER
# =========================================================================
- name: "üåê [INGRESS] V√©rification de l'Ingress Controller"
  block:
    - name: "üîç Recherche de Traefik (K3s par d√©faut)"
      k8s_info:
        api_version: v1
        kind: Service
        name: traefik
        namespace: kube-system
      register: traefik_info

    - name: "üîç Recherche de NGINX Ingress Controller"
      k8s_info:
        api_version: v1
        kind: Service
        name: ingress-nginx-controller
        namespace: ingress-nginx
      register: nginx_ingress_info

    - name: "üîç Recherche d'autres Ingress Controllers"
      k8s_info:
        api_version: v1
        kind: Service
        label_selectors:
          - "app.kubernetes.io/component=controller"
      register: generic_ingress_info

    - name: "‚úÖ Ingress Controller trouv√©"
      debug:
        msg: |
          üéØ Ingress Controller disponible:
          {% if traefik_info.resources | length > 0 %}
          - Traefik (K3s int√©gr√©) ‚úÖ
          {% endif %}
          {% if nginx_ingress_info.resources | length > 0 %}
          - NGINX Ingress Controller ‚úÖ
          {% endif %}
      when: >
        traefik_info.resources | length > 0 or 
        nginx_ingress_info.resources | length > 0 or
        generic_ingress_info.resources | length > 0

    - name: "‚ö†Ô∏è Aucun Ingress Controller d√©tect√©"
      debug:
        msg: |
          ‚ö†Ô∏è  ATTENTION: Aucun Ingress Controller d√©tect√©
          
          üìã Impact:
          - L'application Quarkus ne sera pas accessible via URL externe
          - Seul l'acc√®s interne au cluster sera possible
          
          üîß Solutions recommand√©es:
          1. Installer Traefik: kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/v2.10/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml
          2. Installer NGINX: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml
          3. Utiliser NodePort pour l'acc√®s externe
      when: >
        traefik_info.resources | length == 0 and 
        nginx_ingress_info.resources | length == 0 and
        generic_ingress_info.resources | length == 0

  tags: [prerequisites, ingress, networking]

# =========================================================================
# V√âRIFICATION DES D√âPENDANCES DE SERVICES
# =========================================================================
- name: "üîó [DEPENDENCIES] V√©rification des d√©pendances de services"
  block:
    - name: "üîç V√©rification de PostgreSQL"
      k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_postgres_service_name }}"
        namespace: "{{ lions_postgres_namespace }}"
      register: postgres_service_info
      when: lions_postgres_enabled | default(true) | bool

    - name: "üîç V√©rification de Redis"
      k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_redis_service_name }}"
        namespace: "{{ lions_redis_namespace }}"
      register: redis_service_info
      when: lions_redis_enabled | default(true) | bool

    - name: "üîç V√©rification de Keycloak"
      k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_keycloak_service_name }}"
        namespace: "{{ lions_keycloak_namespace }}"
      register: keycloak_service_info
      when: lions_keycloak_enabled | default(true) | bool

    - name: "üìä Rapport des d√©pendances"
      debug:
        msg:
          - "üìä √âtat des d√©pendances de services:"
          - "  üóÑÔ∏è  PostgreSQL: {% if lions_postgres_enabled and postgres_service_info.resources | length > 0 %}‚úÖ Disponible{% elif lions_postgres_enabled %}‚ùå Indisponible{% else %}‚è≠Ô∏è  D√©sactiv√©{% endif %}"
          - "  üîÑ Redis: {% if lions_redis_enabled and redis_service_info.resources | length > 0 %}‚úÖ Disponible{% elif lions_redis_enabled %}‚ùå Indisponible{% else %}‚è≠Ô∏è  D√©sactiv√©{% endif %}"
          - "  üîê Keycloak: {% if lions_keycloak_enabled and keycloak_service_info.resources | length > 0 %}‚úÖ Disponible{% elif lions_keycloak_enabled %}‚ùå Indisponible{% else %}‚è≠Ô∏è  D√©sactiv√©{% endif %}"

  tags: [prerequisites, dependencies, services]

# =========================================================================
# V√âRIFICATION DES RESSOURCES SYST√àME
# =========================================================================
- name: "‚ö° [RESOURCES] V√©rification des ressources syst√®me"
  block:
    - name: "üîç V√©rification des ressources des n≈ìuds"
      k8s_info:
        api_version: v1
        kind: Node
      register: node_resources

    - name: "üìä Analyse des ressources disponibles"
      set_fact:
        total_cpu: "{{ node_resources.resources | map(attribute='status.capacity.cpu') | map('int') | sum }}"
        total_memory: "{{ node_resources.resources | map(attribute='status.capacity.memory') | map('regex_replace', 'Ki$', '') | map('int') | sum }}"

    - name: "üîç V√©rification des quotas de ressources"
      k8s_info:
        api_version: v1
        kind: ResourceQuota
        namespace: "{{ lions_quarkus_namespace }}"
      register: resource_quota_info

    - name: "üìä Rapport des ressources syst√®me"
      debug:
        msg:
          - "üìä Ressources cluster disponibles:"
          - "  üñ•Ô∏è  CPU total: {{ total_cpu }} c≈ìurs"
          - "  üíæ M√©moire totale: {{ (total_memory | int / 1024 / 1024) | round(1) }} GB"
          - "  üìã ResourceQuotas actifs: {{ resource_quota_info.resources | length }}"
          - "üìã Ressources requises pour Quarkus:"
          - "  üñ•Ô∏è  CPU: {{ lions_resources_medium_cpu_request }} - {{ lions_resources_medium_cpu_limit }}"
          - "  üíæ M√©moire: {{ lions_resources_medium_memory_request }} - {{ lions_resources_medium_memory_limit }}"
      when: lions_debug_mode | default(false) | bool

    - name: "‚ö†Ô∏è Avertissement ressources limit√©es"
      debug:
        msg: "‚ö†Ô∏è  ATTENTION: Ressources syst√®me limit√©es d√©tect√©es - surveiller les performances"
      when: total_cpu | int < 2 or (total_memory | int / 1024 / 1024) < 4

  tags: [prerequisites, resources, capacity]

# =========================================================================
# V√âRIFICATION DE LA CONFIGURATION TLS/SSL
# =========================================================================
- name: "üîí [TLS] V√©rification de la configuration TLS/SSL"
  block:
    - name: "üîç V√©rification de cert-manager"
      k8s_info:
        api_version: v1
        kind: Service
        name: cert-manager
        namespace: cert-manager
      register: cert_manager_info
      when: lions_security_tls_enabled | default(true) | bool

    - name: "üîç V√©rification des ClusterIssuers"
      k8s_info:
        api_version: cert-manager.io/v1
        kind: ClusterIssuer
      register: cluster_issuers_info
      when: lions_security_tls_enabled | default(true) | bool

    - name: "‚úÖ Configuration TLS valid√©e"
      debug:
        msg: |
          üéØ Configuration TLS/SSL:
          - cert-manager: {% if cert_manager_info.resources | length > 0 %}‚úÖ Disponible{% else %}‚ùå Indisponible{% endif %}
          - ClusterIssuers: {{ cluster_issuers_info.resources | length }} configur√©s
      when: lions_security_tls_enabled | default(true) | bool

    - name: "‚ö†Ô∏è TLS d√©sactiv√©"
      debug:
        msg: "‚ö†Ô∏è  ATTENTION: TLS d√©sactiv√© - communications non chiffr√©es"
      when: not (lions_security_tls_enabled | default(true) | bool)

  tags: [prerequisites, tls, security]

# =========================================================================
# RAPPORT FINAL DES PR√âREQUIS
# =========================================================================
- name: "üìã [SUMMARY] Rapport final des pr√©requis Quarkus"
  debug:
    msg:
      - "üéØ =========================================="
      - "üìã RAPPORT FINAL - PR√âREQUIS QUARKUS"
      - "üéØ =========================================="
      - "‚úÖ Configuration valid√©e"
      - "‚úÖ Cluster Kubernetes accessible"
      - "‚úÖ Namespace '{{ lions_quarkus_namespace }}' pr√©par√©"
      - "‚úÖ Permissions RBAC valid√©es"
      - "üì¶ Registre: {% if lions_registry_enabled %}Configur√©{% else %}Externe requis{% endif %}"
      - "üåê Ingress: {% if traefik_info.resources | length > 0 or nginx_ingress_info.resources | length > 0 %}Disponible{% else %}Configuration manuelle requise{% endif %}"
      - "üîí TLS: {% if lions_security_tls_enabled %}Activ√©{% else %}D√©sactiv√©{% endif %}"
      - "üéØ Statut: PR√äT POUR LE D√âPLOIEMENT ‚úÖ"
      - "üéØ =========================================="
  tags: [prerequisites, summary, final]