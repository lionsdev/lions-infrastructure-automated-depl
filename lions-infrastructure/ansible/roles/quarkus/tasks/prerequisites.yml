---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - VÃ‰RIFICATION PRÃ‰REQUIS QUARKUS
# =========================================================================
# Description: VÃ©rification complÃ¨te des prÃ©requis pour le dÃ©ploiement Quarkus
# RÃ´le: quarkus
# Composant: prerequisites
# Version: 5.0.0
# Maintainer: DevOps Team <devops@lions.dev>
# Documentation: https://docs.lions.dev/infrastructure/roles/quarkus
# =========================================================================

# =========================================================================
# VALIDATION DE LA CONFIGURATION QUARKUS
# =========================================================================
- name: "ğŸ“‹ [QUARKUS] Validation de la configuration des variables"
  block:
    - name: "ğŸ” VÃ©rification des variables obligatoires"
      assert:
        that:
          - lions_quarkus_namespace is defined
          - lions_quarkus_namespace | length > 0
          - lions_quarkus_service_name is defined
          - lions_quarkus_service_name | length > 0
          - lions_dns_full_domain is defined
          - lions_dns_full_domain | length > 0
        fail_msg: "âŒ Variables obligatoires manquantes pour Quarkus"
        success_msg: "âœ… Variables obligatoires Quarkus validÃ©es"

    - name: "ğŸ“Š Affichage de la configuration Quarkus"
      debug:
        msg:
          - "ğŸ·ï¸  Namespace: {{ lions_quarkus_namespace }}"
          - "ğŸ”§ Service: {{ lions_quarkus_service_name }}"
          - "ğŸŒ Domaine: {{ lions_dns_full_domain }}"
          - "ğŸš¢ Port: {{ lions_quarkus_port }}"
          - "ğŸ“¦ Version: {{ lions_quarkus_version | default('latest') }}"
      when: lions_debug_mode | default(false) | bool

  tags: [prerequisites, config, validation]

# =========================================================================
# VÃ‰RIFICATION DE L'INFRASTRUCTURE KUBERNETES
# =========================================================================
- name: "ğŸ—ï¸ [INFRASTRUCTURE] VÃ©rification de l'infrastructure Kubernetes"
  block:
    - name: "ğŸ” VÃ©rification de la connectivitÃ© au cluster K8s"
      k8s_info:
        api_version: v1
        kind: Namespace
        name: kube-system
      register: k8s_connectivity
      failed_when: k8s_connectivity.resources | length == 0
      retries: 3
      delay: 5

    - name: "âœ… Confirmation de la connectivitÃ© K8s"
      debug:
        msg: "ğŸ¯ Connexion au cluster Kubernetes Ã©tablie avec succÃ¨s"

    - name: "ğŸ” VÃ©rification de la version Kubernetes"
      k8s_info:
        api_version: v1
        kind: Node
      register: k8s_nodes
      failed_when: k8s_nodes.resources | length == 0

    - name: "ğŸ“Š Information sur les nÅ“uds Kubernetes"
      debug:
        msg:
          - "ğŸ–¥ï¸  Nombre de nÅ“uds: {{ k8s_nodes.resources | length }}"
          - "ğŸ“‹ Versions K8s: {{ k8s_nodes.resources | map(attribute='status.nodeInfo.kubeletVersion') | unique | list }}"
      when: lions_debug_mode | default(false) | bool

  rescue:
    - name: "âŒ Ã‰chec de la vÃ©rification Kubernetes"
      fail:
        msg: |
          ğŸš¨ ERREUR CRITIQUE: Impossible de se connecter au cluster Kubernetes
          
          ğŸ“‹ Actions recommandÃ©es:
          1. VÃ©rifier que kubectl est configurÃ© correctement
          2. VÃ©rifier la connectivitÃ© rÃ©seau au cluster
          3. VÃ©rifier que le cluster K3s est dÃ©marrÃ©
          4. Consulter les logs: kubectl get nodes -o wide

  tags: [prerequisites, kubernetes, connectivity]

# =========================================================================
# VÃ‰RIFICATION DU NAMESPACE CIBLE
# =========================================================================
- name: "ğŸ“ [NAMESPACE] VÃ©rification du namespace {{ lions_quarkus_namespace }}"
  block:
    - name: "ğŸ” VÃ©rification de l'existence du namespace"
      k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ lions_quarkus_namespace }}"
      register: quarkus_namespace_info

    - name: "ğŸ“‹ CrÃ©ation du namespace si nÃ©cessaire"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ lions_quarkus_namespace }}"
            labels:
              name: "{{ lions_quarkus_namespace }}"
              component: "application"
              managed-by: "lions-infrastructure"
              environment: "{{ lions_environment }}"
              version: "{{ lions_config_version }}"
            annotations:
              description: "Namespace pour les applications Quarkus"
              contact: "{{ lions_config_maintainer }}"
              created-by: "ansible-lions-infrastructure"
      when: quarkus_namespace_info.resources | length == 0
      register: namespace_creation

    - name: "âœ… Confirmation du namespace"
      debug:
        msg: "ğŸ¯ Namespace '{{ lions_quarkus_namespace }}' {% if namespace_creation.changed %}crÃ©Ã©{% else %}existant{% endif %} et accessible"

  tags: [prerequisites, namespace, creation]

# =========================================================================
# VÃ‰RIFICATION DES DROITS D'ACCÃˆS
# =========================================================================
- name: "ğŸ” [PERMISSIONS] VÃ©rification des droits d'accÃ¨s"
  block:
    - name: "ğŸ§ª Test de crÃ©ation d'une ressource temporaire"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "lions-quarkus-access-test"
            namespace: "{{ lions_quarkus_namespace }}"
            labels:
              test: "access-verification"
              component: "quarkus"
              temporary: "true"
          data:
            test: "access-granted"
            timestamp: "{{ ansible_date_time.iso8601 }}"
      register: access_test_creation

    - name: "ğŸ§ª Test de lecture de la ressource"
      k8s_info:
        api_version: v1
        kind: ConfigMap
        name: "lions-quarkus-access-test"
        namespace: "{{ lions_quarkus_namespace }}"
      register: access_test_read

    - name: "ğŸ§ª Test de modification de la ressource"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "lions-quarkus-access-test"
            namespace: "{{ lions_quarkus_namespace }}"
          data:
            test: "access-granted"
            timestamp: "{{ ansible_date_time.iso8601 }}"
            modified: "true"
      register: access_test_update

    - name: "ğŸ§¹ Nettoyage de la ressource de test"
      k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "lions-quarkus-access-test"
        namespace: "{{ lions_quarkus_namespace }}"
      register: access_test_cleanup

    - name: "âœ… Validation des permissions complÃ¨tes"
      debug:
        msg: "ğŸ¯ Droits d'accÃ¨s complets validÃ©s (CRUD) sur le namespace {{ lions_quarkus_namespace }}"

  rescue:
    - name: "ğŸ§¹ Nettoyage en cas d'erreur"
      k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "lions-quarkus-access-test"
        namespace: "{{ lions_quarkus_namespace }}"
      ignore_errors: true

    - name: "âŒ Ã‰chec des permissions"
      fail:
        msg: |
          ğŸš¨ ERREUR CRITIQUE: Droits d'accÃ¨s insuffisants
          
          ğŸ“‹ Permissions requises sur le namespace '{{ lions_quarkus_namespace }}':
          - CrÃ©er des ressources (ConfigMaps, Deployments, Services)
          - Lire les ressources existantes
          - Modifier les ressources
          - Supprimer les ressources
          
          ğŸ”§ Actions recommandÃ©es:
          1. VÃ©rifier les ClusterRoles et RoleBindings
          2. Consulter: kubectl auth can-i --list --namespace={{ lions_quarkus_namespace }}
          3. VÃ©rifier la configuration RBAC

  tags: [prerequisites, permissions, rbac]

# =========================================================================
# VÃ‰RIFICATION DU REGISTRE DE CONTENEURS
# =========================================================================
- name: "ğŸ“¦ [REGISTRY] VÃ©rification du registre de conteneurs"
  block:
    - name: "ğŸ” VÃ©rification du service registre"
      k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_registry_service_name }}"
        namespace: "{{ lions_registry_namespace }}"
      register: registry_service_info
      when: lions_registry_enabled | default(true) | bool

    - name: "ğŸ” VÃ©rification du dÃ©ploiement registre"
      k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: "{{ lions_registry_service_name }}"
        namespace: "{{ lions_registry_namespace }}"
      register: registry_deployment_info
      when: lions_registry_enabled | default(true) | bool

    - name: "âœ… Registre de conteneurs disponible"
      debug:
        msg: "ğŸ¯ Registre de conteneurs '{{ lions_registry_service_name }}' accessible"
      when:
        - lions_registry_enabled | default(true) | bool
        - registry_service_info.resources | length > 0
        - registry_deployment_info.resources | length > 0

    - name: "âš ï¸ Avertissement registre non disponible"
      debug:
        msg: "âš ï¸  ATTENTION: Registre de conteneurs non disponible - utilisation d'un registre externe requis"
      when:
        - lions_registry_enabled | default(true) | bool
        - (registry_service_info.resources | length == 0 or registry_deployment_info.resources | length == 0)

  tags: [prerequisites, registry, containers]

# =========================================================================
# VÃ‰RIFICATION DE L'INGRESS CONTROLLER
# =========================================================================
- name: "ğŸŒ [INGRESS] VÃ©rification de l'Ingress Controller"
  block:
    - name: "ğŸ” Recherche de Traefik (K3s par dÃ©faut)"
      k8s_info:
        api_version: v1
        kind: Service
        name: traefik
        namespace: kube-system
      register: traefik_info

    - name: "ğŸ” Recherche de NGINX Ingress Controller"
      k8s_info:
        api_version: v1
        kind: Service
        name: ingress-nginx-controller
        namespace: ingress-nginx
      register: nginx_ingress_info

    - name: "ğŸ” Recherche d'autres Ingress Controllers"
      k8s_info:
        api_version: v1
        kind: Service
        label_selectors:
          - "app.kubernetes.io/component=controller"
      register: generic_ingress_info

    - name: "âœ… Ingress Controller trouvÃ©"
      debug:
        msg: |
          ğŸ¯ Ingress Controller disponible:
          {% if traefik_info.resources | length > 0 %}
          - Traefik (K3s intÃ©grÃ©) âœ…
          {% endif %}
          {% if nginx_ingress_info.resources | length > 0 %}
          - NGINX Ingress Controller âœ…
          {% endif %}
      when: >
        traefik_info.resources | length > 0 or 
        nginx_ingress_info.resources | length > 0 or
        generic_ingress_info.resources | length > 0

    - name: "âš ï¸ Aucun Ingress Controller dÃ©tectÃ©"
      debug:
        msg: |
          âš ï¸  ATTENTION: Aucun Ingress Controller dÃ©tectÃ©
          
          ğŸ“‹ Impact:
          - L'application Quarkus ne sera pas accessible via URL externe
          - Seul l'accÃ¨s interne au cluster sera possible
          
          ğŸ”§ Solutions recommandÃ©es:
          1. Installer Traefik: kubectl apply -f https://raw.githubusercontent.com/traefik/traefik/v2.10/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml
          2. Installer NGINX: kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml
          3. Utiliser NodePort pour l'accÃ¨s externe
      when: >
        traefik_info.resources | length == 0 and 
        nginx_ingress_info.resources | length == 0 and
        generic_ingress_info.resources | length == 0

  tags: [prerequisites, ingress, networking]

# =========================================================================
# VÃ‰RIFICATION DES DÃ‰PENDANCES DE SERVICES
# =========================================================================
- name: "ğŸ”— [DEPENDENCIES] VÃ©rification des dÃ©pendances de services"
  block:
    - name: "ğŸ” VÃ©rification de PostgreSQL"
      k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_postgres_service_name }}"
        namespace: "{{ lions_postgres_namespace }}"
      register: postgres_service_info
      when: lions_postgres_enabled | default(true) | bool

    - name: "ğŸ” VÃ©rification de Redis"
      k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_redis_service_name }}"
        namespace: "{{ lions_redis_namespace }}"
      register: redis_service_info
      when: lions_redis_enabled | default(true) | bool

    - name: "ğŸ” VÃ©rification de Keycloak"
      k8s_info:
        api_version: v1
        kind: Service
        name: "{{ lions_keycloak_service_name }}"
        namespace: "{{ lions_keycloak_namespace }}"
      register: keycloak_service_info
      when: lions_keycloak_enabled | default(true) | bool

    - name: "ğŸ“Š Rapport des dÃ©pendances"
      debug:
        msg:
          - "ğŸ“Š Ã‰tat des dÃ©pendances de services:"
          - "  ğŸ—„ï¸  PostgreSQL: {% if lions_postgres_enabled and postgres_service_info.resources | length > 0 %}âœ… Disponible{% elif lions_postgres_enabled %}âŒ Indisponible{% else %}â­ï¸  DÃ©sactivÃ©{% endif %}"
          - "  ğŸ”„ Redis: {% if lions_redis_enabled and redis_service_info.resources | length > 0 %}âœ… Disponible{% elif lions_redis_enabled %}âŒ Indisponible{% else %}â­ï¸  DÃ©sactivÃ©{% endif %}"
          - "  ğŸ” Keycloak: {% if lions_keycloak_enabled and keycloak_service_info.resources | length > 0 %}âœ… Disponible{% elif lions_keycloak_enabled %}âŒ Indisponible{% else %}â­ï¸  DÃ©sactivÃ©{% endif %}"

  tags: [prerequisites, dependencies, services]

# =========================================================================
# VÃ‰RIFICATION DES RESSOURCES SYSTÃˆME
# =========================================================================
- name: "âš¡ [RESOURCES] VÃ©rification des ressources systÃ¨me"
  block:
    - name: "ğŸ” VÃ©rification des ressources des nÅ“uds"
      k8s_info:
        api_version: v1
        kind: Node
      register: node_resources

    - name: "ğŸ“Š Analyse des ressources disponibles"
      set_fact:
        total_cpu: "{{ node_resources.resources | map(attribute='status.capacity.cpu') | map('int') | sum }}"
        total_memory: "{{ node_resources.resources | map(attribute='status.capacity.memory') | map('regex_replace', 'Ki$', '') | map('int') | sum }}"

    - name: "ğŸ” VÃ©rification des quotas de ressources"
      k8s_info:
        api_version: v1
        kind: ResourceQuota
        namespace: "{{ lions_quarkus_namespace }}"
      register: resource_quota_info

    - name: "ğŸ“Š Rapport des ressources systÃ¨me"
      debug:
        msg:
          - "ğŸ“Š Ressources cluster disponibles:"
          - "  ğŸ–¥ï¸  CPU total: {{ total_cpu }} cÅ“urs"
          - "  ğŸ’¾ MÃ©moire totale: {{ (total_memory | int / 1024 / 1024) | round(1) }} GB"
          - "  ğŸ“‹ ResourceQuotas actifs: {{ resource_quota_info.resources | length }}"
          - "ğŸ“‹ Ressources requises pour Quarkus:"
          - "  ğŸ–¥ï¸  CPU: {{ lions_resources_medium_cpu_request }} - {{ lions_resources_medium_cpu_limit }}"
          - "  ğŸ’¾ MÃ©moire: {{ lions_resources_medium_memory_request }} - {{ lions_resources_medium_memory_limit }}"
      when: lions_debug_mode | default(false) | bool

    - name: "âš ï¸ Avertissement ressources limitÃ©es"
      debug:
        msg: "âš ï¸  ATTENTION: Ressources systÃ¨me limitÃ©es dÃ©tectÃ©es - surveiller les performances"
      when: total_cpu | int < 2 or (total_memory | int / 1024 / 1024) < 4

  tags: [prerequisites, resources, capacity]

# =========================================================================
# VÃ‰RIFICATION DE LA CONFIGURATION TLS/SSL
# =========================================================================
- name: "ğŸ”’ [TLS] VÃ©rification de la configuration TLS/SSL"
  block:
    - name: "ğŸ” VÃ©rification de cert-manager"
      k8s_info:
        api_version: v1
        kind: Service
        name: cert-manager
        namespace: cert-manager
      register: cert_manager_info
      when: lions_security_tls_enabled | default(true) | bool

    - name: "ğŸ” VÃ©rification des ClusterIssuers"
      k8s_info:
        api_version: cert-manager.io/v1
        kind: ClusterIssuer
      register: cluster_issuers_info
      when: lions_security_tls_enabled | default(true) | bool

    - name: "âœ… Configuration TLS validÃ©e"
      debug:
        msg: |
          ğŸ¯ Configuration TLS/SSL:
          - cert-manager: {% if cert_manager_info.resources | length > 0 %}âœ… Disponible{% else %}âŒ Indisponible{% endif %}
          - ClusterIssuers: {{ cluster_issuers_info.resources | length }} configurÃ©s
      when: lions_security_tls_enabled | default(true) | bool

    - name: "âš ï¸ TLS dÃ©sactivÃ©"
      debug:
        msg: "âš ï¸  ATTENTION: TLS dÃ©sactivÃ© - communications non chiffrÃ©es"
      when: not (lions_security_tls_enabled | default(true) | bool)

  tags: [prerequisites, tls, security]

# =========================================================================
# RAPPORT FINAL DES PRÃ‰REQUIS
# =========================================================================
- name: "ğŸ“‹ [SUMMARY] Rapport final des prÃ©requis Quarkus"
  debug:
    msg:
      - "ğŸ¯ =========================================="
      - "ğŸ“‹ RAPPORT FINAL - PRÃ‰REQUIS QUARKUS"
      - "ğŸ¯ =========================================="
      - "âœ… Configuration validÃ©e"
      - "âœ… Cluster Kubernetes accessible"
      - "âœ… Namespace '{{ lions_quarkus_namespace }}' prÃ©parÃ©"
      - "âœ… Permissions RBAC validÃ©es"
      - "ğŸ“¦ Registre: {% if lions_registry_enabled %}ConfigurÃ©{% else %}Externe requis{% endif %}"
      - "ğŸŒ Ingress: {% if traefik_info.resources | length > 0 or nginx_ingress_info.resources | length > 0 %}Disponible{% else %}Configuration manuelle requise{% endif %}"
      - "ğŸ”’ TLS: {% if lions_security_tls_enabled %}ActivÃ©{% else %}DÃ©sactivÃ©{% endif %}"
      - "ğŸ¯ Statut: PRÃŠT POUR LE DÃ‰PLOIEMENT âœ…"
      - "ğŸ¯ =========================================="
  tags: [prerequisites, summary, final]