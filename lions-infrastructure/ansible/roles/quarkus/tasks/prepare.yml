---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - PRÃ‰PARATION QUARKUS
# =========================================================================
# Description: PrÃ©paration et validation des ressources pour dÃ©ploiement Quarkus
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: "{{ ansible_date_time.iso8601 }}"
# Environnement: "{{ lions_environment | default('development') }}"
# =========================================================================

- name: "ğŸ“‹ Initialisation des variables de prÃ©paration Quarkus"
  set_fact:
    quarkus_prep_config:
      namespace: "{{ lions_quarkus_namespace }}"
      app_name: "{{ lions_quarkus_service_name }}"
      app_version: "{{ lions_quarkus_version | default('latest') }}"
      environment: "{{ lions_environment }}"
      debug_mode: "{{ lions_debug_mode | default(false) }}"
      dry_run: "{{ lions_dry_run | default(false) }}"
      timestamp: "{{ ansible_date_time.epoch }}"
    quarkus_temp_config:
      base_dir: "/tmp/lions-quarkus-{{ ansible_date_time.epoch }}"
      templates_dir: "templates"
      manifests_dir: "manifests"
      cleanup_on_failure: true
    quarkus_required_templates:
      - name: "deployment"
        src: "deployment.yml.j2"
        dest: "deployment.yml"
        required: true
      - name: "service"
        src: "service.yml.j2"
        dest: "service.yml"
        required: true
      - name: "ingress"
        src: "ingress.yml.j2"
        dest: "ingress.yml"
        required: "{{ lions_security_tls_enabled | default(true) }}"
      - name: "ingress-traefik"
        src: "ingress-traefik.yml.j2"
        dest: "ingress-traefik.yml"
        required: "{{ lions_k8s_traefik_enabled | default(true) }}"
      - name: "configmap"
        src: "configmap.yml.j2"
        dest: "configmap.yml"
        required: true
      - name: "serviceaccount"
        src: "serviceaccount.yml.j2"
        dest: "serviceaccount.yml"
        required: "{{ lions_security_rbac_enabled | default(true) }}"
      - name: "servicemonitor"
        src: "servicemonitor.yml.j2"
        dest: "servicemonitor.yml"
        required: "{{ lions_monitoring_enabled | default(true) }}"
  tags:
    - quarkus
    - preparation
    - initialization

- name: "ğŸ” Validation des prÃ©requis pour Quarkus"
  block:
    - name: "VÃ©rification de la disponibilitÃ© du cluster Kubernetes"
      k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ quarkus_prep_config.namespace }}"
      register: quarkus_namespace_check
      failed_when: false

    - name: "Validation des variables critiques"
      assert:
        that:
          - quarkus_prep_config.namespace is defined
          - quarkus_prep_config.namespace | length > 0
          - quarkus_prep_config.app_name is defined
          - quarkus_prep_config.app_name | length > 0
          - lions_quarkus_enabled | default(false) | bool
        fail_msg: "âŒ Variables critiques manquantes pour Quarkus"
        success_msg: "âœ… Variables critiques validÃ©es"

    - name: "VÃ©rification de l'Ã©tat du namespace"
      debug:
        msg: |
          ğŸ“Š Ã‰tat du namespace {{ quarkus_prep_config.namespace }}:
          - Existe: {{ quarkus_namespace_check.resources | length > 0 }}
          - Ã‰tat: {{ quarkus_namespace_check.resources[0].status.phase if quarkus_namespace_check.resources | length > 0 else 'Non trouvÃ©' }}

  rescue:
    - name: "âŒ Ã‰chec de la validation des prÃ©requis"
      fail:
        msg: "La validation des prÃ©requis a Ã©chouÃ©. VÃ©rifiez la configuration et la connectivitÃ© Kubernetes."

  tags:
    - quarkus
    - validation
    - prerequisites

- name: "ğŸ“ CrÃ©ation de la structure de rÃ©pertoires temporaires"
  block:
    - name: "CrÃ©ation du rÃ©pertoire de base temporaire"
      file:
        path: "{{ quarkus_temp_config.base_dir }}"
        state: directory
        mode: '0750'
      register: quarkus_temp_base_dir
      changed_when: false

    - name: "CrÃ©ation des sous-rÃ©pertoires"
      file:
        path: "{{ quarkus_temp_config.base_dir }}/{{ item }}"
        state: directory
        mode: '0750'
      loop:
        - "{{ quarkus_temp_config.templates_dir }}"
        - "{{ quarkus_temp_config.manifests_dir }}"
        - "logs"
        - "backup"
      changed_when: false

    - name: "Enregistrement du rÃ©pertoire temporaire"
      set_fact:
        quarkus_working_dir: "{{ quarkus_temp_base_dir.path }}"
        cacheable: false

  rescue:
    - name: "âŒ Ã‰chec de crÃ©ation des rÃ©pertoires temporaires"
      fail:
        msg: "Impossible de crÃ©er la structure de rÃ©pertoires temporaires dans {{ quarkus_temp_config.base_dir }}"

  tags:
    - quarkus
    - preparation
    - filesystem

- name: "ğŸ“ GÃ©nÃ©ration des manifestes Kubernetes pour Quarkus"
  block:
    - name: "GÃ©nÃ©ration des templates requis"
      template:
        src: "{{ item.src }}"
        dest: "{{ quarkus_working_dir }}/{{ quarkus_temp_config.manifests_dir }}/{{ item.dest }}"
        mode: '0640'
        backup: true
      loop: "{{ quarkus_required_templates }}"
      when: item.required | bool
      register: quarkus_templates_generated
      notify:
        - "backup quarkus manifests"

    - name: "Validation de la syntaxe YAML des manifestes"
      include_tasks: validate_yaml_syntax.yml
      vars:
        manifest_file: "{{ quarkus_working_dir }}/{{ quarkus_temp_config.manifests_dir }}/{{ item.dest }}"
      loop: "{{ quarkus_required_templates }}"
      when: item.required | bool

    - name: "GÃ©nÃ©ration du rÃ©sumÃ© des manifestes"
      template:
        src: "manifest-summary.yml.j2"
        dest: "{{ quarkus_working_dir }}/manifest-summary.yml"
        mode: '0640'
      vars:
        generated_manifests: "{{ quarkus_templates_generated.results | selectattr('changed') | list }}"

  rescue:
    - name: "âŒ Ã‰chec de gÃ©nÃ©ration des manifestes"
      debug:
        msg: "Erreur lors de la gÃ©nÃ©ration des manifestes Kubernetes pour {{ quarkus_prep_config.app_name }}"

    - name: "Nettoyage en cas d'Ã©chec"
      file:
        path: "{{ quarkus_working_dir }}"
        state: absent
      when: quarkus_temp_config.cleanup_on_failure | bool

    - name: "ArrÃªt du processus"
      fail:
        msg: "GÃ©nÃ©ration des manifestes Ã©chouÃ©e. VÃ©rifiez les templates et les variables."

  tags:
    - quarkus
    - templates
    - manifests

- name: "ğŸ”’ PrÃ©paration des ressources de sÃ©curitÃ©"
  block:
    - name: "CrÃ©ation du ServiceAccount"
      k8s:
        state: present
        definition: "{{ lookup('file', quarkus_working_dir + '/' + quarkus_temp_config.manifests_dir + '/serviceaccount.yml') | from_yaml }}"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: "{{ lions_timeout_default | default(300) }}"
      register: quarkus_serviceaccount_result
      when: lions_security_rbac_enabled | default(true) | bool

    - name: "VÃ©rification des secrets d'application"
      k8s_info:
        api_version: v1
        kind: Secret
        namespace: "{{ quarkus_prep_config.namespace }}"
        name: "{{ quarkus_prep_config.app_name }}-secrets"
      register: quarkus_secrets_check

    - name: "CrÃ©ation des secrets par dÃ©faut si nÃ©cessaires"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ quarkus_prep_config.app_name }}-secrets"
            namespace: "{{ quarkus_prep_config.namespace }}"
            labels:
              app.kubernetes.io/name: "{{ quarkus_prep_config.app_name }}"
              app.kubernetes.io/component: "application"
              app.kubernetes.io/part-of: "lions-infrastructure"
              app.kubernetes.io/managed-by: "ansible"
              lions.dev/environment: "{{ quarkus_prep_config.environment }}"
          type: Opaque
          data:
            # Secrets par dÃ©faut - Ã€ remplacer par les vraies valeurs
            app-secret: "{{ 'changeme' | b64encode }}"
      when:
        - quarkus_secrets_check.resources | length == 0
        - not lions_dry_run | default(false) | bool
      register: quarkus_default_secrets_created

  rescue:
    - name: "âš ï¸ Avertissement pour les ressources de sÃ©curitÃ©"
      debug:
        msg: |
          âš ï¸ ProblÃ¨me lors de la prÃ©paration des ressources de sÃ©curitÃ©:
          - ServiceAccount: {{ 'OK' if quarkus_serviceaccount_result is succeeded else 'ERREUR' }}
          - Secrets: {{ 'Existants' if quarkus_secrets_check.resources | length > 0 else 'CrÃ©Ã©s par dÃ©faut' }}

  tags:
    - quarkus
    - security
    - rbac

- name: "âš™ï¸ PrÃ©paration de la configuration applicative"
  block:
    - name: "CrÃ©ation du ConfigMap principal"
      k8s:
        state: present
        definition: "{{ lookup('file', quarkus_working_dir + '/' + quarkus_temp_config.manifests_dir + '/configmap.yml') | from_yaml }}"
        wait: true
        wait_timeout: "{{ lions_timeout_default | default(300) }}"
      register: quarkus_configmap_result

    - name: "Validation de la configuration Quarkus"
      k8s_info:
        api_version: v1
        kind: ConfigMap
        namespace: "{{ quarkus_prep_config.namespace }}"
        name: "{{ quarkus_prep_config.app_name }}-config"
      register: quarkus_config_validation

    - name: "GÃ©nÃ©ration du manifeste de validation des ressources"
      template:
        src: "resource-validation.yml.j2"
        dest: "{{ quarkus_working_dir }}/resource-validation.yml"
        mode: '0640'
      vars:
        validation_results:
          serviceaccount: "{{ quarkus_serviceaccount_result | default({}) }}"
          configmap: "{{ quarkus_configmap_result }}"
          secrets: "{{ quarkus_secrets_check }}"

  rescue:
    - name: "âŒ Ã‰chec de prÃ©paration de la configuration"
      debug:
        msg: "Erreur lors de la crÃ©ation des ressources de configuration pour {{ quarkus_prep_config.app_name }}"

    - name: "Diagnostic des erreurs de configuration"
      debug:
        var: quarkus_configmap_result
      when: quarkus_configmap_result is failed

  tags:
    - quarkus
    - configuration
    - configmap

- name: "ğŸ“Š Collecte des informations de prÃ©paration"
  block:
    - name: "Collecte des statistiques de prÃ©paration"
      set_fact:
        quarkus_preparation_summary:
          status: "completed"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          environment: "{{ quarkus_prep_config.environment }}"
          namespace: "{{ quarkus_prep_config.namespace }}"
          app_name: "{{ quarkus_prep_config.app_name }}"
          working_directory: "{{ quarkus_working_dir }}"
          generated_manifests: "{{ quarkus_templates_generated.results | selectattr('changed') | map(attribute='dest') | list }}"
          resources_created:
            serviceaccount: "{{ quarkus_serviceaccount_result is succeeded }}"
            configmap: "{{ quarkus_configmap_result is succeeded }}"
            secrets: "{{ quarkus_secrets_check.resources | length > 0 or quarkus_default_secrets_created is succeeded }}"
          next_steps:
            - "ExÃ©cuter les tÃ¢ches de dÃ©ploiement"
            - "VÃ©rifier les logs d'application"
            - "Configurer le monitoring"
        cacheable: false

    - name: "Affichage du rÃ©sumÃ© de prÃ©paration"
      debug:
        msg: |
          âœ… PrÃ©paration Quarkus terminÃ©e avec succÃ¨s!
          
          ğŸ“‹ RÃ©sumÃ©:
          - Application: {{ quarkus_preparation_summary.app_name }}
          - Namespace: {{ quarkus_preparation_summary.namespace }}
          - Environnement: {{ quarkus_preparation_summary.environment }}
          - RÃ©pertoire de travail: {{ quarkus_preparation_summary.working_directory }}
          
          ğŸ“„ Manifestes gÃ©nÃ©rÃ©s: {{ quarkus_preparation_summary.generated_manifests | length }}
          {{ quarkus_preparation_summary.generated_manifests | join(', ') }}
          
          ğŸ”§ Ressources crÃ©Ã©es:
          - ServiceAccount: {{ 'âœ…' if quarkus_preparation_summary.resources_created.serviceaccount else 'âŒ' }}
          - ConfigMap: {{ 'âœ…' if quarkus_preparation_summary.resources_created.configmap else 'âŒ' }}
          - Secrets: {{ 'âœ…' if quarkus_preparation_summary.resources_created.secrets else 'âŒ' }}

  rescue:
    - name: "âš ï¸ PrÃ©paration complÃ©tÃ©e avec des avertissements"
      debug:
        msg: "La prÃ©paration s'est terminÃ©e mais avec des avertissements. VÃ©rifiez les logs pour plus de dÃ©tails."

  always:
    - name: "ğŸ’¾ Sauvegarde des logs de prÃ©paration"
      copy:
        content: "{{ quarkus_preparation_summary | to_nice_yaml }}"
        dest: "{{ quarkus_working_dir }}/logs/preparation-summary-{{ ansible_date_time.epoch }}.yml"
        mode: '0640'
      when: quarkus_preparation_summary is defined

  tags:
    - quarkus
    - summary
    - reporting

- name: "ğŸ§¹ Nettoyage et finalisation"
  block:
    - name: "Conservation des manifestes importants"
      synchronize:
        src: "{{ quarkus_working_dir }}/{{ quarkus_temp_config.manifests_dir }}/"
        dest: "{{ lions_storage_base_path | default('/opt/lions/storage') }}/manifests/quarkus/{{ quarkus_prep_config.environment }}/"
        mode: push
        archive: true
        delete: false
      delegate_to: localhost
      when: not lions_dry_run | default(false) | bool

    - name: "Mise Ã  jour du registre des dÃ©ploiements"
      lineinfile:
        path: "{{ lions_storage_base_path | default('/opt/lions/storage') }}/deployment-registry.log"
        line: "{{ ansible_date_time.iso8601 }} PREPARE {{ quarkus_prep_config.app_name }} {{ quarkus_prep_config.namespace }} {{ quarkus_prep_config.environment }} SUCCESS"
        create: true
        mode: '0640'
      when: not lions_dry_run | default(false) | bool

  rescue:
    - name: "âš ï¸ Avertissement de nettoyage"
      debug:
        msg: "Impossible de finaliser complÃ¨tement le nettoyage, mais la prÃ©paration principale a rÃ©ussi."

  tags:
    - quarkus
    - cleanup
    - finalization