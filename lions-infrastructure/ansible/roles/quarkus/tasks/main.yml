---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - RÃ”LE QUARKUS REFACTORISÃ‰
# =========================================================================
# Description: Orchestrateur principal pour le dÃ©ploiement d'applications Quarkus
# Version: 5.0.0
# Maintainer: DevOps Team <devops@lions.dev>
# Documentation: https://docs.lions.dev/infrastructure/applications/quarkus
# Standards: DevOps 5.0, GitOps, Cloud Native, Security First
# =========================================================================

# =========================================================================
# CHARGEMENT DES VARIABLES ET VALIDATION INITIALE
# =========================================================================
- name: "Quarkus | Chargement des variables d'environnement standardisÃ©es"
  set_fact:
    # Alignement avec les nouvelles variables d'environnement .env
    quarkus_config:
      enabled: "{{ LIONS_QUARKUS_ENABLED | default(lions_quarkus_enabled) | default(false) | bool }}"
      version: "{{ LIONS_QUARKUS_VERSION | default(lions_quarkus_version) | default('3.6.0') }}"
      namespace: "{{ LIONS_QUARKUS_NAMESPACE | default(lions_quarkus_namespace) | default('applications') }}"
      service_name: "{{ LIONS_QUARKUS_SERVICE_NAME | default(lions_quarkus_service_name) | default('quarkus-app') }}"
      port: "{{ LIONS_QUARKUS_PORT | default(lions_quarkus_port) | default(8080) | int }}"
      image_repository: "{{ LIONS_QUARKUS_IMAGE_REPOSITORY | default(lions_quarkus_image_repository) | default('quay.io/quarkus/quarkus') }}"
      backup_enabled: "{{ LIONS_QUARKUS_BACKUP_ENABLED | default(lions_quarkus_backup_enabled) | default(true) | bool }}"

    # Configuration des ressources avec fallback intelligent
    quarkus_resources:
      profile: "{{ LIONS_QUARKUS_RESOURCE_PROFILE | default(lions_quarkus_resource_profile) | default('medium') }}"
      cpu_request: "{{ LIONS_RESOURCES_MEDIUM_CPU_REQUEST | default(lions_resources_medium_cpu_request) | default('200m') }}"
      cpu_limit: "{{ LIONS_RESOURCES_MEDIUM_CPU_LIMIT | default(lions_resources_medium_cpu_limit) | default('1000m') }}"
      memory_request: "{{ LIONS_RESOURCES_MEDIUM_MEMORY_REQUEST | default(lions_resources_medium_memory_request) | default('512Mi') }}"
      memory_limit: "{{ LIONS_RESOURCES_MEDIUM_MEMORY_LIMIT | default(lions_resources_medium_memory_limit) | default('2Gi') }}"
      storage_size: "{{ LIONS_STORAGE_PV_SIZE_MEDIUM | default(lions_storage_pv_size_medium) | default('20Gi') }}"

    # Configuration environnementale
    quarkus_environment:
      name: "{{ LIONS_ENVIRONMENT | default(lions_environment) | default('development') }}"
      domain: "{{ LIONS_DNS_FULL_DOMAIN | default(lions_dns_full_domain) | default('lions.local') }}"
      debug_mode: "{{ LIONS_DEBUG_MODE | default(lions_debug_mode) | default(false) | bool }}"
      dry_run: "{{ LIONS_DRY_RUN | default(lions_dry_run) | default(false) | bool }}"

    # Configuration sÃ©curitÃ©
    quarkus_security:
      tls_enabled: "{{ LIONS_SECURITY_TLS_ENABLED | default(lions_security_tls_enabled) | default(true) | bool }}"
      network_policies: "{{ LIONS_SECURITY_NETWORK_POLICIES | default(lions_security_network_policies) | default(true) | bool }}"
      pod_security_standards: "{{ LIONS_SECURITY_POD_SECURITY_STANDARDS | default(lions_security_pod_security_standards) | default('restricted') }}"
      rbac_enabled: "{{ LIONS_SECURITY_RBAC_ENABLED | default(lions_security_rbac_enabled) | default(true) | bool }}"
  tags:
    - quarkus
    - variables
    - always

- name: "Quarkus | Validation prÃ©alable de l'activation du service"
  fail:
    msg: |
      âŒ Le service Quarkus n'est pas activÃ© dans la configuration.
      
      Pour activer Quarkus, dÃ©finissez:
      - LIONS_QUARKUS_ENABLED=true dans le fichier .env
      - Ou lions_quarkus_enabled: true dans les variables Ansible
      
      Configuration actuelle: {{ quarkus_config.enabled }}
  when: not quarkus_config.enabled | bool
  tags:
    - quarkus
    - validation
    - always

# =========================================================================
# MÃ‰TADONNÃ‰ES ET TÃ‰LÃ‰MÃ‰TRIE DE DÃ‰PLOIEMENT
# =========================================================================
- name: "Quarkus | Initialisation des mÃ©tadonnÃ©es de dÃ©ploiement enrichies"
  set_fact:
    quarkus_deployment_metadata:
      # MÃ©tadonnÃ©es de base
      role_name: "quarkus"
      role_version: "5.0.0"
      deployment_id: "{{ ansible_date_time.epoch }}"
      deployment_uuid: "{{ ansible_date_time.epoch + '-' + ansible_hostname + '-' + (99999 | random) }}"

      # Contexte environnemental
      environment: "{{ quarkus_environment.name }}"
      namespace: "{{ quarkus_config.namespace }}"
      cluster_info:
        name: "{{ ansible_hostname }}"
        node_count: "{{ groups['all'] | length if groups['all'] is defined else 1 }}"
        architecture: "{{ ansible_architecture | default('unknown') }}"

      # Horodatage et traÃ§abilitÃ©
      started_at: "{{ ansible_date_time.iso8601 }}"
      started_by: "{{ ansible_user_id | default('system') }}"
      initiated_from: "{{ ansible_hostname }}"
      ansible_version: "{{ ansible_version.full }}"

      # Configuration de dÃ©ploiement
      config_hash: "{{ (quarkus_config | to_json) | hash('sha256') }}"
      feature_flags:
        monitoring_enabled: "{{ LIONS_MONITORING_ENABLED | default(lions_monitoring_enabled) | default(true) | bool }}"
        backup_enabled: "{{ quarkus_config.backup_enabled }}"
        vault_integration: "{{ LIONS_VAULT_ENABLED | default(lions_vault_enabled) | default(true) | bool }}"
        autoscaling_enabled: "{{ LIONS_AUTOSCALING_ENABLED | default(lions_autoscaling_enabled) | default(true) | bool }}"

    # Configuration de gestion d'erreurs avancÃ©e
    quarkus_deployment_config:
      dry_run: "{{ quarkus_environment.dry_run }}"
      debug_mode: "{{ quarkus_environment.debug_mode }}"
      skip_validation: "{{ quarkus_skip_validation | default(false) | bool }}"
      force_recreate: "{{ quarkus_force_recreate | default(false) | bool }}"
      max_retries: "{{ LIONS_QUARKUS_MAX_RETRIES | default(quarkus_max_retries) | default(3) | int }}"
      retry_delay: "{{ LIONS_QUARKUS_RETRY_DELAY | default(quarkus_retry_delay) | default(10) | int }}"
      timeout_deployment: "{{ LIONS_TIMEOUT_DEPLOYMENT | default(lions_timeout_deployment) | default(1800) | int }}"
      rollback_on_failure: "{{ LIONS_QUARKUS_ROLLBACK_ON_FAILURE | default(quarkus_rollback_on_failure) | default(true) | bool }}"
  tags:
    - quarkus
    - metadata
    - always

- name: "Quarkus | Inclusion des variables Traefik optimisÃ©es"
  include_vars:
    file: traefik.yml
  when: LIONS_K8S_TRAEFIK_ENABLED | default(lions_k8s_traefik_enabled) | default(true) | bool
  tags:
    - quarkus
    - traefik
    - ingress

- name: "Quarkus | Affichage du tableau de bord de dÃ©ploiement"
  debug:
    msg:
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘                ğŸš€ DÃ‰PLOIEMENT QUARKUS 5.0                     â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ ğŸ“Š Environnement      â”‚ {{ (quarkus_deployment_metadata.environment + '                    ')[:19] }} â•‘"
      - "â•‘ ğŸ·ï¸  Namespace          â”‚ {{ (quarkus_deployment_metadata.namespace + '                    ')[:19] }} â•‘"
      - "â•‘ â˜• Version Quarkus     â”‚ {{ (quarkus_config.version + '                    ')[:19] }} â•‘"
      - "â•‘ ğŸ†” ID de dÃ©ploiement  â”‚ {{ (quarkus_deployment_metadata.deployment_uuid[:19] + '...') if quarkus_deployment_metadata.deployment_uuid | length > 19 else (quarkus_deployment_metadata.deployment_uuid + '                    ')[:19] }} â•‘"
      - "â•‘ â° DÃ©marrÃ© le         â”‚ {{ (quarkus_deployment_metadata.started_at + '                    ')[:19] }} â•‘"
      - "â•‘ ğŸ‘¤ InitiÃ© par         â”‚ {{ (quarkus_deployment_metadata.started_by + '                    ')[:19] }} â•‘"
      - "â•‘ ğŸ”§ Mode debug         â”‚ {{ ('ActivÃ©' if quarkus_deployment_config.debug_mode else 'DÃ©sactivÃ©') + '                    ' }}                    â•‘"[:20]
      - "â•‘ ğŸ§ª Dry run            â”‚ {{ ('ActivÃ©' if quarkus_deployment_config.dry_run else 'DÃ©sactivÃ©') + '                    ' }}                    â•‘"[:20]
      - "â•‘ ğŸ“ˆ Monitoring         â”‚ {{ ('ActivÃ©' if quarkus_deployment_metadata.feature_flags.monitoring_enabled else 'DÃ©sactivÃ©') + '                    ' }}                    â•‘"[:20]
      - "â•‘ ğŸ” IntÃ©gration Vault  â”‚ {{ ('ActivÃ©' if quarkus_deployment_metadata.feature_flags.vault_integration else 'DÃ©sactivÃ©') + '                    ' }}                    â•‘"[:20]
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  when: quarkus_deployment_config.debug_mode | bool
  tags:
    - quarkus
    - debug
    - dashboard

# =========================================================================
# GESTION AVANCÃ‰E DES ERREURS ET OBSERVABILITÃ‰
# =========================================================================
- name: "Quarkus | Configuration de la tÃ©lÃ©mÃ©trie et gestion d'erreurs"
  set_fact:
    quarkus_error_handling:
      max_retries: "{{ quarkus_deployment_config.max_retries }}"
      retry_delay: "{{ quarkus_deployment_config.retry_delay }}"
      rollback_on_failure: "{{ quarkus_deployment_config.rollback_on_failure }}"
      error_log_file: "/tmp/quarkus-deployment-{{ quarkus_deployment_metadata.deployment_id }}.log"
      metrics_file: "/tmp/quarkus-metrics-{{ quarkus_deployment_metadata.deployment_id }}.json"
      trace_id: "{{ quarkus_deployment_metadata.deployment_uuid }}"

    # MÃ©triques de performance
    quarkus_performance_metrics:
      deployment_start_time: "{{ ansible_date_time.epoch | int }}"
      phase_timings: {}
      resource_usage: {}

    # Configuration d'observabilitÃ©
    quarkus_observability:
      metrics_enabled: "{{ quarkus_deployment_metadata.feature_flags.monitoring_enabled }}"
      tracing_enabled: "{{ LIONS_QUARKUS_TRACING_ENABLED | default(lions_quarkus_tracing_enabled) | default(true) | bool }}"
      logging_level: "{{ LIONS_LOG_LEVEL | default(lions_log_level) | default('INFO') }}"
      alerts_enabled: "{{ LIONS_QUARKUS_ALERTS_ENABLED | default(lions_quarkus_alerts_enabled) | default(true) | bool }}"
  tags:
    - quarkus
    - error-handling
    - observability
    - always

# =========================================================================
# INTÃ‰GRATION VAULT POUR LA GESTION DES SECRETS
# =========================================================================
- name: "Quarkus | Configuration de l'intÃ©gration Vault"
  block:
    - name: "Quarkus | RÃ©cupÃ©ration des secrets depuis Vault"
      community.hashi_vault.vault_kv2_get:
        url: "{{ LIONS_VAULT_ADDR | default(lions_vault_addr) }}"
        path: "quarkus/{{ quarkus_environment.name }}"
        mount_point: "secrets"
      register: quarkus_vault_secrets
      no_log: true
      when: not quarkus_deployment_config.dry_run | bool

    - name: "Quarkus | Configuration des secrets Quarkus"
      set_fact:
        quarkus_secrets:
          database_password: "{{ quarkus_vault_secrets.secret.database_password | default('') }}"
          jwt_secret: "{{ quarkus_vault_secrets.secret.jwt_secret | default('') }}"
          admin_password: "{{ quarkus_vault_secrets.secret.admin_password | default('') }}"
          registry_credentials: "{{ quarkus_vault_secrets.secret.registry_credentials | default('') }}"
      no_log: true
      when:
        - not quarkus_deployment_config.dry_run | bool
        - quarkus_vault_secrets is defined
        - quarkus_vault_secrets.secret is defined

  rescue:
    - name: "Quarkus | Gestion d'erreur Vault - Utilisation des secrets par dÃ©faut"
      debug:
        msg: "âš ï¸  Impossible de rÃ©cupÃ©rer les secrets depuis Vault, utilisation des valeurs par dÃ©faut"

    - name: "Quarkus | Configuration des secrets par dÃ©faut"
      set_fact:
        quarkus_secrets:
          database_password: "{{ lookup('password', '/tmp/quarkus-db-password chars=ascii_letters,digits length=32') }}"
          jwt_secret: "{{ lookup('password', '/tmp/quarkus-jwt-secret chars=ascii_letters,digits length=64') }}"
          admin_password: "{{ lookup('password', '/tmp/quarkus-admin-password chars=ascii_letters,digits length=16') }}"
          registry_credentials: ""
      no_log: true

  when: quarkus_deployment_metadata.feature_flags.vault_integration | bool
  tags:
    - quarkus
    - vault
    - secrets

# =========================================================================
# VÃ‰RIFICATIONS PRÃ‰ALABLES RENFORCÃ‰ES
# =========================================================================
- name: "Quarkus | VÃ©rifications prÃ©alables critiques avec mÃ©triques"
  block:
    - name: "Quarkus | DÃ©marrage du chronomÃ¨tre - VÃ©rifications prÃ©alables"
      set_fact:
        phase_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "Quarkus | VÃ©rification de l'accessibilitÃ© du cluster Kubernetes"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ quarkus_config.namespace }}"
      register: quarkus_namespace_check
      retries: "{{ quarkus_error_handling.max_retries }}"
      delay: "{{ quarkus_error_handling.retry_delay }}"
      failed_when: false

    - name: "Quarkus | VÃ©rification des variables d'environnement critiques"
      assert:
        that:
          - quarkus_config.enabled | bool
          - quarkus_config.version is defined
          - quarkus_config.version | length > 0
          - quarkus_config.namespace is defined
          - quarkus_config.namespace | length > 0
          - quarkus_config.service_name is defined
          - quarkus_config.port is defined
          - quarkus_config.port | int > 0
        fail_msg: |
          âŒ Variables d'environnement Quarkus manquantes ou incorrectes:
          - Enabled: {{ quarkus_config.enabled }}
          - Version: {{ quarkus_config.version | default('NON DÃ‰FINI') }}
          - Namespace: {{ quarkus_config.namespace | default('NON DÃ‰FINI') }}
          - Service: {{ quarkus_config.service_name | default('NON DÃ‰FINI') }}
          - Port: {{ quarkus_config.port | default('NON DÃ‰FINI') }}
        success_msg: "âœ… Variables d'environnement Quarkus validÃ©es avec succÃ¨s"

    - name: "Quarkus | VÃ©rification des dÃ©pendances de services"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ item.namespace }}"
        name: "{{ item.service }}"
      loop:
        - { namespace: "{{ LIONS_POSTGRES_NAMESPACE | default('database') }}", service: "{{ LIONS_POSTGRES_SERVICE_NAME | default('postgresql') }}" }
        - { namespace: "{{ LIONS_REDIS_NAMESPACE | default('database') }}", service: "{{ LIONS_REDIS_SERVICE_NAME | default('redis') }}" }
      register: quarkus_dependencies_check
      when: item.namespace is defined and item.service is defined
      failed_when: false

    - name: "Quarkus | Enregistrement des mÃ©triques - VÃ©rifications prÃ©alables"
      set_fact:
        quarkus_performance_metrics: "{{ quarkus_performance_metrics | combine({
          'phase_timings': quarkus_performance_metrics.phase_timings | combine({
            'preflight_checks': (ansible_date_time.epoch | int) - phase_start_time
          })
        }) }}"

  rescue:
    - name: "Quarkus | Gestion d'erreur critique - VÃ©rifications prÃ©alables"
      fail:
        msg: |
          ğŸ’¥ Ã‰CHEC CRITIQUE DES VÃ‰RIFICATIONS PRÃ‰ALABLES QUARKUS
          
          ğŸ” Erreur dÃ©tectÃ©e: {{ ansible_failed_result.msg | default('Erreur inconnue') }}
          ğŸ†” Trace ID: {{ quarkus_error_handling.trace_id }}
          â° Heure: {{ ansible_date_time.iso8601 }}
          
          ğŸ“š Consultez la documentation de dÃ©pannage:
          https://docs.lions.dev/infrastructure/troubleshooting/quarkus#preflight-checks

  tags:
    - quarkus
    - preflight
    - validation
    - metrics

# =========================================================================
# PHASE 1: PRÃ‰REQUIS ET DÃ‰PENDANCES AVANCÃ‰ES
# =========================================================================
- name: "Quarkus | Phase 1 - VÃ©rification des prÃ©requis avec tÃ©lÃ©mÃ©trie"
  block:
    - name: "Quarkus | DÃ©marrage Phase 1 - MÃ©triques"
      set_fact:
        phase_start_time: "{{ ansible_date_time.epoch | int }}"
        current_phase: "prerequisites"

    - name: "Quarkus | Inclusion des tÃ¢ches de prÃ©requis enrichies"
      include_tasks: prerequisites.yml
      vars:
        current_phase: "prerequisites"
        phase_description: "VÃ©rification des prÃ©requis systÃ¨me et Kubernetes"
        deployment_metadata: "{{ quarkus_deployment_metadata }}"
        deployment_config: "{{ quarkus_deployment_config }}"
        quarkus_configuration: "{{ quarkus_config }}"
        security_configuration: "{{ quarkus_security }}"
        observability_config: "{{ quarkus_observability }}"

    - name: "Quarkus | Finalisation Phase 1 - MÃ©triques"
      set_fact:
        quarkus_performance_metrics: "{{ quarkus_performance_metrics | combine({
          'phase_timings': quarkus_performance_metrics.phase_timings | combine({
            'prerequisites': (ansible_date_time.epoch | int) - phase_start_time
          })
        }) }}"

  rescue:
    - name: "Quarkus | Ã‰chec Phase 1 - Gestion avancÃ©e des erreurs"
      set_fact:
        quarkus_deployment_failed: true
        quarkus_failure_phase: "prerequisites"
        quarkus_failure_reason: "{{ ansible_failed_result.msg | default('Ã‰chec des prÃ©requis systÃ¨me') }}"
        quarkus_failure_details:
          phase: "prerequisites"
          timestamp: "{{ ansible_date_time.iso8601 }}"
          trace_id: "{{ quarkus_error_handling.trace_id }}"
          context: "{{ ansible_failed_result | default({}) }}"

    - name: "Quarkus | Journalisation structurÃ©e - Ã‰chec Phase 1"
      copy:
        content: |
          {
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "level": "ERROR",
            "service": "quarkus",
            "phase": "prerequisites",
            "deployment_id": "{{ quarkus_deployment_metadata.deployment_id }}",
            "trace_id": "{{ quarkus_error_handling.trace_id }}",
            "error": "{{ quarkus_failure_reason }}",
            "context": {{ ansible_failed_result | default({}) | to_json }},
            "environment": "{{ quarkus_environment.name }}",
            "namespace": "{{ quarkus_config.namespace }}"
          }
        dest: "{{ quarkus_error_handling.error_log_file }}"
      delegate_to: localhost

    - name: "Quarkus | Notification d'Ã©chec - Phase 1"
      uri:
        url: "{{ LIONS_NOTIFICATION_WEBHOOK_URL | default('') }}"
        method: POST
        body_format: json
        body:
          service: "quarkus"
          status: "FAILED"
          phase: "prerequisites"
          environment: "{{ quarkus_environment.name }}"
          error: "{{ quarkus_failure_reason }}"
          trace_id: "{{ quarkus_error_handling.trace_id }}"
      when:
        - LIONS_NOTIFICATION_WEBHOOK_URL is defined
        - LIONS_NOTIFICATION_WEBHOOK_URL | length > 0
      ignore_errors: yes

    - name: "Quarkus | ArrÃªt critique - Phase 1"
      fail:
        msg: |
          ğŸ’¥ DÃ‰PLOIEMENT QUARKUS INTERROMPU EN PHASE 1 (PRÃ‰REQUIS)
          
          ğŸ” Raison: {{ quarkus_failure_reason }}
          ğŸ†” Trace: {{ quarkus_error_handling.trace_id }}
          ğŸ“Š Environnement: {{ quarkus_environment.name }}
          
          ğŸ› ï¸  Actions recommandÃ©es:
          1. VÃ©rifiez la connectivitÃ© au cluster Kubernetes
          2. Validez les permissions RBAC
          3. ContrÃ´lez les variables d'environnement
          
          ğŸ“š Documentation: https://docs.lions.dev/infrastructure/troubleshooting/quarkus

  tags:
    - quarkus
    - prerequisites
    - phase-1

# =========================================================================
# PHASE 2: PRÃ‰PARATION DES RESSOURCES KUBERNETES
# =========================================================================
- name: "Quarkus | Phase 2 - PrÃ©paration des ressources avec validation"
  block:
    - name: "Quarkus | DÃ©marrage Phase 2 - MÃ©triques"
      set_fact:
        phase_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "Quarkus | Inclusion des tÃ¢ches de prÃ©paration optimisÃ©es"
      include_tasks: prepare.yml
      vars:
        current_phase: "preparation"
        phase_description: "CrÃ©ation et validation des ressources Kubernetes"
        deployment_metadata: "{{ quarkus_deployment_metadata }}"
        deployment_config: "{{ quarkus_deployment_config }}"
        quarkus_configuration: "{{ quarkus_config }}"
        resource_configuration: "{{ quarkus_resources }}"
        security_configuration: "{{ quarkus_security }}"
        secrets_configuration: "{{ quarkus_secrets | default({}) }}"

    - name: "Quarkus | Finalisation Phase 2 - MÃ©triques"
      set_fact:
        quarkus_performance_metrics: "{{ quarkus_performance_metrics | combine({
          'phase_timings': quarkus_performance_metrics.phase_timings | combine({
            'preparation': (ansible_date_time.epoch | int) - phase_start_time
          })
        }) }}"

  rescue:
    - name: "Quarkus | Ã‰chec Phase 2 - Gestion d'erreur avec rollback"
      set_fact:
        quarkus_deployment_failed: true
        quarkus_failure_phase: "preparation"
        quarkus_failure_reason: "{{ ansible_failed_result.msg | default('Ã‰chec de la prÃ©paration des ressources') }}"

    - name: "Quarkus | Journalisation - Ã‰chec Phase 2"
      lineinfile:
        path: "{{ quarkus_error_handling.error_log_file }}"
        line: |
          {
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "level": "ERROR",
            "phase": "preparation",
            "error": "{{ quarkus_failure_reason }}",
            "trace_id": "{{ quarkus_error_handling.trace_id }}"
          }
        create: yes

    - name: "Quarkus | Rollback automatique - Phase 2"
      include_tasks: cleanup.yml
      vars:
        cleanup_scope: "preparation"
        deployment_metadata: "{{ quarkus_deployment_metadata }}"
        cleanup_reason: "Ã‰chec de la phase de prÃ©paration"
      when: quarkus_error_handling.rollback_on_failure | bool

    - name: "Quarkus | ArrÃªt contrÃ´lÃ© - Phase 2"
      fail:
        msg: "ğŸ’¥ DÃ©ploiement Quarkus interrompu en Phase 2 (PrÃ©paration): {{ quarkus_failure_reason }}"

  when: quarkus_deployment_failed is not defined
  tags:
    - quarkus
    - preparation
    - phase-2

# =========================================================================
# PHASE 3: DÃ‰PLOIEMENT PRINCIPAL AVEC AUTO-SCALING
# =========================================================================
- name: "Quarkus | Phase 3 - DÃ©ploiement principal avec optimisations"
  block:
    - name: "Quarkus | DÃ©marrage Phase 3 - MÃ©triques"
      set_fact:
        phase_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "Quarkus | Inclusion des tÃ¢ches de dÃ©ploiement avancÃ©es"
      include_tasks: deploy.yml
      vars:
        current_phase: "deployment"
        phase_description: "DÃ©ploiement des composants Quarkus avec auto-scaling"
        deployment_metadata: "{{ quarkus_deployment_metadata }}"
        deployment_config: "{{ quarkus_deployment_config }}"
        quarkus_configuration: "{{ quarkus_config }}"
        resource_configuration: "{{ quarkus_resources }}"
        security_configuration: "{{ quarkus_security }}"
        secrets_configuration: "{{ quarkus_secrets | default({}) }}"
        environment_configuration: "{{ quarkus_environment }}"
        autoscaling_enabled: "{{ quarkus_deployment_metadata.feature_flags.autoscaling_enabled }}"

    - name: "Quarkus | Finalisation Phase 3 - MÃ©triques"
      set_fact:
        quarkus_performance_metrics: "{{ quarkus_performance_metrics | combine({
          'phase_timings': quarkus_performance_metrics.phase_timings | combine({
            'deployment': (ansible_date_time.epoch | int) - phase_start_time
          })
        }) }}"

  rescue:
    - name: "Quarkus | Ã‰chec Phase 3 - Gestion critique avec rollback complet"
      set_fact:
        quarkus_deployment_failed: true
        quarkus_failure_phase: "deployment"
        quarkus_failure_reason: "{{ ansible_failed_result.msg | default('Ã‰chec du dÃ©ploiement principal') }}"

    - name: "Quarkus | Journalisation critique - Ã‰chec Phase 3"
      copy:
        content: |
          {
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "level": "CRITICAL",
            "service": "quarkus",
            "phase": "deployment",
            "deployment_id": "{{ quarkus_deployment_metadata.deployment_id }}",
            "trace_id": "{{ quarkus_error_handling.trace_id }}",
            "error": "{{ quarkus_failure_reason }}",
            "context": {{ ansible_failed_result | default({}) | to_json }},
            "environment": "{{ quarkus_environment.name }}",
            "namespace": "{{ quarkus_config.namespace }}",
            "rollback_initiated": {{ quarkus_error_handling.rollback_on_failure }}
          }
        dest: "{{ quarkus_error_handling.error_log_file }}"
      delegate_to: localhost

    - name: "Quarkus | Rollback complet automatique - Phase 3"
      include_tasks: rollback.yml
      vars:
        rollback_reason: "Ã‰chec du dÃ©ploiement principal Quarkus"
        deployment_metadata: "{{ quarkus_deployment_metadata }}"
        rollback_scope: "complete"
      when: quarkus_error_handling.rollback_on_failure | bool

    - name: "Quarkus | ArrÃªt critique - Phase 3"
      fail:
        msg: |
          ğŸ’¥ DÃ‰PLOIEMENT QUARKUS CRITIQUE - Ã‰CHEC EN PHASE 3 (DÃ‰PLOIEMENT)
          
          ğŸ” Raison: {{ quarkus_failure_reason }}
          ğŸ†” Trace: {{ quarkus_error_handling.trace_id }}
          ğŸ”„ Rollback: {{ 'EffectuÃ©' if quarkus_error_handling.rollback_on_failure else 'IgnorÃ©' }}

  when: quarkus_deployment_failed is not defined
  tags:
    - quarkus
    - deployment
    - phase-3

# =========================================================================
# PHASE 4: CONFIGURATION DU MONITORING ET ALERTES
# =========================================================================
- name: "Quarkus | Phase 4 - Configuration du monitoring et observabilitÃ©"
  block:
    - name: "Quarkus | DÃ©marrage Phase 4 - MÃ©triques"
      set_fact:
        phase_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "Quarkus | Inclusion des tÃ¢ches de monitoring enrichies"
      include_tasks: monitoring.yml
      vars:
        current_phase: "monitoring"
        phase_description: "Configuration des mÃ©triques, alertes et tableaux de bord Quarkus"
        deployment_metadata: "{{ quarkus_deployment_metadata }}"
        observability_config: "{{ quarkus_observability }}"
        monitoring_enabled: "{{ quarkus_deployment_metadata.feature_flags.monitoring_enabled }}"
        quarkus_configuration: "{{ quarkus_config }}"
        environment_configuration: "{{ quarkus_environment }}"

    - name: "Quarkus | Finalisation Phase 4 - MÃ©triques"
      set_fact:
        quarkus_performance_metrics: "{{ quarkus_performance_metrics | combine({
          'phase_timings': quarkus_performance_metrics.phase_timings | combine({
            'monitoring': (ansible_date_time.epoch | int) - phase_start_time
          })
        }) }}"

  rescue:
    - name: "Quarkus | Avertissement Phase 4 - Monitoring dÃ©gradÃ©"
      debug:
        msg:
          - "âš ï¸  AVERTISSEMENT: Ã‰chec partiel de la configuration du monitoring Quarkus"
          - "â„¹ï¸  Le dÃ©ploiement principal a rÃ©ussi, mais l'observabilitÃ© peut Ãªtre limitÃ©e"
          - "ğŸ” Erreur dÃ©taillÃ©e: {{ ansible_failed_result.msg | default('Erreur de monitoring inconnue') }}"
          - "ğŸ†” Trace ID: {{ quarkus_error_handling.trace_id }}"
          - "ğŸ”§ Impact: MÃ©triques et alertes peuvent Ãªtre indisponibles"

    - name: "Quarkus | Journalisation - Avertissement Phase 4"
      lineinfile:
        path: "{{ quarkus_error_handling.error_log_file }}"
        line: |
          {
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "level": "WARNING",
            "phase": "monitoring",
            "error": "{{ ansible_failed_result.msg | default('Erreur de monitoring') }}",
            "trace_id": "{{ quarkus_error_handling.trace_id }}",
            "impact": "ObservabilitÃ© dÃ©gradÃ©e"
          }
        create: yes

    - name: "Quarkus | Marquage du monitoring comme dÃ©faillant"
      set_fact:
        quarkus_monitoring_failed: true
        quarkus_monitoring_error: "{{ ansible_failed_result.msg | default('Erreur de monitoring inconnue') }}"

  when:
    - quarkus_deployment_failed is not defined
    - quarkus_deployment_metadata.feature_flags.monitoring_enabled | bool
  tags:
    - quarkus
    - monitoring
    - observability
    - phase-4

# =========================================================================
# PHASE 5: VALIDATION POST-DÃ‰PLOIEMENT AVANCÃ‰E
# =========================================================================
- name: "Quarkus | Phase 5 - Validation post-dÃ©ploiement complÃ¨te"
  block:
    - name: "Quarkus | DÃ©marrage Phase 5 - MÃ©triques"
      set_fact:
        phase_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "Quarkus | Inclusion des tÃ¢ches de validation approfondies"
      include_tasks: validate.yml
      vars:
        current_phase: "validation"
        phase_description: "Validation complÃ¨te de l'Ã©tat et des fonctionnalitÃ©s Quarkus"
        deployment_metadata: "{{ quarkus_deployment_metadata }}"
        deployment_config: "{{ quarkus_deployment_config }}"
        quarkus_configuration: "{{ quarkus_config }}"
        environment_configuration: "{{ quarkus_environment }}"
        validation_timeout: "{{ LIONS_TIMEOUT_DEFAULT | default(300) | int }}"
        health_check_enabled: true
        performance_test_enabled: "{{ quarkus_environment.name != 'production' }}"

    - name: "Quarkus | Finalisation Phase 5 - MÃ©triques"
      set_fact:
        quarkus_performance_metrics: "{{ quarkus_performance_metrics | combine({
          'phase_timings': quarkus_performance_metrics.phase_timings | combine({
            'validation': (ansible_date_time.epoch | int) - phase_start_time
          })
        }) }}"

  rescue:
    - name: "Quarkus | Ã‰chec Phase 5 - Validation critique"
      set_fact:
        quarkus_deployment_failed: true
        quarkus_failure_phase: "validation"
        quarkus_failure_reason: "{{ ansible_failed_result.msg | default('Ã‰chec de la validation post-dÃ©ploiement') }}"

    - name: "Quarkus | Journalisation - Ã‰chec Phase 5"
      copy:
        content: |
          {
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "level": "ERROR",
            "service": "quarkus",
            "phase": "validation",
            "deployment_id": "{{ quarkus_deployment_metadata.deployment_id }}",
            "trace_id": "{{ quarkus_error_handling.trace_id }}",
            "error": "{{ quarkus_failure_reason }}",
            "context": {{ ansible_failed_result | default({}) | to_json }},
            "recommendation": "Quarkus peut Ãªtre partiellement fonctionnel malgrÃ© l'Ã©chec de validation"
          }
        dest: "{{ quarkus_error_handling.error_log_file }}"
      delegate_to: localhost

    - name: "Quarkus | Ã‰valuation de l'impact - Validation Ã©chouÃ©e"
      debug:
        msg:
          - "âš ï¸  VALIDATION Ã‰CHOUÃ‰E - IMPACT Ã€ Ã‰VALUER"
          - "ğŸ” Raison: {{ quarkus_failure_reason }}"
          - "ğŸ’¡ Quarkus peut Ãªtre partiellement fonctionnel"
          - "ğŸ› ï¸  Intervention manuelle recommandÃ©e"

    - name: "Quarkus | ArrÃªt avec avertissement - Phase 5"
      fail:
        msg: |
          âš ï¸  DÃ‰PLOIEMENT QUARKUS TERMINÃ‰ AVEC ERREURS DE VALIDATION
          
          ğŸ” Raison: {{ quarkus_failure_reason }}
          ğŸ†” Trace: {{ quarkus_error_handling.trace_id }}
          
          ğŸ’¡ Actions recommandÃ©es:
          1. VÃ©rifiez les logs de l'application Quarkus
          2. Testez manuellement les endpoints critiques
          3. Consultez les mÃ©triques de santÃ©
          
          ğŸ“š Guide de validation: https://docs.lions.dev/infrastructure/validation/quarkus

  when:
    - quarkus_deployment_failed is not defined
    - not quarkus_deployment_config.skip_validation | bool
  tags:
    - quarkus
    - validation
    - health-check
    - phase-5

# =========================================================================
# PHASE 6: CONFIGURATION DE LA SAUVEGARDE ET RÃ‰CUPÃ‰RATION
# =========================================================================
- name: "Quarkus | Phase 6 - Configuration de la sauvegarde et rÃ©cupÃ©ration"
  block:
    - name: "Quarkus | DÃ©marrage Phase 6 - MÃ©triques"
      set_fact:
        phase_start_time: "{{ ansible_date_time.epoch | int }}"

    - name: "Quarkus | Inclusion des tÃ¢ches de sauvegarde avancÃ©es"
      include_tasks: backup.yml
      vars:
        current_phase: "backup"
        phase_description: "Configuration des stratÃ©gies de sauvegarde et rÃ©cupÃ©ration Quarkus"
        deployment_metadata: "{{ quarkus_deployment_metadata }}"
        backup_config:
          enabled: "{{ quarkus_config.backup_enabled }}"
          retention_days: "{{ LIONS_BACKUP_RETENTION_DAYS | default(30) | int }}"
          schedule: "{{ LIONS_BACKUP_SCHEDULE | default('0 2 * * *') }}"
          encryption: "{{ LIONS_BACKUP_ENCRYPTION | default(true) | bool }}"
          external_storage: "{{ LIONS_BACKUP_EXTERNAL_ENABLED | default(false) | bool }}"
        quarkus_configuration: "{{ quarkus_config }}"
        environment_configuration: "{{ quarkus_environment }}"

    - name: "Quarkus | Finalisation Phase 6 - MÃ©triques"
      set_fact:
        quarkus_performance_metrics: "{{ quarkus_performance_metrics | combine({
          'phase_timings': quarkus_performance_metrics.phase_timings | combine({
            'backup': (ansible_date_time.epoch | int) - phase_start_time
          })
        }) }}"

  rescue:
    - name: "Quarkus | Avertissement Phase 6 - Sauvegarde compromise"
      debug:
        msg:
          - "âš ï¸  AVERTISSEMENT: Ã‰chec de la configuration de sauvegarde Quarkus"
          - "â„¹ï¸  Quarkus fonctionne mais les sauvegardes automatiques sont dÃ©sactivÃ©es"
          - "ğŸ” Erreur: {{ ansible_failed_result.msg | default('Erreur de sauvegarde inconnue') }}"
          - "ğŸ›¡ï¸  Impact: Risque de perte de donnÃ©es en cas de problÃ¨me"
          - "ğŸ”§ Action requise: Configuration manuelle de la sauvegarde"

    - name: "Quarkus | Journalisation - Avertissement Phase 6"
      lineinfile:
        path: "{{ quarkus_error_handling.error_log_file }}"
        line: |
          {
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "level": "WARNING",
            "phase": "backup",
            "error": "{{ ansible_failed_result.msg | default('Erreur de sauvegarde') }}",
            "trace_id": "{{ quarkus_error_handling.trace_id }}",
            "impact": "Sauvegardes automatiques dÃ©sactivÃ©es",
            "risk_level": "MEDIUM"
          }
        create: yes

    - name: "Quarkus | Marquage de la sauvegarde comme dÃ©faillante"
      set_fact:
        quarkus_backup_failed: true
        quarkus_backup_error: "{{ ansible_failed_result.msg | default('Erreur de sauvegarde inconnue') }}"

  when:
    - quarkus_deployment_failed is not defined
    - LIONS_BACKUP_ENABLED | default(true) | bool
    - quarkus_config.backup_enabled | bool
  tags:
    - quarkus
    - backup
    - disaster-recovery
    - phase-6

# =========================================================================
# FINALISATION ET RAPPORT DE DÃ‰PLOIEMENT ENRICHI
# =========================================================================
- name: "Quarkus | Calcul des mÃ©triques finales de dÃ©ploiement"
  set_fact:
    quarkus_deployment_duration: "{{ (ansible_date_time.epoch | int) - (quarkus_deployment_metadata.deployment_id | int) }}"
    quarkus_total_phases: 6
    quarkus_successful_phases: "{{ (6 - ([quarkus_deployment_failed, quarkus_monitoring_failed, quarkus_backup_failed] | select('defined') | list | length)) }}"

- name: "Quarkus | GÃ©nÃ©ration du rapport de dÃ©ploiement enrichi"
  set_fact:
    quarkus_deployment_report:
      # Statut gÃ©nÃ©ral
      status: "{{ 'FAILED' if quarkus_deployment_failed | default(false) else 'SUCCESS' }}"
      overall_health: |
        {% if quarkus_deployment_failed | default(false) %}CRITICAL
        {% elif quarkus_monitoring_failed | default(false) or quarkus_backup_failed | default(false) %}DEGRADED
        {% else %}HEALTHY{% endif %}

      # MÃ©tadonnÃ©es de dÃ©ploiement
      deployment_metadata:
        id: "{{ quarkus_deployment_metadata.deployment_id }}"
        uuid: "{{ quarkus_deployment_metadata.deployment_uuid }}"
        environment: "{{ quarkus_deployment_metadata.environment }}"
        namespace: "{{ quarkus_deployment_metadata.namespace }}"
        initiated_by: "{{ quarkus_deployment_metadata.started_by }}"
        initiated_from: "{{ quarkus_deployment_metadata.initiated_from }}"

      # TemporalitÃ©
      timing:
        started_at: "{{ quarkus_deployment_metadata.started_at }}"
        completed_at: "{{ ansible_date_time.iso8601 }}"
        duration_seconds: "{{ quarkus_deployment_duration }}"
        duration_human: "{{ (quarkus_deployment_duration // 60) }}m {{ (quarkus_deployment_duration % 60) }}s"

      # Performance par phase
      phase_performance: "{{ quarkus_performance_metrics.phase_timings | default({}) }}"

      # Statut des composants
      component_status:
        core_deployment: "{{ 'FAILED' if quarkus_deployment_failed | default(false) else 'SUCCESS' }}"
        monitoring: "{{ 'FAILED' if quarkus_monitoring_failed | default(false) else 'SUCCESS' }}"
        backup: "{{ 'FAILED' if quarkus_backup_failed | default(false) else 'SUCCESS' }}"

      # Configuration Quarkus dÃ©ployÃ©e
      quarkus_config:
        version: "{{ quarkus_config.version }}"
        service_name: "{{ quarkus_config.service_name }}"
        port: "{{ quarkus_config.port }}"
        endpoint: "{{ quarkus_config.service_name }}.{{ quarkus_config.namespace }}.svc.cluster.local:{{ quarkus_config.port }}"
        external_url: "https://{{ quarkus_config.service_name }}.{{ quarkus_environment.domain }}"

      # DÃ©tails d'Ã©chec (si applicable)
      failure_details:
        failed_phase: "{{ quarkus_failure_phase | default('N/A') }}"
        failure_reason: "{{ quarkus_failure_reason | default('N/A') }}"
        trace_id: "{{ quarkus_error_handling.trace_id | default('N/A') }}"
        monitoring_error: "{{ quarkus_monitoring_error | default('N/A') }}"
        backup_error: "{{ quarkus_backup_error | default('N/A') }}"

      # FonctionnalitÃ©s activÃ©es
      features:
        vault_integration: "{{ quarkus_deployment_metadata.feature_flags.vault_integration }}"
        monitoring: "{{ quarkus_deployment_metadata.feature_flags.monitoring_enabled }}"
        backup: "{{ quarkus_deployment_metadata.feature_flags.backup_enabled }}"
        autoscaling: "{{ quarkus_deployment_metadata.feature_flags.autoscaling_enabled }}"

      # Recommandations post-dÃ©ploiement
      recommendations: |
        {% if quarkus_deployment_report.status == 'SUCCESS' %}
        âœ… DÃ©ploiement rÃ©ussi ! Actions recommandÃ©es :
        - Surveillez les mÃ©triques dans Grafana
        - VÃ©rifiez les logs d'application
        - Testez les endpoints critiques
        {% else %}
        âŒ DÃ©ploiement Ã©chouÃ©. Actions immÃ©diates :
        - Consultez les logs d'erreur dÃ©taillÃ©s
        - VÃ©rifiez la connectivitÃ© rÃ©seau
        - Validez les permissions RBAC
        {% endif %}
        
        {% if quarkus_monitoring_failed | default(false) %}
        âš ï¸ Monitoring dÃ©gradÃ© - Configurez manuellement Prometheus/Grafana
        {% endif %}
        
        {% if quarkus_backup_failed | default(false) %}
        âš ï¸ Sauvegarde compromise - Planifiez une configuration de backup manuelle
        {% endif %}
  tags:
    - quarkus
    - report
    - metrics
    - always

- name: "Quarkus | Affichage du tableau de bord final"
  debug:
    msg:
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘                         ğŸ“Š RAPPORT FINAL QUARKUS 5.0                    â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ ğŸ“ˆ Statut Global       â”‚ {{ (quarkus_deployment_report.status + ' (' + quarkus_deployment_report.overall_health + ')                              ')[:35] }} â•‘"
      - "â•‘ ğŸŒ Environnement       â”‚ {{ (quarkus_deployment_report.deployment_metadata.environment + '                              ')[:35] }} â•‘"
      - "â•‘ ğŸ·ï¸  Namespace           â”‚ {{ (quarkus_deployment_report.deployment_metadata.namespace + '                              ')[:35] }} â•‘"
      - "â•‘ â° DurÃ©e totale        â”‚ {{ (quarkus_deployment_report.timing.duration_human + '                              ')[:35] }} â•‘"
      - "â•‘ â˜• Version Quarkus      â”‚ {{ (quarkus_deployment_report.quarkus_config.version + '                              ')[:35] }} â•‘"
      - "â•‘ ğŸ”— Endpoint interne    â”‚ {{ (quarkus_deployment_report.quarkus_config.endpoint[:35] + '...') if quarkus_deployment_report.quarkus_config.endpoint | length > 35 else (quarkus_deployment_report.quarkus_config.endpoint + '                              ')[:35] }} â•‘"
      - "â•‘ ğŸŒ URL externe         â”‚ {{ (quarkus_deployment_report.quarkus_config.external_url[:35] + '...') if quarkus_deployment_report.quarkus_config.external_url | length > 35 else (quarkus_deployment_report.quarkus_config.external_url + '                              ')[:35] }} â•‘"
      - "â•‘                                                                          â•‘"
      - "â•‘ ğŸ“Š STATUT DES COMPOSANTS                                                â•‘"
      - "â•‘ â€¢ DÃ©ploiement principal â”‚ {{ (quarkus_deployment_report.component_status.core_deployment + '                              ')[:35] }} â•‘"
      - "â•‘ â€¢ Monitoring            â”‚ {{ (quarkus_deployment_report.component_status.monitoring + '                              ')[:35] }} â•‘"
      - "â•‘ â€¢ Sauvegarde            â”‚ {{ (quarkus_deployment_report.component_status.backup + '                              ')[:35] }} â•‘"
      - "â•‘                                                                          â•‘"
      - "â•‘ ğŸš€ FONCTIONNALITÃ‰S                                                      â•‘"
      - "â•‘ â€¢ IntÃ©gration Vault     â”‚ {{ ('âœ… ActivÃ©e' if quarkus_deployment_report.features.vault_integration else 'âŒ DÃ©sactivÃ©e') + '                              ' }}                              â•‘"[:39]
      - "â•‘ â€¢ Auto-scaling          â”‚ {{ ('âœ… ActivÃ©' if quarkus_deployment_report.features.autoscaling else 'âŒ DÃ©sactivÃ©') + '                              ' }}                              â•‘"[:39]
      - "â•‘                                                                          â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘ {{ quarkus_deployment_report.recommendations.split('\n')[0][:70] + '                                      ' }}                                      â•‘"[:75]
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  tags:
    - quarkus
    - report
    - dashboard
    - always

- name: "Quarkus | Sauvegarde du rapport de dÃ©ploiement dÃ©taillÃ©"
  copy:
    content: "{{ quarkus_deployment_report | to_nice_json }}"
    dest: "/tmp/quarkus-deployment-report-{{ quarkus_deployment_metadata.deployment_id }}.json"
    mode: '0644'
  delegate_to: localhost
  tags:
    - quarkus
    - report
    - persistence

- name: "Quarkus | Sauvegarde des mÃ©triques de performance"
  copy:
    content: "{{ quarkus_performance_metrics | to_nice_json }}"
    dest: "{{ quarkus_error_handling.metrics_file }}"
    mode: '0644'
  delegate_to: localhost
  tags:
    - quarkus
    - metrics
    - performance

# =========================================================================
# INTÃ‰GRATION AVEC LES SYSTÃˆMES EXTERNES
# =========================================================================
- name: "Quarkus | Notification des systÃ¨mes externes"
  block:
    - name: "Quarkus | Notification Webhook de fin de dÃ©ploiement"
      uri:
        url: "{{ LIONS_NOTIFICATION_WEBHOOK_URL }}"
        method: POST
        body_format: json
        body:
          service: "quarkus"
          status: "{{ quarkus_deployment_report.status }}"
          environment: "{{ quarkus_deployment_report.deployment_metadata.environment }}"
          namespace: "{{ quarkus_deployment_report.deployment_metadata.namespace }}"
          duration: "{{ quarkus_deployment_report.timing.duration_seconds }}"
          endpoint: "{{ quarkus_deployment_report.quarkus_config.external_url }}"
          deployment_id: "{{ quarkus_deployment_report.deployment_metadata.uuid }}"
          trace_id: "{{ quarkus_error_handling.trace_id }}"
        headers:
          Content-Type: "application/json"
          X-Lions-Service: "infrastructure"
          X-Lions-Version: "5.0.0"
      register: webhook_notification
      ignore_errors: yes

    - name: "Quarkus | Mise Ã  jour du registre de services"
      uri:
        url: "{{ LIONS_SERVICE_REGISTRY_URL }}/api/v1/services"
        method: POST
        body_format: json
        body:
          name: "{{ quarkus_deployment_report.quarkus_config.service_name }}"
          version: "{{ quarkus_deployment_report.quarkus_config.version }}"
          environment: "{{ quarkus_deployment_report.deployment_metadata.environment }}"
          namespace: "{{ quarkus_deployment_report.deployment_metadata.namespace }}"
          endpoint: "{{ quarkus_deployment_report.quarkus_config.endpoint }}"
          external_url: "{{ quarkus_deployment_report.quarkus_config.external_url }}"
          status: "{{ quarkus_deployment_report.status }}"
          health: "{{ quarkus_deployment_report.overall_health }}"
          deployed_at: "{{ quarkus_deployment_report.timing.completed_at }}"
          tags:
            - "quarkus"
            - "java"
            - "microservice"
            - "{{ quarkus_deployment_report.deployment_metadata.environment }}"
      when: LIONS_SERVICE_REGISTRY_URL is defined
      ignore_errors: yes

  when:
    - LIONS_NOTIFICATION_WEBHOOK_URL is defined or LIONS_SERVICE_REGISTRY_URL is defined
    - not quarkus_deployment_config.dry_run | bool
  tags:
    - quarkus
    - integration
    - notification

# =========================================================================
# NETTOYAGE ET FINALISATION OPTIMISÃ‰S
# =========================================================================
- name: "Quarkus | Nettoyage intelligent des ressources temporaires"
  block:
    - name: "Quarkus | Suppression des fichiers temporaires de dÃ©ploiement rÃ©ussi"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ quarkus_error_handling.error_log_file }}"
        - "/tmp/quarkus-db-password"
        - "/tmp/quarkus-jwt-secret"
        - "/tmp/quarkus-admin-password"
      when:
        - quarkus_deployment_report.status == "SUCCESS"
        - not quarkus_deployment_config.debug_mode | bool

    - name: "Quarkus | Conservation des artefacts en cas d'Ã©chec ou mode debug"
      debug:
        msg:
          - "ğŸ” Mode debug activÃ© ou dÃ©ploiement Ã©chouÃ© - Conservation des artefacts"
          - "ğŸ“ Fichiers conservÃ©s:"
          - "   â€¢ Logs d'erreur: {{ quarkus_error_handling.error_log_file }}"
          - "   â€¢ MÃ©triques: {{ quarkus_error_handling.metrics_file }}"
          - "   â€¢ Rapport: /tmp/quarkus-deployment-report-{{ quarkus_deployment_metadata.deployment_id }}.json"
      when:
        - quarkus_deployment_report.status == "FAILED" or quarkus_deployment_config.debug_mode | bool

  ignore_errors: yes
  tags:
    - quarkus
    - cleanup
    - maintenance

- name: "Quarkus | Message de finalisation enrichi"
  debug:
    msg: |
      {% if quarkus_deployment_report.status == 'SUCCESS' %}
      ğŸ‰ DÃ‰PLOIEMENT QUARKUS TERMINÃ‰ AVEC SUCCÃˆS !

      ğŸ”— Informations de connexion:
      â€¢ Endpoint interne: {{ quarkus_deployment_report.quarkus_config.endpoint }}
      â€¢ URL externe: {{ quarkus_deployment_report.quarkus_config.external_url }}
      â€¢ Port de service: {{ quarkus_deployment_report.quarkus_config.port }}

      ğŸ“Š MÃ©triques de dÃ©ploiement:
      â€¢ DurÃ©e totale: {{ quarkus_deployment_report.timing.duration_human }}
      â€¢ SantÃ© globale: {{ quarkus_deployment_report.overall_health }}

      ğŸ“š Ressources disponibles:
      â€¢ Documentation: https://docs.lions.dev/infrastructure/applications/quarkus
      â€¢ Monitoring: https://grafana.{{ quarkus_environment.domain }}/d/quarkus
      â€¢ Logs: https://grafana.{{ quarkus_environment.domain }}/explore

      ğŸ”§ Prochaines Ã©tapes recommandÃ©es:
      1. VÃ©rifiez les mÃ©triques de santÃ©
      2. ExÃ©cutez les tests d'intÃ©gration
      3. Configurez les alertes personnalisÃ©es
      {% else %}
      ğŸ’¥ DÃ‰PLOIEMENT QUARKUS Ã‰CHOUÃ‰ !

      ğŸ” DÃ©tails de l'Ã©chec:
      â€¢ Phase d'Ã©chec: {{ quarkus_deployment_report.failure_details.failed_phase }}
      â€¢ Raison: {{ quarkus_deployment_report.failure_details.failure_reason }}
      â€¢ ID de trace: {{ quarkus_deployment_report.failure_details.trace_id }}

      ğŸ“ Fichiers de diagnostic disponibles:
      â€¢ Logs d'erreur: {{ quarkus_error_handling.error_log_file }}
      â€¢ Rapport JSON: /tmp/quarkus-deployment-report-{{ quarkus_deployment_metadata.deployment_id }}.json
      â€¢ MÃ©triques: {{ quarkus_error_handling.metrics_file }}

      ğŸ› ï¸  Actions de rÃ©cupÃ©ration:
      1. Consultez les logs dÃ©taillÃ©s ci-dessus
      2. VÃ©rifiez la connectivitÃ© au cluster Kubernetes
      3. Validez les variables d'environnement
      4. Consultez le guide de dÃ©pannage: https://docs.lions.dev/infrastructure/troubleshooting/quarkus

      ğŸ“ Support disponible:
      â€¢ Documentation: https://docs.lions.dev
      â€¢ Issues GitHub: https://github.com/lions-infrastructure/issues
      â€¢ Contact DevOps: devops@lions.dev
      {% endif %}

      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      ğŸ¦ LIONS Infrastructure 5.0 - DÃ©ploiement Quarkus terminÃ©
      Trace ID: {{ quarkus_error_handling.trace_id }}
      â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  tags:
    - quarkus
    - summary
    - always