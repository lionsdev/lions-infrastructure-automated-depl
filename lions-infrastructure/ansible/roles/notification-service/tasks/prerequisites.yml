---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - NOTIFICATION SERVICE PREREQUISITES
# =========================================================================
# Description: Vérification complète des prérequis pour le service de notification
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Documentation: https://docs.lions.dev/notification/prerequisites
# =========================================================================

- name: "🔍 [NOTIFICATION-PREREQ] Validation de l'environnement Kubernetes"
  assert:
    that:
      - notification_enabled | bool
      - notification_namespace is defined
      - notification_service_name is defined
    fail_msg: "❌ Configuration de base du service de notification manquante"
    success_msg: "✅ Configuration de base validée"
  tags: [validation, config]

- name: "🌐 [NOTIFICATION-PREREQ] Vérification de l'existence du namespace"
  k8s_info:
    api_version: v1
    kind: Namespace
    name: "{{ notification_namespace }}"
  register: namespace_info
  failed_when: false
  tags: [namespace, validation]

- name: "🔐 [NOTIFICATION-PREREQ] Vérification des secrets critiques"
  k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ notification_namespace }}"
    name: "{{ item.name }}"
  loop:
    - name: "{{ notification_secrets.admin.password_secret }}"
      description: "Secret administrateur"
      required: true
    - name: "{{ notification_secrets.api.key_secret }}"
      description: "Clé API"
      required: true
    - name: "{{ notification_app_config.channels.email.user_secret }}"
      description: "Identifiants SMTP"
      required: false
  register: notification_secrets_check
  failed_when: false
  loop_control:
    label: "{{ item.description }}"
  tags: [secrets, validation]

- name: "⚠️  [NOTIFICATION-PREREQ] Rapport des secrets manquants"
  debug:
    msg: "❌ Secret manquant: {{ item.item.name }} ({{ item.item.description }})"
  loop: "{{ notification_secrets_check.results }}"
  when:
    - item.resources | length == 0
    - item.item.required | default(false)
  tags: [secrets, warning]

- name: "🏗️  [NOTIFICATION-PREREQ] Vérification des composants Kubernetes"
  k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: "{{ item.name }}"
  register: k8s_components_check
  loop:
    - name: "certificates.cert-manager.io"
      description: "cert-manager"
      required: false
    - name: "servicemonitors.monitoring.coreos.com"
      description: "Prometheus Operator"
      required: false
  failed_when: false
  loop_control:
    label: "{{ item.description }}"
  tags: [components, validation]

- name: "📊 [NOTIFICATION-PREREQ] Résumé des prérequis"
  debug:
    msg:
      - "✅ Validation des prérequis terminée"
      - "🌐 Namespace: {{ 'Existe' if namespace_info.resources | length > 0 else 'À créer' }}"
      - "🔐 Secrets: {{ notification_secrets_check.results | selectattr('resources', 'defined') | selectattr('resources', '!=', []) | list | length }}/{{ notification_secrets_check.results | length }} présents"
      - "🏗️  Composants optionnels disponibles:"
      - "   - cert-manager: {{ 'Oui' if k8s_components_check.results[0].resources | length > 0 else 'Non' }}"
      - "   - Prometheus Operator: {{ 'Oui' if k8s_components_check.results[1].resources | length > 0 else 'Non' }}"
  tags: [summary, reporting]