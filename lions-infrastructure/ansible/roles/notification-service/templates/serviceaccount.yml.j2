---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - NOTIFICATION SERVICE SERVICEACCOUNT TEMPLATE
# =========================================================================
# Description: Template Kubernetes ServiceAccount pour le service de notification
# Version: 5.0.0
# Auteur: LIONS DevOps Team
# Date de création: {{ ansible_date_time.iso8601 }}
# Documentation: https://docs.lions.dev/infrastructure/services/notification
# =========================================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  # Nom du ServiceAccount basé sur les variables d'environnement
  name: "{{ notification_service_name }}"
  namespace: "{{ notification_namespace }}"

  # Labels standardisés LIONS Infrastructure
  labels:
    # Labels de base pour l'application
    app.kubernetes.io/name: "{{ notification_service_name }}"
    app.kubernetes.io/instance: "{{ notification_service_name }}-{{ notification_environment }}"
    app.kubernetes.io/version: "{{ notification_service_meta.version }}"
    app.kubernetes.io/component: "notification-service"
    app.kubernetes.io/part-of: "lions-infrastructure"
    app.kubernetes.io/managed-by: "ansible"

    # Labels d'environnement et déploiement
    lions.dev/environment: "{{ notification_environment }}"
    lions.dev/tier: "application"
    lions.dev/category: "communication"
    lions.dev/deployment-mode: "{{ notification_deployment.mode | default('rolling') }}"

    # Labels de versioning et maintenance
    lions.dev/config-version: "{{ notification_service_meta.config_version | default('5.0.0') }}"
    lions.dev/deployed-by: "{{ ansible_user | default('ansible') }}"
    lions.dev/deployment-timestamp: "{{ ansible_date_time.epoch }}"

    # Labels de monitoring et observabilité
    lions.dev/monitoring: "{{ notification_monitoring.enabled | default('true') | string }}"
    lions.dev/backup: "{{ notification_storage.backup_enabled | default('false') | string }}"
    lions.dev/service-mesh: "{{ notification_service_mesh.enabled | default('false') | string }}"

    # Labels de sécurité
    lions.dev/rbac: "{{ notification_security.rbac.enabled | default('true') | string }}"
    lions.dev/network-policy: "{{ notification_security.network_policies.enabled | default('true') | string }}"
    lions.dev/pod-security-standard: "{{ notification_security.pod_security.standard | default('restricted') }}"

  # Annotations pour métadonnées et configuration
  annotations:
    # Métadonnées de base
    lions.dev/description: "ServiceAccount pour le service de notification - Service de communication multi-canal pour l'environnement {{ notification_environment }}"
    lions.dev/maintainer: "{{ notification_service_meta.maintainer | default('devops@lions.dev') }}"
    lions.dev/documentation: "https://docs.lions.dev/infrastructure/services/notification"
    lions.dev/support-channel: "#notification-support"

    # Informations de déploiement
    lions.dev/deployed-at: "{{ ansible_date_time.iso8601 }}"
    lions.dev/ansible-playbook: "{{ ansible_playbook_python | default('unknown') }}"
    lions.dev/ansible-version: "{{ ansible_version.full | default('unknown') }}"
    lions.dev/deployment-id: "{{ notification_deployment.id | default(ansible_date_time.epoch + '_' + inventory_hostname) }}"

    # Configuration technique
    lions.dev/service-type: "notification-service"
    lions.dev/data-classification: "{{ notification_security.data_classification | default('internal') }}"
    lions.dev/service-level: "{{ notification_sla.level | default('standard') }}"
    lions.dev/high-availability: "{{ notification_deployment.high_availability | default('false') | string }}"

    # Informations de ressources
    lions.dev/resource-profile: "{{ notification_resources.tier | default('medium') }}"
    lions.dev/storage-class: "{{ notification_storage.class | default('local-path') }}"
    lions.dev/storage-size: "{{ notification_storage.size | default('5Gi') }}"

    # Configuration de sécurité
    lions.dev/tls-enabled: "{{ notification_tls.enabled | default('false') | string }}"
    lions.dev/encryption-at-rest: "{{ notification_security.encryption.at_rest | default('true') | string }}"
    lions.dev/secrets-management: "{{ notification_secrets.vault_enabled | default('false') | string }}"

    # Configuration de backup
    lions.dev/backup-schedule: "{{ notification_storage.backup_schedule | default('0 2 * * *') }}"
    lions.dev/backup-retention: "{{ notification_storage.backup_retention_days | default('30') }}d"
    lions.dev/backup-encryption: "{{ notification_storage.backup_encryption | default('true') | string }}"

    # Monitoring et alerting
    lions.dev/prometheus-scrape: "{{ notification_monitoring.prometheus.enabled | default('true') | string }}"
    lions.dev/grafana-dashboard: "{{ notification_monitoring.grafana.enabled | default('true') | string }}"
    lions.dev/log-level: "{{ notification_logging.levels.root | default('INFO') }}"

    # Conformité et audit
    lions.dev/compliance-level: "{{ notification_compliance.level | default('standard') }}"
    lions.dev/audit-enabled: "{{ notification_audit.enabled | default('true') | string }}"
    lions.dev/data-retention: "{{ notification_data_retention.days | default('365') }}d"

    # Configuration spécifique aux notifications
    notification.lions.dev/email-enabled: "{{ notification_app_config.channels.email.enabled | default('false') | string }}"
    notification.lions.dev/slack-enabled: "{{ notification_app_config.channels.slack.enabled | default('false') | string }}"
    notification.lions.dev/sms-enabled: "{{ notification_app_config.channels.sms.enabled | default('false') | string }}"
    notification.lions.dev/webhook-enabled: "{{ notification_app_config.channels.webhook.enabled | default('false') | string }}"
    notification.lions.dev/template-engine: "{{ notification_app_config.templates.engine | default('jinja2') }}"
    notification.lions.dev/queue-provider: "{{ notification_app_config.queue.provider | default('memory') }}"

    # Intégrations externes
{% if notification_integrations.keycloak.enabled | default('false') | bool %}
    notification.lions.dev/oidc-provider: "keycloak"
    notification.lions.dev/oidc-endpoint: "{{ notification_integrations.keycloak.endpoint }}"
{% endif %}

{% if notification_integrations.vault.enabled | default('false') | bool %}
    notification.lions.dev/vault-endpoint: "{{ notification_integrations.vault.endpoint }}"
    notification.lions.dev/vault-role: "{{ notification_integrations.vault.role }}"
{% endif %}

{% if notification_database.enabled | default('false') | bool %}
    notification.lions.dev/database-type: "{{ notification_database.type }}"
    notification.lions.dev/database-host: "{{ notification_database.host }}"
{% endif %}

{% if notification_redis.enabled | default('false') | bool %}
    notification.lions.dev/redis-host: "{{ notification_redis.host }}"
    notification.lions.dev/redis-sentinel: "{{ notification_redis.sentinel.enabled | default('false') | string }}"
{% endif %}

    # Configuration réseau et exposition
{% if notification_ingress.enabled | default('true') | bool %}
    notification.lions.dev/external-url: "{{ 'https' if notification_tls.enabled else 'http' }}://{{ notification_dns.full_domain }}"
    notification.lions.dev/ingress-class: "{{ notification_ingress.class | default('nginx') }}"
{% endif %}

    # Gestion des certificats
{% if notification_tls.enabled | default('false') | bool %}
    notification.lions.dev/tls-issuer: "{{ notification_tls.provider | default('self-signed') }}"
    notification.lions.dev/cert-manager: "{{ notification_tls.cert_manager_enabled | default('false') | string }}"
{% endif %}

    # Configuration API
    notification.lions.dev/api-version: "{{ notification_api.version | default('v1') }}"
    notification.lions.dev/api-rate-limit: "{{ notification_security.rate_limiting.requests_per_minute | default('100') }}"
    notification.lions.dev/api-authentication: "{{ notification_security.authentication.enabled | default('false') | string }}"

    # Configuration de performance
    notification.lions.dev/max-concurrent-notifications: "{{ notification_app_config.performance.max_concurrent | default('100') }}"
    notification.lions.dev/batch-size: "{{ notification_app_config.queue.batch_size | default('10') }}"
    notification.lions.dev/retry-policy: "{{ notification_app_config.queue.retry_policy | default('exponential') }}"

    # Informations de capacité
    notification.lions.dev/max-queue-size: "{{ notification_app_config.queue.max_size | default('10000') }}"
    notification.lions.dev/delivery-timeout: "{{ notification_app_config.delivery.timeout | default('30s') }}"

# Configuration automatique des permissions RBAC si activé
{% if notification_security.rbac.enabled | default('true') | bool %}
automountServiceAccountToken: true
{% else %}
automountServiceAccountToken: false
{% endif %}

# Secrets associés automatiquement montés
{% if notification_integrations.vault.enabled | default('false') | bool %}
secrets:
  - name: "{{ notification_service_name }}-vault-secrets"
{% endif %}

# Configuration d'image pull secrets si registry privé activé
{% if notification_container.registry_auth_required | default('false') | bool %}
imagePullSecrets:
  - name: "{{ notification_container.image_pull_secret | default('registry-credentials') }}"
{% endif %}