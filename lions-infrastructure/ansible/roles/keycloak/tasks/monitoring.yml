---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - KEYCLOAK MONITORING CONFIGURATION
# =========================================================================
# Description: Configuration avanc√©e du monitoring pour Keycloak
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: {{ ansible_date_time.iso8601 }}
# Dependencies: Prometheus Operator, Grafana, AlertManager
# =========================================================================

# =========================================================================
# VALIDATION DES PR√âREQUIS MONITORING
# =========================================================================
- name: "üîç Validation des pr√©requis monitoring Keycloak"
  block:
    - name: "V√©rification de l'√©tat du monitoring global"
      ansible.builtin.assert:
        that:
          - lions_monitoring_enabled | bool
          - keycloak_monitoring_enabled | default(true) | bool
        fail_msg: "‚ùå Le monitoring doit √™tre activ√© pour configurer le monitoring Keycloak"
        success_msg: "‚úÖ Monitoring global activ√© pour Keycloak"

    - name: "V√©rification de l'existence de Prometheus Operator CRDs"
      kubernetes.core.k8s_info:
        api_version: apiextensions.k8s.io/v1
        kind: CustomResourceDefinition
        name: "{{ item }}"
      register: prometheus_operator_crds
      loop:
        - servicemonitors.monitoring.coreos.com
        - prometheusrules.monitoring.coreos.com
        - podmonitors.monitoring.coreos.com
      failed_when: false
      changed_when: false

    - name: "√âvaluation de la disponibilit√© de Prometheus Operator"
      ansible.builtin.set_fact:
        prometheus_operator_available: >-
          {{
            prometheus_operator_crds.results |
            selectattr('resources', 'defined') |
            selectattr('resources', '>', []) |
            list | length == 3
          }}

    - name: "Information sur l'√©tat de Prometheus Operator"
      ansible.builtin.debug:
        msg: >-
          {{
            '‚úÖ Prometheus Operator d√©tect√© - Configuration compl√®te du monitoring'
            if prometheus_operator_available else
            '‚ö†Ô∏è  Prometheus Operator non d√©tect√© - Monitoring limit√©'
          }}

  tags:
    - keycloak
    - monitoring
    - validation

# =========================================================================
# CONFIGURATION SERVICEMONITOR PROMETHEUS
# =========================================================================
- name: "üìä Configuration ServiceMonitor Prometheus pour Keycloak"
  block:
    - name: "Cr√©ation du ServiceMonitor Keycloak"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: monitoring.coreos.com/v1
          kind: ServiceMonitor
          metadata:
            name: "{{ keycloak_service_name }}-servicemonitor"
            namespace: "{{ keycloak_namespace }}"
            labels:
              app.kubernetes.io/name: "{{ keycloak_service_name }}"
              app.kubernetes.io/component: monitoring
              app.kubernetes.io/part-of: "{{ lions_project_name | default('lions-infrastructure') }}"
              app.kubernetes.io/managed-by: ansible
              app.kubernetes.io/version: "{{ keycloak_version }}"
              environment: "{{ lions_environment }}"
              monitoring.lions.dev/enabled: "true"
            annotations:
              description: "ServiceMonitor pour le monitoring Prometheus de Keycloak"
              documentation: "https://docs.lions.dev/monitoring/keycloak"
              contact: "{{ lions_config_maintainer | default('devops@lions.dev') }}"
          spec:
            selector:
              matchLabels:
                app.kubernetes.io/name: "{{ keycloak_service_name }}"
            endpoints:
              - port: http
                path: "{{ keycloak_metrics_path | default('/auth/realms/master/metrics') }}"
                interval: "{{ keycloak_scrape_interval | default('30s') }}"
                scrapeTimeout: "{{ keycloak_scrape_timeout | default('10s') }}"
                scheme: "{{ 'https' if lions_security_tls_enabled else 'http' }}"
                tlsConfig: "{{ keycloak_tls_config if lions_security_tls_enabled else omit }}"
                metricRelabelings:
                  - sourceLabels: [__name__]
                    regex: "keycloak_.*"
                    targetLabel: service
                    replacement: "{{ keycloak_service_name }}"
                  - sourceLabels: [__name__]
                    regex: "keycloak_.*"
                    targetLabel: environment
                    replacement: "{{ lions_environment }}"
            namespaceSelector:
              matchNames:
                - "{{ keycloak_namespace }}"
      register: servicemonitor_result
      when: prometheus_operator_available

    - name: "V√©rification du d√©ploiement ServiceMonitor"
      ansible.builtin.debug:
        msg: "‚úÖ ServiceMonitor Keycloak cr√©√© avec succ√®s"
      when:
        - prometheus_operator_available
        - servicemonitor_result is succeeded

  when:
    - prometheus_operator_available
    - keycloak_prometheus_scrape | default(true) | bool
  tags:
    - keycloak
    - monitoring
    - prometheus

# =========================================================================
# CONFIGURATION PODMONITOR (MONITORING D√âTAILL√â)
# =========================================================================
- name: "üìà Configuration PodMonitor pour monitoring d√©taill√©"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: monitoring.coreos.com/v1
      kind: PodMonitor
      metadata:
        name: "{{ keycloak_service_name }}-podmonitor"
        namespace: "{{ keycloak_namespace }}"
        labels:
          app.kubernetes.io/name: "{{ keycloak_service_name }}"
          app.kubernetes.io/component: monitoring
          app.kubernetes.io/part-of: "{{ lions_project_name | default('lions-infrastructure') }}"
          environment: "{{ lions_environment }}"
      spec:
        selector:
          matchLabels:
            app.kubernetes.io/name: "{{ keycloak_service_name }}"
        podMetricsEndpoints:
          - port: http-management
            path: "/q/metrics"
            interval: "{{ keycloak_detailed_scrape_interval | default('15s') }}"
            scrapeTimeout: "{{ keycloak_detailed_scrape_timeout | default('10s') }}"
  when:
    - prometheus_operator_available
    - keycloak_detailed_monitoring | default(false) | bool
  tags:
    - keycloak
    - monitoring
    - detailed

# =========================================================================
# CONFIGURATION R√àGLES D'ALERTE PROMETHEUS
# =========================================================================
- name: "üö® Configuration des r√®gles d'alerte Keycloak"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: monitoring.coreos.com/v1
      kind: PrometheusRule
      metadata:
        name: "{{ keycloak_service_name }}-alerts"
        namespace: "{{ keycloak_namespace }}"
        labels:
          app.kubernetes.io/name: "{{ keycloak_service_name }}"
          app.kubernetes.io/component: alerting
          app.kubernetes.io/part-of: "{{ lions_project_name | default('lions-infrastructure') }}"
          app.kubernetes.io/managed-by: ansible
          environment: "{{ lions_environment }}"
          prometheus: kube-prometheus
          role: alert-rules
          tier: "{{ lions_environment }}"
        annotations:
          description: "R√®gles d'alerte Prometheus pour Keycloak"
          runbook_url: "https://docs.lions.dev/runbooks/keycloak-alerts"
      spec:
        groups:
          # ===== ALERTES CRITIQUES =====
          - name: "keycloak.critical"
            interval: "{{ keycloak_alert_evaluation_interval | default('30s') }}"
            rules:
              - alert: KeycloakInstanceDown
                expr: >
                  up{
                    job=~".*{{ keycloak_service_name }}.*",
                    namespace="{{ keycloak_namespace }}"
                  } == 0
                for: "{{ keycloak_alert_down_duration | default('5m') }}"
                labels:
                  severity: critical
                  service: "{{ keycloak_service_name }}"
                  environment: "{{ lions_environment }}"
                  tier: auth
                  team: platform
                  runbook_url: "https://docs.lions.dev/runbooks/keycloak-down"
                annotations:
                  summary: "üî¥ Instance Keycloak indisponible"
                  description: >
                    L'instance Keycloak {{ keycloak_service_name }} dans le namespace 
                    {{ keycloak_namespace }} est indisponible depuis {{ keycloak_alert_down_duration | default('5m') }}.
                    Cela impacte l'authentification sur la plateforme LIONS.
                  action: "V√©rifier l'√©tat des pods Keycloak et les logs d'erreur"
                  dashboard: "https://grafana.{{ lions_dns_full_domain }}/d/keycloak/keycloak-dashboard"

              - alert: KeycloakDatabaseConnectionFailure
                expr: >
                  keycloak_connections_db{
                    namespace="{{ keycloak_namespace }}"
                  } == 0
                for: "{{ keycloak_alert_db_duration | default('3m') }}"
                labels:
                  severity: critical
                  service: "{{ keycloak_service_name }}"
                  environment: "{{ lions_environment }}"
                  component: database
                annotations:
                  summary: "üî¥ √âchec connexion base de donn√©es Keycloak"
                  description: >
                    Keycloak ne peut pas se connecter √† sa base de donn√©es depuis 
                    {{ keycloak_alert_db_duration | default('3m') }}. Service d'authentification compromis.
                  action: "V√©rifier l'√©tat de PostgreSQL et la connectivit√© r√©seau"

          # ===== ALERTES WARNING =====
          - name: "keycloak.warning"
            interval: "{{ keycloak_alert_evaluation_interval | default('30s') }}"
            rules:
              - alert: KeycloakHighMemoryUsage
                expr: >
                  (
                    container_memory_working_set_bytes{
                      pod=~"{{ keycloak_service_name }}.*",
                      namespace="{{ keycloak_namespace }}",
                      container!="POD"
                    } / 
                    container_spec_memory_limit_bytes{
                      pod=~"{{ keycloak_service_name }}.*",
                      namespace="{{ keycloak_namespace }}",
                      container!="POD"
                    }
                  ) * 100 > {{ keycloak_memory_threshold | default('85') }}
                for: "{{ keycloak_alert_memory_duration | default('10m') }}"
                labels:
                  severity: warning
                  service: "{{ keycloak_service_name }}"
                  environment: "{{ lions_environment }}"
                  resource: memory
                annotations:
                  summary: "‚ö†Ô∏è Utilisation m√©moire √©lev√©e Keycloak"
                  description: >
                    Keycloak {{ keycloak_service_name }} utilise plus de 
                    {{ keycloak_memory_threshold | default('85') }}% de sa limite m√©moire 
                    depuis {{ keycloak_alert_memory_duration | default('10m') }}.
                  action: "Consid√©rer l'augmentation des limites m√©moire ou l'optimisation"

              - alert: KeycloakHighCPUUsage
                expr: >
                  (
                    rate(container_cpu_usage_seconds_total{
                      pod=~"{{ keycloak_service_name }}.*",
                      namespace="{{ keycloak_namespace }}",
                      container!="POD"
                    }[5m]) * 100
                  ) > {{ keycloak_cpu_threshold | default('80') }}
                for: "{{ keycloak_alert_cpu_duration | default('15m') }}"
                labels:
                  severity: warning
                  service: "{{ keycloak_service_name }}"
                  environment: "{{ lions_environment }}"
                  resource: cpu
                annotations:
                  summary: "‚ö†Ô∏è Utilisation CPU √©lev√©e Keycloak"
                  description: >
                    Keycloak {{ keycloak_service_name }} utilise plus de 
                    {{ keycloak_cpu_threshold | default('80') }}% CPU 
                    depuis {{ keycloak_alert_cpu_duration | default('15m') }}.

              - alert: KeycloakHighResponseTime
                expr: >
                  histogram_quantile(0.95,
                    rate(http_request_duration_seconds_bucket{
                      job=~".*{{ keycloak_service_name }}.*",
                      namespace="{{ keycloak_namespace }}"
                    }[5m])
                  ) > {{ keycloak_response_time_threshold | default('2') }}
                for: "{{ keycloak_alert_response_duration | default('5m') }}"
                labels:
                  severity: warning
                  service: "{{ keycloak_service_name }}"
                  environment: "{{ lions_environment }}"
                  performance: latency
                annotations:
                  summary: "‚ö†Ô∏è Temps de r√©ponse √©lev√© Keycloak"
                  description: >
                    Le 95e percentile du temps de r√©ponse de Keycloak est sup√©rieur √† 
                    {{ keycloak_response_time_threshold | default('2') }}s depuis 
                    {{ keycloak_alert_response_duration | default('5m') }}.

              - alert: KeycloakHighLoginFailureRate
                expr: >
                  (
                    sum(rate(keycloak_failed_login_attempts_total{
                      namespace="{{ keycloak_namespace }}"
                    }[5m])) /
                    sum(rate(keycloak_login_attempts_total{
                      namespace="{{ keycloak_namespace }}"
                    }[5m]))
                  ) * 100 > {{ keycloak_failure_rate_threshold | default('10') }}
                for: "{{ keycloak_alert_failure_duration | default('5m') }}"
                labels:
                  severity: warning
                  service: "{{ keycloak_service_name }}"
                  environment: "{{ lions_environment }}"
                  security: authentication
                annotations:
                  summary: "‚ö†Ô∏è Taux d'√©chec de connexion √©lev√©"
                  description: >
                    Le taux d'√©chec de connexion Keycloak est sup√©rieur √† 
                    {{ keycloak_failure_rate_threshold | default('10') }}% depuis 
                    {{ keycloak_alert_failure_duration | default('5m') }}. 
                    Possible attaque ou probl√®me de configuration.
                  action: "V√©rifier les logs de s√©curit√© et les tentatives de connexion"

          # ===== ALERTES INFO/BUSINESS =====
          - name: "keycloak.business"
            interval: "{{ keycloak_alert_evaluation_interval | default('30s') }}"
            rules:
              - alert: KeycloakHighActiveUsers
                expr: >
                  keycloak_user_sessions_total{
                    namespace="{{ keycloak_namespace }}"
                  } > {{ keycloak_max_sessions_threshold | default('1000') }}
                for: "{{ keycloak_alert_sessions_duration | default('10m') }}"
                labels:
                  severity: info
                  service: "{{ keycloak_service_name }}"
                  environment: "{{ lions_environment }}"
                  business: capacity
                annotations:
                  summary: "‚ÑπÔ∏è Nombre √©lev√© d'utilisateurs actifs"
                  description: >
                    Plus de {{ keycloak_max_sessions_threshold | default('1000') }} 
                    sessions utilisateur actives d√©tect√©es.
                  action: "Monitorer les performances et pr√©parer la mont√©e en charge"

              - alert: KeycloakRealmConfigurationChange
                expr: >
                  increase(keycloak_realm_configuration_changes_total{
                    namespace="{{ keycloak_namespace }}"
                  }[1h]) > 0
                for: "1m"
                labels:
                  severity: info
                  service: "{{ keycloak_service_name }}"
                  environment: "{{ lions_environment }}"
                  audit: configuration
                annotations:
                  summary: "‚ÑπÔ∏è Modification configuration realm Keycloak"
                  description: "Configuration d'un realm Keycloak modifi√©e dans la derni√®re heure"
                  action: "V√©rifier les logs d'audit pour les changements de configuration"

  when:
    - prometheus_operator_available
    - keycloak_alerts_enabled | default(true) | bool
  tags:
    - keycloak
    - monitoring
    - alerts

# =========================================================================
# CONFIGURATION DASHBOARD GRAFANA
# =========================================================================
- name: "üìä Configuration Dashboard Grafana Keycloak"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "{{ keycloak_service_name }}-dashboard"
        namespace: "{{ lions_monitoring_namespace }}"
        labels:
          grafana_dashboard: "1"
          app.kubernetes.io/name: "{{ keycloak_service_name }}"
          app.kubernetes.io/component: dashboard
          app.kubernetes.io/part-of: "{{ lions_project_name | default('lions-infrastructure') }}"
          environment: "{{ lions_environment }}"
          dashboard.grafana.com/load: "true"
        annotations:
          description: "Dashboard Grafana pour le monitoring Keycloak"
          version: "5.0.0"
          maintainer: "{{ lions_config_maintainer | default('devops@lions.dev') }}"
      data:
        "{{ keycloak_service_name }}-dashboard.json": |
          {
            "annotations": {
              "list": [
                {
                  "builtIn": 1,
                  "datasource": "-- Grafana --",
                  "enable": true,
                  "hide": true,
                  "iconColor": "rgba(0, 211, 255, 1)",
                  "name": "Annotations & Alerts",
                  "type": "dashboard"
                }
              ]
            },
            "description": "Dashboard de monitoring pour Keycloak - LIONS Infrastructure 5.0",
            "editable": true,
            "gnetId": null,
            "graphTooltip": 1,
            "id": null,
            "links": [
              {
                "asDropdown": false,
                "icon": "external link",
                "includeVars": false,
                "keepTime": false,
                "tags": ["keycloak"],
                "targetBlank": true,
                "title": "Keycloak Admin Console",
                "tooltip": "Acc√©der √† la console d'administration Keycloak",
                "type": "link",
                "url": "https://keycloak.{{ lions_dns_full_domain }}/auth/admin/"
              }
            ],
            "panels": [
              {
                "datasource": "Prometheus",
                "fieldConfig": {
                  "defaults": {
                    "color": {
                      "mode": "palette-classic"
                    },
                    "custom": {
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "gradientMode": "none",
                      "hideFrom": {
                        "legend": false,
                        "tooltip": false,
                        "vis": false
                      },
                      "lineInterpolation": "linear",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": {
                        "type": "linear"
                      },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": {
                        "group": "A",
                        "mode": "none"
                      },
                      "thresholdsStyle": {
                        "mode": "off"
                      }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {
                          "color": "green",
                          "value": null
                        },
                        {
                          "color": "red",
                          "value": 80
                        }
                      ]
                    },
                    "unit": "bytes"
                  },
                  "overrides": []
                },
                "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 0,
                  "y": 0
                },
                "id": 2,
                "options": {
                  "legend": {
                    "calcs": ["lastNotNull", "max"],
                    "displayMode": "table",
                    "placement": "right"
                  },
                  "tooltip": {
                    "mode": "multi",
                    "sort": "desc"
                  }
                },
                "targets": [
                  {
                    "expr": "container_memory_working_set_bytes{pod=~\"{{ keycloak_service_name }}.*\", namespace=\"{{ keycloak_namespace }}\", container!=\"POD\"}",
                    "interval": "",
                    "legendFormat": "M√©moire utilis√©e - {{pod}}",
                    "refId": "A"
                  },
                  {
                    "expr": "container_spec_memory_limit_bytes{pod=~\"{{ keycloak_service_name }}.*\", namespace=\"{{ keycloak_namespace }}\", container!=\"POD\"}",
                    "interval": "",
                    "legendFormat": "Limite m√©moire - {{pod}}",
                    "refId": "B"
                  }
                ],
                "title": "üíæ Utilisation M√©moire Keycloak",
                "type": "timeseries"
              },
              {
                "datasource": "Prometheus",
                "fieldConfig": {
                  "defaults": {
                    "color": {
                      "mode": "palette-classic"
                    },
                    "custom": {
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "gradientMode": "none",
                      "hideFrom": {
                        "legend": false,
                        "tooltip": false,
                        "vis": false
                      },
                      "lineInterpolation": "linear",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": {
                        "type": "linear"
                      },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": {
                        "group": "A",
                        "mode": "none"
                      },
                      "thresholdsStyle": {
                        "mode": "off"
                      }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {
                          "color": "green",
                          "value": null
                        },
                        {
                          "color": "red",
                          "value": 80
                        }
                      ]
                    },
                    "unit": "percent"
                  },
                  "overrides": []
                },
                "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 12,
                  "y": 0
                },
                "id": 3,
                "options": {
                  "legend": {
                    "calcs": ["lastNotNull", "max"],
                    "displayMode": "table",
                    "placement": "right"
                  },
                  "tooltip": {
                    "mode": "multi",
                    "sort": "desc"
                  }
                },
                "targets": [
                  {
                    "expr": "rate(container_cpu_usage_seconds_total{pod=~\"{{ keycloak_service_name }}.*\", namespace=\"{{ keycloak_namespace }}\", container!=\"POD\"}[5m]) * 100",
                    "interval": "",
                    "legendFormat": "CPU utilis√© - {{pod}}",
                    "refId": "A"
                  }
                ],
                "title": "üñ•Ô∏è Utilisation CPU Keycloak",
                "type": "timeseries"
              },
              {
                "datasource": "Prometheus",
                "fieldConfig": {
                  "defaults": {
                    "color": {
                      "mode": "palette-classic"
                    },
                    "custom": {
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "barAlignment": 0,
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "gradientMode": "none",
                      "hideFrom": {
                        "legend": false,
                        "tooltip": false,
                        "vis": false
                      },
                      "lineInterpolation": "linear",
                      "lineWidth": 2,
                      "pointSize": 5,
                      "scaleDistribution": {
                        "type": "linear"
                      },
                      "showPoints": "never",
                      "spanNulls": false,
                      "stacking": {
                        "group": "A",
                        "mode": "none"
                      },
                      "thresholdsStyle": {
                        "mode": "off"
                      }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {
                          "color": "green",
                          "value": null
                        },
                        {
                          "color": "red",
                          "value": 80
                        }
                      ]
                    },
                    "unit": "reqps"
                  },
                  "overrides": []
                },
                "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 0,
                  "y": 8
                },
                "id": 4,
                "options": {
                  "legend": {
                    "calcs": ["lastNotNull", "max"],
                    "displayMode": "table",
                    "placement": "right"
                  },
                  "tooltip": {
                    "mode": "multi",
                    "sort": "desc"
                  }
                },
                "targets": [
                  {
                    "expr": "rate(keycloak_login_attempts_total{namespace=\"{{ keycloak_namespace }}\"}[5m])",
                    "interval": "",
                    "legendFormat": "Tentatives de connexion",
                    "refId": "A"
                  },
                  {
                    "expr": "rate(keycloak_failed_login_attempts_total{namespace=\"{{ keycloak_namespace }}\"}[5m])",
                    "interval": "",
                    "legendFormat": "√âchecs de connexion",
                    "refId": "B"
                  }
                ],
                "title": "üîê Activit√© d'Authentification",
                "type": "timeseries"
              },
              {
                "datasource": "Prometheus",
                "fieldConfig": {
                  "defaults": {
                    "color": {
                      "mode": "thresholds"
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        {
                          "color": "red",
                          "value": null
                        },
                        {
                          "color": "green",
                          "value": 1
                        }
                      ]
                    },
                    "unit": "none"
                  },
                  "overrides": []
                },
                "gridPos": {
                  "h": 8,
                  "w": 12,
                  "x": 12,
                  "y": 8
                },
                "id": 5,
                "options": {
                  "colorMode": "background",
                  "graphMode": "area",
                  "justifyMode": "center",
                  "orientation": "horizontal",
                  "reduceOptions": {
                    "calcs": ["lastNotNull"],
                    "fields": "",
                    "values": false
                  },
                  "text": {},
                  "textMode": "auto"
                },
                "pluginVersion": "8.0.0",
                "targets": [
                  {
                    "expr": "up{job=~\".*{{ keycloak_service_name }}.*\", namespace=\"{{ keycloak_namespace }}\"}",
                    "interval": "",
                    "legendFormat": "√âtat Keycloak",
                    "refId": "A"
                  }
                ],
                "title": "üü¢ √âtat du Service Keycloak",
                "type": "stat"
              }
            ],
            "refresh": "30s",
            "schemaVersion": 27,
            "style": "dark",
            "tags": ["keycloak", "auth", "lions", "{{ lions_environment }}"],
            "templating": {
              "list": []
            },
            "time": {
              "from": "now-6h",
              "to": "now"
            },
            "timepicker": {},
            "timezone": "{{ lions_timezone | default('UTC') }}",
            "title": "üîê Keycloak - {{ keycloak_service_name | title }} [{{ lions_environment | upper }}]",
            "uid": "keycloak-{{ keycloak_service_name }}-{{ lions_environment }}",
            "version": 1,
            "weekStart": ""
          }
  when:
    - prometheus_operator_available
    - keycloak_grafana_dashboard | default(true) | bool
  tags:
    - keycloak
    - monitoring
    - grafana
    - dashboard

# =========================================================================
# CONFIGURATION ALERTES SLACK/TEAMS (OPTIONNEL)
# =========================================================================
- name: "üì¢ Configuration notifications AlertManager"
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ keycloak_service_name }}-alertmanager-config"
        namespace: "{{ lions_monitoring_namespace }}"
        labels:
          app.kubernetes.io/name: alertmanager
          app.kubernetes.io/component: notification
          environment: "{{ lions_environment }}"
      type: Opaque
      stringData:
        notification-config.yml: |
          route:
            group_by: ['alertname', 'cluster', 'service']
            group_wait: 10s
            group_interval: 10s
            repeat_interval: 1h
            receiver: 'keycloak-notifications'
            routes:
            - match:
                service: "{{ keycloak_service_name }}"
              receiver: 'keycloak-critical'
              routes:
              - match:
                  severity: critical
                receiver: 'keycloak-critical'
              - match:
                  severity: warning  
                receiver: 'keycloak-warning'
          receivers:
          - name: 'keycloak-notifications'
            slack_configs:
            - api_url: "{{ keycloak_slack_webhook_url | default('') }}"
              channel: '#{{ keycloak_slack_channel | default("lions-alerts") }}'
              title: 'üîê Alerte Keycloak - {{ lions_environment | upper }}'
              text: >
                {{ "{{ range .Alerts }}" }}
                *Alerte:* {{ "{{ .Annotations.summary }}" }}
                *Description:* {{ "{{ .Annotations.description }}" }}
                *Service:* {{ keycloak_service_name }}
                *Environnement:* {{ lions_environment }}
                *S√©v√©rit√©:* {{ "{{ .Labels.severity }}" }}
                {{ "{{ end }}" }}
          - name: 'keycloak-critical'
            slack_configs:
            - api_url: "{{ keycloak_slack_webhook_url | default('') }}"
              channel: '#{{ keycloak_critical_slack_channel | default("lions-critical") }}'
              title: 'üö® ALERTE CRITIQUE - Keycloak {{ lions_environment | upper }}'
              text: >
                @channel ALERTE CRITIQUE Keycloak
                {{ "{{ range .Alerts }}" }}
                *Service:* {{ keycloak_service_name }}
                *Probl√®me:* {{ "{{ .Annotations.summary }}" }}
                *Action requise:* {{ "{{ .Annotations.action | default('Intervention imm√©diate requise') }}" }}
                *Dashboard:* {{ "{{ .Annotations.dashboard | default('Non disponible') }}" }}
                {{ "{{ end }}" }}
          - name: 'keycloak-warning'
            slack_configs:
            - api_url: "{{ keycloak_slack_webhook_url | default('') }}"
              channel: '#{{ keycloak_slack_channel | default("lions-alerts") }}'
              title: '‚ö†Ô∏è Alerte Warning - Keycloak {{ lions_environment | upper }}'
  when:
    - keycloak_notifications_enabled | default(false) | bool
    - keycloak_slack_webhook_url is defined
    - keycloak_slack_webhook_url | length > 0
  tags:
    - keycloak
    - monitoring
    - notifications

# =========================================================================
# VALIDATION FINALE ET REPORTING
# =========================================================================
- name: "‚úÖ Validation finale configuration monitoring Keycloak"
  block:
    - name: "V√©rification d√©ploiement ServiceMonitor"
      kubernetes.core.k8s_info:
        api_version: monitoring.coreos.com/v1
        kind: ServiceMonitor
        name: "{{ keycloak_service_name }}-servicemonitor"
        namespace: "{{ keycloak_namespace }}"
      register: servicemonitor_check
      when: prometheus_operator_available

    - name: "V√©rification d√©ploiement PrometheusRule"
      kubernetes.core.k8s_info:
        api_version: monitoring.coreos.com/v1
        kind: PrometheusRule
        name: "{{ keycloak_service_name }}-alerts"
        namespace: "{{ keycloak_namespace }}"
      register: prometheusrule_check
      when: prometheus_operator_available

    - name: "Rapport de configuration monitoring"
      ansible.builtin.debug:
        msg:
          - "üîê Configuration monitoring Keycloak termin√©e"
          - "üìä ServiceMonitor: {{ '‚úÖ Configur√©' if (prometheus_operator_available and servicemonitor_check.resources | length > 0) else '‚ùå Non configur√©' }}"
          - "üö® AlertRules: {{ '‚úÖ Configur√©es' if (prometheus_operator_available and prometheusrule_check.resources | length > 0) else '‚ùå Non configur√©es' }}"
          - "üìà Dashboard Grafana: {{ '‚úÖ D√©ploy√©' if keycloak_grafana_dashboard | default(true) else '‚ùå D√©sactiv√©' }}"
          - "üì¢ Notifications: {{ '‚úÖ Configur√©es' if (keycloak_notifications_enabled | default(false) and keycloak_slack_webhook_url is defined) else '‚ùå Non configur√©es' }}"
          - "üåê Environnement: {{ lions_environment }}"
          - "üè∑Ô∏è Namespace: {{ keycloak_namespace }}"

  always:
    - name: "Journalisation configuration monitoring"
      ansible.builtin.lineinfile:
        path: "{{ lions_log_file | default('/var/log/lions-infrastructure.log') }}"
        line: >
          {{ ansible_date_time.iso8601 }} - MONITORING - Keycloak {{ keycloak_service_name }} 
          configur√© dans {{ keycloak_namespace }} ({{ lions_environment }})
        create: yes
      delegate_to: localhost
      run_once: true

  tags:
    - keycloak
    - monitoring
    - validation

# =========================================================================