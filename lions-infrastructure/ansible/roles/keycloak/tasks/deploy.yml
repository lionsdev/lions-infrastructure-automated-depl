---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - DÃ‰PLOIEMENT KEYCLOAK
# =========================================================================
# Description: DÃ©ploiement sÃ©curisÃ© et robuste de Keycloak sur Kubernetes
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: 2025-05-27
# Documentation: https://docs.lions.dev/infrastructure/keycloak
# =========================================================================

# =========================================================================
# PHASE 1: PRÃ‰PARATIFS ET VALIDATION PRE-DÃ‰PLOIEMENT
# =========================================================================

- name: "ğŸ” [KEYCLOAK] Validation des prÃ©-requis pour le dÃ©ploiement"
  block:
    - name: "ğŸ“‹ VÃ©rification des variables d'environnement obligatoires"
      assert:
        that:
          - keycloak_namespace is defined and keycloak_namespace != ""
          - keycloak_app_name is defined and keycloak_app_name != ""
          - keycloak_version is defined and keycloak_version != ""
          - keycloak_database_host is defined and keycloak_database_host != ""
        fail_msg: "âŒ Variables d'environnement Keycloak manquantes ou invalides"
        success_msg: "âœ… Variables d'environnement Keycloak validÃ©es"

    - name: "ğŸ” VÃ©rification de la disponibilitÃ© des secrets"
      k8s_info:
        api_version: v1
        kind: Secret
        namespace: "{{ keycloak_namespace }}"
        name: "{{ keycloak_secret_name }}"
      register: keycloak_secret_check
      failed_when: false

    - name: "ğŸ¥ VÃ©rification de la santÃ© du cluster"
      k8s_info:
        api_version: v1
        kind: Node
      register: cluster_nodes

    - name: "ğŸ“Š Affichage de l'Ã©tat du cluster"
      debug:
        msg: "ğŸ—ï¸ Cluster K8s: {{ cluster_nodes.resources | length }} nÅ“uds disponibles"

  rescue:
    - name: "âŒ Ã‰chec de la validation des prÃ©-requis"
      fail:
        msg: "La validation des prÃ©-requis a Ã©chouÃ©. VÃ©rifiez la configuration."

  tags:
    - keycloak
    - validation
    - pre-deployment

# =========================================================================
# PHASE 2: CRÃ‰ATION DES RESSOURCES KUBERNETES
# =========================================================================

- name: "ğŸš€ [KEYCLOAK] DÃ©ploiement des ressources Kubernetes"
  block:
    - name: "ğŸ“¦ CrÃ©ation du ServiceAccount Keycloak"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: "{{ keycloak_service_account_name }}"
            namespace: "{{ keycloak_namespace }}"
            labels:
              app.kubernetes.io/name: keycloak
              app.kubernetes.io/instance: "{{ keycloak_instance_name }}"
              app.kubernetes.io/version: "{{ keycloak_version }}"
              app.kubernetes.io/component: identity-provider
              app.kubernetes.io/part-of: lions-infrastructure
              app.kubernetes.io/managed-by: ansible
              lions.dev/environment: "{{ lions_environment }}"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: "{{ keycloak_timeout_short }}"
      register: serviceaccount_result

    - name: "âš™ï¸ CrÃ©ation du ConfigMap pour Keycloak"
      k8s:
        state: present
        src: "{{ keycloak_temp_dir }}/configmap.yml"
        wait: true
        wait_timeout: "{{ keycloak_timeout_short }}"
      register: configmap_result

    - name: "ğŸ’¾ CrÃ©ation du PersistentVolumeClaim (si nÃ©cessaire)"
      k8s:
        state: present
        src: "{{ keycloak_temp_dir }}/persistentvolumeclaim.yml"
        wait: true
        wait_condition:
          type: Bound
          status: "True"
        wait_timeout: "{{ keycloak_timeout_medium }}"
      register: pvc_result
      when: keycloak_persistence_enabled | default(true) | bool

    - name: "ğŸ”§ DÃ©ploiement de l'application Keycloak"
      k8s:
        state: present
        src: "{{ keycloak_temp_dir }}/deployment.yml"
        wait: false  # Nous gÃ©rerons l'attente manuellement
      register: deployment_result

    - name: "ğŸŒ CrÃ©ation du Service Keycloak"
      k8s:
        state: present
        src: "{{ keycloak_temp_dir }}/service.yml"
        wait: true
        wait_timeout: "{{ keycloak_timeout_short }}"
      register: service_result

    - name: "ğŸ”— CrÃ©ation de l'Ingress pour Keycloak"
      k8s:
        state: present
        src: "{{ keycloak_temp_dir }}/ingress.yml"
        wait: true
        wait_timeout: "{{ keycloak_timeout_short }}"
      register: ingress_result
      when:
        - keycloak_ingress_enabled | default(true) | bool
        - lions_environment != 'development' or keycloak_dev_ingress_enabled | default(true) | bool

  rescue:
    - name: "âŒ Ã‰chec du dÃ©ploiement des ressources"
      debug:
        msg: "Ã‰chec lors de la crÃ©ation des ressources Kubernetes pour Keycloak"

    - name: "ğŸ” Collecte d'informations pour diagnostic"
      k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ keycloak_namespace }}"
        name: "{{ keycloak_app_name }}"
      register: failed_deployment_info
      ignore_errors: true

    - name: "ğŸ“‹ Affichage des informations de diagnostic"
      debug:
        var: failed_deployment_info
      when: failed_deployment_info is defined

    - name: "ğŸ’¥ ArrÃªt du processus avec erreur"
      fail:
        msg: "Le dÃ©ploiement des ressources Keycloak a Ã©chouÃ©"

  tags:
    - keycloak
    - deployment
    - kubernetes

# =========================================================================
# PHASE 3: SURVEILLANCE ET VALIDATION DU DÃ‰PLOIEMENT
# =========================================================================

- name: "â±ï¸ [KEYCLOAK] Surveillance du dÃ©ploiement"
  block:
    - name: "ğŸ”„ Attente du dÃ©ploiement avec retry intelligent"
      k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ keycloak_namespace }}"
        name: "{{ keycloak_app_name }}"
        wait: true
        wait_condition:
          type: Progressing
          status: "True"
          reason: NewReplicaSetAvailable
        wait_timeout: "{{ keycloak_timeout_deployment }}"
      register: deployment_status
      retries: "{{ keycloak_deploy_retries }}"
      delay: "{{ keycloak_deploy_retry_delay }}"
      until: >
        deployment_status.resources | length > 0 and
        deployment_status.resources[0].status.readyReplicas is defined and
        deployment_status.resources[0].status.readyReplicas == deployment_status.resources[0].spec.replicas

    - name: "ğŸ“Š VÃ©rification de l'Ã©tat dÃ©taillÃ© du dÃ©ploiement"
      k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ keycloak_namespace }}"
        name: "{{ keycloak_app_name }}"
      register: final_deployment_status

    - name: "âœ… Validation du succÃ¨s du dÃ©ploiement"
      assert:
        that:
          - final_deployment_status.resources[0].status.readyReplicas is defined
          - final_deployment_status.resources[0].status.readyReplicas > 0
          - final_deployment_status.resources[0].status.readyReplicas == final_deployment_status.resources[0].spec.replicas
        fail_msg: "âŒ Le dÃ©ploiement n'a pas atteint l'Ã©tat souhaitÃ©"
        success_msg: "âœ… DÃ©ploiement rÃ©ussi: {{ final_deployment_status.resources[0].status.readyReplicas }}/{{ final_deployment_status.resources[0].spec.replicas }} replicas"

  rescue:
    - name: "âš ï¸ Gestion des Ã©checs de dÃ©ploiement"
      block:
        - name: "ğŸ” Collecte d'informations sur les pods en Ã©chec"
          k8s_info:
            api_version: v1
            kind: Pod
            namespace: "{{ keycloak_namespace }}"
            label_selectors:
              - "app.kubernetes.io/name=keycloak"
              - "app.kubernetes.io/instance={{ keycloak_instance_name }}"
          register: failed_pods_info

        - name: "ğŸ“‹ Analyse des Ã©vÃ©nements du namespace"
          shell: |
            kubectl get events --namespace {{ keycloak_namespace }} \
              --field-selector involvedObject.name={{ keycloak_app_name }} \
              --sort-by='.lastTimestamp' --no-headers -o custom-columns=REASON:.reason,MESSAGE:.message
          register: deployment_events
          ignore_errors: true
          changed_when: false

        - name: "ğŸš¨ Affichage des informations de diagnostic"
          debug:
            msg:
              - "âŒ Le dÃ©ploiement Keycloak a Ã©chouÃ©"
              - "ğŸ” Pods en Ã©chec: {{ failed_pods_info.resources | length }}"
              - "ğŸ“° Ã‰vÃ©nements rÃ©cents:"
              - "{{ deployment_events.stdout_lines | default(['Aucun Ã©vÃ©nement trouvÃ©']) }}"

        - name: "ğŸ’¥ Ã‰chec critique du dÃ©ploiement"
          fail:
            msg: "Le dÃ©ploiement de Keycloak a Ã©chouÃ© aprÃ¨s {{ keycloak_deploy_retries }} tentatives"

  tags:
    - keycloak
    - monitoring
    - validation

# =========================================================================
# PHASE 4: VÃ‰RIFICATIONS POST-DÃ‰PLOIEMENT
# =========================================================================

- name: "ğŸ” [KEYCLOAK] VÃ©rifications post-dÃ©ploiement"
  block:
    - name: "ğŸ“‹ RÃ©cupÃ©ration des informations sur les pods"
      k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ keycloak_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=keycloak"
          - "app.kubernetes.io/instance={{ keycloak_instance_name }}"
      register: keycloak_pods_info

    - name: "ğŸ” Affichage de l'Ã©tat des pods"
      debug:
        msg: "ğŸ“¦ Pod {{ item.metadata.name }}: {{ item.status.phase | default('Inconnu') }} ({{ item.status.containerStatuses[0].ready | default(false) | ternary('Ready', 'Not Ready') }})"
      loop: "{{ keycloak_pods_info.resources }}"
      loop_control:
        label: "{{ item.metadata.name }}"

    - name: "â³ PÃ©riode d'initialisation de Keycloak"
      pause:
        seconds: "{{ keycloak_init_delay }}"
        prompt: "ğŸ• Attente de l'initialisation complÃ¨te de Keycloak ({{ keycloak_init_delay }}s)"
      when: keycloak_wait_for_init | default(true) | bool

    - name: "ğŸ¥ VÃ©rification de la santÃ© via health endpoint"
      uri:
        url: "{{ keycloak_health_check_url }}"
        method: GET
        status_code: [200, 204]
        timeout: "{{ keycloak_timeout_health_check }}"
        validate_certs: "{{ keycloak_tls_verify | default(true) }}"
      register: keycloak_health_check
      retries: "{{ keycloak_health_check_retries }}"
      delay: "{{ keycloak_health_check_delay }}"
      until: keycloak_health_check is succeeded
      ignore_errors: true

    - name: "ğŸ”Œ Test de connectivitÃ© interne (service)"
      uri:
        url: "http://{{ keycloak_app_name }}.{{ keycloak_namespace }}.svc.cluster.local:{{ keycloak_service_port }}{{ keycloak_health_path }}"
        method: GET
        status_code: [200, 204]
        timeout: "{{ keycloak_timeout_health_check }}"
      register: keycloak_internal_check
      retries: "{{ keycloak_health_check_retries }}"
      delay: "{{ keycloak_health_check_delay }}"
      until: keycloak_internal_check is succeeded
      ignore_errors: true

    - name: "ğŸ’¾ VÃ©rification de la connectivitÃ© base de donnÃ©es"
      uri:
        url: "http://{{ keycloak_app_name }}.{{ keycloak_namespace }}.svc.cluster.local:{{ keycloak_service_port }}/health/ready"
        method: GET
        status_code: [200, 204]
        timeout: "{{ keycloak_timeout_health_check }}"
      register: keycloak_db_check
      retries: 3
      delay: 5
      until: keycloak_db_check is succeeded
      ignore_errors: true

    - name: "ğŸ“Š Collecte des mÃ©triques de performance"
      uri:
        url: "http://{{ keycloak_app_name }}.{{ keycloak_namespace }}.svc.cluster.local:{{ keycloak_service_port }}/metrics"
        method: GET
        status_code: [200, 404]  # 404 acceptable si les mÃ©triques ne sont pas activÃ©es
        timeout: 10
      register: keycloak_metrics
      ignore_errors: true

  rescue:
    - name: "âš ï¸ Gestion des erreurs de vÃ©rification"
      debug:
        msg: "âŒ Certaines vÃ©rifications post-dÃ©ploiement ont Ã©chouÃ©, mais le dÃ©ploiement continue"

  tags:
    - keycloak
    - post-deployment
    - health-check

# =========================================================================
# PHASE 5: MONITORING ET SURVEILLANCE
# =========================================================================

- name: "ğŸ“Š [KEYCLOAK] Configuration du monitoring"
  block:
    - name: "ğŸ“ˆ CrÃ©ation du ServiceMonitor pour Prometheus"
      k8s:
        state: present
        src: "{{ keycloak_temp_dir }}/servicemonitor.yml"
        wait: true
        wait_timeout: "{{ keycloak_timeout_short }}"
      register: servicemonitor_result
      when:
        - keycloak_monitoring_enabled | default(true) | bool
        - lions_monitoring_enabled | default(true) | bool

    - name: "ğŸš¨ Configuration des alertes personnalisÃ©es"
      k8s:
        state: present
        definition:
          apiVersion: monitoring.coreos.com/v1
          kind: PrometheusRule
          metadata:
            name: "{{ keycloak_app_name }}-alerts"
            namespace: "{{ keycloak_namespace }}"
            labels:
              app.kubernetes.io/name: keycloak
              app.kubernetes.io/instance: "{{ keycloak_instance_name }}"
              prometheus: kube-prometheus
              role: alert-rules
          spec:
            groups:
              - name: keycloak.rules
                rules:
                  - alert: KeycloakDown
                    expr: up{job="keycloak"} == 0
                    for: 5m
                    labels:
                      severity: critical
                    annotations:
                      summary: "Keycloak instance is down"
                      description: "Keycloak instance {{ '{{ $labels.instance }}' }} has been down for more than 5 minutes."

                  - alert: KeycloakHighResponseTime
                    expr: http_request_duration_seconds{job="keycloak",quantile="0.95"} > 2
                    for: 10m
                    labels:
                      severity: warning
                    annotations:
                      summary: "Keycloak high response time"
                      description: "Keycloak 95th percentile response time is above 2 seconds."
      when:
        - keycloak_monitoring_enabled | default(true) | bool
        - lions_monitoring_enabled | default(true) | bool
        - keycloak_alerts_enabled | default(true) | bool

  tags:
    - keycloak
    - monitoring
    - prometheus

# =========================================================================
# PHASE 6: RAPPORT FINAL ET LOGGING
# =========================================================================

- name: "ğŸ“‹ [KEYCLOAK] GÃ©nÃ©ration du rapport de dÃ©ploiement"
  block:
    - name: "ğŸ“Š Collecte des informations finales"
      k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ keycloak_namespace }}"
        name: "{{ keycloak_app_name }}"
      register: final_deployment_info

    - name: "ğŸ” Informations sur les services"
      k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ keycloak_namespace }}"
        name: "{{ keycloak_app_name }}"
      register: service_info

    - name: "ğŸŒ Informations sur l'ingress"
      k8s_info:
        api_version: networking.k8s.io/v1
        kind: Ingress
        namespace: "{{ keycloak_namespace }}"
        name: "{{ keycloak_app_name }}"
      register: ingress_info
      when: keycloak_ingress_enabled | default(true) | bool

    - name: "âœ… Rapport de dÃ©ploiement rÃ©ussi"
      debug:
        msg:
          - "ğŸ‰ ============================================="
          - "ğŸ‰          DÃ‰PLOIEMENT KEYCLOAK RÃ‰USSI"
          - "ğŸ‰ ============================================="
          - "ğŸ“¦ Application: {{ keycloak_app_name }}"
          - "ğŸ·ï¸  Version: {{ keycloak_version }}"
          - "ğŸ¢ Namespace: {{ keycloak_namespace }}"
          - "ğŸ”¢ Replicas: {{ final_deployment_info.resources[0].status.readyReplicas | default(0) }}/{{ final_deployment_info.resources[0].spec.replicas }}"
          - "ğŸŒ Service: {{ service_info.resources[0].spec.clusterIP }}:{{ keycloak_service_port }}"
          - "ğŸ”— URL externe: {{ keycloak_external_url | default('Non configurÃ©e') }}"
          - "ğŸ¥ SantÃ©: {{ keycloak_health_check.status | default('Non testÃ©e') }}"
          - "ğŸ’¾ Base de donnÃ©es: {{ keycloak_db_check.status | default('Non testÃ©e') }}"
          - "ğŸ“Š Monitoring: {{ 'ActivÃ©' if (keycloak_monitoring_enabled | default(true)) else 'DÃ©sactivÃ©' }}"
          - "ğŸ¯ Environnement: {{ lions_environment }}"
          - "â° DÃ©ployÃ© le: {{ ansible_date_time.iso8601 }}"
          - "ğŸ‰ ============================================="

    - name: "ğŸ“ Logging du dÃ©ploiement rÃ©ussi"
      lineinfile:
        path: "{{ keycloak_deploy_log_file | default('/var/log/lions/keycloak-deploy.log') }}"
        line: "{{ ansible_date_time.iso8601 }} - SUCCESS - Keycloak {{ keycloak_version }} deployed successfully in {{ keycloak_namespace }} namespace"
        create: true
        mode: '0644'
      delegate_to: localhost
      ignore_errors: true

  rescue:
    - name: "âŒ Rapport d'Ã©chec du dÃ©ploiement"
      debug:
        msg:
          - "ğŸ’¥ ============================================="
          - "ğŸ’¥        Ã‰CHEC DU DÃ‰PLOIEMENT KEYCLOAK"
          - "ğŸ’¥ ============================================="
          - "ğŸ“¦ Application: {{ keycloak_app_name }}"
          - "ğŸ¢ Namespace: {{ keycloak_namespace }}"
          - "â° Ã‰chec le: {{ ansible_date_time.iso8601 }}"
          - "ğŸ’¥ ============================================="

  always:
    - name: "ğŸ§¹ Nettoyage des fichiers temporaires"
      file:
        path: "{{ keycloak_temp_dir }}"
        state: absent
      ignore_errors: true
      when: keycloak_cleanup_temp_files | default(true) | bool

  tags:
    - keycloak
    - reporting
    - cleanup

# =========================================================================
# GESTION GLOBALE DES ERREURS
# =========================================================================
rescue:
  - name: "ğŸš¨ Gestion globale des erreurs critiques"
    block:
      - name: "ğŸ“‹ Collecte d'informations systÃ¨me pour diagnostic"
        shell: |
          echo "=== DIAGNOSTIC SYSTÃˆME ==="
          kubectl get nodes -o wide
          echo ""
          echo "=== UTILISATION DES RESSOURCES ==="
          kubectl top nodes --no-headers | head -5
          echo ""
          echo "=== Ã‰VÃ‰NEMENTS RÃ‰CENTS ==="
          kubectl get events --all-namespaces --sort-by='.lastTimestamp' | tail -10
        register: emergency_diagnostic
        ignore_errors: true

      - name: "ğŸš¨ Notification d'Ã©chec critique"
        debug:
          msg:
            - "ğŸš¨ Ã‰CHEC CRITIQUE: Le dÃ©ploiement de Keycloak a Ã©chouÃ©"
            - "ğŸ” Diagnostic systÃ¨me:"
            - "{{ emergency_diagnostic.stdout_lines | default(['Diagnostic non disponible']) }}"
            - "ğŸ“§ Contactez l'Ã©quipe DevOps pour investigation"

      - name: "ğŸ“ Logging de l'Ã©chec critique"
        lineinfile:
          path: "{{ keycloak_deploy_log_file | default('/var/log/lions/keycloak-deploy.log') }}"
          line: "{{ ansible_date_time.iso8601 }} - CRITICAL_FAILURE - Keycloak deployment failed critically"
          create: true
          mode: '0644'
        delegate_to: localhost
        ignore_errors: true

      - name: "ğŸ’¥ ArrÃªt avec code d'erreur"
        fail:
          msg: "DÃ©ploiement de Keycloak Ã©chouÃ© de maniÃ¨re critique"

# =========================================================================
# FIN DU PLAYBOOK
# =========================================================================