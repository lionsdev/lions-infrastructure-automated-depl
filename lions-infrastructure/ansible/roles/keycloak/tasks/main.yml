---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - R√îLE KEYCLOAK - ORCHESTRATEUR PRINCIPAL
# =========================================================================
# Description: Orchestrateur principal pour le d√©ploiement Keycloak IAM
# Version: 5.0.0
# Date: {{ ansible_date_time.date }}
# Maintainer: DevOps Team <devops@lions.dev>
# Documentation: https://docs.lions.dev/infrastructure/services/keycloak
# Compatibilit√©: Kubernetes 1.24+, Keycloak 22.0+
# =========================================================================

# =========================================================================
# M√âTADONN√âES ET CONTEXTE DE D√âPLOIEMENT
# =========================================================================
- name: "Keycloak | Initialisation du contexte de d√©ploiement"
  set_fact:
    # M√©tadonn√©es de d√©ploiement
    lions_keycloak_deployment_context:
      role_name: "keycloak"
      role_version: "5.0.0"
      deployment_id: "keycloak-{{ ansible_date_time.epoch }}"
      environment: "{{ lions_environment | default('development') }}"
      namespace: "{{ lions_keycloak_namespace | default('security') }}"
      cluster_name: "{{ lions_k8s_cluster_name | default('lions-cluster') }}"
      deployment_strategy: "{{ lions_keycloak_deployment_strategy | default('rolling') }}"

    # Horodatage et tra√ßabilit√©
    lions_keycloak_deployment_tracking:
      started_at: "{{ ansible_date_time.iso8601 }}"
      started_by: "{{ ansible_user_id | default('ansible-system') }}"
      hostname: "{{ ansible_hostname }}"
      ansible_version: "{{ ansible_version.full }}"
      playbook_dir: "{{ playbook_dir | default('N/A') }}"

    # Configuration op√©rationnelle
    lions_keycloak_deployment_config:
      dry_run: "{{ lions_dry_run | default(false) | bool }}"
      debug_mode: "{{ lions_debug_mode | default(false) | bool }}"
      skip_validation: "{{ lions_keycloak_skip_validation | default(false) | bool }}"
      force_recreate: "{{ lions_keycloak_force_recreate | default(false) | bool }}"
      timeout_seconds: "{{ lions_timeout_deployment | default(1800) | int }}"
      check_interval: "{{ lions_keycloak_check_interval | default(30) | int }}"

    # Configuration de s√©curit√©
    lions_keycloak_security_config:
      tls_enabled: "{{ lions_security_tls_enabled | default(true) | bool }}"
      rbac_enabled: "{{ lions_security_rbac_enabled | default(true) | bool }}"
      network_policies: "{{ lions_security_network_policies | default(true) | bool }}"
      pod_security_standards: "{{ lions_security_pod_security_standards | default('restricted') }}"
      vault_integration: "{{ lions_vault_enabled | default(true) | bool }}"
  tags:
    - keycloak
    - metadata
    - always

- name: "Keycloak | Validation des variables d'environnement critiques"
  assert:
    that:
      - lions_keycloak_enabled is defined
      - lions_keycloak_enabled | bool
      - lions_keycloak_version is defined
      - lions_keycloak_version | length > 0
      - lions_keycloak_namespace is defined
      - lions_dns_domain_base is defined
      - lions_infra_target_host is defined
    fail_msg: |
      ‚ùå Variables d'environnement Keycloak manquantes ou incorrectes:
      - LIONS_KEYCLOAK_ENABLED: {{ lions_keycloak_enabled | default('NON D√âFINI') }}
      - LIONS_KEYCLOAK_VERSION: {{ lions_keycloak_version | default('NON D√âFINI') }}
      - LIONS_KEYCLOAK_NAMESPACE: {{ lions_keycloak_namespace | default('NON D√âFINI') }}
      - LIONS_DNS_DOMAIN_BASE: {{ lions_dns_domain_base | default('NON D√âFINI') }}
      - LIONS_INFRA_TARGET_HOST: {{ lions_infra_target_host | default('NON D√âFINI') }}
    success_msg: "‚úÖ Variables d'environnement Keycloak valid√©es avec succ√®s"
  tags:
    - keycloak
    - validation
    - preflight

- name: "Keycloak | Affichage du contexte de d√©ploiement"
  debug:
    msg:
      - "üöÄ D√âMARRAGE DU D√âPLOIEMENT KEYCLOAK LIONS 5.0"
      - "=============================================="
      - "üìä Environnement: {{ lions_keycloak_deployment_context.environment | upper }}"
      - "üè∑Ô∏è  Namespace: {{ lions_keycloak_deployment_context.namespace }}"
      - "üèóÔ∏è  Cluster: {{ lions_keycloak_deployment_context.cluster_name }}"
      - "üÜî ID de d√©ploiement: {{ lions_keycloak_deployment_context.deployment_id }}"
      - "üìÖ D√©marr√© le: {{ lions_keycloak_deployment_tracking.started_at }}"
      - "üë§ Initi√© par: {{ lions_keycloak_deployment_tracking.started_by }}"
      - "üîß Version Keycloak: {{ lions_keycloak_version }}"
      - "üéØ Strat√©gie: {{ lions_keycloak_deployment_context.deployment_strategy }}"
      - "üîí TLS activ√©: {{ lions_keycloak_security_config.tls_enabled }}"
      - "üîê Vault int√©gration: {{ lions_keycloak_security_config.vault_integration }}"
      - "üß™ Mode dry-run: {{ lions_keycloak_deployment_config.dry_run }}"
      - "üêõ Mode debug: {{ lions_keycloak_deployment_config.debug_mode }}"
      - "=============================================="
  when: lions_keycloak_deployment_config.debug_mode | bool
  tags:
    - keycloak
    - debug
    - always

# =========================================================================
# CONFIGURATION AVANC√âE DE LA GESTION D'ERREURS
# =========================================================================
- name: "Keycloak | Configuration de la strat√©gie de gestion d'erreurs"
  set_fact:
    lions_keycloak_error_handling:
      # Strat√©gies de reprise
      max_retries: "{{ lions_keycloak_max_retries | default(3) | int }}"
      retry_delay: "{{ lions_keycloak_retry_delay | default(15) | int }}"
      exponential_backoff: "{{ lions_keycloak_exponential_backoff | default(true) | bool }}"

      # Gestion du rollback
      rollback_enabled: "{{ lions_keycloak_rollback_enabled | default(true) | bool }}"
      rollback_timeout: "{{ lions_keycloak_rollback_timeout | default(600) | int }}"
      preserve_data: "{{ lions_keycloak_preserve_data | default(true) | bool }}"

      # Logging et tra√ßabilit√©
      error_log_dir: "/tmp/lions-keycloak-logs"
      error_log_file: "/tmp/lions-keycloak-logs/deployment-{{ lions_keycloak_deployment_context.deployment_id }}.log"
      detailed_logging: "{{ lions_keycloak_deployment_config.debug_mode | bool }}"

      # Notifications
      slack_webhook: "{{ lions_notification_slack_webhook | default('') }}"
      email_notifications: "{{ lions_notification_email_enabled | default(false) | bool }}"
      webhook_enabled: "{{ lions_notification_webhook_enabled | default(false) | bool }}"
  tags:
    - keycloak
    - error-handling
    - always

- name: "Keycloak | Cr√©ation du r√©pertoire de logs d'erreur"
  file:
    path: "{{ lions_keycloak_error_handling.error_log_dir }}"
    state: directory
    mode: '0755'
  delegate_to: localhost
  tags:
    - keycloak
    - logging
    - always

# =========================================================================
# V√âRIFICATIONS DE SANT√â DE L'ENVIRONNEMENT
# =========================================================================
- name: "Keycloak | V√©rifications de sant√© de l'environnement"
  block:
    - name: "Keycloak | Test de connectivit√© Kubernetes"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: lions_keycloak_k8s_nodes
      retries: "{{ lions_keycloak_error_handling.max_retries }}"
      delay: "{{ lions_keycloak_error_handling.retry_delay }}"

    - name: "Keycloak | V√©rification de l'espace disque disponible"
      kubernetes.core.k8s_info:
        api_version: storage.k8s.io/v1
        kind: StorageClass
        name: "{{ lions_storage_class_default }}"
      register: lions_keycloak_storage_check
      failed_when: false

    - name: "Keycloak | V√©rification de l'√©tat des services pr√©requis"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ item.namespace }}"
        name: "{{ item.service }}"
      register: lions_keycloak_prereq_services
      loop:
        - { namespace: "{{ lions_postgres_namespace | default('database') }}", service: "{{ lions_postgres_service_name | default('postgresql') }}" }
        - { namespace: "{{ lions_vault_namespace | default('vault-system') }}", service: "{{ lions_vault_service_name | default('vault') }}" }
      when:
        - (lions_postgres_enabled | default(true) | bool) or (lions_vault_enabled | default(true) | bool)
      failed_when: false

    - name: "Keycloak | √âvaluation de la sant√© de l'environnement"
      set_fact:
        lions_keycloak_environment_health:
          k8s_ready: "{{ lions_keycloak_k8s_nodes is succeeded }}"
          storage_ready: "{{ lions_keycloak_storage_check.resources is defined }}"
          prereq_services_ready: "{{ lions_keycloak_prereq_services.results | selectattr('resources', 'defined') | list | length > 0 }}"
          overall_healthy: "{{ (lions_keycloak_k8s_nodes is succeeded) and (lions_keycloak_storage_check.resources is defined or lions_keycloak_storage_check is skipped) }}"

  rescue:
    - name: "Keycloak | √âchec des v√©rifications de sant√©"
      set_fact:
        lions_keycloak_deployment_failed: true
        lions_keycloak_failure_phase: "health-checks"
        lions_keycloak_failure_reason: "Environnement non pr√™t: {{ ansible_failed_result.msg | default('V√©rifications de sant√© √©chou√©es') }}"

    - name: "Keycloak | Log d'erreur - Sant√© environnement"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] CRITIQUE - V√©rifications de sant√© √©chou√©es: {{ lions_keycloak_failure_reason }}"
        create: yes

    - name: "Keycloak | Arr√™t critique - Environnement non pr√™t"
      fail:
        msg: "üö® Environnement Kubernetes non pr√™t pour le d√©ploiement Keycloak: {{ lions_keycloak_failure_reason }}"

  tags:
    - keycloak
    - health-checks
    - preflight

# =========================================================================
# PHASE 1: PR√âREQUIS ET D√âPENDANCES SYST√àME
# =========================================================================
- name: "Keycloak | Phase 1 - V√©rification des pr√©requis syst√®me"
  block:
    - name: "Keycloak | Initialisation Phase 1"
      set_fact:
        lions_keycloak_current_phase: "prerequisites"
        lions_keycloak_phase_start_time: "{{ ansible_date_time.epoch }}"

    - name: "Keycloak | Log Phase 1"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] INFO - D√©but Phase 1 (Pr√©requis syst√®me)"
        create: yes

    - name: "Keycloak | Ex√©cution des t√¢ches de pr√©requis"
      include_tasks: prerequisites.yml
      vars:
        current_phase: "{{ lions_keycloak_current_phase }}"
        phase_description: "V√©rification des pr√©requis syst√®me et Kubernetes"
        deployment_context: "{{ lions_keycloak_deployment_context }}"
        security_config: "{{ lions_keycloak_security_config }}"

    - name: "Keycloak | Succ√®s Phase 1"
      set_fact:
        lions_keycloak_phase_1_duration: "{{ (ansible_date_time.epoch | int) - (lions_keycloak_phase_start_time | int) }}"

    - name: "Keycloak | Log succ√®s Phase 1"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] SUCC√àS - Phase 1 termin√©e en {{ lions_keycloak_phase_1_duration }}s"
        create: yes

  rescue:
    - name: "Keycloak | √âchec Phase 1 - Pr√©requis"
      set_fact:
        lions_keycloak_deployment_failed: true
        lions_keycloak_failure_phase: "prerequisites"
        lions_keycloak_failure_reason: "{{ ansible_failed_result.msg | default('√âchec des pr√©requis syst√®me') }}"
        lions_keycloak_failure_details: "{{ ansible_failed_result | default({}) }}"

    - name: "Keycloak | Log d√©taill√© d'erreur Phase 1"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] ERREUR Phase 1 (Pr√©requis): {{ lions_keycloak_failure_reason }}"
        create: yes

    - name: "Keycloak | Notification d'√©chec Phase 1"
      include_tasks: notify_failure.yml
      vars:
        failure_phase: "Phase 1 - Pr√©requis"
        failure_reason: "{{ lions_keycloak_failure_reason }}"
      when: lions_keycloak_error_handling.webhook_enabled | bool

    - name: "Keycloak | Arr√™t critique - Phase 1"
      fail:
        msg: "‚ùå D√©ploiement Keycloak interrompu en Phase 1 (Pr√©requis): {{ lions_keycloak_failure_reason }}"

  tags:
    - keycloak
    - prerequisites
    - phase-1

# =========================================================================
# PHASE 2: PR√âPARATION ET PROVISIONING DES RESSOURCES
# =========================================================================
- name: "Keycloak | Phase 2 - Pr√©paration des ressources Kubernetes"
  block:
    - name: "Keycloak | Initialisation Phase 2"
      set_fact:
        lions_keycloak_current_phase: "preparation"
        lions_keycloak_phase_start_time: "{{ ansible_date_time.epoch }}"

    - name: "Keycloak | Log Phase 2"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] INFO - D√©but Phase 2 (Pr√©paration des ressources)"
        create: yes

    - name: "Keycloak | Ex√©cution des t√¢ches de pr√©paration"
      include_tasks: prepare.yml
      vars:
        current_phase: "{{ lions_keycloak_current_phase }}"
        phase_description: "Cr√©ation des ressources Kubernetes de base"
        deployment_context: "{{ lions_keycloak_deployment_context }}"
        security_config: "{{ lions_keycloak_security_config }}"
        dry_run: "{{ lions_keycloak_deployment_config.dry_run }}"

    - name: "Keycloak | Succ√®s Phase 2"
      set_fact:
        lions_keycloak_phase_2_duration: "{{ (ansible_date_time.epoch | int) - (lions_keycloak_phase_start_time | int) }}"

    - name: "Keycloak | Log succ√®s Phase 2"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] SUCC√àS - Phase 2 termin√©e en {{ lions_keycloak_phase_2_duration }}s"
        create: yes

  rescue:
    - name: "Keycloak | √âchec Phase 2 - Pr√©paration"
      set_fact:
        lions_keycloak_deployment_failed: true
        lions_keycloak_failure_phase: "preparation"
        lions_keycloak_failure_reason: "{{ ansible_failed_result.msg | default('√âchec de la pr√©paration des ressources') }}"

    - name: "Keycloak | Log d'erreur Phase 2"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] ERREUR Phase 2 (Pr√©paration): {{ lions_keycloak_failure_reason }}"
        create: yes

    - name: "Keycloak | Rollback partiel apr√®s √©chec Phase 2"
      include_tasks: rollback.yml
      vars:
        rollback_scope: "preparation"
        preserve_data: "{{ lions_keycloak_error_handling.preserve_data }}"
      when: lions_keycloak_error_handling.rollback_enabled | bool

    - name: "Keycloak | Notification d'√©chec Phase 2"
      include_tasks: notify_failure.yml
      vars:
        failure_phase: "Phase 2 - Pr√©paration"
        failure_reason: "{{ lions_keycloak_failure_reason }}"
      when: lions_keycloak_error_handling.webhook_enabled | bool

    - name: "Keycloak | Arr√™t avec rollback - Phase 2"
      fail:
        msg: "‚ùå D√©ploiement Keycloak interrompu en Phase 2 (Pr√©paration): {{ lions_keycloak_failure_reason }}"

  when: lions_keycloak_deployment_failed is not defined
  tags:
    - keycloak
    - preparation
    - phase-2

# =========================================================================
# PHASE 3: D√âPLOIEMENT PRINCIPAL ET CONFIGURATION
# =========================================================================
- name: "Keycloak | Phase 3 - D√©ploiement principal"
  block:
    - name: "Keycloak | Initialisation Phase 3"
      set_fact:
        lions_keycloak_current_phase: "deployment"
        lions_keycloak_phase_start_time: "{{ ansible_date_time.epoch }}"

    - name: "Keycloak | Log Phase 3"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] INFO - D√©but Phase 3 (D√©ploiement principal)"
        create: yes

    - name: "Keycloak | Ex√©cution du d√©ploiement principal"
      include_tasks: deploy.yml
      vars:
        current_phase: "{{ lions_keycloak_current_phase }}"
        phase_description: "D√©ploiement des composants Keycloak"
        deployment_context: "{{ lions_keycloak_deployment_context }}"
        security_config: "{{ lions_keycloak_security_config }}"
        timeout_seconds: "{{ lions_keycloak_deployment_config.timeout_seconds }}"

    - name: "Keycloak | Attente de la disponibilit√© du service"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ lions_keycloak_deployment_context.namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=keycloak"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: "{{ lions_keycloak_deployment_config.timeout_seconds }}"
      register: lions_keycloak_pods_ready

    - name: "Keycloak | Succ√®s Phase 3"
      set_fact:
        lions_keycloak_phase_3_duration: "{{ (ansible_date_time.epoch | int) - (lions_keycloak_phase_start_time | int) }}"
        lions_keycloak_pods_count: "{{ lions_keycloak_pods_ready.resources | length }}"

    - name: "Keycloak | Log succ√®s Phase 3"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] SUCC√àS - Phase 3 termin√©e en {{ lions_keycloak_phase_3_duration }}s ({{ lions_keycloak_pods_count }} pods pr√™ts)"
        create: yes

  rescue:
    - name: "Keycloak | √âchec Phase 3 - D√©ploiement"
      set_fact:
        lions_keycloak_deployment_failed: true
        lions_keycloak_failure_phase: "deployment"
        lions_keycloak_failure_reason: "{{ ansible_failed_result.msg | default('√âchec du d√©ploiement principal') }}"

    - name: "Keycloak | Collecte des logs de d√©bogage Phase 3"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ lions_keycloak_deployment_context.namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=keycloak"
      register: lions_keycloak_debug_pods
      failed_when: false

    - name: "Keycloak | Log d√©taill√© d'erreur Phase 3"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] ERREUR Phase 3 (D√©ploiement): {{ lions_keycloak_failure_reason }} - Pods trouv√©s: {{ lions_keycloak_debug_pods.resources | length }}"
        create: yes

    - name: "Keycloak | Rollback complet apr√®s √©chec Phase 3"
      include_tasks: rollback.yml
      vars:
        rollback_reason: "√âchec du d√©ploiement principal"
        preserve_data: "{{ lions_keycloak_error_handling.preserve_data }}"
      when: lions_keycloak_error_handling.rollback_enabled | bool

    - name: "Keycloak | Notification d'√©chec critique Phase 3"
      include_tasks: notify_failure.yml
      vars:
        failure_phase: "Phase 3 - D√©ploiement"
        failure_reason: "{{ lions_keycloak_failure_reason }}"
        is_critical: true
      when: lions_keycloak_error_handling.webhook_enabled | bool

    - name: "Keycloak | Arr√™t critique - Phase 3"
      fail:
        msg: "‚ùå D√©ploiement Keycloak interrompu en Phase 3 (D√©ploiement): {{ lions_keycloak_failure_reason }}"

  when: lions_keycloak_deployment_failed is not defined
  tags:
    - keycloak
    - deployment
    - phase-3

# =========================================================================
# PHASE 4: CONFIGURATION DU MONITORING ET M√âTRIQUES
# =========================================================================
- name: "Keycloak | Phase 4 - Configuration du monitoring"
  block:
    - name: "Keycloak | Initialisation Phase 4"
      set_fact:
        lions_keycloak_current_phase: "monitoring"
        lions_keycloak_phase_start_time: "{{ ansible_date_time.epoch }}"

    - name: "Keycloak | Log Phase 4"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] INFO - D√©but Phase 4 (Configuration monitoring)"
        create: yes

    - name: "Keycloak | Configuration du monitoring"
      include_tasks: monitoring.yml
      vars:
        current_phase: "{{ lions_keycloak_current_phase }}"
        phase_description: "Configuration des m√©triques et alertes Keycloak"
        deployment_context: "{{ lions_keycloak_deployment_context }}"
        monitoring_namespace: "{{ lions_monitoring_namespace | default('monitoring') }}"

    - name: "Keycloak | Succ√®s Phase 4"
      set_fact:
        lions_keycloak_phase_4_duration: "{{ (ansible_date_time.epoch | int) - (lions_keycloak_phase_start_time | int) }}"
        lions_keycloak_monitoring_configured: true

    - name: "Keycloak | Log succ√®s Phase 4"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] SUCC√àS - Phase 4 termin√©e en {{ lions_keycloak_phase_4_duration }}s"
        create: yes

  rescue:
    - name: "Keycloak | Gestion non-critique Phase 4 - Monitoring"
      set_fact:
        lions_keycloak_monitoring_failed: true
        lions_keycloak_monitoring_failure_reason: "{{ ansible_failed_result.msg | default('Erreur de monitoring inconnue') }}"

    - name: "Keycloak | Log d'avertissement Phase 4"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] AVERTISSEMENT Phase 4 (Monitoring): {{ lions_keycloak_monitoring_failure_reason }}"
        create: yes

    - name: "Keycloak | Affichage d'avertissement Phase 4"
      debug:
        msg:
          - "‚ö†Ô∏è  √âchec de la configuration du monitoring Keycloak"
          - "‚ÑπÔ∏è  Le d√©ploiement principal a r√©ussi, mais les m√©triques peuvent √™tre indisponibles"
          - "üîç Erreur: {{ lions_keycloak_monitoring_failure_reason }}"
          - "üìä Impact: Dashboards et alertes Keycloak non disponibles"

  when:
    - lions_keycloak_deployment_failed is not defined
    - lions_monitoring_enabled | default(true) | bool
  tags:
    - keycloak
    - monitoring
    - phase-4

# =========================================================================
# PHASE 5: VALIDATION POST-D√âPLOIEMENT ET TESTS FONCTIONNELS
# =========================================================================
- name: "Keycloak | Phase 5 - Validation post-d√©ploiement"
  block:
    - name: "Keycloak | Initialisation Phase 5"
      set_fact:
        lions_keycloak_current_phase: "validation"
        lions_keycloak_phase_start_time: "{{ ansible_date_time.epoch }}"

    - name: "Keycloak | Log Phase 5"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] INFO - D√©but Phase 5 (Validation post-d√©ploiement)"
        create: yes

    - name: "Keycloak | Ex√©cution des tests de validation"
      include_tasks: validate.yml
      vars:
        current_phase: "{{ lions_keycloak_current_phase }}"
        phase_description: "Validation de l'√©tat et des fonctionnalit√©s Keycloak"
        deployment_context: "{{ lions_keycloak_deployment_context }}"
        validation_timeout: "{{ lions_keycloak_deployment_config.timeout_seconds }}"

    - name: "Keycloak | Succ√®s Phase 5"
      set_fact:
        lions_keycloak_phase_5_duration: "{{ (ansible_date_time.epoch | int) - (lions_keycloak_phase_start_time | int) }}"
        lions_keycloak_validation_passed: true

    - name: "Keycloak | Log succ√®s Phase 5"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] SUCC√àS - Phase 5 termin√©e en {{ lions_keycloak_phase_5_duration }}s"
        create: yes

  rescue:
    - name: "Keycloak | √âchec Phase 5 - Validation"
      set_fact:
        lions_keycloak_validation_failed: true
        lions_keycloak_validation_failure_reason: "{{ ansible_failed_result.msg | default('√âchec de la validation fonctionnelle') }}"

    - name: "Keycloak | Log d'erreur Phase 5"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] ERREUR Phase 5 (Validation): {{ lions_keycloak_validation_failure_reason }}"
        create: yes

    - name: "Keycloak | D√©cision sur les actions correctives"
      debug:
        msg:
          - "‚ö†Ô∏è  Validation fonctionnelle √©chou√©e"
          - "üîç Raison: {{ lions_keycloak_validation_failure_reason }}"
          - "ü§î Keycloak peut √™tre partiellement fonctionnel"
          - "üéØ Recommandation: V√©rifier manuellement l'√©tat du service"

  when:
    - lions_keycloak_deployment_failed is not defined
    - not lions_keycloak_deployment_config.skip_validation | bool
  tags:
    - keycloak
    - validation
    - phase-5

# =========================================================================
# PHASE 6: CONFIGURATION DE LA SAUVEGARDE ET R√âCUP√âRATION
# =========================================================================
- name: "Keycloak | Phase 6 - Configuration de la sauvegarde"
  block:
    - name: "Keycloak | Initialisation Phase 6"
      set_fact:
        lions_keycloak_current_phase: "backup"
        lions_keycloak_phase_start_time: "{{ ansible_date_time.epoch }}"

    - name: "Keycloak | Log Phase 6"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] INFO - D√©but Phase 6 (Configuration sauvegarde)"
        create: yes

    - name: "Keycloak | Configuration des strat√©gies de sauvegarde"
      include_tasks: backup.yml
      vars:
        current_phase: "{{ lions_keycloak_current_phase }}"
        phase_description: "Configuration des strat√©gies de sauvegarde Keycloak"
        deployment_context: "{{ lions_keycloak_deployment_context }}"
        backup_retention_days: "{{ lions_backup_retention_days | default(30) }}"
        backup_schedule: "{{ lions_backup_schedule | default('0 2 * * *') }}"

    - name: "Keycloak | Succ√®s Phase 6"
      set_fact:
        lions_keycloak_phase_6_duration: "{{ (ansible_date_time.epoch | int) - (lions_keycloak_phase_start_time | int) }}"
        lions_keycloak_backup_configured: true

    - name: "Keycloak | Log succ√®s Phase 6"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] SUCC√àS - Phase 6 termin√©e en {{ lions_keycloak_phase_6_duration }}s"
        create: yes

  rescue:
    - name: "Keycloak | Gestion non-critique Phase 6 - Sauvegarde"
      set_fact:
        lions_keycloak_backup_failed: true
        lions_keycloak_backup_failure_reason: "{{ ansible_failed_result.msg | default('Erreur de configuration de sauvegarde') }}"

    - name: "Keycloak | Log d'avertissement Phase 6"
      lineinfile:
        path: "{{ lions_keycloak_error_handling.error_log_file }}"
        line: "[{{ ansible_date_time.iso8601 }}] AVERTISSEMENT Phase 6 (Sauvegarde): {{ lions_keycloak_backup_failure_reason }}"
        create: yes

    - name: "Keycloak | Affichage d'avertissement Phase 6"
      debug:
        msg:
          - "‚ö†Ô∏è  √âchec de la configuration de sauvegarde Keycloak"
          - "‚ÑπÔ∏è  Keycloak fonctionne mais les sauvegardes automatiques sont d√©sactiv√©es"
          - "üîç Erreur: {{ lions_keycloak_backup_failure_reason }}"
          - "üíæ Impact: Pas de sauvegarde automatique des donn√©es Keycloak"
          - "üéØ Action: Configurer manuellement les sauvegardes si n√©cessaire"

  when:
    - lions_keycloak_deployment_failed is not defined
    - lions_backup_enabled | default(true) | bool
    - lions_keycloak_backup_enabled | default(true) | bool
  tags:
    - keycloak
    - backup
    - phase-6

# =========================================================================
# G√âN√âRATION DU RAPPORT FINAL DE D√âPLOIEMENT
# =========================================================================
- name: "Keycloak | Calcul des m√©triques de performance"
  set_fact:
    lions_keycloak_deployment_performance:
      total_duration: "{{ (ansible_date_time.epoch | int) - (lions_keycloak_deployment_context.deployment_id | regex_replace('keycloak-', '') | int) }}"
      phase_1_duration: "{{ lions_keycloak_phase_1_duration | default(0) }}"
      phase_2_duration: "{{ lions_keycloak_phase_2_duration | default(0) }}"
      phase_3_duration: "{{ lions_keycloak_phase_3_duration | default(0) }}"
      phase_4_duration: "{{ lions_keycloak_phase_4_duration | default(0) }}"
      phase_5_duration: "{{ lions_keycloak_phase_5_duration | default(0) }}"
      phase_6_duration: "{{ lions_keycloak_phase_6_duration | default(0) }}"
      pods_deployed: "{{ lions_keycloak_pods_count | default(0) }}"
  tags:
    - keycloak
    - metrics
    - always

- name: "Keycloak | G√©n√©ration du rapport final de d√©ploiement"
  set_fact:
    lions_keycloak_deployment_report:
      # Statut global
      status: "{{ 'FAILED' if lions_keycloak_deployment_failed | default(false) else 'SUCCESS' }}"
      deployment_health: "{{ 'HEALTHY' if not (lions_keycloak_deployment_failed | default(false) or lions_keycloak_validation_failed | default(false)) else 'DEGRADED' }}"

      # M√©tadonn√©es
      environment: "{{ lions_keycloak_deployment_context.environment }}"
      namespace: "{{ lions_keycloak_deployment_context.namespace }}"
      cluster: "{{ lions_keycloak_deployment_context.cluster_name }}"
      deployment_id: "{{ lions_keycloak_deployment_context.deployment_id }}"

      # Chronologie
      started_at: "{{ lions_keycloak_deployment_tracking.started_at }}"
      completed_at: "{{ ansible_date_time.iso8601 }}"
      total_duration_seconds: "{{ lions_keycloak_deployment_performance.total_duration }}"

      # √âchecs et erreurs
      failed_phase: "{{ lions_keycloak_failure_phase | default('N/A') }}"
      failure_reason: "{{ lions_keycloak_failure_reason | default('N/A') }}"

      # Statut des composants
      monitoring_status: "{{ 'FAILED' if lions_keycloak_monitoring_failed | default(false) else 'OK' }}"
      backup_status: "{{ 'FAILED' if lions_keycloak_backup_failed | default(false) else 'OK' }}"
      validation_status: "{{ 'FAILED' if lions_keycloak_validation_failed | default(false) else 'OK' }}"

      # Configuration technique
      keycloak_version: "{{ lions_keycloak_version }}"
      keycloak_service_name: "{{ lions_keycloak_service_name | default('keycloak') }}"
      keycloak_endpoint: "{{ lions_keycloak_service_name | default('keycloak') }}.{{ lions_keycloak_deployment_context.namespace }}.svc.cluster.local:{{ lions_keycloak_port | default(8080) }}"
      keycloak_admin_console: "https://{{ lions_keycloak_service_name | default('keycloak') }}.{{ lions_dns_full_domain | default(lions_dns_domain_base) }}/admin"

      # M√©triques de performance
      performance_metrics: "{{ lions_keycloak_deployment_performance }}"

      # Configuration de s√©curit√©
      security_features:
        tls_enabled: "{{ lions_keycloak_security_config.tls_enabled }}"
        rbac_enabled: "{{ lions_keycloak_security_config.rbac_enabled }}"
        network_policies: "{{ lions_keycloak_security_config.network_policies }}"
        vault_integration: "{{ lions_keycloak_security_config.vault_integration }}"

      # Environnement syst√®me
      system_info:
        ansible_version: "{{ lions_keycloak_deployment_tracking.ansible_version }}"
        hostname: "{{ lions_keycloak_deployment_tracking.hostname }}"
        initiated_by: "{{ lions_keycloak_deployment_tracking.started_by }}"
  tags:
    - keycloak
    - report
    - always

- name: "Keycloak | Affichage du rapport final de d√©ploiement"
  debug:
    msg:
      - "=============================================="
      - "üìä RAPPORT FINAL DE D√âPLOIEMENT KEYCLOAK 5.0"
      - "=============================================="
      - "‚úÖ Statut global: {{ lions_keycloak_deployment_report.status }} ({{ lions_keycloak_deployment_report.deployment_health }})"
      - "üåç Environnement: {{ lions_keycloak_deployment_report.environment | upper }}"
      - "üèóÔ∏è  Cluster: {{ lions_keycloak_deployment_report.cluster }}"
      - "üè∑Ô∏è  Namespace: {{ lions_keycloak_deployment_report.namespace }}"
      - "üÜî ID de d√©ploiement: {{ lions_keycloak_deployment_report.deployment_id }}"
      - "‚è±Ô∏è  Dur√©e totale: {{ lions_keycloak_deployment_report.total_duration_seconds }}s"
      - "üîê Version Keycloak: {{ lions_keycloak_deployment_report.keycloak_version }}"
      - "üîó Endpoint interne: {{ lions_keycloak_deployment_report.keycloak_endpoint }}"
      - "üåê Console d'admin: {{ lions_keycloak_deployment_report.keycloak_admin_console }}"
      - "üöÄ Pods d√©ploy√©s: {{ lions_keycloak_deployment_report.performance_metrics.pods_deployed }}"
      - "=============================================="
      - "üìà STATUT DES COMPOSANTS:"
      - "  üìä Monitoring: {{ lions_keycloak_deployment_report.monitoring_status }}"
      - "  üíæ Sauvegarde: {{ lions_keycloak_deployment_report.backup_status }}"
      - "  ‚úÖ Validation: {{ lions_keycloak_deployment_report.validation_status }}"
      - "=============================================="
      - "üîí S√âCURIT√â:"
      - "  üîê TLS: {{ 'Activ√©' if lions_keycloak_deployment_report.security_features.tls_enabled else 'D√©sactiv√©' }}"
      - "  üõ°Ô∏è  RBAC: {{ 'Activ√©' if lions_keycloak_deployment_report.security_features.rbac_enabled else 'D√©sactiv√©' }}"
      - "  üöß Politiques r√©seau: {{ 'Activ√©es' if lions_keycloak_deployment_report.security_features.network_policies else 'D√©sactiv√©es' }}"
      - "  üóùÔ∏è  Vault: {{ 'Int√©gr√©' if lions_keycloak_deployment_report.security_features.vault_integration else 'Non int√©gr√©' }}"
      - "=============================================="
      - "‚è±Ô∏è  PERFORMANCE PAR PHASE:"
      - "  Phase 1 (Pr√©requis): {{ lions_keycloak_deployment_report.performance_metrics.phase_1_duration }}s"
      - "  Phase 2 (Pr√©paration): {{ lions_keycloak_deployment_report.performance_metrics.phase_2_duration }}s"
      - "  Phase 3 (D√©ploiement): {{ lions_keycloak_deployment_report.performance_metrics.phase_3_duration }}s"
      - "  Phase 4 (Monitoring): {{ lions_keycloak_deployment_report.performance_metrics.phase_4_duration }}s"
      - "  Phase 5 (Validation): {{ lions_keycloak_deployment_report.performance_metrics.phase_5_duration }}s"
      - "  Phase 6 (Sauvegarde): {{ lions_keycloak_deployment_report.performance_metrics.phase_6_duration }}s"
      - "=============================================="
      - "{{ '‚ùå √âCHEC en ' + lions_keycloak_deployment_report.failed_phase + ': ' + lions_keycloak_deployment_report.failure_reason if lions_keycloak_deployment_report.status == 'FAILED' else 'üéâ D√âPLOIEMENT R√âUSSI !' }}"
      - "=============================================="
  tags:
    - keycloak
    - report
    - always

- name: "Keycloak | Sauvegarde du rapport JSON"
  copy:
    content: "{{ lions_keycloak_deployment_report | to_nice_json }}"
    dest: "/tmp/lions-keycloak-deployment-report-{{ lions_keycloak_deployment_context.deployment_id }}.json"
    mode: '0644'
  delegate_to: localhost
  tags:
    - keycloak
    - report

- name: "Keycloak | Notification de succ√®s"
  include_tasks: notify_success.yml
  vars:
    deployment_report: "{{ lions_keycloak_deployment_report }}"
  when:
    - lions_keycloak_deployment_report.status == "SUCCESS"
    - lions_keycloak_error_handling.webhook_enabled | bool
  tags:
    - keycloak
    - notifications

# =========================================================================
# NETTOYAGE ET FINALISATION
# =========================================================================
- name: "Keycloak | Nettoyage s√©lectif des fichiers temporaires"
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ lions_keycloak_error_handling.error_log_file }}"
  when:
    - lions_keycloak_deployment_report.status == "SUCCESS"
    - not lions_keycloak_deployment_config.debug_mode | bool
    - lions_environment != "development"
  ignore_errors: yes
  tags:
    - keycloak
    - cleanup

- name: "Keycloak | Archivage des logs de d√©ploiement"
  archive:
    path: "{{ lions_keycloak_error_handling.error_log_dir }}"
    dest: "/tmp/lions-keycloak-logs-{{ lions_keycloak_deployment_context.deployment_id }}.tar.gz"
    remove: false
  when:
    - lions_keycloak_deployment_config.debug_mode | bool
    - lions_keycloak_error_handling.detailed_logging | bool
  delegate_to: localhost
  ignore_errors: yes
  tags:
    - keycloak
    - archiving

- name: "Keycloak | Message de finalisation personnalis√©"
  debug:
    msg: |
      {% if lions_keycloak_deployment_report.status == 'SUCCESS' %}
      üéâ D√âPLOIEMENT KEYCLOAK LIONS 5.0 TERMIN√â AVEC SUCC√àS !
      
      üöÄ Keycloak est maintenant disponible et pr√™t √† l'emploi
      üìã Informations de connexion:
         ‚Ä¢ Console d'administration: {{ lions_keycloak_deployment_report.keycloak_admin_console }}
         ‚Ä¢ Endpoint API: {{ lions_keycloak_deployment_report.keycloak_endpoint }}
         ‚Ä¢ Namespace: {{ lions_keycloak_deployment_report.namespace }}
      
      üìä Statistiques de d√©ploiement:
         ‚Ä¢ Dur√©e totale: {{ lions_keycloak_deployment_report.total_duration_seconds }}s
         ‚Ä¢ Pods d√©ploy√©s: {{ lions_keycloak_deployment_report.performance_metrics.pods_deployed }}
         ‚Ä¢ Environnement: {{ lions_keycloak_deployment_report.environment | upper }}
      
      üìö Ressources utiles:
         ‚Ä¢ Documentation: https://docs.lions.dev/infrastructure/services/keycloak
         ‚Ä¢ Guide d'administration: https://docs.lions.dev/guides/keycloak-admin
         ‚Ä¢ Monitoring: {{ lions_keycloak_deployment_report.keycloak_admin_console }}/monitoring
      
      {% if lions_keycloak_deployment_report.monitoring_status == 'FAILED' %}
      ‚ö†Ô∏è  ATTENTION: Le monitoring n'a pas pu √™tre configur√©
      {% endif %}
      {% if lions_keycloak_deployment_report.backup_status == 'FAILED' %}
      ‚ö†Ô∏è  ATTENTION: Les sauvegardes automatiques ne sont pas configur√©es
      {% endif %}
      {% else %}
      üí• √âCHEC DU D√âPLOIEMENT KEYCLOAK LIONS 5.0
      
      üîç D√©tails de l'√©chec:
         ‚Ä¢ Phase d'√©chec: {{ lions_keycloak_deployment_report.failed_phase | upper }}
         ‚Ä¢ Raison: {{ lions_keycloak_deployment_report.failure_reason }}
         ‚Ä¢ Dur√©e avant √©chec: {{ lions_keycloak_deployment_report.total_duration_seconds }}s
      
      üõ†Ô∏è  Actions de d√©pannage:
         ‚Ä¢ Consultez les logs: {{ lions_keycloak_error_handling.error_log_file }}
         ‚Ä¢ Rapport d√©taill√©: /tmp/lions-keycloak-deployment-report-{{ lions_keycloak_deployment_context.deployment_id }}.json
         ‚Ä¢ Guide de d√©pannage: https://docs.lions.dev/infrastructure/troubleshooting/keycloak
      
      üîÑ Pour relancer le d√©ploiement:
         ansible-playbook -i inventories/{{ lions_keycloak_deployment_context.environment }}/hosts.yml playbooks/deploy-application-services.yml --tags keycloak
      {% endif %}
  tags:
    - keycloak
    - always