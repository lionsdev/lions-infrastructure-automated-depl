---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - KEYCLOAK PREREQUISITES
# =========================================================================
# Description: VÃ©rification et prÃ©paration des prÃ©requis pour le dÃ©ploiement de Keycloak
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: "{{ ansible_date_time.date }}"
# Documentation: https://docs.lions.dev/infrastructure/keycloak/prerequisites
# =========================================================================

# =========================================================================
# SECTION 1: VALIDATION DES VARIABLES CRITIQUES
# =========================================================================
- name: "ğŸ” [VALIDATION] VÃ©rification des variables critiques Keycloak"
  block:
    - name: "Validation de la configuration Keycloak"
      assert:
        that:
          - keycloak_namespace is defined and keycloak_namespace != ""
          - keycloak_service_name is defined and keycloak_service_name != ""
          - keycloak_version is defined and keycloak_version != ""
          - keycloak_port is defined and keycloak_port != ""
          - lions_environment is defined and lions_environment != ""
        fail_msg: "âŒ Variables critiques Keycloak manquantes ou vides"
        success_msg: "âœ… Variables critiques Keycloak validÃ©es"
      tags: ['validation', 'keycloak']

    - name: "Validation de la configuration des ressources"
      assert:
        that:
          - keycloak_resources_cpu_request is defined
          - keycloak_resources_memory_request is defined
          - keycloak_resources_cpu_limit is defined
          - keycloak_resources_memory_limit is defined
        fail_msg: "âŒ Configuration des ressources Keycloak incomplÃ¨te"
        success_msg: "âœ… Configuration des ressources Keycloak validÃ©e"
      tags: ['validation', 'resources']

  rescue:
    - name: "âŒ Ã‰chec de la validation des variables"
      fail:
        msg: |
          La validation des variables critiques a Ã©chouÃ©.
          VÃ©rifiez que toutes les variables requises sont dÃ©finies dans:
          - ansible/vars/common.yml
          - ansible/vars/{{ lions_environment }}.yml
          - ansible/roles/keycloak/vars/main.yml

# =========================================================================
# SECTION 2: VÃ‰RIFICATION DE L'INFRASTRUCTURE KUBERNETES
# =========================================================================
- name: "ğŸ—ï¸ [INFRASTRUCTURE] VÃ©rification de l'Ã©tat du cluster Kubernetes"
  block:
    - name: "VÃ©rification de la connectivitÃ© au cluster K8s"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: k8s_nodes_info
      failed_when: false
      tags: ['infrastructure', 'k8s']

    - name: "Validation de la connectivitÃ© K8s"
      assert:
        that:
          - k8s_nodes_info is succeeded
          - k8s_nodes_info.resources | length > 0
        fail_msg: "âŒ Impossible de se connecter au cluster Kubernetes"
        success_msg: "âœ… ConnectivitÃ© au cluster Kubernetes validÃ©e"

    - name: "Collecte des informations sur les nÅ“uds"
      set_fact:
        k8s_cluster_info:
          nodes_count: "{{ k8s_nodes_info.resources | length }}"
          nodes_ready: "{{ k8s_nodes_info.resources | json_query('[?status.conditions[?type==`Ready` && status==`True`]]') | length }}"
          kubernetes_version: "{{ k8s_nodes_info.resources[0].status.nodeInfo.kubeletVersion | default('unknown') }}"

    - name: "Affichage des informations cluster"
      debug:
        msg: |
          ğŸ“Š Informations du cluster Kubernetes:
          - NÅ“uds total: {{ k8s_cluster_info.nodes_count }}
          - NÅ“uds prÃªts: {{ k8s_cluster_info.nodes_ready }}
          - Version K8s: {{ k8s_cluster_info.kubernetes_version }}
      tags: ['information']

  rescue:
    - name: "âŒ Ã‰chec de vÃ©rification de l'infrastructure K8s"
      fail:
        msg: |
          Impossible de vÃ©rifier l'Ã©tat du cluster Kubernetes.
          VÃ©rifiez que:
          - Le cluster K8s est accessible
          - Les credentials kubectl sont configurÃ©s
          - Le service kube-apiserver fonctionne

# =========================================================================
# SECTION 3: GESTION DES NAMESPACES
# =========================================================================
- name: "ğŸ“ [NAMESPACE] Gestion du namespace Keycloak"
  block:
    - name: "VÃ©rification de l'existence du namespace {{ keycloak_namespace }}"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ keycloak_namespace }}"
      register: keycloak_namespace_info
      tags: ['namespace']

    - name: "CrÃ©ation du namespace {{ keycloak_namespace }}"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ keycloak_namespace }}"
            labels:
              app.kubernetes.io/name: "keycloak"
              app.kubernetes.io/component: "identity-provider"
              app.kubernetes.io/part-of: "lions-infrastructure"
              app.kubernetes.io/managed-by: "ansible"
              app.kubernetes.io/version: "{{ keycloak_version }}"
              lions.dev/environment: "{{ lions_environment }}"
              lions.dev/service-type: "security"
            annotations:
              lions.dev/created-by: "ansible-{{ ansible_user | default('automation') }}"
              lions.dev/created-date: "{{ ansible_date_time.iso8601 }}"
              lions.dev/description: "Namespace for Keycloak identity and access management"
      when: keycloak_namespace_info.resources | length == 0
      tags: ['namespace', 'creation']

    - name: "Validation des permissions dans le namespace"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "keycloak-access-validation"
            namespace: "{{ keycloak_namespace }}"
            labels:
              lions.dev/test: "access-validation"
          data:
            validation: "{{ ansible_date_time.iso8601 }}"
            environment: "{{ lions_environment }}"
      register: access_validation_result
      tags: ['validation', 'permissions']

    - name: "Nettoyage du ConfigMap de validation"
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "keycloak-access-validation"
        namespace: "{{ keycloak_namespace }}"
      when: access_validation_result is succeeded
      tags: ['cleanup']

  rescue:
    - name: "âŒ Ã‰chec de gestion du namespace"
      fail:
        msg: |
          Impossible de crÃ©er ou d'accÃ©der au namespace {{ keycloak_namespace }}.
          VÃ©rifiez que vous avez les permissions suffisantes.

# =========================================================================
# SECTION 4: VÃ‰RIFICATION DES DÃ‰PENDANCES CRITIQUES
# =========================================================================
- name: "ğŸ”— [DEPENDENCIES] VÃ©rification des dÃ©pendances critiques"
  block:
    # VÃ©rification de PostgreSQL
    - name: "VÃ©rification du service PostgreSQL"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "{{ keycloak_database_service }}"
        namespace: "{{ keycloak_database_namespace }}"
      register: postgres_service_info
      tags: ['dependencies', 'database']

    - name: "Validation de la disponibilitÃ© PostgreSQL"
      set_fact:
        postgres_available: "{{ postgres_service_info.resources | length > 0 }}"

    - name: "Test de connectivitÃ© PostgreSQL"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Pod
          metadata:
            name: "postgres-connectivity-test"
            namespace: "{{ keycloak_namespace }}"
            labels:
              lions.dev/test: "connectivity"
          spec:
            restartPolicy: Never
            containers:
              - name: postgres-test
                image: "postgres:{{ postgres_version | default('15') }}-alpine"
                command:
                  - "/bin/sh"
                  - "-c"
                  - |
                    pg_isready -h {{ keycloak_database_service }}.{{ keycloak_database_namespace }}.svc.cluster.local -p {{ postgres_port | default('5432') }} -U {{ keycloak_database_user | default('keycloak') }}
                env:
                  - name: PGPASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: "{{ keycloak_database_secret }}"
                        key: "password"
                        optional: true
      register: postgres_test_creation
      when: postgres_available
      failed_when: false
      tags: ['connectivity', 'database']

    # Attendre et vÃ©rifier le rÃ©sultat du test
    - name: "Attente du rÃ©sultat du test PostgreSQL"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        name: "postgres-connectivity-test"
        namespace: "{{ keycloak_namespace }}"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 60
      register: postgres_test_result
      when: postgres_available and postgres_test_creation is succeeded
      failed_when: false
      tags: ['connectivity']

    # Nettoyage du pod de test
    - name: "Nettoyage du pod de test PostgreSQL"
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Pod
        name: "postgres-connectivity-test"
        namespace: "{{ keycloak_namespace }}"
      when: postgres_test_creation is succeeded
      tags: ['cleanup']

  rescue:
    - name: "âš ï¸ Avertissement sur les dÃ©pendances"
      debug:
        msg: |
          âš ï¸ Certaines dÃ©pendances ne sont pas disponibles:
          - PostgreSQL: {{ 'Disponible' if postgres_available else 'Non disponible' }}
          
          Keycloak pourra Ãªtre dÃ©ployÃ© mais pourrait ne pas fonctionner correctement
          sans toutes ses dÃ©pendances.

# =========================================================================
# SECTION 5: VÃ‰RIFICATION DES COMPOSANTS D'INFRASTRUCTURE
# =========================================================================
- name: "ğŸ› ï¸ [INFRASTRUCTURE] VÃ©rification des composants d'infrastructure"
  block:
    # VÃ©rification de l'Ingress Controller
    - name: "Detection de l'Ingress Controller"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ item.namespace }}"
        label_selectors:
          - "{{ item.selector }}"
      register: ingress_controllers
      loop:
        - { namespace: "kube-system", selector: "app.kubernetes.io/name=traefik" }
        - { namespace: "ingress-nginx", selector: "app.kubernetes.io/name=ingress-nginx" }
        - { namespace: "nginx-ingress", selector: "app=nginx-ingress" }
      failed_when: false
      tags: ['infrastructure', 'ingress']

    - name: "Identification de l'Ingress Controller actif"
      set_fact:
        active_ingress_controller: >-
          {%- for result in ingress_controllers.results -%}
            {%- if result.resources | length > 0 -%}
              {%- if 'traefik' in result.item.selector -%}traefik
              {%- elif 'ingress-nginx' in result.item.selector -%}nginx
              {%- elif 'nginx-ingress' in result.item.selector -%}nginx-legacy
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}

    # VÃ©rification de cert-manager
    - name: "VÃ©rification de cert-manager"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "cert-manager"
        namespace: "cert-manager"
      register: cert_manager_info
      failed_when: false
      tags: ['infrastructure', 'tls']

    # VÃ©rification des issuer TLS
    - name: "VÃ©rification des ClusterIssuer TLS"
      kubernetes.core.k8s_info:
        api_version: cert-manager.io/v1
        kind: ClusterIssuer
      register: cluster_issuers_info
      failed_when: false
      tags: ['infrastructure', 'tls']

    - name: "RÃ©sumÃ© de l'infrastructure disponible"
      debug:
        msg: |
          ğŸ—ï¸ Ã‰tat de l'infrastructure:
          - Ingress Controller: {{ active_ingress_controller | default('Aucun dÃ©tectÃ©') }}
          - cert-manager: {{ 'Disponible' if cert_manager_info.resources | length > 0 else 'Non disponible' }}
          - ClusterIssuers: {{ cluster_issuers_info.resources | length if cluster_issuers_info is succeeded else 0 }}
          - TLS activÃ©: {{ keycloak_tls_enabled | default(false) }}
      tags: ['information']

# =========================================================================
# SECTION 6: VÃ‰RIFICATION DE VAULT (SI ACTIVÃ‰)
# =========================================================================
- name: "ğŸ” [VAULT] VÃ©rification de HashiCorp Vault"
  block:
    - name: "VÃ©rification du service Vault"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "{{ vault_service_name | default('vault') }}"
        namespace: "{{ vault_namespace | default('vault-system') }}"
      register: vault_service_info
      tags: ['vault', 'security']

    - name: "Test de connectivitÃ© Vault"
      uri:
        url: "{{ vault_addr | default('http://vault.vault-system.svc.cluster.local:8200') }}/v1/sys/health"
        method: GET
        status_code: [200, 429, 472, 473, 501, 503]
        timeout: 10
      register: vault_health_check
      when: vault_service_info.resources | length > 0
      failed_when: false
      tags: ['vault', 'connectivity']

    - name: "Ã‰tat de Vault"
      debug:
        msg: |
          ğŸ” Ã‰tat de HashiCorp Vault:
          - Service disponible: {{ 'Oui' if vault_service_info.resources | length > 0 else 'Non' }}
          - Statut santÃ©: {{ vault_health_check.status | default('Non testÃ©') if vault_health_check is defined else 'Non testÃ©' }}
          - Vault sera utilisÃ© pour: Secrets Keycloak
      tags: ['information']

  when: vault_enabled | default(false)

# =========================================================================
# SECTION 7: VÃ‰RIFICATION DES RESSOURCES SYSTÃˆME
# =========================================================================
- name: "ğŸ“Š [RESOURCES] VÃ©rification des ressources systÃ¨me"
  block:
    - name: "Collecte des mÃ©triques de ressources des nÅ“uds"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: nodes_resources
      tags: ['resources', 'monitoring']

    - name: "Calcul des ressources disponibles"
      set_fact:
        cluster_resources:
          total_cpu: "{{ nodes_resources.resources | json_query('[].status.capacity.cpu') | map('int') | sum }}"
          total_memory: "{{ nodes_resources.resources | json_query('[].status.capacity.memory') | map('regex_replace', 'Ki$', '') | map('int') | sum }}"
          allocatable_cpu: "{{ nodes_resources.resources | json_query('[].status.allocatable.cpu') | map('int') | sum }}"
          allocatable_memory: "{{ nodes_resources.resources | json_query('[].status.allocatable.memory') | map('regex_replace', 'Ki$', '') | map('int') | sum }}"

    - name: "Validation des ressources requises"
      assert:
        that:
          - cluster_resources.allocatable_cpu | int >= (keycloak_resources_cpu_request | regex_replace('m$', '') | int / 1000)
          - (cluster_resources.allocatable_memory | int * 1024) >= (keycloak_resources_memory_request | regex_replace('Mi$', '') | int * 1024 * 1024)
        fail_msg: |
          âŒ Ressources insuffisantes pour dÃ©ployer Keycloak:
          - CPU requis: {{ keycloak_resources_cpu_request }}
          - MÃ©moire requise: {{ keycloak_resources_memory_request }}
          - CPU disponible: {{ cluster_resources.allocatable_cpu }}
          - MÃ©moire disponible: {{ (cluster_resources.allocatable_memory | int / 1024) | round }}Mi
        success_msg: "âœ… Ressources systÃ¨me suffisantes pour Keycloak"
      tags: ['validation', 'resources']

# =========================================================================
# SECTION 8: CRÃ‰ATION DES RESSOURCES PRÃ‰PARATOIRES
# =========================================================================
- name: "ğŸ”§ [PREPARATION] CrÃ©ation des ressources prÃ©paratoires"
  block:
    - name: "CrÃ©ation des labels par dÃ©faut pour le namespace"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ keycloak_namespace }}"
            labels:
              pod-security.kubernetes.io/enforce: "{{ pod_security_standard | default('restricted') }}"
              pod-security.kubernetes.io/audit: "{{ pod_security_standard | default('restricted') }}"
              pod-security.kubernetes.io/warn: "{{ pod_security_standard | default('restricted') }}"
      when: pod_security_enabled | default(true)
      tags: ['security', 'pod-security']

    - name: "CrÃ©ation d'une NetworkPolicy par dÃ©faut"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: "keycloak-default-network-policy"
            namespace: "{{ keycloak_namespace }}"
            labels:
              app.kubernetes.io/name: "keycloak"
              app.kubernetes.io/component: "network-policy"
          spec:
            podSelector:
              matchLabels:
                app.kubernetes.io/name: "keycloak"
            policyTypes:
              - Ingress
              - Egress
            ingress:
              - from:
                  - namespaceSelector:
                      matchLabels:
                        name: "{{ ingress_namespace | default('kube-system') }}"
                ports:
                  - protocol: TCP
                    port: {{ keycloak_port }}
            egress:
              - to:
                  - namespaceSelector:
                      matchLabels:
                        name: "{{ keycloak_database_namespace }}"
                ports:
                  - protocol: TCP
                    port: {{ postgres_port | default('5432') }}
              - to: []
                ports:
                  - protocol: TCP
                    port: 53
                  - protocol: UDP
                    port: 53
      when: network_policies_enabled | default(true)
      tags: ['security', 'network-policy']

# =========================================================================
# SECTION 9: RÃ‰SUMÃ‰ ET VALIDATION FINALE
# =========================================================================
- name: "ğŸ“‹ [SUMMARY] RÃ©sumÃ© de la validation des prÃ©requis"
  debug:
    msg: |
      ğŸ¯ RÃ‰SUMÃ‰ DE LA VALIDATION DES PRÃ‰REQUIS KEYCLOAK:
      
      âœ… Configuration:
      - Namespace: {{ keycloak_namespace }}
      - Version: {{ keycloak_version }}
      - Environnement: {{ lions_environment }}
      - Port: {{ keycloak_port }}
      
      âœ… Infrastructure:
      - Cluster K8s: OpÃ©rationnel ({{ k8s_cluster_info.nodes_ready }}/{{ k8s_cluster_info.nodes_count }} nÅ“uds)
      - Ingress Controller: {{ active_ingress_controller | default('Non dÃ©tectÃ©') }}
      - cert-manager: {{ 'Disponible' if cert_manager_info.resources | length > 0 else 'Non disponible' }}
      
      âœ… DÃ©pendances:
      - PostgreSQL: {{ 'Disponible' if postgres_available else 'Non disponible' }}
      - Vault: {{ 'ActivÃ©' if vault_enabled | default(false) else 'DÃ©sactivÃ©' }}
      
      âœ… SÃ©curitÃ©:
      - TLS: {{ 'ActivÃ©' if keycloak_tls_enabled | default(false) else 'DÃ©sactivÃ©' }}
      - NetworkPolicy: {{ 'ActivÃ©' if network_policies_enabled | default(true) else 'DÃ©sactivÃ©' }}
      - Pod Security: {{ 'ActivÃ©' if pod_security_enabled | default(true) else 'DÃ©sactivÃ©' }}
      
      ğŸš€ Keycloak est prÃªt Ã  Ãªtre dÃ©ployÃ©!
  tags: ['summary', 'information']

- name: "âœ… Validation finale des prÃ©requis"
  debug:
    msg: "Tous les prÃ©requis pour le dÃ©ploiement de Keycloak ont Ã©tÃ© validÃ©s avec succÃ¨s."
  tags: ['validation', 'completion']---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - KEYCLOAK PREREQUISITES
# =========================================================================
# Description: VÃ©rification et prÃ©paration des prÃ©requis pour le dÃ©ploiement de Keycloak
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: "{{ ansible_date_time.date }}"
# Documentation: https://docs.lions.dev/infrastructure/keycloak/prerequisites
# =========================================================================

# =========================================================================
# SECTION 1: VALIDATION DES VARIABLES CRITIQUES
# =========================================================================
- name: "ğŸ” [VALIDATION] VÃ©rification des variables critiques Keycloak"
  block:
    - name: "Validation de la configuration Keycloak"
      assert:
        that:
          - keycloak_namespace is defined and keycloak_namespace != ""
          - keycloak_service_name is defined and keycloak_service_name != ""
          - keycloak_version is defined and keycloak_version != ""
          - keycloak_port is defined and keycloak_port != ""
          - lions_environment is defined and lions_environment != ""
        fail_msg: "âŒ Variables critiques Keycloak manquantes ou vides"
        success_msg: "âœ… Variables critiques Keycloak validÃ©es"
      tags: ['validation', 'keycloak']

    - name: "Validation de la configuration des ressources"
      assert:
        that:
          - keycloak_resources_cpu_request is defined
          - keycloak_resources_memory_request is defined
          - keycloak_resources_cpu_limit is defined
          - keycloak_resources_memory_limit is defined
        fail_msg: "âŒ Configuration des ressources Keycloak incomplÃ¨te"
        success_msg: "âœ… Configuration des ressources Keycloak validÃ©e"
      tags: ['validation', 'resources']

  rescue:
    - name: "âŒ Ã‰chec de la validation des variables"
      fail:
        msg: |
          La validation des variables critiques a Ã©chouÃ©.
          VÃ©rifiez que toutes les variables requises sont dÃ©finies dans:
          - ansible/vars/common.yml
          - ansible/vars/{{ lions_environment }}.yml
          - ansible/roles/keycloak/vars/main.yml

# =========================================================================
# SECTION 2: VÃ‰RIFICATION DE L'INFRASTRUCTURE KUBERNETES
# =========================================================================
- name: "ğŸ—ï¸ [INFRASTRUCTURE] VÃ©rification de l'Ã©tat du cluster Kubernetes"
  block:
    - name: "VÃ©rification de la connectivitÃ© au cluster K8s"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: k8s_nodes_info
      failed_when: false
      tags: ['infrastructure', 'k8s']

    - name: "Validation de la connectivitÃ© K8s"
      assert:
        that:
          - k8s_nodes_info is succeeded
          - k8s_nodes_info.resources | length > 0
        fail_msg: "âŒ Impossible de se connecter au cluster Kubernetes"
        success_msg: "âœ… ConnectivitÃ© au cluster Kubernetes validÃ©e"

    - name: "Collecte des informations sur les nÅ“uds"
      set_fact:
        k8s_cluster_info:
          nodes_count: "{{ k8s_nodes_info.resources | length }}"
          nodes_ready: "{{ k8s_nodes_info.resources | json_query('[?status.conditions[?type==`Ready` && status==`True`]]') | length }}"
          kubernetes_version: "{{ k8s_nodes_info.resources[0].status.nodeInfo.kubeletVersion | default('unknown') }}"

    - name: "Affichage des informations cluster"
      debug:
        msg: |
          ğŸ“Š Informations du cluster Kubernetes:
          - NÅ“uds total: {{ k8s_cluster_info.nodes_count }}
          - NÅ“uds prÃªts: {{ k8s_cluster_info.nodes_ready }}
          - Version K8s: {{ k8s_cluster_info.kubernetes_version }}
      tags: ['information']

  rescue:
    - name: "âŒ Ã‰chec de vÃ©rification de l'infrastructure K8s"
      fail:
        msg: |
          Impossible de vÃ©rifier l'Ã©tat du cluster Kubernetes.
          VÃ©rifiez que:
          - Le cluster K8s est accessible
          - Les credentials kubectl sont configurÃ©s
          - Le service kube-apiserver fonctionne

# =========================================================================
# SECTION 3: GESTION DES NAMESPACES
# =========================================================================
- name: "ğŸ“ [NAMESPACE] Gestion du namespace Keycloak"
  block:
    - name: "VÃ©rification de l'existence du namespace {{ keycloak_namespace }}"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ keycloak_namespace }}"
      register: keycloak_namespace_info
      tags: ['namespace']

    - name: "CrÃ©ation du namespace {{ keycloak_namespace }}"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ keycloak_namespace }}"
            labels:
              app.kubernetes.io/name: "keycloak"
              app.kubernetes.io/component: "identity-provider"
              app.kubernetes.io/part-of: "lions-infrastructure"
              app.kubernetes.io/managed-by: "ansible"
              app.kubernetes.io/version: "{{ keycloak_version }}"
              lions.dev/environment: "{{ lions_environment }}"
              lions.dev/service-type: "security"
            annotations:
              lions.dev/created-by: "ansible-{{ ansible_user | default('automation') }}"
              lions.dev/created-date: "{{ ansible_date_time.iso8601 }}"
              lions.dev/description: "Namespace for Keycloak identity and access management"
      when: keycloak_namespace_info.resources | length == 0
      tags: ['namespace', 'creation']

    - name: "Validation des permissions dans le namespace"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "keycloak-access-validation"
            namespace: "{{ keycloak_namespace }}"
            labels:
              lions.dev/test: "access-validation"
          data:
            validation: "{{ ansible_date_time.iso8601 }}"
            environment: "{{ lions_environment }}"
      register: access_validation_result
      tags: ['validation', 'permissions']

    - name: "Nettoyage du ConfigMap de validation"
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: ConfigMap
        name: "keycloak-access-validation"
        namespace: "{{ keycloak_namespace }}"
      when: access_validation_result is succeeded
      tags: ['cleanup']

  rescue:
    - name: "âŒ Ã‰chec de gestion du namespace"
      fail:
        msg: |
          Impossible de crÃ©er ou d'accÃ©der au namespace {{ keycloak_namespace }}.
          VÃ©rifiez que vous avez les permissions suffisantes.

# =========================================================================
# SECTION 4: VÃ‰RIFICATION DES DÃ‰PENDANCES CRITIQUES
# =========================================================================
- name: "ğŸ”— [DEPENDENCIES] VÃ©rification des dÃ©pendances critiques"
  block:
    # VÃ©rification de PostgreSQL
    - name: "VÃ©rification du service PostgreSQL"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "{{ keycloak_database_service }}"
        namespace: "{{ keycloak_database_namespace }}"
      register: postgres_service_info
      tags: ['dependencies', 'database']

    - name: "Validation de la disponibilitÃ© PostgreSQL"
      set_fact:
        postgres_available: "{{ postgres_service_info.resources | length > 0 }}"

    - name: "Test de connectivitÃ© PostgreSQL"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Pod
          metadata:
            name: "postgres-connectivity-test"
            namespace: "{{ keycloak_namespace }}"
            labels:
              lions.dev/test: "connectivity"
          spec:
            restartPolicy: Never
            containers:
              - name: postgres-test
                image: "postgres:{{ postgres_version | default('15') }}-alpine"
                command:
                  - "/bin/sh"
                  - "-c"
                  - |
                    pg_isready -h {{ keycloak_database_service }}.{{ keycloak_database_namespace }}.svc.cluster.local -p {{ postgres_port | default('5432') }} -U {{ keycloak_database_user | default('keycloak') }}
                env:
                  - name: PGPASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: "{{ keycloak_database_secret }}"
                        key: "password"
                        optional: true
      register: postgres_test_creation
      when: postgres_available
      failed_when: false
      tags: ['connectivity', 'database']

    # Attendre et vÃ©rifier le rÃ©sultat du test
    - name: "Attente du rÃ©sultat du test PostgreSQL"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        name: "postgres-connectivity-test"
        namespace: "{{ keycloak_namespace }}"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 60
      register: postgres_test_result
      when: postgres_available and postgres_test_creation is succeeded
      failed_when: false
      tags: ['connectivity']

    # Nettoyage du pod de test
    - name: "Nettoyage du pod de test PostgreSQL"
      kubernetes.core.k8s:
        state: absent
        api_version: v1
        kind: Pod
        name: "postgres-connectivity-test"
        namespace: "{{ keycloak_namespace }}"
      when: postgres_test_creation is succeeded
      tags: ['cleanup']

  rescue:
    - name: "âš ï¸ Avertissement sur les dÃ©pendances"
      debug:
        msg: |
          âš ï¸ Certaines dÃ©pendances ne sont pas disponibles:
          - PostgreSQL: {{ 'Disponible' if postgres_available else 'Non disponible' }}
          
          Keycloak pourra Ãªtre dÃ©ployÃ© mais pourrait ne pas fonctionner correctement
          sans toutes ses dÃ©pendances.

# =========================================================================
# SECTION 5: VÃ‰RIFICATION DES COMPOSANTS D'INFRASTRUCTURE
# =========================================================================
- name: "ğŸ› ï¸ [INFRASTRUCTURE] VÃ©rification des composants d'infrastructure"
  block:
    # VÃ©rification de l'Ingress Controller
    - name: "Detection de l'Ingress Controller"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ item.namespace }}"
        label_selectors:
          - "{{ item.selector }}"
      register: ingress_controllers
      loop:
        - { namespace: "kube-system", selector: "app.kubernetes.io/name=traefik" }
        - { namespace: "ingress-nginx", selector: "app.kubernetes.io/name=ingress-nginx" }
        - { namespace: "nginx-ingress", selector: "app=nginx-ingress" }
      failed_when: false
      tags: ['infrastructure', 'ingress']

    - name: "Identification de l'Ingress Controller actif"
      set_fact:
        active_ingress_controller: >-
          {%- for result in ingress_controllers.results -%}
            {%- if result.resources | length > 0 -%}
              {%- if 'traefik' in result.item.selector -%}traefik
              {%- elif 'ingress-nginx' in result.item.selector -%}nginx
              {%- elif 'nginx-ingress' in result.item.selector -%}nginx-legacy
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}

    # VÃ©rification de cert-manager
    - name: "VÃ©rification de cert-manager"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "cert-manager"
        namespace: "cert-manager"
      register: cert_manager_info
      failed_when: false
      tags: ['infrastructure', 'tls']

    # VÃ©rification des issuer TLS
    - name: "VÃ©rification des ClusterIssuer TLS"
      kubernetes.core.k8s_info:
        api_version: cert-manager.io/v1
        kind: ClusterIssuer
      register: cluster_issuers_info
      failed_when: false
      tags: ['infrastructure', 'tls']

    - name: "RÃ©sumÃ© de l'infrastructure disponible"
      debug:
        msg: |
          ğŸ—ï¸ Ã‰tat de l'infrastructure:
          - Ingress Controller: {{ active_ingress_controller | default('Aucun dÃ©tectÃ©') }}
          - cert-manager: {{ 'Disponible' if cert_manager_info.resources | length > 0 else 'Non disponible' }}
          - ClusterIssuers: {{ cluster_issuers_info.resources | length if cluster_issuers_info is succeeded else 0 }}
          - TLS activÃ©: {{ keycloak_tls_enabled | default(false) }}
      tags: ['information']

# =========================================================================
# SECTION 6: VÃ‰RIFICATION DE VAULT (SI ACTIVÃ‰)
# =========================================================================
- name: "ğŸ” [VAULT] VÃ©rification de HashiCorp Vault"
  block:
    - name: "VÃ©rification du service Vault"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        name: "{{ vault_service_name | default('vault') }}"
        namespace: "{{ vault_namespace | default('vault-system') }}"
      register: vault_service_info
      tags: ['vault', 'security']

    - name: "Test de connectivitÃ© Vault"
      uri:
        url: "{{ vault_addr | default('http://vault.vault-system.svc.cluster.local:8200') }}/v1/sys/health"
        method: GET
        status_code: [200, 429, 472, 473, 501, 503]
        timeout: 10
      register: vault_health_check
      when: vault_service_info.resources | length > 0
      failed_when: false
      tags: ['vault', 'connectivity']

    - name: "Ã‰tat de Vault"
      debug:
        msg: |
          ğŸ” Ã‰tat de HashiCorp Vault:
          - Service disponible: {{ 'Oui' if vault_service_info.resources | length > 0 else 'Non' }}
          - Statut santÃ©: {{ vault_health_check.status | default('Non testÃ©') if vault_health_check is defined else 'Non testÃ©' }}
          - Vault sera utilisÃ© pour: Secrets Keycloak
      tags: ['information']

  when: vault_enabled | default(false)

# =========================================================================
# SECTION 7: VÃ‰RIFICATION DES RESSOURCES SYSTÃˆME
# =========================================================================
- name: "ğŸ“Š [RESOURCES] VÃ©rification des ressources systÃ¨me"
  block:
    - name: "Collecte des mÃ©triques de ressources des nÅ“uds"
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: nodes_resources
      tags: ['resources', 'monitoring']

    - name: "Calcul des ressources disponibles"
      set_fact:
        cluster_resources:
          total_cpu: "{{ nodes_resources.resources | json_query('[].status.capacity.cpu') | map('int') | sum }}"
          total_memory: "{{ nodes_resources.resources | json_query('[].status.capacity.memory') | map('regex_replace', 'Ki$', '') | map('int') | sum }}"
          allocatable_cpu: "{{ nodes_resources.resources | json_query('[].status.allocatable.cpu') | map('int') | sum }}"
          allocatable_memory: "{{ nodes_resources.resources | json_query('[].status.allocatable.memory') | map('regex_replace', 'Ki$', '') | map('int') | sum }}"

    - name: "Validation des ressources requises"
      assert:
        that:
          - cluster_resources.allocatable_cpu | int >= (keycloak_resources_cpu_request | regex_replace('m$', '') | int / 1000)
          - (cluster_resources.allocatable_memory | int * 1024) >= (keycloak_resources_memory_request | regex_replace('Mi$', '') | int * 1024 * 1024)
        fail_msg: |
          âŒ Ressources insuffisantes pour dÃ©ployer Keycloak:
          - CPU requis: {{ keycloak_resources_cpu_request }}
          - MÃ©moire requise: {{ keycloak_resources_memory_request }}
          - CPU disponible: {{ cluster_resources.allocatable_cpu }}
          - MÃ©moire disponible: {{ (cluster_resources.allocatable_memory | int / 1024) | round }}Mi
        success_msg: "âœ… Ressources systÃ¨me suffisantes pour Keycloak"
      tags: ['validation', 'resources']

# =========================================================================
# SECTION 8: CRÃ‰ATION DES RESSOURCES PRÃ‰PARATOIRES
# =========================================================================
- name: "ğŸ”§ [PREPARATION] CrÃ©ation des ressources prÃ©paratoires"
  block:
    - name: "CrÃ©ation des labels par dÃ©faut pour le namespace"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ keycloak_namespace }}"
            labels:
              pod-security.kubernetes.io/enforce: "{{ pod_security_standard | default('restricted') }}"
              pod-security.kubernetes.io/audit: "{{ pod_security_standard | default('restricted') }}"
              pod-security.kubernetes.io/warn: "{{ pod_security_standard | default('restricted') }}"
      when: pod_security_enabled | default(true)
      tags: ['security', 'pod-security']

    - name: "CrÃ©ation d'une NetworkPolicy par dÃ©faut"
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: networking.k8s.io/v1
          kind: NetworkPolicy
          metadata:
            name: "keycloak-default-network-policy"
            namespace: "{{ keycloak_namespace }}"
            labels:
              app.kubernetes.io/name: "keycloak"
              app.kubernetes.io/component: "network-policy"
          spec:
            podSelector:
              matchLabels:
                app.kubernetes.io/name: "keycloak"
            policyTypes:
              - Ingress
              - Egress
            ingress:
              - from:
                  - namespaceSelector:
                      matchLabels:
                        name: "{{ ingress_namespace | default('kube-system') }}"
                ports:
                  - protocol: TCP
                    port: {{ keycloak_port }}
            egress:
              - to:
                  - namespaceSelector:
                      matchLabels:
                        name: "{{ keycloak_database_namespace }}"
                ports:
                  - protocol: TCP
                    port: {{ postgres_port | default('5432') }}
              - to: []
                ports:
                  - protocol: TCP
                    port: 53
                  - protocol: UDP
                    port: 53
      when: network_policies_enabled | default(true)
      tags: ['security', 'network-policy']

# =========================================================================
# SECTION 9: RÃ‰SUMÃ‰ ET VALIDATION FINALE
# =========================================================================
- name: "ğŸ“‹ [SUMMARY] RÃ©sumÃ© de la validation des prÃ©requis"
  debug:
    msg: |
      ğŸ¯ RÃ‰SUMÃ‰ DE LA VALIDATION DES PRÃ‰REQUIS KEYCLOAK:
      
      âœ… Configuration:
      - Namespace: {{ keycloak_namespace }}
      - Version: {{ keycloak_version }}
      - Environnement: {{ lions_environment }}
      - Port: {{ keycloak_port }}
      
      âœ… Infrastructure:
      - Cluster K8s: OpÃ©rationnel ({{ k8s_cluster_info.nodes_ready }}/{{ k8s_cluster_info.nodes_count }} nÅ“uds)
      - Ingress Controller: {{ active_ingress_controller | default('Non dÃ©tectÃ©') }}
      - cert-manager: {{ 'Disponible' if cert_manager_info.resources | length > 0 else 'Non disponible' }}
      
      âœ… DÃ©pendances:
      - PostgreSQL: {{ 'Disponible' if postgres_available else 'Non disponible' }}
      - Vault: {{ 'ActivÃ©' if vault_enabled | default(false) else 'DÃ©sactivÃ©' }}
      
      âœ… SÃ©curitÃ©:
      - TLS: {{ 'ActivÃ©' if keycloak_tls_enabled | default(false) else 'DÃ©sactivÃ©' }}
      - NetworkPolicy: {{ 'ActivÃ©' if network_policies_enabled | default(true) else 'DÃ©sactivÃ©' }}
      - Pod Security: {{ 'ActivÃ©' if pod_security_enabled | default(true) else 'DÃ©sactivÃ©' }}
      
      ğŸš€ Keycloak est prÃªt Ã  Ãªtre dÃ©ployÃ©!
  tags: ['summary', 'information']

- name: "âœ… Validation finale des prÃ©requis"
  debug:
    msg: "Tous les prÃ©requis pour le dÃ©ploiement de Keycloak ont Ã©tÃ© validÃ©s avec succÃ¨s."
  tags: ['validation', 'completion']