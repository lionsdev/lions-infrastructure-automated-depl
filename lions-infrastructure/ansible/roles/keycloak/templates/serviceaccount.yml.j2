---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - KEYCLOAK SERVICEACCOUNT TEMPLATE
# =========================================================================
# Titre: Template Kubernetes ServiceAccount pour Keycloak
# Description: Définition du ServiceAccount Kubernetes pour le service Keycloak
#              avec support complet des standards DevOps et sécurité renforcée
# Auteur: LIONS DevOps Team
# Date: {{ ansible_date_time.iso8601 }}
# Version: 5.0.0
# Dépendances:
#   - RBAC Kubernetes activé
#   - Variables d'environnement LIONS_* configurées
# Documentation: https://docs.lions.dev/infrastructure/security/serviceaccounts
# =========================================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  # =========================================================================
  # IDENTIFICATION DU SERVICEACCOUNT
  # =========================================================================
  name: "{{ lions_keycloak_service_name | default(lookup('env', 'LIONS_KEYCLOAK_SERVICE_NAME')) }}"
  namespace: "{{ lions_keycloak_namespace | default(lookup('env', 'LIONS_KEYCLOAK_NAMESPACE')) }}"

  # =========================================================================
  # LABELS STANDARDISÉS LIONS 5.0
  # =========================================================================
  labels:
    # Labels d'identification primaires
    app.kubernetes.io/name: "{{ lions_keycloak_service_name | default(lookup('env', 'LIONS_KEYCLOAK_SERVICE_NAME')) }}"
    app.kubernetes.io/instance: "{{ lions_keycloak_service_name | default(lookup('env', 'LIONS_KEYCLOAK_SERVICE_NAME')) }}-{{ lions_environment | default(lookup('env', 'LIONS_ENVIRONMENT')) }}"
    app.kubernetes.io/version: "{{ lions_keycloak_version | default(lookup('env', 'LIONS_KEYCLOAK_VERSION')) }}"
    app.kubernetes.io/component: "identity-provider"
    app.kubernetes.io/part-of: "lions-infrastructure"
    app.kubernetes.io/managed-by: "ansible"

    # Labels de catégorisation
    lions.dev/service-type: "security"
    lions.dev/service-category: "identity-management"
    lions.dev/technology: "keycloak"
    lions.dev/environment: "{{ lions_environment | default(lookup('env', 'LIONS_ENVIRONMENT')) }}"
    lions.dev/deployment-mode: "{{ lions_deployment_mode | default(lookup('env', 'LIONS_DEPLOYMENT_MODE')) }}"

    # Labels de gestion des ressources
    lions.dev/resource-tier: "{{ lions_keycloak_resource_tier | default('medium') }}"
    lions.dev/backup-enabled: "{{ lions_backup_enabled | default(lookup('env', 'LIONS_BACKUP_ENABLED')) | string }}"
    lions.dev/monitoring-enabled: "{{ lions_monitoring_enabled | default(lookup('env', 'LIONS_MONITORING_ENABLED')) | string }}"

    # Labels de sécurité
    lions.dev/security-level: "high"
    lions.dev/rbac-enabled: "{{ lions_security_rbac_enabled | default(lookup('env', 'LIONS_SECURITY_RBAC_ENABLED')) | string }}"
    lions.dev/network-policies: "{{ lions_security_network_policies | default(lookup('env', 'LIONS_SECURITY_NETWORK_POLICIES')) | string }}"

    # Labels de versioning et maintenance
    lions.dev/config-version: "{{ lions_config_version | default(lookup('env', 'LIONS_CONFIG_VERSION')) }}"
    lions.dev/last-updated: "{{ ansible_date_time.iso8601 }}"
    lions.dev/created-by: "{{ ansible_user_id | default('ansible') }}"

  # =========================================================================
  # ANNOTATIONS MÉTADONNÉES ET DOCUMENTATION
  # =========================================================================
  annotations:
    # Annotations de description
    description: "ServiceAccount Kubernetes pour Keycloak {{ lions_keycloak_service_name | default(lookup('env', 'LIONS_KEYCLOAK_SERVICE_NAME')) }} v{{ lions_keycloak_version | default(lookup('env', 'LIONS_KEYCLOAK_VERSION')) }}"
    summary: "Compte de service pour l'authentification et l'autorisation Keycloak en environnement {{ lions_environment | default(lookup('env', 'LIONS_ENVIRONMENT')) }}"

    # Annotations de déploiement
    lions.dev/deployment-timestamp: "{{ ansible_date_time.iso8601 }}"
    lions.dev/deployment-user: "{{ ansible_user_id | default('ansible') }}"
    lions.dev/deployment-host: "{{ ansible_hostname }}"
    lions.dev/deployment-method: "ansible"
    lions.dev/deployment-playbook: "{{ ansible_playbook_name | default('unknown') }}"

    # Annotations de configuration
    lions.dev/environment-config: "{{ lions_environment | default(lookup('env', 'LIONS_ENVIRONMENT')) }}"
    lions.dev/namespace-config: "{{ lions_keycloak_namespace | default(lookup('env', 'LIONS_KEYCLOAK_NAMESPACE')) }}"
    lions.dev/service-port: "{{ lions_keycloak_port | default(lookup('env', 'LIONS_KEYCLOAK_PORT')) }}"
    lions.dev/admin-realm: "{{ lions_keycloak_realm | default(lookup('env', 'LIONS_KEYCLOAK_REALM')) }}"

    # Annotations de sécurité
    lions.dev/security-context: "restricted"
    lions.dev/pod-security-standards: "{{ lions_security_pod_security_standards | default(lookup('env', 'LIONS_SECURITY_POD_SECURITY_STANDARDS')) }}"
    lions.dev/requires-secrets: "true"
    lions.dev/vault-integration: "{{ lions_vault_enabled | default(lookup('env', 'LIONS_VAULT_ENABLED')) | string }}"

    # Annotations de maintenance et support
    lions.dev/maintainer: "{{ lions_config_maintainer | default(lookup('env', 'LIONS_CONFIG_MAINTAINER')) }}"
    lions.dev/support-contact: "devops@lions.dev"
    lions.dev/documentation-url: "https://docs.lions.dev/services/keycloak"
    lions.dev/runbook-url: "https://docs.lions.dev/runbooks/keycloak"

    # Annotations de monitoring et observabilité
    lions.dev/metrics-enabled: "{{ lions_monitoring_enabled | default(lookup('env', 'LIONS_MONITORING_ENABLED')) | string }}"
    lions.dev/log-level: "{{ lions_log_level | default(lookup('env', 'LIONS_LOG_LEVEL')) }}"
    lions.dev/tracing-enabled: "true"

    # Annotations de backup et récupération
    lions.dev/backup-strategy: "{{ 'external' if lions_backup_external_enabled | default(lookup('env', 'LIONS_BACKUP_EXTERNAL_ENABLED')) | bool else 'local' }}"
    lions.dev/backup-retention: "{{ lions_backup_retention_days | default(lookup('env', 'LIONS_BACKUP_RETENTION_DAYS')) }}d"
    lions.dev/disaster-recovery: "enabled"

    # Annotations de conformité et audit
    lions.dev/compliance-required: "true"
    lions.dev/audit-enabled: "{{ lions_audit_enabled | default(lookup('env', 'LIONS_AUDIT_ENABLED')) | string }}"
    lions.dev/data-classification: "confidential"
    lions.dev/privacy-impact: "high"

    # Annotations conditionnelles pour production
    {% if lions_environment | default(lookup('env', 'LIONS_ENVIRONMENT')) == 'production' %}
    lions.dev/sla-level: "tier-1"
    lions.dev/availability-requirement: "99.9%"
    lions.dev/performance-monitoring: "enhanced"
    lions.dev/security-scanning: "continuous"
    {% endif %}

    # Annotations conditionnelles pour développement
    {% if lions_environment | default(lookup('env', 'LIONS_ENVIRONMENT')) == 'development' %}
    lions.dev/debug-mode: "{{ lions_debug_mode | default(lookup('env', 'LIONS_DEBUG_MODE')) | string }}"
    lions.dev/test-data-allowed: "true"
    lions.dev/experimental-features: "enabled"
    {% endif %}

# =========================================================================
# CONFIGURATION DU SERVICE ACCOUNT
# =========================================================================
# Configuration automatique du token selon l'activation de Vault
automountServiceAccountToken: {{ lions_vault_enabled | default(lookup('env', 'LIONS_VAULT_ENABLED')) | bool }}

# =========================================================================
# SECRETS ASSOCIÉS (référencés si Vault est activé)
# =========================================================================
{% if lions_vault_enabled | default(lookup('env', 'LIONS_VAULT_ENABLED')) | bool %}
secrets:
  - name: "{{ lions_keycloak_service_name | default(lookup('env', 'LIONS_KEYCLOAK_SERVICE_NAME')) }}-vault-token"
{% endif %}

# =========================================================================
# CONFIGURATION D'IMAGE PULL (si registry privé activé)
# =========================================================================
{% if lions_registry_enabled | default(lookup('env', 'LIONS_REGISTRY_ENABLED')) | bool %}
imagePullSecrets:
  - name: "{{ lions_keycloak_service_name | default(lookup('env', 'LIONS_KEYCLOAK_SERVICE_NAME')) }}-registry-secret"
{% endif %}