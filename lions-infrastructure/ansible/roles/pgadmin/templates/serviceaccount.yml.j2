---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - SERVICEACCOUNT PGADMIN
# =========================================================================
# Description: Template ServiceAccount Kubernetes pour pgAdmin
# Composant: pgAdmin Database Administration Tool
# Version: 5.0.0
# Auteur: LIONS Infrastructure DevOps Team
# Date: {{ ansible_date_time.iso8601 }}
# Documentation: https://docs.lions.dev/infrastructure/pgadmin
# =========================================================================

apiVersion: v1
kind: ServiceAccount
metadata:
  # ===== IDENTIFICATION =====
  name: "{{ lions_pgadmin_service_account_name | default('pgadmin-sa') }}"
  namespace: "{{ lions_pgadmin_namespace | default(lions_postgres_namespace) | default('database') }}"

  # ===== LABELS STANDARDISÉS =====
  labels:
    # Labels d'identification du composant
    app.kubernetes.io/name: "pgadmin"
    app.kubernetes.io/instance: "{{ lions_pgadmin_instance_name | default('pgadmin') }}"
    app.kubernetes.io/version: "{{ lions_pgadmin_version | default('7.8') }}"
    app.kubernetes.io/component: "database-admin"
    app.kubernetes.io/part-of: "lions-infrastructure"
    app.kubernetes.io/managed-by: "ansible"

    # Labels d'environnement et déploiement
    lions.dev/environment: "{{ lions_environment }}"
    lions.dev/tier: "management"
    lions.dev/category: "database"
    lions.dev/technology: "pgadmin"
    lions.dev/deployment-mode: "{{ lions_deployment_mode }}"

    # Labels de sécurité et compliance
    lions.dev/security-profile: "{{ lions_pgadmin_security_profile | default('standard') }}"
    lions.dev/backup-enabled: "{{ lions_pgadmin_backup_enabled | default('false') | string }}"
    lions.dev/monitoring-enabled: "{{ lions_monitoring_enabled | string }}"

    # Labels de gestion des ressources
    lions.dev/resource-profile: "{{ lions_pgadmin_resource_profile | default('small') }}"
    lions.dev/autoscaling-enabled: "{{ lions_pgadmin_autoscaling_enabled | default('false') | string }}"

    # Labels de versioning et traçabilité
    lions.dev/config-version: "{{ lions_config_version }}"
    lions.dev/ansible-role: "pgadmin"
    lions.dev/ansible-playbook: "{{ ansible_playbook_python }}"

  # ===== ANNOTATIONS COMPLÈTES =====
  annotations:
    # Métadonnées descriptives
    description: "ServiceAccount pour pgAdmin - Interface d'administration PostgreSQL"
    lions.dev/description: "ServiceAccount gérant les permissions pour l'instance pgAdmin {{ lions_pgadmin_instance_name | default('pgadmin') }}"
    lions.dev/purpose: "Fournir une interface web d'administration pour les bases de données PostgreSQL"
    lions.dev/owner: "{{ lions_pgadmin_owner | default('database-team') }}"
    lions.dev/contact: "{{ lions_pgadmin_contact | default('database-admin@lions.dev') }}"

    # Métadonnées de déploiement
    lions.dev/deployed-by: "{{ ansible_user_id }}@{{ ansible_hostname }}"
    lions.dev/deployed-at: "{{ ansible_date_time.iso8601 }}"
    lions.dev/deployment-tool: "ansible"
    lions.dev/deployment-version: "{{ lions_config_version }}"

    # Métadonnées de configuration
    lions.dev/config-hash: "{{ (lions_pgadmin_config | default({})) | to_json | hash('sha256') }}"
    lions.dev/dependencies: "postgresql,vault"
    lions.dev/network-policies: "{{ lions_security_network_policies | string }}"

    # Métadonnées de sécurité
    lions.dev/security-context: "restricted"
    lions.dev/service-mesh-enabled: "{{ lions_pgadmin_service_mesh_enabled | default('false') | string }}"
    lions.dev/tls-enabled: "{{ lions_security_tls_enabled | string }}"
    lions.dev/vault-integration: "{{ lions_vault_enabled | string }}"

    # Métadonnées de monitoring et observabilité
    lions.dev/metrics-enabled: "{{ lions_pgadmin_metrics_enabled | default('true') | string }}"
    lions.dev/logging-enabled: "{{ lions_pgladmin_logging_enabled | default('true') | string }}"
    lions.dev/tracing-enabled: "{{ lions_pgadmin_tracing_enabled | default('false') | string }}"

    # Métadonnées de gestion du cycle de vie
    lions.dev/lifecycle-stage: "{{ lions_pgadmin_lifecycle_stage | default('active') }}"
    lions.dev/maintenance-window: "{{ lions_pgadmin_maintenance_window | default('Sunday 02:00-04:00 UTC') }}"
    lions.dev/retention-policy: "{{ lions_pgadmin_retention_policy | default('30d') }}"

    # Annotations Kubernetes natives pour la sécurité
    kubernetes.io/service-account.name: "{{ lions_pgladmin_service_account_name | default('pgadmin-sa') }}"
    {% if lions_vault_enabled | default(false) %}
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/agent-inject-status: "update"
    vault.hashicorp.com/agent-inject-secret-pgadmin-config: "secret/data/{{ lions_environment }}/pgadmin/config"
    vault.hashicorp.com/agent-inject-template-pgadmin-config: |
      {{`{{- with secret "secret/data/`}}{{ lions_environment }}{{`/pgadmin/config" -}}
      PGADMIN_DEFAULT_EMAIL={{ .Data.data.admin_email }}
      PGADMIN_DEFAULT_PASSWORD={{ .Data.data.admin_password }}
      {{- end }}`}}
    vault.hashicorp.com/role: "{{ lions_pgadmin_vault_role | default('pgadmin') }}"
    {% endif %}

    # Annotations pour le monitoring
    {% if lions_monitoring_enabled | default(false) %}
    prometheus.io/scrape: "true"
    prometheus.io/port: "{{ lions_pgadmin_metrics_port | default('9187') }}"
    prometheus.io/path: "/metrics"
    {% endif %}

    # Annotations de documentation
    documentation/architecture: "https://docs.lions.dev/architecture/database-management"
    documentation/runbook: "https://docs.lions.dev/runbooks/pgadmin"
    documentation/troubleshooting: "https://docs.lions.dev/troubleshooting/pgadmin"

# ===== CONFIGURATION AUTOMATIQUE DES SECRETS =====
{% if lions_vault_enabled | default(false) %}
automountServiceAccountToken: true
{% else %}
automountServiceAccountToken: false
{% endif %}

# ===== SECRETS ASSOCIÉS =====
{% if not lions_vault_enabled | default(false) %}
secrets:
  - name: "{{ lions_pgadmin_secret_name | default('pgadmin-secrets') }}"
{% endif %}

---
# =========================================================================
# SECRETS PGADMIN (SI VAULT N'EST PAS UTILISÉ)
# =========================================================================
{% if not lions_vault_enabled | default(false) %}
apiVersion: v1
kind: Secret
metadata:
  name: "{{ lions_pgadmin_secret_name | default('pgadmin-secrets') }}"
  namespace: "{{ lions_pgadmin_namespace | default(lions_postgres_namespace) | default('database') }}"
  labels:
    app.kubernetes.io/name: "pgadmin"
    app.kubernetes.io/instance: "{{ lions_pgadmin_instance_name | default('pgadmin') }}"
    app.kubernetes.io/component: "secrets"
    app.kubernetes.io/part-of: "lions-infrastructure"
    lions.dev/environment: "{{ lions_environment }}"
    lions.dev/secret-type: "application-credentials"
  annotations:
    description: "Secrets pour l'authentification pgAdmin"
    lions.dev/rotation-policy: "90d"
    lions.dev/encryption: "{{ lions_security_secrets_encryption | string }}"
type: Opaque
data:
  # Les valeurs doivent être encodées en base64
  admin-email: "{{ lions_pgadmin_admin_email | default('admin@' + lions_dns_domain_base) | b64encode }}"
  admin-password: "{{ lions_pgadmin_admin_password | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits')) | b64encode }}"
  secret-key: "{{ lions_pgadmin_secret_key | default(lookup('password', '/dev/null length=64 chars=ascii_letters,digits,punctuation')) | b64encode }}"
{% endif %}

---
# =========================================================================
# CONFIGMAP PGADMIN
# =========================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ lions_pgadmin_config_name | default('pgadmin-config') }}"
  namespace: "{{ lions_pgadmin_namespace | default(lions_postgres_namespace) | default('database') }}"
  labels:
    app.kubernetes.io/name: "pgadmin"
    app.kubernetes.io/instance: "{{ lions_pgadmin_instance_name | default('pgadmin') }}"
    app.kubernetes.io/component: "configuration"
    app.kubernetes.io/part-of: "lions-infrastructure"
    lions.dev/environment: "{{ lions_environment }}"
    lions.dev/config-type: "application-settings"
  annotations:
    description: "Configuration non-sensible pour pgAdmin"
    lions.dev/config-version: "{{ lions_config_version }}"
data:
  # Configuration pgAdmin
  PGADMIN_LISTEN_PORT: "{{ lions_pgadmin_port | default('5050') }}"
  PGADMIN_LISTEN_ADDRESS: "0.0.0.0"
  PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "True"
  PGADMIN_CONFIG_LOGIN_BANNER: "LIONS Infrastructure - pgAdmin {{ lions_environment | title }}"
  PGLADMIN_CONFIG_CONSOLE_LOG_LEVEL: "{{ lions_log_level | default('INFO') }}"

  # Configuration de sécurité
  PGADMIN_CONFIG_SESSION_EXPIRATION_TIME: "{{ lions_pgadmin_session_timeout | default('28800') }}"  # 8 heures
  PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "{{ lions_pgadmin_master_password_required | default('True') }}"
  PGADMIN_CONFIG_MFA_ENABLED: "{{ lions_pgadmin_mfa_enabled | default('False') }}"

  # Configuration de l'interface
  PGADMIN_CONFIG_THEME: "{{ lions_pgadmin_theme | default('standard') }}"
  PGADMIN_CONFIG_SHOW_GRAVATAR_IMAGE: "False"
  PGADMIN_CONFIG_SHOW_SYSTEM_OBJECTS: "{{ lions_pgadmin_show_system_objects | default('False') }}"

  # Configuration de logging
  PGADMIN_CONFIG_LOG_FILE: "/var/log/pgadmin/pgadmin4.log"
  PGADMIN_CONFIG_LOG_ROTATION_SIZE: "{{ lions_pgadmin_log_rotation_size | default('10485760') }}"  # 10MB
  PGADMIN_CONFIG_LOG_ROTATION_COUNT: "{{ lions_pgadmin_log_rotation_count | default('5') }}"

  # Configuration des connexions PostgreSQL par défaut
  {% if lions_postgres_enabled | default(false) %}
  PGADMIN_DEFAULT_SERVER: "PostgreSQL LIONS"
  PGADMIN_DEFAULT_SERVER_HOST: "{{ lions_postgres_service_name | default('postgresql') }}.{{ lions_postgres_namespace | default('database') }}.svc.cluster.local"
  PGADMIN_DEFAULT_SERVER_PORT: "{{ lions_postgres_port | default('5432') }}"
  PGADMIN_DEFAULT_SERVER_MAINTENANCE_DB: "{{ lions_postgres_database | default('lions_db') }}"
  PGADMIN_DEFAULT_SERVER_USERNAME: "postgres"
  {% endif %}

  # Configuration de performance
  PGADMIN_CONFIG_SESSION_DB_PATH: "/var/lib/pgadmin/sessions"
  PGADMIN_CONFIG_STORAGE_DIR: "/var/lib/pgadmin/storage"
  PGADMIN_CONFIG_MAX_SESSION_IDLE_TIME: "{{ lions_pgadmin_max_idle_time | default('3600') }}"  # 1 heure

---
# =========================================================================
# RBAC - ROLE POUR PGADMIN
# =========================================================================
{% if lions_security_rbac_enabled | default(true) %}
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: "{{ lions_pgadmin_role_name | default('pgadmin-role') }}"
  namespace: "{{ lions_pgadmin_namespace | default(lions_postgres_namespace) | default('database') }}"
  labels:
    app.kubernetes.io/name: "pgadmin"
    app.kubernetes.io/instance: "{{ lions_pgadmin_instance_name | default('pgadmin') }}"
    app.kubernetes.io/component: "rbac"
    app.kubernetes.io/part-of: "lions-infrastructure"
    lions.dev/environment: "{{ lions_environment }}"
  annotations:
    description: "Rôle RBAC pour pgAdmin - permissions minimales requises"
rules:
  # Permissions pour lire les services (découverte PostgreSQL)
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch"]

  # Permissions pour lire les secrets (connexions DB)
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames:
      - "{{ lions_pgadmin_secret_name | default('pgadmin-secrets') }}"
      - "{{ lions_postgres_secret_name | default('postgresql-secrets') }}"
    verbs: ["get"]

  # Permissions pour lire les ConfigMaps
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames:
      - "{{ lions_pgadmin_config_name | default('pgadmin-config') }}"
    verbs: ["get"]

  # Permissions pour les events (debugging)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create"]

---
# =========================================================================
# RBAC - ROLEBINDING POUR PGADMIN
# =========================================================================
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: "{{ lions_pgadmin_rolebinding_name | default('pgadmin-rolebinding') }}"
  namespace: "{{ lions_pgadmin_namespace | default(lions_postgres_namespace) | default('database') }}"
  labels:
    app.kubernetes.io/name: "pgadmin"
    app.kubernetes.io/instance: "{{ lions_pgadmin_instance_name | default('pgadmin') }}"
    app.kubernetes.io/component: "rbac"
    app.kubernetes.io/part-of: "lions-infrastructure"
    lions.dev/environment: "{{ lions_environment }}"
  annotations:
    description: "Liaison RBAC entre le ServiceAccount pgAdmin et son rôle"
subjects:
  - kind: ServiceAccount
    name: "{{ lions_pgadmin_service_account_name | default('pgadmin-sa') }}"
    namespace: "{{ lions_pgadmin_namespace | default(lions_postgres_namespace) | default('database') }}"
roleRef:
  kind: Role
  name: "{{ lions_pgladmin_role_name | default('pgadmin-role') }}"
  apiGroup: rbac.authorization.k8s.io
{% endif %}