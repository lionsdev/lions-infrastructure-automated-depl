---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - PGADMIN PREPARATION TASKS
# =========================================================================
# Description: TÃ¢ches de prÃ©paration avancÃ©es pour pgAdmin avec gestion d'erreurs robuste
# Version: 5.0.0
# Maintainer: DevOps Team LIONS
# Date: "{{ lions_config_last_updated | default(ansible_date_time.iso8601) }}"
# Documentation: https://docs.lions.dev/infrastructure/database/pgadmin
# =========================================================================

# =========================================================================
# VALIDATION DE LA CONFIGURATION PRÃ‰ALABLE
# =========================================================================
- name: "pgAdmin | Validation | VÃ©rification des variables obligatoires"
  assert:
    that:
      - lions_pgadmin_enabled is defined
      - lions_pgladmin_enabled | bool
      - lions_pgadmin_namespace is defined
      - lions_pgadmin_service_name is defined
      - lions_postgres_enabled is defined
      - lions_postgres_enabled | bool
    fail_msg: "Variables de configuration pgAdmin manquantes ou invalides"
    success_msg: "Configuration pgAdmin validÃ©e avec succÃ¨s"
  tags:
    - validation
    - pgadmin
    - preparation

- name: "pgAdmin | Validation | VÃ©rification de la disponibilitÃ© de PostgreSQL"
  k8s_info:
    api_version: v1
    kind: Service
    namespace: "{{ lions_postgres_namespace }}"
    name: "{{ lions_postgres_service_name }}"
  register: postgres_service_check
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file }}"
  failed_when: false
  tags:
    - validation
    - dependencies

- name: "pgAdmin | Validation | Avertissement sur la dÃ©pendance PostgreSQL"
  debug:
    msg: |
      âš ï¸  AVERTISSEMENT: Service PostgreSQL non dÃ©tectÃ©
      ğŸ“‹ Namespace recherchÃ©: {{ lions_postgres_namespace }}
      ğŸ“‹ Service recherchÃ©: {{ lions_postgres_service_name }}
      ğŸ’¡ pgAdmin sera dÃ©ployÃ© mais pourrait ne pas fonctionner correctement
  when:
    - postgres_service_check.resources is defined
    - postgres_service_check.resources | length == 0

# =========================================================================
# PRÃ‰PARATION DE L'ENVIRONNEMENT DE TRAVAIL
# =========================================================================
- name: "pgAdmin | PrÃ©paration | CrÃ©ation du rÃ©pertoire de travail temporaire"
  tempfile:
    state: directory
    suffix: ".{{ lions_pgadmin_service_name }}-{{ lions_environment }}"
    prefix: "lions-pgadmin-"
  register: pgadmin_temp_workspace
  changed_when: false
  tags:
    - preparation
    - workspace

- name: "pgAdmin | PrÃ©paration | Configuration des mÃ©tadonnÃ©es de dÃ©ploiement"
  set_fact:
    pgadmin_deployment_metadata:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      environment: "{{ lions_environment }}"
      version: "{{ lions_config_version }}"
      operator: "{{ ansible_user_id }}"
      deployment_id: "{{ 999999 | random | to_uuid }}"
  tags:
    - preparation
    - metadata

- name: "pgAdmin | PrÃ©paration | Affichage des informations de dÃ©ploiement"
  debug:
    msg: |
      ğŸš€ PrÃ©paration du dÃ©ploiement pgAdmin
      ğŸ“Š Environnement: {{ lions_environment }}
      ğŸ·ï¸  Namespace: {{ lions_pgladmin_namespace }}
      ğŸ“¦ Service: {{ lions_pgadmin_service_name }}
      ğŸ”§ Version config: {{ lions_config_version }}
      â° Timestamp: {{ pgadmin_deployment_metadata.timestamp }}
      ğŸ†” ID DÃ©ploiement: {{ pgadmin_deployment_metadata.deployment_id }}
  when: lions_debug_mode | default(false) | bool

# =========================================================================
# GESTION DES SECRETS ET SÃ‰CURITÃ‰
# =========================================================================
- name: "pgAdmin | SÃ©curitÃ© | VÃ©rification de l'existence des secrets"
  k8s_info:
    api_version: v1
    kind: Secret
    namespace: "{{ lions_pgadmin_namespace }}"
    name: "{{ lions_pgadmin_service_name }}-credentials"
  register: pgadmin_credentials_secret
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file }}"
  failed_when: false
  tags:
    - security
    - secrets

- name: "pgAdmin | SÃ©curitÃ© | GÃ©nÃ©ration de credentials sÃ©curisÃ©s si nÃ©cessaire"
  block:
    - name: "pgAdmin | SÃ©curitÃ© | GÃ©nÃ©ration d'un mot de passe administrateur sÃ©curisÃ©"
      set_fact:
        pgadmin_generated_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
      no_log: true
      when: pgadmin_admin_password is not defined

    - name: "pgAdmin | SÃ©curitÃ© | CrÃ©ation du secret avec credentials sÃ©curisÃ©s"
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: "{{ lions_pgadmin_service_name }}-credentials"
            namespace: "{{ lions_pgadmin_namespace }}"
            labels:
              app.kubernetes.io/name: "{{ lions_pgadmin_service_name }}"
              app.kubernetes.io/instance: "{{ lions_pgadmin_service_name }}-{{ lions_environment }}"
              app.kubernetes.io/component: pgladmin
              app.kubernetes.io/part-of: "{{ lions_project_name | default('lions-infrastructure') }}"
              app.kubernetes.io/managed-by: ansible
              lions.dev/environment: "{{ lions_environment }}"
              lions.dev/service-type: database
            annotations:
              lions.dev/deployment-id: "{{ pgadmin_deployment_metadata.deployment_id }}"
              lions.dev/created-by: "{{ ansible_user_id }}"
              lions.dev/created-at: "{{ pgadmin_deployment_metadata.timestamp }}"
              description: "Credentials sÃ©curisÃ©s pour pgAdmin {{ lions_environment }}"
          type: Opaque
          stringData:
            PGADMIN_DEFAULT_EMAIL: "{{ pgadmin_admin_email | default('admin@' + lions_dns_domain_base) }}"
            PGADMIN_DEFAULT_PASSWORD: "{{ pgadmin_admin_password | default(pgadmin_generated_password) }}"
        wait: true
        wait_condition:
          type: Complete
          status: "True"
        wait_timeout: "{{ lions_timeout_default }}"
      environment:
        KUBECONFIG: "{{ lions_k8s_config_file }}"
      register: pgadmin_secret_creation
      no_log: true

    - name: "pgAdmin | SÃ©curitÃ© | Confirmation de la crÃ©ation du secret"
      debug:
        msg: |
          âœ… Secret pgAdmin crÃ©Ã© avec succÃ¨s
          ğŸ“§ Email administrateur: {{ pgadmin_admin_email | default('admin@' + lions_dns_domain_base) }}
          ğŸ” Mot de passe: [GÃ‰NÃ‰RÃ‰ AUTOMATIQUEMENT - SÃ‰CURISÃ‰]
      when: pgadmin_secret_creation.changed

  when:
    - pgadmin_credentials_secret.resources is defined
    - pgadmin_credentials_secret.resources | length == 0
  tags:
    - security
    - secrets
    - credentials

- name: "pgAdmin | SÃ©curitÃ© | Validation de l'existence du secret"
  assert:
    that:
      - pgadmin_credentials_secret.resources | length > 0 or pgadmin_secret_creation.changed
    fail_msg: "Impossible de crÃ©er ou de trouver le secret pour pgAdmin"
    success_msg: "Secret pgAdmin disponible et validÃ©"
  tags:
    - security
    - validation

# =========================================================================
# GÃ‰NÃ‰RATION DES MANIFESTES KUBERNETES
# =========================================================================
- name: "pgAdmin | Manifestes | GÃ©nÃ©ration des templates Kubernetes optimisÃ©s"
  template:
    src: "{{ item.template }}.yml.j2"
    dest: "{{ pgadmin_temp_workspace.path }}/{{ item.output }}.yml"
    mode: '0644'
    backup: false
  loop:
    - { template: "serviceaccount", output: "01-serviceaccount" }
    - { template: "configmap", output: "02-configmap" }
    - { template: "service", output: "03-service" }
    - { template: "deployment", output: "04-deployment" }
    - { template: "ingress", output: "05-ingress" }
    - { template: "servicemonitor", output: "06-servicemonitor" }
  register: pgadmin_templates_generation
  changed_when: false
  tags:
    - manifests
    - templates

- name: "pgAdmin | Manifestes | Validation de la syntaxe des manifestes gÃ©nÃ©rÃ©s"
  k8s:
    state: present
    src: "{{ item }}"
    dry_run: true
    validate:
      fail_on_error: true
      strict: true
  loop: "{{ pgadmin_templates_generation.results | map(attribute='dest') | list }}"
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file }}"
  changed_when: false
  tags:
    - validation
    - manifests

# =========================================================================
# PRÃ‰PARATION DES RESSOURCES KUBERNETES
# =========================================================================
- name: "pgAdmin | K8s | CrÃ©ation/Mise Ã  jour du ServiceAccount"
  k8s:
    state: present
    src: "{{ pgadmin_temp_workspace.path }}/01-serviceaccount.yml"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: "{{ lions_timeout_default }}"
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file }}"
  register: pgadmin_serviceaccount_result
  tags:
    - k8s-resources
    - serviceaccount

- name: "pgAdmin | K8s | CrÃ©ation/Mise Ã  jour du ConfigMap"
  k8s:
    state: present
    src: "{{ pgadmin_temp_workspace.path }}/02-configmap.yml"
    wait: true
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file }}"
  register: pgladmin_configmap_result
  tags:
    - k8s-resources
    - configmap

- name: "pgAdmin | K8s | CrÃ©ation/Mise Ã  jour du Service"
  k8s:
    state: present
    src: "{{ pgadmin_temp_workspace.path }}/03-service.yml"
    wait: true
    wait_condition:
      type: Ready
      status: "True"
    wait_timeout: "{{ lions_timeout_default }}"
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file }}"
  register: pgadmin_service_result
  tags:
    - k8s-resources
    - service

# =========================================================================
# VÃ‰RIFICATIONS POST-PRÃ‰PARATION
# =========================================================================
- name: "pgAdmin | Validation | VÃ©rification de la disponibilitÃ© des ressources"
  k8s_info:
    api_version: "{{ item.api_version }}"
    kind: "{{ item.kind }}"
    namespace: "{{ lions_pgadmin_namespace }}"
    name: "{{ item.name }}"
  loop:
    - { api_version: "v1", kind: "ServiceAccount", name: "{{ lions_pgadmin_service_name }}" }
    - { api_version: "v1", kind: "ConfigMap", name: "{{ lions_pgadmin_service_name }}-config" }
    - { api_version: "v1", kind: "Service", name: "{{ lions_pgadmin_service_name }}" }
    - { api_version: "v1", kind: "Secret", name: "{{ lions_pgadmin_service_name }}-credentials" }
  register: pgadmin_resources_verification
  environment:
    KUBECONFIG: "{{ lions_k8s_config_file }}"
  tags:
    - validation
    - verification

- name: "pgAdmin | Validation | Confirmation des ressources crÃ©Ã©es"
  assert:
    that:
      - item.resources | length > 0
    fail_msg: "Ressource {{ item.item.kind }}/{{ item.item.name }} non trouvÃ©e"
    success_msg: "Ressource {{ item.item.kind }}/{{ item.item.name }} disponible"
  loop: "{{ pgadmin_resources_verification.results }}"
  tags:
    - validation

# =========================================================================
# FINALISATION ET RAPPORT
# =========================================================================
- name: "pgAdmin | Finalisation | Enregistrement des mÃ©tadonnÃ©es de prÃ©paration"
  set_fact:
    pgadmin_preparation_status:
      completed: true
      timestamp: "{{ ansible_date_time.iso8601 }}"
      environment: "{{ lions_environment }}"
      namespace: "{{ lions_pgladmin_namespace }}"
      service_name: "{{ lions_pgladmin_service_name }}"
      deployment_id: "{{ pgadmin_deployment_metadata.deployment_id }}"
      resources_created:
        - serviceaccount
        - configmap
        - service
        - secret
      next_step: "deploy"
  tags:
    - finalization
    - metadata

- name: "pgAdmin | Finalisation | Affichage du rapport de prÃ©paration"
  debug:
    msg: |
      âœ… PRÃ‰PARATION PGADMIN TERMINÃ‰E AVEC SUCCÃˆS
      ==========================================
      ğŸ“Š Environnement: {{ lions_environment }}
      ğŸ·ï¸  Namespace: {{ lions_pgladmin_namespace }}
      ğŸ“¦ Service: {{ lions_pgladmin_service_name }}
      ğŸ†” ID DÃ©ploiement: {{ pgadmin_deployment_metadata.deployment_id }}
      â° DurÃ©e: {{ (ansible_date_time.epoch | int) - (pgadmin_deployment_metadata.timestamp | to_datetime('%Y-%m-%dT%H:%M:%SZ') | int) }}s
      
      ğŸ“‹ RESSOURCES PRÃ‰PARÃ‰ES:
      - âœ… ServiceAccount: {{ lions_pgladmin_service_name }}
      - âœ… ConfigMap: {{ lions_pgladmin_service_name }}-config  
      - âœ… Service: {{ lions_pgladmin_service_name }}
      - âœ… Secret: {{ lions_pgladmin_service_name }}-credentials
      
      ğŸ”„ PROCHAINE Ã‰TAPE: ExÃ©cution du dÃ©ploiement
  tags:
    - reporting
    - finalization

# =========================================================================
# NETTOYAGE DU WORKSPACE TEMPORAIRE
# =========================================================================
- name: "pgAdmin | Nettoyage | Suppression du rÃ©pertoire de travail temporaire"
  file:
    path: "{{ pgadmin_temp_workspace.path }}"
    state: absent
  changed_when: false
  when: not (lions_debug_mode | default(false) | bool)
  tags:
    - cleanup
    - workspace

- name: "pgAdmin | Debug | Conservation du workspace pour dÃ©bogage"
  debug:
    msg: |
      ğŸ› MODE DEBUG: Workspace conservÃ©
      ğŸ“ Chemin: {{ pgadmin_temp_workspace.path }}
      ğŸ’¡ Supprimer manuellement aprÃ¨s inspection
  when: lions_debug_mode | default(false) | bool
  tags:
    - debug
    - workspace