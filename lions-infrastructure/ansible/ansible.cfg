# ===============================================================================
# ANSIBLE CONFIGURATION - LIONS INFRASTRUCTURE v5.0
# ===============================================================================
# Description: Configuration Ansible optimisée pour l'infrastructure LIONS DevOps
# Version: 5.0.0
# Date: 26/05/2025
# Author: LIONS DevOps Team
# 
# Cette configuration utilise strictement les variables d'environnement pour
# une flexibilité maximale selon les environnements (dev/staging/prod)
# ===============================================================================

[defaults]
# ===============================================================================
# CORE CONFIGURATION - Variables d'environnement prioritaires
# ===============================================================================

# Inventaire - Variable d'environnement avec fallback intelligent
inventory = ${LIONS_ANSIBLE_INVENTORY:-${LIONS_ANSIBLE_INVENTORIES_PATH:-inventories}/${LIONS_ENVIRONMENT:-development}/hosts.yml}

# Chemins des composants Ansible
roles_path = ${LIONS_ANSIBLE_ROLES_PATH:-roles}:${LIONS_ANSIBLE_GALAXY_ROLES_PATH:-~/.ansible/roles}:/usr/share/ansible/roles
library = ${LIONS_ANSIBLE_LIBRARY_PATH:-library}:${LIONS_ANSIBLE_CUSTOM_MODULES:-~/.ansible/plugins/modules}
filter_plugins = ${LIONS_ANSIBLE_FILTER_PLUGINS:-filter_plugins}:${LIONS_ANSIBLE_CUSTOM_FILTERS:-~/.ansible/plugins/filter}
action_plugins = ${LIONS_ANSIBLE_ACTION_PLUGINS:-~/.ansible/plugins/action}
callback_plugins = ${LIONS_ANSIBLE_CALLBACK_PLUGINS:-~/.ansible/plugins/callback}
connection_plugins = ${LIONS_ANSIBLE_CONNECTION_PLUGINS:-~/.ansible/plugins/connection}
lookup_plugins = ${LIONS_ANSIBLE_LOOKUP_PLUGINS:-~/.ansible/plugins/lookup}
vars_plugins = ${LIONS_ANSIBLE_VARS_PLUGINS:-~/.ansible/plugins/vars}
strategy_plugins = ${LIONS_ANSIBLE_STRATEGY_PLUGINS:-~/.ansible/plugins/strategy}

# Variables Ansible avec valeurs par défaut intelligentes
ansible_managed = "Ansible managed: {file} modified on %Y-%m-%d %H:%M:%S by {uid} on {host} - LIONS Infrastructure v5.0"
error_on_undefined_vars = ${LIONS_ANSIBLE_ERROR_ON_UNDEFINED:-true}
force_valid_group_names = ${LIONS_ANSIBLE_FORCE_VALID_GROUPS:-always}

# ===============================================================================
# LOGGING & MONITORING CONFIGURATION
# ===============================================================================

# Système de logs rotatif et configurable
log_path = ${LIONS_ANSIBLE_LOG_PATH:-${LIONS_LOG_DIR:-./logs}/ansible/ansible-${LIONS_ENVIRONMENT:-development}.log}
display_skipped_hosts = ${LIONS_ANSIBLE_DISPLAY_SKIPPED:-false}
display_ok_hosts = ${LIONS_ANSIBLE_DISPLAY_OK:-true}
display_failed_stderr = ${LIONS_ANSIBLE_DISPLAY_STDERR:-true}

# Gestion des logs selon l'environnement
syslog_facility = ${LIONS_ANSIBLE_SYSLOG_FACILITY:-LOG_USER}
no_log = ${LIONS_ANSIBLE_NO_LOG:-false}
no_target_syslog = ${LIONS_ANSIBLE_NO_TARGET_SYSLOG:-false}

# ===============================================================================
# PERFORMANCE & SCALING CONFIGURATION
# ===============================================================================

# Parallélisme adaptatif selon l'environnement
forks = ${LIONS_ANSIBLE_FORKS:-${LIONS_ANSIBLE_MAX_FORKS:-50}}
serial = ${LIONS_ANSIBLE_SERIAL:-0}
poll_interval = ${LIONS_ANSIBLE_POLL_INTERVAL:-15}

# Optimisations réseau et performance
gathering = ${LIONS_ANSIBLE_GATHERING:-smart}
gather_subset = ${LIONS_ANSIBLE_GATHER_SUBSET:-all}
gather_timeout = ${LIONS_ANSIBLE_GATHER_TIMEOUT:-30}
inject_facts_as_vars = ${LIONS_ANSIBLE_INJECT_FACTS_AS_VARS:-true}

# Cache des facts avec configuration avancée
fact_caching = ${LIONS_ANSIBLE_FACT_CACHING:-jsonfile}
fact_caching_connection = ${LIONS_ANSIBLE_FACT_CACHE_DIR:-${LIONS_CACHE_DIR:-./cache}/ansible_facts}
fact_caching_timeout = ${LIONS_ANSIBLE_FACT_CACHE_TIMEOUT:-86400}
fact_caching_prefix = ${LIONS_ANSIBLE_FACT_CACHE_PREFIX:-ansible_facts_${LIONS_ENVIRONMENT:-dev}}

# ===============================================================================
# SECURITY & CONNECTION CONFIGURATION
# ===============================================================================

# Configuration SSH sécurisée
host_key_checking = ${LIONS_ANSIBLE_HOST_KEY_CHECKING:-false}
remote_user = ${LIONS_VPS_USER:-${LIONS_ANSIBLE_REMOTE_USER:-root}}
private_key_file = ${LIONS_SSH_PRIVATE_KEY:-${LIONS_VPS_SSH_KEY_PATH:-~/.ssh/id_rsa}}
timeout = ${LIONS_ANSIBLE_TIMEOUT:-60}
command_timeout = ${LIONS_ANSIBLE_COMMAND_TIMEOUT:-120}

# Gestion des privilèges avec sécurité renforcée
become = ${LIONS_ANSIBLE_BECOME:-true}
become_method = ${LIONS_ANSIBLE_BECOME_METHOD:-sudo}
become_user = ${LIONS_ANSIBLE_BECOME_USER:-root}
become_ask_pass = ${LIONS_ANSIBLE_BECOME_ASK_PASS:-false}
become_password_file = ${LIONS_ANSIBLE_BECOME_PASSWORD_FILE}

# Configuration des mots de passe
ask_pass = ${LIONS_ANSIBLE_ASK_PASS:-false}
ask_sudo_pass = ${LIONS_ANSIBLE_ASK_SUDO_PASS:-false}
ask_su_pass = ${LIONS_ANSIBLE_ASK_SU_PASS:-false}
ask_vault_pass = ${LIONS_ANSIBLE_ASK_VAULT_PASS:-false}

# ===============================================================================
# RETRY & RELIABILITY CONFIGURATION
# ===============================================================================

# Système de retry intelligent
retry_files_enabled = ${LIONS_ANSIBLE_RETRY_ENABLED:-true}
retry_files_save_path = ${LIONS_ANSIBLE_RETRY_PATH:-${LIONS_TEMP_DIR:-/tmp}/ansible-retry}

# Gestion des erreurs et reprise
any_errors_fatal = ${LIONS_ANSIBLE_ANY_ERRORS_FATAL:-false}
max_fail_percentage = ${LIONS_ANSIBLE_MAX_FAIL_PERCENTAGE:-0}
force_handlers = ${LIONS_ANSIBLE_FORCE_HANDLERS:-false}

# ===============================================================================
# OUTPUT & CALLBACK CONFIGURATION
# ===============================================================================

# Callbacks et rapports configurables
stdout_callback = ${LIONS_ANSIBLE_STDOUT_CALLBACK:-yaml}
callback_whitelist = ${LIONS_ANSIBLE_CALLBACKS:-timer,profile_tasks,log_plays,mail}
callback_enabled = ${LIONS_ANSIBLE_CALLBACK_ENABLED:-timer,profile_tasks}

# Configuration des callbacks spécialisés
bin_ansible_callbacks = ${LIONS_ANSIBLE_BIN_CALLBACKS:-true}
nocows = ${LIONS_ANSIBLE_NOCOWS:-1}
cow_selection = ${LIONS_ANSIBLE_COW_SELECTION:-default}

# ===============================================================================
# WARNINGS & DEPRECATIONS CONFIGURATION
# ===============================================================================

# Gestion des avertissements selon l'environnement
deprecation_warnings = ${LIONS_ANSIBLE_DEPRECATION_WARNINGS:-false}
system_warnings = ${LIONS_ANSIBLE_SYSTEM_WARNINGS:-false}
action_warnings = ${LIONS_ANSIBLE_ACTION_WARNINGS:-false}
command_warnings = ${LIONS_ANSIBLE_COMMAND_WARNINGS:-false}
localhost_warning = ${LIONS_ANSIBLE_LOCALHOST_WARNING:-false}
invalid_task_attribute_failed = ${LIONS_ANSIBLE_INVALID_TASK_FAILED:-false}

# ===============================================================================
# MODULES & COLLECTIONS CONFIGURATION
# ===============================================================================

# Gestion des collections et modules
collections_on_ansible_version_mismatch = ${LIONS_ANSIBLE_COLLECTIONS_MISMATCH:-ignore}
collections_path = ${LIONS_ANSIBLE_COLLECTIONS_PATH:-~/.ansible/collections:/usr/share/ansible/collections}
collections_scan_sys_path = ${LIONS_ANSIBLE_COLLECTIONS_SCAN_SYS:-true}

# Configuration des modules
module_lang = ${LIONS_ANSIBLE_MODULE_LANG:-C}
module_set_locale = ${LIONS_ANSIBLE_MODULE_SET_LOCALE:-false}
module_compression = ${LIONS_ANSIBLE_MODULE_COMPRESSION:-ZIP_DEFLATE}

# ===============================================================================
# JINJA2 & TEMPLATING CONFIGURATION
# ===============================================================================

# Configuration Jinja2 avancée
jinja2_extensions = ${LIONS_ANSIBLE_JINJA2_EXTENSIONS:-jinja2.ext.do,jinja2.ext.i18n}
jinja2_native = ${LIONS_ANSIBLE_JINJA2_NATIVE:-false}
variable_start_string = ${LIONS_ANSIBLE_VAR_START:-{{}
variable_end_string = ${LIONS_ANSIBLE_VAR_END:-}}}
block_start_string = ${LIONS_ANSIBLE_BLOCK_START:-{%}
block_end_string = ${LIONS_ANSIBLE_BLOCK_END:-%}}

# ===============================================================================
# CONDITIONAL CONFIGURATION FOR ENVIRONMENTS
# ===============================================================================

# Variables conditionnelles selon l'environnement
strategy = ${LIONS_ANSIBLE_STRATEGY:-linear}
hash_behaviour = ${LIONS_ANSIBLE_HASH_BEHAVIOUR:-replace}
show_custom_stats = ${LIONS_ANSIBLE_SHOW_CUSTOM_STATS:-true}

# ===============================================================================
# DIFF & DEBUGGING CONFIGURATION
# ===============================================================================

# Configuration des diffs
always_make_backup = ${LIONS_ANSIBLE_ALWAYS_BACKUP:-false}
keep_remote_files = ${LIONS_ANSIBLE_KEEP_REMOTE_FILES:-false}
diff_always = ${LIONS_ANSIBLE_DIFF_ALWAYS:-false}
diff_context = ${LIONS_ANSIBLE_DIFF_CONTEXT:-3}

# ===============================================================================
# INVENTORY CONFIGURATION
# ===============================================================================

[inventory]
# Configuration avancée de l'inventaire
enable_plugins = ${LIONS_ANSIBLE_INVENTORY_PLUGINS:-host_list,script,auto,yaml,ini,toml,advanced_host_list,constructed,openstack,ec2,gcp_compute}
cache = ${LIONS_ANSIBLE_INVENTORY_CACHE:-true}
cache_plugin = ${LIONS_ANSIBLE_INVENTORY_CACHE_PLUGIN:-jsonfile}
cache_timeout = ${LIONS_ANSIBLE_INVENTORY_CACHE_TIMEOUT:-3600}
cache_connection = ${LIONS_ANSIBLE_INVENTORY_CACHE_CONNECTION:-${LIONS_CACHE_DIR:-./cache}/inventory_cache}
cache_prefix = ${LIONS_ANSIBLE_INVENTORY_CACHE_PREFIX:-inventory_${LIONS_ENVIRONMENT:-dev}}

# Parsing et validation
ignore_extensions = ${LIONS_ANSIBLE_INVENTORY_IGNORE_EXT:-.pyc,.pyo,.swp,.bak,~,.rpm,.md,.txt}
ignore_patterns = ${LIONS_ANSIBLE_INVENTORY_IGNORE_PATTERNS}
unparsed_is_failed = ${LIONS_ANSIBLE_INVENTORY_UNPARSED_FAILED:-false}

# ===============================================================================
# SSH CONNECTION CONFIGURATION
# ===============================================================================

[ssh_connection]
# Configuration SSH optimisée pour la production
ssh_args = ${LIONS_SSH_ARGS:--o ServerAliveInterval=60 -o ServerAliveCountMax=3 -o ControlMaster=auto -o ControlPersist=300s -o PreferredAuthentications=publickey -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null}
ssh_common_args = ${LIONS_SSH_COMMON_ARGS}
ssh_extra_args = ${LIONS_SSH_EXTRA_ARGS}

# Optimisations réseau SSH
pipelining = ${LIONS_SSH_PIPELINING:-true}
scp_if_ssh = ${LIONS_SSH_SCP_IF_SSH:-smart}
transfer_method = ${LIONS_SSH_TRANSFER_METHOD:-smart}

# Configuration des chemins et sockets
control_path_dir = ${LIONS_SSH_CONTROL_PATH_DIR:-${LIONS_TEMP_DIR:-/tmp}}
control_path = ${LIONS_SSH_CONTROL_PATH:-${LIONS_TEMP_DIR:-/tmp}/ansible-ssh-%h-%p-%r-%C}
usetty = ${LIONS_SSH_USE_TTY:-true}

# Configuration SFTP/SCP
sftp_batch_mode = ${LIONS_SFTP_BATCH_MODE:-false}
scp_extra_args = ${LIONS_SCP_EXTRA_ARGS}
sftp_extra_args = ${LIONS_SFTP_EXTRA_ARGS}

# Timeouts et reconnexions
timeout = ${LIONS_SSH_TIMEOUT:-30}
retries = ${LIONS_SSH_RETRIES:-3}

# ===============================================================================
# PARAMIKO CONNECTION CONFIGURATION (Fallback)
# ===============================================================================

[paramiko_connection]
# Configuration Paramiko pour les connexions fallback
record_host_keys = ${LIONS_PARAMIKO_RECORD_HOST_KEYS:-false}
pty = ${LIONS_PARAMIKO_PTY:-true}
look_for_keys = ${LIONS_PARAMIKO_LOOK_FOR_KEYS:-true}
host_key_auto_add = ${LIONS_PARAMIKO_HOST_KEY_AUTO_ADD:-true}

# ===============================================================================
# PERSISTENT CONNECTION CONFIGURATION
# ===============================================================================

[persistent_connection]
# Configuration des connexions persistantes
connect_timeout = ${LIONS_PERSISTENT_CONNECT_TIMEOUT:-30}
connect_retry_timeout = ${LIONS_PERSISTENT_RETRY_TIMEOUT:-15}
connect_interval = ${LIONS_PERSISTENT_CONNECT_INTERVAL:-1}
command_timeout = ${LIONS_PERSISTENT_COMMAND_TIMEOUT:-120}

# ===============================================================================
# COLORS CONFIGURATION
# ===============================================================================

[colors]
# Configuration des couleurs pour l'output
highlight = ${LIONS_ANSIBLE_COLOR_HIGHLIGHT:-white}
verbose = ${LIONS_ANSIBLE_COLOR_VERBOSE:-blue}
warn = ${LIONS_ANSIBLE_COLOR_WARN:-bright purple}
error = ${LIONS_ANSIBLE_COLOR_ERROR:-red}
debug = ${LIONS_ANSIBLE_COLOR_DEBUG:-dark gray}
deprecate = ${LIONS_ANSIBLE_COLOR_DEPRECATE:-purple}
skip = ${LIONS_ANSIBLE_COLOR_SKIP:-cyan}
unreachable = ${LIONS_ANSIBLE_COLOR_UNREACHABLE:-bright red}
ok = ${LIONS_ANSIBLE_COLOR_OK:-green}
changed = ${LIONS_ANSIBLE_COLOR_CHANGED:-yellow}
diff_add = ${LIONS_ANSIBLE_COLOR_DIFF_ADD:-green}
diff_remove = ${LIONS_ANSIBLE_COLOR_DIFF_REMOVE:-red}
diff_lines = ${LIONS_ANSIBLE_COLOR_DIFF_LINES:-cyan}

# ===============================================================================
# SELINUX CONFIGURATION
# ===============================================================================

[selinux]
# Configuration SELinux
special_context_filesystems = ${LIONS_SELINUX_SPECIAL_FS:-fuse,nfs,vboxsf,ramfs,9p,vfat}
libvirt_lxc_noseclabel = ${LIONS_SELINUX_LIBVIRT_NOSECLABEL:-true}

# ===============================================================================
# PRIVILEGE ESCALATION METHODS
# ===============================================================================

[privilege_escalation]
# Configuration avancée de l'escalade de privilèges
become = ${LIONS_ANSIBLE_BECOME:-true}
become_method = ${LIONS_ANSIBLE_BECOME_METHOD:-sudo}
become_user = ${LIONS_ANSIBLE_BECOME_USER:-root}
become_ask_pass = ${LIONS_ANSIBLE_BECOME_ASK_PASS:-false}
become_exe = ${LIONS_ANSIBLE_BECOME_EXE}
become_flags = ${LIONS_ANSIBLE_BECOME_FLAGS}

# ===============================================================================
# GALAXY CONFIGURATION
# ===============================================================================

[galaxy]
# Configuration Ansible Galaxy
server_list = ${LIONS_GALAXY_SERVERS:-galaxy,community_galaxy}
ignore_certs = ${LIONS_GALAXY_IGNORE_CERTS:-false}
timeout = ${LIONS_GALAXY_TIMEOUT:-60}
cache_dir = ${LIONS_GALAXY_CACHE_DIR:-${LIONS_CACHE_DIR:-~/.ansible/galaxy_cache}}

# Configuration des serveurs Galaxy
[galaxy_server.galaxy]
url = ${LIONS_GALAXY_SERVER_URL:-https://galaxy.ansible.com/}
username = ${LIONS_GALAXY_USERNAME}
password = ${LIONS_GALAXY_PASSWORD}
token = ${LIONS_GALAXY_TOKEN}

[galaxy_server.community_galaxy]
url = ${LIONS_COMMUNITY_GALAXY_URL:-https://galaxy.ansible.com/}
username = ${LIONS_COMMUNITY_GALAXY_USERNAME}
password = ${LIONS_COMMUNITY_GALAXY_PASSWORD}
token = ${LIONS_COMMUNITY_GALAXY_TOKEN}

# ===============================================================================
# NETCONF CONFIGURATION
# ===============================================================================

[netconf_connection]
# Configuration pour les connexions NETCONF
ncclient_device_handler = ${LIONS_NETCONF_HANDLER:-default}
network_os = ${LIONS_NETCONF_OS}
port = ${LIONS_NETCONF_PORT:-830}
timeout = ${LIONS_NETCONF_TIMEOUT:-10}
host_key_checking = ${LIONS_NETCONF_HOST_KEY_CHECKING:-true}
persistent_connect_timeout = ${LIONS_NETCONF_PERSISTENT_TIMEOUT:-30}

# ===============================================================================
# TAGS CONFIGURATION
# ===============================================================================

[tags]
# Configuration des tags
run = ${LIONS_ANSIBLE_TAGS_RUN}
skip = ${LIONS_ANSIBLE_TAGS_SKIP}

# ===============================================================================
# DIFF CONFIGURATION
# ===============================================================================

[diff]
# Configuration des diffs
always = ${LIONS_ANSIBLE_DIFF_ALWAYS:-false}
context = ${LIONS_ANSIBLE_DIFF_CONTEXT:-3}

# ===============================================================================
# RUNNER CONFIGURATION (AWX/Tower)
# ===============================================================================

[runner]
# Configuration pour AWX/Ansible Tower
fact_cache_timeout = ${LIONS_RUNNER_FACT_CACHE_TIMEOUT:-86400}
job_timeout = ${LIONS_RUNNER_JOB_TIMEOUT:-0}
pexpect_timeout = ${LIONS_RUNNER_PEXPECT_TIMEOUT:-10}

# ===============================================================================
# ENVIRONMENT-SPECIFIC INCLUDES
# ===============================================================================

# Inclusion conditionnelle de configurations spécifiques à l'environnement
# Ces fichiers peuvent surcharger les paramètres ci-dessus

# Configuration de développement
%{if env.LIONS_ENVIRONMENT == "development"}
%include ${LIONS_CONFIG_DIR:-./config}/ansible-dev.cfg
%endif

# Configuration de staging  
%{if env.LIONS_ENVIRONMENT == "staging"}
%include ${LIONS_CONFIG_DIR:-./config}/ansible-staging.cfg
%endif

# Configuration de production
%{if env.LIONS_ENVIRONMENT == "production"}
%include ${LIONS_CONFIG_DIR:-./config}/ansible-prod.cfg
%endif

# Configuration locale (non versionnée)
%{if file_exists("${LIONS_CONFIG_DIR:-./config}/ansible-local.cfg")}
%include ${LIONS_CONFIG_DIR:-./config}/ansible-local.cfg
%endif

# ===============================================================================
# PERFORMANCE TUNING NOTES
# ===============================================================================
# 
# Variables d'environnement recommandées pour l'optimisation:
#
# DÉVELOPPEMENT:
# export LIONS_ANSIBLE_FORKS=10
# export LIONS_ANSIBLE_GATHERING=smart
# export LIONS_ANSIBLE_FACT_CACHING=jsonfile
# export LIONS_ANSIBLE_STDOUT_CALLBACK=debug
#
# STAGING:
# export LIONS_ANSIBLE_FORKS=25
# export LIONS_ANSIBLE_GATHERING=smart
# export LIONS_ANSIBLE_FACT_CACHING=redis
# export LIONS_ANSIBLE_STDOUT_CALLBACK=yaml
#
# PRODUCTION:
# export LIONS_ANSIBLE_FORKS=50
# export LIONS_ANSIBLE_GATHERING=smart
# export LIONS_ANSIBLE_FACT_CACHING=redis
# export LIONS_ANSIBLE_STDOUT_CALLBACK=json
# export LIONS_ANSIBLE_HOST_KEY_CHECKING=true
# export LIONS_ANSIBLE_ANY_ERRORS_FATAL=true
#
# ===============================================================================