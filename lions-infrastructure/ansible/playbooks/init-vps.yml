---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - PLAYBOOK D'INITIALISATION VPS
# =========================================================================
# Description: Playbook d'initialisation s√©curis√©e et optimis√©e du VPS
# Version: 5.0.0
# Maintainer: DevOps Team <devops@lions.dev>
# Documentation: https://docs.lions.dev/infrastructure/vps-initialization
# =========================================================================

- name: "LIONS Infrastructure 5.0 - Initialisation VPS {{ inventory_hostname }}"
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true

  vars:
    # Variables de contr√¥le du playbook
    lions_init_skip_reboot: "{{ lions_skip_reboot | default(false) }}"
    lions_init_force_update: "{{ lions_force_system_update | default(false) }}"
    lions_init_debug_mode: "{{ lions_debug_mode | default(false) }}"

    # Configuration syst√®me de base
    lions_system_timezone: "{{ lions_timezone | default('UTC') }}"
    lions_system_locale: "{{ lions_locale | default('en_US.UTF-8') }}"
    lions_system_swap_size: "{{ lions_swap_size | default('4G') }}"

    # Configuration r√©seau et s√©curit√©
    lions_ssh_port: "{{ ansible_port | default(22) }}"
    lions_firewall_enabled: "{{ lions_security_firewall_enabled | default(true) }}"
    lions_fail2ban_enabled: "{{ lions_security_fail2ban_enabled | default(true) }}"

    # Configuration des r√©pertoires
    lions_base_directory: "{{ lions_base_dir | default('/opt/lions') }}"
    lions_logs_directory: "{{ lions_logs_dir | default('/var/log/lions') }}"
    lions_config_directory: "{{ lions_config_dir | default('/etc/lions') }}"
    lions_data_directory: "{{ lions_data_dir | default('/var/lib/lions') }}"

  pre_tasks:
    - name: "üîç Validation de la configuration d'initialisation"
      block:
        - name: "V√©rification des variables requises"
          assert:
            that:
              - inventory_hostname is defined
              - ansible_user is defined
              - lions_environment is defined
            fail_msg: "Variables d'environnement requises manquantes"
            success_msg: "‚úÖ Variables d'environnement valid√©es"

        - name: "Affichage des informations d'initialisation"
          debug:
            msg:
              - "üèóÔ∏è  Initialisation VPS: {{ inventory_hostname }}"
              - "üåç Environnement: {{ lions_environment }}"
              - "üë§ Utilisateur: {{ ansible_user }}"
              - "üîß Mode debug: {{ lions_init_debug_mode }}"
              - "‚è∞ Fuseau horaire: {{ lions_system_timezone }}"
          when: lions_init_debug_mode | bool

        - name: "Test de connectivit√© et privil√®ges"
          ping:
          register: connectivity_test

        - name: "V√©rification des privil√®ges sudo"
          command: whoami
          become: true
          register: sudo_test
          changed_when: false

      rescue:
        - name: "‚ùå √âchec de la validation pr√©-initialisation"
          fail:
            msg: "Impossible de continuer l'initialisation - v√©rifiez la connectivit√© et les privil√®ges"

  tasks:
    # =========================================================================
    # PHASE 1: PR√âPARATION SYST√àME
    # =========================================================================
    - name: "üöÄ PHASE 1: Pr√©paration du syst√®me"
      block:
        - name: "üìä Collecte des informations syst√®me"
          setup:
            gather_subset:
              - hardware
              - network
              - virtual
              - distribution
          register: system_facts

        - name: "üìù Journalisation de l'initialisation"
          lineinfile:
            path: "/var/log/lions-init.log"
            line: "{{ ansible_date_time.iso8601 }} - D√©but initialisation VPS {{ inventory_hostname }} ({{ lions_environment }})"
            create: true
            mode: '0644'
          delegate_to: localhost
          become: false

        - name: "üîß Cr√©ation de la structure de r√©pertoires LIONS"
          file:
            path: "{{ item }}"
            state: directory
            mode: '0755'
            owner: root
            group: root
          loop:
            - "{{ lions_base_directory }}"
            - "{{ lions_config_directory }}"
            - "{{ lions_data_directory }}"
            - "{{ lions_logs_directory }}"
            - "{{ lions_logs_directory }}/system"
            - "{{ lions_logs_directory }}/security"
            - "{{ lions_logs_directory }}/applications"
            - "{{ lions_logs_directory }}/deployments"
            - "{{ lions_logs_directory }}/maintenance"
            - "/opt/lions/backups"
            - "/opt/lions/scripts"
            - "/opt/lions/tmp"

    # =========================================================================
    # PHASE 2: MISE √Ä JOUR SYST√àME S√âCURIS√âE
    # =========================================================================
    - name: "üîÑ PHASE 2: Mise √† jour syst√®me s√©curis√©e"
      block:
        - name: "üßπ Nettoyage des anciens d√©p√¥ts Kubernetes obsol√®tes"
          block:
            - name: "Suppression des d√©p√¥ts Kubernetes obsol√®tes"
              file:
                path: "{{ item }}"
                state: absent
              loop:
                - "/etc/apt/sources.list.d/kubernetes.list"
                - "/etc/apt/sources.list.d/docker.list"
              ignore_errors: true

            - name: "Nettoyage des entr√©es obsol√®tes dans sources.list"
              lineinfile:
                path: /etc/apt/sources.list
                regexp: "{{ item }}"
                state: absent
              loop:
                - '.*apt.kubernetes.io.*xenial.*'
                - '.*download.docker.com.*xenial.*'
              ignore_errors: true

        - name: "üîë Configuration des d√©p√¥ts s√©curis√©s"
          block:
            - name: "Cr√©ation du r√©pertoire des cl√©s GPG"
              file:
                path: /etc/apt/keyrings
                state: directory
                mode: '0755'

            - name: "Installation des certificats CA mis √† jour"
              apt:
                name: ca-certificates
                state: present
                update_cache: true
                cache_valid_time: 0

        - name: "‚¨ÜÔ∏è Mise √† jour du syst√®me avec gestion d'erreurs am√©lior√©e"
          block:
            - name: "Mise √† jour du cache APT"
              apt:
                update_cache: true
                cache_valid_time: 3600
                force_apt_get: true
              register: apt_cache_update
              retries: 3
              delay: 10
              until: apt_cache_update is succeeded

            - name: "Mise √† jour des paquets syst√®me"
              apt:
                upgrade: safe
                force_apt_get: true
                dpkg_options: 'force-confdef,force-confold'
              register: system_upgrade
              retries: 2
              delay: 30
              when: lions_init_force_update | bool

            - name: "Nettoyage des paquets orphelins"
              apt:
                autoremove: true
                autoclean: true

          rescue:
            - name: "‚ö†Ô∏è Gestion des erreurs de mise √† jour"
              debug:
                msg: "Probl√®me lors de la mise √† jour syst√®me - continuons avec l'installation des paquets essentiels"

    # =========================================================================
    # PHASE 3: INSTALLATION DES PAQUETS ESSENTIELS
    # =========================================================================
    - name: "üì¶ PHASE 3: Installation des paquets essentiels"
      block:
        - name: "Installation des paquets de base syst√®me"
          apt:
            name:
              # S√©curit√© et monitoring
              - fail2ban
              - ufw
              - unattended-upgrades
              - logrotate
              # Outils syst√®me
              - curl
              - wget
              - vim
              - htop
              - iotop
              - sysstat
              - tree
              # R√©seau et diagnostics
              - net-tools
              - dnsutils
              - telnet
              - traceroute
              - tcpdump
              # D√©veloppement et automation
              - git
              - jq
              - yq
              - unzip
              - zip
              - tar
              - gzip
              # Python et pip
              - python3
              - python3-pip
              - python3-venv
              # Certificats et cryptographie
              - ca-certificates
              - gnupg
              - software-properties-common
              - apt-transport-https
              - lsb-release
            state: present
            install_recommends: false
          register: essential_packages
          retries: 3
          delay: 30

        - name: "Installation des outils de monitoring avanc√©s"
          apt:
            name:
              - prometheus-node-exporter
              - collectd
              - rsyslog
            state: present
          when: lions_monitoring_enabled | default(true) | bool

    # =========================================================================
    # PHASE 4: CONFIGURATION S√âCURIS√âE DU SYST√àME
    # =========================================================================
    - name: "üîê PHASE 4: Configuration de la s√©curit√©"
      block:
        - name: "üïê Configuration du fuseau horaire"
          timezone:
            name: "{{ lions_system_timezone }}"
          notify: restart rsyslog

        - name: "üóÇÔ∏è Configuration des locales"
          locale_gen:
            name: "{{ lions_system_locale }}"
            state: present

        - name: "üî• Configuration du pare-feu UFW"
          include_tasks: tasks/configure_firewall.yml
          when: lions_firewall_enabled | bool

        - name: "üõ°Ô∏è Configuration de Fail2Ban"
          include_tasks: tasks/configure_fail2ban.yml
          when: lions_fail2ban_enabled | bool

        - name: "üë§ Configuration de l'utilisateur LIONS"
          include_tasks: tasks/configure_user.yml

    # =========================================================================
    # PHASE 5: OPTIMISATION SYST√àME
    # =========================================================================
    - name: "‚ö° PHASE 5: Optimisation syst√®me"
      block:
        - name: "üíæ Configuration du swap intelligent"
          include_tasks: tasks/configure_swap.yml

        - name: "üöÄ Optimisation des param√®tres kernel"
          sysctl:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            state: present
            reload: true
            sysctl_file: /etc/sysctl.d/99-lions-optimization.conf
          loop:
            # Optimisation m√©moire
            - { name: "vm.swappiness", value: "10" }
            - { name: "vm.vfs_cache_pressure", value: "50" }
            - { name: "vm.dirty_ratio", value: "15" }
            - { name: "vm.dirty_background_ratio", value: "5" }
            # Optimisation r√©seau
            - { name: "net.core.rmem_max", value: "16777216" }
            - { name: "net.core.wmem_max", value: "16777216" }
            - { name: "net.ipv4.tcp_rmem", value: "4096 65536 16777216" }
            - { name: "net.ipv4.tcp_wmem", value: "4096 65536 16777216" }
            # S√©curit√© r√©seau
            - { name: "net.ipv4.conf.all.send_redirects", value: "0" }
            - { name: "net.ipv4.conf.default.send_redirects", value: "0" }
            - { name: "net.ipv4.conf.all.accept_redirects", value: "0" }
            - { name: "net.ipv4.conf.default.accept_redirects", value: "0" }
            - { name: "net.ipv4.conf.all.secure_redirects", value: "0" }
            - { name: "net.ipv4.conf.default.secure_redirects", value: "0" }
            # Kubernetes/Container optimizations
            - { name: "net.bridge.bridge-nf-call-iptables", value: "1" }
            - { name: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
            - { name: "net.ipv4.ip_forward", value: "1" }
          register: sysctl_optimization

        - name: "üìä Configuration des limites syst√®me"
          pam_limits:
            domain: "{{ item.domain }}"
            limit_type: "{{ item.type }}"
            limit_item: "{{ item.item }}"
            value: "{{ item.value }}"
          loop:
            - { domain: "*", type: "soft", item: "nofile", value: "65536" }
            - { domain: "*", type: "hard", item: "nofile", value: "65536" }
            - { domain: "*", type: "soft", item: "nproc", value: "32768" }
            - { domain: "*", type: "hard", item: "nproc", value: "32768" }
            - { domain: "root", type: "soft", item: "nofile", value: "65536" }
            - { domain: "root", type: "hard", item: "nofile", value: "65536" }

    # =========================================================================
    # PHASE 6: CONFIGURATION DES SERVICES
    # =========================================================================
    - name: "üîß PHASE 6: Configuration des services syst√®me"
      block:
        - name: "üîÑ Configuration de la rotation des logs"
          template:
            src: logrotate-lions.conf.j2
            dest: /etc/logrotate.d/lions
            mode: '0644'
          vars:
            log_directories:
              - "{{ lions_logs_directory }}"
              - "/var/log/lions"
            retention_days: "{{ lions_log_retention_days | default(30) }}"

        - name: "üìà Configuration de la collecte des m√©triques"
          systemd:
            name: "{{ item }}"
            enabled: true
            state: started
          loop:
            - prometheus-node-exporter
            - rsyslog
          when: lions_monitoring_enabled | default(true) | bool

        - name: "üîß Configuration des mises √† jour automatiques de s√©curit√©"
          template:
            src: unattended-upgrades.conf.j2
            dest: /etc/apt/apt.conf.d/50unattended-upgrades
            mode: '0644'
          vars:
            auto_security_updates: true
            auto_reboot: false
            notification_email: "{{ lions_admin_email | default('') }}"

    # =========================================================================
    # PHASE 7: PR√âPARATION POUR KUBERNETES
    # =========================================================================
    - name: "‚ò∏Ô∏è PHASE 7: Pr√©paration pour Kubernetes"
      block:
        - name: "üîß Chargement des modules kernel requis"
          modprobe:
            name: "{{ item }}"
            state: present
          loop:
            - br_netfilter
            - overlay
            - ip_vs
            - ip_vs_rr
            - ip_vs_wrr
            - ip_vs_sh
            - nf_conntrack

        - name: "üìù Configuration permanente des modules"
          lineinfile:
            path: /etc/modules-load.d/lions-k8s.conf
            line: "{{ item }}"
            create: true
            mode: '0644'
          loop:
            - br_netfilter
            - overlay
            - ip_vs
            - ip_vs_rr
            - ip_vs_wrr
            - ip_vs_sh
            - nf_conntrack

        - name: "üèóÔ∏è Pr√©paration des r√©pertoires Kubernetes"
          file:
            path: "{{ item }}"
            state: directory
            mode: '0755'
            owner: root
            group: root
          loop:
            - /etc/rancher
            - /etc/rancher/k3s
            - /var/lib/rancher
            - /var/lib/rancher/k3s
            - /var/log/rancher

    # =========================================================================
    # PHASE 8: VALIDATION FINALE
    # =========================================================================
    - name: "‚úÖ PHASE 8: Validation finale de l'initialisation"
      block:
        - name: "üîç V√©rification des services critiques"
          service_facts:
          register: services_status

        - name: "üìä V√©rification de l'√©tat syst√®me"
          command: "{{ item }}"
          loop:
            - "systemctl is-active rsyslog"
            - "systemctl is-active ssh"
            - "ufw status"
          register: system_checks
          changed_when: false
          failed_when: false

        - name: "üíæ V√©rification de l'espace disque"
          shell: |
            df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
          register: disk_usage
          changed_when: false

        - name: "‚ö†Ô∏è Alerte espace disque"
          debug:
            msg: "‚ö†Ô∏è  ATTENTION: Espace disque utilis√© √† {{ disk_usage.stdout }}%"
          when: disk_usage.stdout | int > 80

        - name: "üìù G√©n√©ration du rapport d'initialisation"
          template:
            src: init-report.j2
            dest: "{{ lions_logs_directory }}/initialization-report-{{ ansible_date_time.epoch }}.log"
            mode: '0644'
          vars:
            initialization_date: "{{ ansible_date_time.iso8601 }}"
            hostname: "{{ inventory_hostname }}"
            environment: "{{ lions_environment }}"
            system_info: "{{ ansible_facts }}"
            installed_packages: "{{ essential_packages }}"

  post_tasks:
    - name: "üéâ Finalisation de l'initialisation"
      block:
        - name: "üìù Journalisation de fin d'initialisation"
          lineinfile:
            path: "/var/log/lions-init.log"
            line: "{{ ansible_date_time.iso8601 }} - Fin initialisation VPS {{ inventory_hostname }} - SUCC√àS"
            create: true
            mode: '0644'
          delegate_to: localhost
          become: false

        - name: "üîÑ Planification du red√©marrage si n√©cessaire"
          block:
            - name: "V√©rification de la n√©cessit√© de red√©marrage"
              stat:
                path: /var/run/reboot-required
              register: reboot_required

            - name: "‚ö†Ô∏è Notification de red√©marrage requis"
              debug:
                msg: |
                  ‚ö†Ô∏è  RED√âMARRAGE REQUIS D√âTECT√â
                  Le syst√®me n√©cessite un red√©marrage pour finaliser les mises √† jour.
                  Ex√©cutez 'sudo reboot' manuellement ou relancez avec -e lions_skip_reboot=false
              when:
                - reboot_required.stat.exists
                - lions_init_skip_reboot | bool

            - name: "üîÑ Red√©marrage automatique du syst√®me"
              reboot:
                reboot_timeout: 600
                post_reboot_delay: 30
                test_command: uptime
              when:
                - reboot_required.stat.exists
                - not lions_init_skip_reboot | bool
                - ansible_connection != 'local'

        - name: "üéØ R√©sum√© de l'initialisation"
          debug:
            msg:
              - "‚úÖ Initialisation VPS complet√©e avec succ√®s!"
              - "üè∑Ô∏è  Hostname: {{ inventory_hostname }}"
              - "üåç Environnement: {{ lions_environment }}"
              - "üìä Espace disque utilis√©: {{ disk_usage.stdout }}%"
              - "üîß R√©pertoire base LIONS: {{ lions_base_directory }}"
              - "üìù Logs disponibles dans: {{ lions_logs_directory }}"
              - "‚è≠Ô∏è  Pr√™t pour l'installation de Kubernetes (K3s)"

  handlers:
    - name: restart rsyslog
      systemd:
        name: rsyslog
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted

    - name: restart ssh
      systemd:
        name: ssh
        state: restarted

    - name: reload ufw
      command: ufw --force reload