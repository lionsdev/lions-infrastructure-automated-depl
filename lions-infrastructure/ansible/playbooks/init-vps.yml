---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - PLAYBOOK D'INITIALISATION VPS
# =========================================================================
# Description: Playbook d'initialisation sÃ©curisÃ©e et optimisÃ©e du VPS
# Version: 5.0.0
# Maintainer: DevOps Team <devops@lions.dev>
# Documentation: https://docs.lions.dev/infrastructure/vps-initialization
# =========================================================================

- name: "LIONS Infrastructure 5.0 - Initialisation VPS {{ inventory_hostname }}"
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true

  vars:
    # Variables de contrÃ´le du playbook
    lions_init_skip_reboot: "{{ lions_skip_reboot | default(false) }}"
    lions_init_force_update: "{{ lions_force_system_update | default(false) }}"
    lions_init_debug_mode: "{{ lions_debug_mode | default(false) }}"

    # Configuration systÃ¨me de base
    lions_system_timezone: "{{ lions_timezone | default('UTC') }}"
    lions_system_locale: "{{ lions_locale | default('en_US.UTF-8') }}"
    lions_system_swap_size: "{{ lions_swap_size | default('4G') }}"

    # Configuration rÃ©seau et sÃ©curitÃ©
    lions_ssh_port: "{{ ansible_port | default(22) }}"
    lions_firewall_enabled: "{{ lions_security_firewall_enabled | default(true) }}"
    lions_fail2ban_enabled: "{{ lions_security_fail2ban_enabled | default(true) }}"

    # Configuration des rÃ©pertoires
    lions_base_directory: "{{ lions_base_dir | default('/opt/lions') }}"
    lions_logs_directory: "{{ lions_logs_dir | default('/var/log/lions') }}"
    lions_config_directory: "{{ lions_config_dir | default('/etc/lions') }}"
    lions_data_directory: "{{ lions_data_dir | default('/var/lib/lions') }}"

  pre_tasks:
    - name: "ğŸ” Validation de la configuration d'initialisation"
      block:
        - name: "VÃ©rification des variables requises"
          assert:
            that:
              - inventory_hostname is defined
              - ansible_user is defined
              - lions_environment is defined
            fail_msg: "Variables d'environnement requises manquantes"
            success_msg: "âœ… Variables d'environnement validÃ©es"

        - name: "Affichage des informations d'initialisation"
          debug:
            msg:
              - "ğŸ—ï¸  Initialisation VPS: {{ inventory_hostname }}"
              - "ğŸŒ Environnement: {{ lions_environment }}"
              - "ğŸ‘¤ Utilisateur: {{ ansible_user }}"
              - "ğŸ”§ Mode debug: {{ lions_init_debug_mode }}"
              - "â° Fuseau horaire: {{ lions_system_timezone }}"
          when: lions_init_debug_mode | bool

        - name: "Test de connectivitÃ© et privilÃ¨ges"
          ping:
          register: connectivity_test

        - name: "VÃ©rification des privilÃ¨ges sudo"
          command: whoami
          become: true
          register: sudo_test
          changed_when: false

      rescue:
        - name: "âŒ Ã‰chec de la validation prÃ©-initialisation"
          fail:
            msg: "Impossible de continuer l'initialisation - vÃ©rifiez la connectivitÃ© et les privilÃ¨ges"

  tasks:
    # =========================================================================
    # PHASE 1: PRÃ‰PARATION SYSTÃˆME
    # =========================================================================
    - name: "ğŸš€ PHASE 1: PrÃ©paration du systÃ¨me"
      block:
        - name: "ğŸ“Š Collecte des informations systÃ¨me"
          setup:
            gather_subset:
              - hardware
              - network
              - virtual
              - distribution
          register: system_facts

        - name: "ğŸ“ Journalisation de l'initialisation"
          lineinfile:
            path: "/var/log/lions-init.log"
            line: "{{ ansible_date_time.iso8601 }} - DÃ©but initialisation VPS {{ inventory_hostname }} ({{ lions_environment }})"
            create: true
            mode: '0644'
          delegate_to: localhost
          become: false

        - name: "ğŸ”§ CrÃ©ation de la structure de rÃ©pertoires LIONS"
          file:
            path: "{{ item }}"
            state: directory
            mode: '0755'
            owner: root
            group: root
          loop:
            - "{{ lions_base_directory }}"
            - "{{ lions_config_directory }}"
            - "{{ lions_data_directory }}"
            - "{{ lions_logs_directory }}"
            - "{{ lions_logs_directory }}/system"
            - "{{ lions_logs_directory }}/security"
            - "{{ lions_logs_directory }}/applications"
            - "{{ lions_logs_directory }}/deployments"
            - "{{ lions_logs_directory }}/maintenance"
            - "/opt/lions/backups"
            - "/opt/lions/scripts"
            - "/opt/lions/tmp"

    # =========================================================================
    # PHASE 2: MISE Ã€ JOUR SYSTÃˆME SÃ‰CURISÃ‰E
    # =========================================================================
    - name: "ğŸ”„ PHASE 2: Mise Ã  jour systÃ¨me sÃ©curisÃ©e"
      block:
        - name: "ğŸ§¹ Nettoyage des anciens dÃ©pÃ´ts Kubernetes obsolÃ¨tes"
          block:
            - name: "Suppression des dÃ©pÃ´ts Kubernetes obsolÃ¨tes"
              file:
                path: "{{ item }}"
                state: absent
              loop:
                - "/etc/apt/sources.list.d/kubernetes.list"
                - "/etc/apt/sources.list.d/docker.list"
              ignore_errors: true

            - name: "Nettoyage des entrÃ©es obsolÃ¨tes dans sources.list"
              lineinfile:
                path: /etc/apt/sources.list
                regexp: "{{ item }}"
                state: absent
              loop:
                - '.*apt.kubernetes.io.*xenial.*'
                - '.*download.docker.com.*xenial.*'
              ignore_errors: true

        - name: "ğŸ”‘ Configuration des dÃ©pÃ´ts sÃ©curisÃ©s"
          block:
            - name: "CrÃ©ation du rÃ©pertoire des clÃ©s GPG"
              file:
                path: /etc/apt/keyrings
                state: directory
                mode: '0755'

            - name: "Installation des certificats CA mis Ã  jour"
              apt:
                name: ca-certificates
                state: present
                update_cache: true
                cache_valid_time: 0

        - name: "â¬†ï¸ Mise Ã  jour du systÃ¨me avec gestion d'erreurs amÃ©liorÃ©e"
          block:
            - name: "Mise Ã  jour du cache APT"
              apt:
                update_cache: true
                cache_valid_time: 3600
                force_apt_get: true
              register: apt_cache_update
              retries: 3
              delay: 10
              until: apt_cache_update is succeeded

            - name: "Mise Ã  jour des paquets systÃ¨me"
              apt:
                upgrade: safe
                force_apt_get: true
                dpkg_options: 'force-confdef,force-confold'
              register: system_upgrade
              retries: 2
              delay: 30
              when: lions_init_force_update | bool

            - name: "Nettoyage des paquets orphelins"
              apt:
                autoremove: true
                autoclean: true

          rescue:
            - name: "âš ï¸ Gestion des erreurs de mise Ã  jour"
              debug:
                msg: "ProblÃ¨me lors de la mise Ã  jour systÃ¨me - continuons avec l'installation des paquets essentiels"

    # =========================================================================
    # PHASE 3: INSTALLATION DES PAQUETS ESSENTIELS
    # =========================================================================
    - name: "ğŸ“¦ PHASE 3: Installation des paquets essentiels"
      block:
        - name: "Installation des paquets de base systÃ¨me"
          apt:
            name:
              # SÃ©curitÃ© et monitoring
              - fail2ban
              - ufw
              - unattended-upgrades
              - logrotate
              # Outils systÃ¨me
              - curl
              - wget
              - vim
              - htop
              - iotop
              - sysstat
              - tree
              # RÃ©seau et diagnostics
              - net-tools
              - dnsutils
              - telnet
              - traceroute
              - tcpdump
              # DÃ©veloppement et automation
              - git
              - jq
              - yq
              - unzip
              - zip
              - tar
              - gzip
              # Python et pip
              - python3
              - python3-pip
              - python3-venv
              # Certificats et cryptographie
              - ca-certificates
              - gnupg
              - software-properties-common
              - apt-transport-https
              - lsb-release
            state: present
            install_recommends: false
          register: essential_packages
          retries: 3
          delay: 30

        - name: "Installation des outils de monitoring avancÃ©s"
          apt:
            name:
              - prometheus-node-exporter
              - collectd
              - rsyslog
            state: present
          when: lions_monitoring_enabled | default(true) | bool

    # =========================================================================
    # PHASE 4: CONFIGURATION SÃ‰CURISÃ‰E DU SYSTÃˆME
    # =========================================================================
    - name: "ğŸ” PHASE 4: Configuration de la sÃ©curitÃ©"
      block:
        - name: "ğŸ• Configuration du fuseau horaire"
          timezone:
            name: "{{ lions_system_timezone }}"
          notify: restart rsyslog

        - name: "ğŸ—‚ï¸ Configuration des locales"
          locale_gen:
            name: "{{ lions_system_locale }}"
            state: present

        - name: "ğŸ”¥ Configuration du pare-feu UFW"
          include_tasks: tasks/configure_firewall.yml
          when: lions_firewall_enabled | bool

        - name: "ğŸ›¡ï¸ Configuration de Fail2Ban"
          include_tasks: tasks/configure_fail2ban.yml
          when: lions_fail2ban_enabled | bool

        - name: "ğŸ‘¤ Configuration de l'utilisateur LIONS"
          include_tasks: tasks/configure_user.yml

    # =========================================================================
    # PHASE 5: OPTIMISATION SYSTÃˆME
    # =========================================================================
    - name: "âš¡ PHASE 5: Optimisation systÃ¨me"
      block:
        - name: "ğŸ’¾ Configuration du swap intelligent"
          include_tasks: tasks/configure_swap.yml

        - name: "ğŸš€ Optimisation des paramÃ¨tres kernel"
          sysctl:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            state: present
            reload: true
            sysctl_file: /etc/sysctl.d/99-lions-optimization.conf
          loop:
            # Optimisation mÃ©moire
            - { name: "vm.swappiness", value: "10" }
            - { name: "vm.vfs_cache_pressure", value: "50" }
            - { name: "vm.dirty_ratio", value: "15" }
            - { name: "vm.dirty_background_ratio", value: "5" }
            # Optimisation rÃ©seau
            - { name: "net.core.rmem_max", value: "16777216" }
            - { name: "net.core.wmem_max", value: "16777216" }
            - { name: "net.ipv4.tcp_rmem", value: "4096 65536 16777216" }
            - { name: "net.ipv4.tcp_wmem", value: "4096 65536 16777216" }
            # SÃ©curitÃ© rÃ©seau
            - { name: "net.ipv4.conf.all.send_redirects", value: "0" }
            - { name: "net.ipv4.conf.default.send_redirects", value: "0" }
            - { name: "net.ipv4.conf.all.accept_redirects", value: "0" }
            - { name: "net.ipv4.conf.default.accept_redirects", value: "0" }
            - { name: "net.ipv4.conf.all.secure_redirects", value: "0" }
            - { name: "net.ipv4.conf.default.secure_redirects", value: "0" }
            # Kubernetes/Container optimizations
            - { name: "net.bridge.bridge-nf-call-iptables", value: "1" }
            - { name: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
            - { name: "net.ipv4.ip_forward", value: "1" }
          register: sysctl_optimization

        - name: "ğŸ“Š Configuration des limites systÃ¨me"
          pam_limits:
            domain: "{{ item.domain }}"
            limit_type: "{{ item.type }}"
            limit_item: "{{ item.item }}"
            value: "{{ item.value }}"
          loop:
            - { domain: "*", type: "soft", item: "nofile", value: "65536" }
            - { domain: "*", type: "hard", item: "nofile", value: "65536" }
            - { domain: "*", type: "soft", item: "nproc", value: "32768" }
            - { domain: "*", type: "hard", item: "nproc", value: "32768" }
            - { domain: "root", type: "soft", item: "nofile", value: "65536" }
            - { domain: "root", type: "hard", item: "nofile", value: "65536" }

    # =========================================================================
    # PHASE 6: CONFIGURATION DES SERVICES
    # =========================================================================
    - name: "ğŸ”§ PHASE 6: Configuration des services systÃ¨me"
      block:
        - name: "ğŸ”„ Configuration de la rotation des logs"
          template:
            src: logrotate-lions.conf.j2
            dest: /etc/logrotate.d/lions
            mode: '0644'
          vars:
            log_directories:
              - "{{ lions_logs_directory }}"
              - "/var/log/lions"
            retention_days: "{{ lions_log_retention_days | default(30) }}"

        - name: "ğŸ“ˆ Configuration de la collecte des mÃ©triques"
          systemd:
            name: "{{ item }}"
            enabled: true
            state: started
          loop:
            - prometheus-node-exporter
            - rsyslog
          when: lions_monitoring_enabled | default(true) | bool

        - name: "ğŸ”§ Configuration des mises Ã  jour automatiques de sÃ©curitÃ©"
          template:
            src: unattended-upgrades.conf.j2
            dest: /etc/apt/apt.conf.d/50unattended-upgrades
            mode: '0644'
          vars:
            auto_security_updates: true
            auto_reboot: false
            notification_email: "{{ lions_admin_email | default('') }}"

    # =========================================================================
    # PHASE 7: PRÃ‰PARATION POUR KUBERNETES
    # =========================================================================
    - name: "â˜¸ï¸ PHASE 7: PrÃ©paration pour Kubernetes"
      block:
        - name: "ğŸ”§ Chargement des modules kernel requis"
          modprobe:
            name: "{{ item }}"
            state: present
          loop:
            - br_netfilter
            - overlay
            - ip_vs
            - ip_vs_rr
            - ip_vs_wrr
            - ip_vs_sh
            - nf_conntrack

        - name: "ğŸ“ Configuration permanente des modules"
          lineinfile:
            path: /etc/modules-load.d/lions-k8s.conf
            line: "{{ item }}"
            create: true
            mode: '0644'
          loop:
            - br_netfilter
            - overlay
            - ip_vs
            - ip_vs_rr
            - ip_vs_wrr
            - ip_vs_sh
            - nf_conntrack

        - name: "ğŸ—ï¸ PrÃ©paration des rÃ©pertoires Kubernetes"
          file:
            path: "{{ item }}"
            state: directory
            mode: '0755'
            owner: root
            group: root
          loop:
            - /etc/rancher
            - /etc/rancher/k3s
            - /var/lib/rancher
            - /var/lib/rancher/k3s
            - /var/log/rancher

    # =========================================================================
    # PHASE 8: VALIDATION FINALE
    # =========================================================================
    - name: "âœ… PHASE 8: Validation finale de l'initialisation"
      block:
        - name: "ğŸ” VÃ©rification des services critiques"
          service_facts:
          register: services_status

        - name: "ğŸ“Š VÃ©rification de l'Ã©tat systÃ¨me"
          command: "{{ item }}"
          loop:
            - "systemctl is-active rsyslog"
            - "systemctl is-active ssh"
            - "ufw status"
          register: system_checks
          changed_when: false
          failed_when: false

        - name: "ğŸ’¾ VÃ©rification de l'espace disque"
          shell: |
            df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
          register: disk_usage
          changed_when: false

        - name: "âš ï¸ Alerte espace disque"
          debug:
            msg: "âš ï¸  ATTENTION: Espace disque utilisÃ© Ã  {{ disk_usage.stdout }}%"
          when: disk_usage.stdout | int > 80

        - name: "ğŸ“ GÃ©nÃ©ration du rapport d'initialisation"
          template:
            src: init-report.j2
            dest: "{{ lions_logs_directory }}/initialization-report-{{ ansible_date_time.epoch }}.log"
            mode: '0644'
          vars:
            initialization_date: "{{ ansible_date_time.iso8601 }}"
            hostname: "{{ inventory_hostname }}"
            environment: "{{ lions_environment }}"
            system_info: "{{ ansible_facts }}"
            installed_packages: "{{ essential_packages }}"

  post_tasks:
    - name: "ğŸ‰ Finalisation de l'initialisation"
      block:
        - name: "ğŸ“ Journalisation de fin d'initialisation"
          lineinfile:
            path: "/var/log/lions-init.log"
            line: "{{ ansible_date_time.iso8601 }} - Fin initialisation VPS {{ inventory_hostname }} - SUCCÃˆS"
            create: true
            mode: '0644'
          delegate_to: localhost
          become: false

        - name: "ğŸ”„ Planification du redÃ©marrage si nÃ©cessaire"
          block:
            - name: "VÃ©rification de la nÃ©cessitÃ© de redÃ©marrage"
              stat:
                path: /var/run/reboot-required
              register: reboot_required

            - name: "âš ï¸ Notification de redÃ©marrage requis"
              debug:
                msg: |
                  âš ï¸  REDÃ‰MARRAGE REQUIS DÃ‰TECTÃ‰
                  Le systÃ¨me nÃ©cessite un redÃ©marrage pour finaliser les mises Ã  jour.
                  ExÃ©cutez 'sudo reboot' manuellement ou relancez avec -e lions_skip_reboot=false
              when:
                - reboot_required.stat.exists
                - lions_init_skip_reboot | bool

            - name: "ğŸ”„ RedÃ©marrage automatique du systÃ¨me"
              reboot:
                reboot_timeout: 600
                post_reboot_delay: 30
                test_command: uptime
              when:
                - reboot_required.stat.exists
                - not lions_init_skip_reboot | bool
                - ansible_connection != 'local'

        - name: "ğŸ¯ RÃ©sumÃ© de l'initialisation"
          debug:
            msg:
              - "âœ… Initialisation VPS completÃ©e avec succÃ¨s!"
              - "ğŸ·ï¸  Hostname: {{ inventory_hostname }}"
              - "ğŸŒ Environnement: {{ lions_environment }}"
              - "ğŸ“Š Espace disque utilisÃ©: {{ disk_usage.stdout }}%"
              - "ğŸ”§ RÃ©pertoire base LIONS: {{ lions_base_directory }}"
              - "ğŸ“ Logs disponibles dans: {{ lions_logs_directory }}"
              - "â­ï¸  PrÃªt pour l'installation de Kubernetes (K3s)"

  handlers:
    - name: restart rsyslog
      systemd:
        name: rsyslog
        state: restarted

    - name: restart fail2ban
      systemd:
        name: fail2ban
        state: restarted

    - name: restart ssh
      systemd:
        name: ssh
        state: restarted

    - name: reload ufw
      command: ufw --force reload