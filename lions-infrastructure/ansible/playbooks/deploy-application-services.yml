---
# =========================================================================
# LIONS INFRASTRUCTURE 5.0 - D√âPLOIEMENT DES SERVICES D'APPLICATION
# =========================================================================
# Description: Playbook pour le d√©ploiement des services applicatifs m√©tier
# Auteur: √âquipe DevOps LIONS Infrastructure
# Version: 5.0.0
# Date: 2025-05-26
# Documentation: https://docs.lions.dev/infrastructure/playbooks/deploy-applications
# =========================================================================

- name: "LIONS Infrastructure 5.0 - D√©ploiement des Services d'Application"
  hosts: "{{ lions_target_hosts | default('lions_cluster') }}"
  become: true
  gather_facts: true
  serial: "{{ lions_deployment_serial | default('100%') }}"
  max_fail_percentage: "{{ lions_max_fail_percentage | default(0) }}"

  # =========================================================================
  # VARIABLES GLOBALES DU PLAYBOOK
  # =========================================================================
  vars:
    # M√©tadonn√©es du d√©ploiement
    playbook_version: "5.0.0"
    playbook_name: "deploy-application-services"
    deployment_timestamp: "{{ ansible_date_time.iso8601 }}"

    # Configuration de l'environnement cible
    target_environment: "{{ lions_environment | default('development') }}"
    deployment_mode: "{{ lions_deployment_mode | default('standard') }}"

    # Configuration des domaines (depuis les variables d'environnement)
    base_domain: "{{ lions_dns_domain_base }}"
    full_domain: "{{ lions_dns_full_domain }}"
    api_subdomain: "api.{{ full_domain }}"

    # Configuration des namespaces
    application_namespace_prefix: "{{ lions_applications_namespace_prefix | default('apps') }}"

    # Configuration des ressources par d√©faut
    default_resources:
      small:
        requests:
          cpu: "{{ lions_resources_small_cpu_request }}"
          memory: "{{ lions_resources_small_memory_request }}"
        limits:
          cpu: "{{ lions_resources_small_cpu_limit }}"
          memory: "{{ lions_resources_small_memory_limit }}"
      medium:
        requests:
          cpu: "{{ lions_resources_medium_cpu_request }}"
          memory: "{{ lions_resources_medium_memory_request }}"
        limits:
          cpu: "{{ lions_resources_medium_cpu_limit }}"
          memory: "{{ lions_resources_medium_memory_limit }}"
      large:
        requests:
          cpu: "{{ lions_resources_large_cpu_request }}"
          memory: "{{ lions_resources_large_memory_request }}"
        limits:
          cpu: "{{ lions_resources_large_cpu_limit }}"
          memory: "{{ lions_resources_large_memory_limit }}"

    # Configuration TLS
    tls_enabled: "{{ lions_security_tls_enabled }}"
    tls_issuer: "{{ 'letsencrypt-staging' if lions_security_tls_staging else 'letsencrypt-prod' }}"

    # Liste des applications m√©tier √† d√©ployer
    lions_applications:
      # APIs Backend
      - name: "site-principal-api"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-backend"
        domain: "{{ full_domain }}"
        port: 8080
        path: "/"
        resources: "medium"
        replicas: "{{ lions_site_principal_replicas | default(2) }}"
        enabled: "{{ lions_site_principal_enabled | default(true) }}"

      - name: "api-principale"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-backend"
        domain: "{{ api_subdomain }}"
        port: 8081
        path: "/portail"
        resources: "medium"
        replicas: "{{ lions_api_principale_replicas | default(2) }}"
        enabled: "{{ lions_api_principale_enabled | default(true) }}"

      - name: "associations-api"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-backend"
        domain: "{{ api_subdomain }}"
        port: 8082
        path: "/associations"
        resources: "small"
        replicas: "{{ lions_associations_api_replicas | default(1) }}"
        enabled: "{{ lions_associations_api_enabled | default(true) }}"

      - name: "afterwork-api"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-backend"
        domain: "{{ api_subdomain }}"
        port: 8083
        path: "/afterwork"
        resources: "small"
        replicas: "{{ lions_afterwork_api_replicas | default(1) }}"
        enabled: "{{ lions_afterwork_api_enabled | default(true) }}"

      - name: "bacy-event-api"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-backend"
        domain: "{{ api_subdomain }}"
        port: 8084
        path: "/bacy-event"
        resources: "small"
        replicas: "{{ lions_bacy_event_api_replicas | default(1) }}"
        enabled: "{{ lions_bacy_event_api_enabled | default(true) }}"

      - name: "btp-api"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-backend"
        domain: "{{ api_subdomain }}"
        port: 8087
        path: "/btp"
        resources: "small"
        replicas: "{{ lions_btp_api_replicas | default(1) }}"
        enabled: "{{ lions_btp_api_enabled | default(true) }}"

      - name: "immobilier-api"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-backend"
        domain: "{{ api_subdomain }}"
        port: 8088
        path: "/immobilier"
        resources: "small"
        replicas: "{{ lions_immobilier_api_replicas | default(1) }}"
        enabled: "{{ lions_immobilier_api_enabled | default(true) }}"

      - name: "mail-api"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-backend"
        domain: "{{ api_subdomain }}"
        port: 8026
        path: "/mail"
        resources: "small"
        replicas: "{{ lions_mail_api_replicas | default(1) }}"
        enabled: "{{ lions_mail_api_enabled | default(true) }}"

      # Applications Frontend
      - name: "afterwork-app"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-frontend"
        domain: "afterwork.{{ full_domain }}"
        port: 8091
        path: "/"
        resources: "medium"
        replicas: "{{ lions_afterwork_app_replicas | default(2) }}"
        enabled: "{{ lions_afterwork_app_enabled | default(true) }}"

      - name: "associations-app"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-frontend"
        domain: "associations.{{ full_domain }}"
        port: 8090
        path: "/"
        resources: "medium"
        replicas: "{{ lions_associations_app_replicas | default(2) }}"
        enabled: "{{ lions_associations_app_enabled | default(true) }}"

      - name: "btp-app"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-frontend"
        domain: "btp.{{ full_domain }}"
        port: 8086
        path: "/"
        resources: "medium"
        replicas: "{{ lions_btp_app_replicas | default(2) }}"
        enabled: "{{ lions_btp_app_enabled | default(true) }}"

      - name: "immobilier-app"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-frontend"
        domain: "immobilier.{{ full_domain }}"
        port: 8089
        path: "/"
        resources: "medium"
        replicas: "{{ lions_immobilier_app_replicas | default(2) }}"
        enabled: "{{ lions_immobilier_app_enabled | default(true) }}"

      # Services Utilitaires
      - name: "mail-service"
        type: "quarkus"
        namespace: "{{ application_namespace_prefix }}-services"
        domain: "mail.{{ full_domain }}"
        port: 8025
        path: "/"
        resources: "small"
        replicas: "{{ lions_mail_service_replicas | default(1) }}"
        enabled: "{{ lions_mail_service_enabled | default(true) }}"

  # =========================================================================
  # T√ÇCHES DE PR√â-V√âRIFICATION
  # =========================================================================
  pre_tasks:
    - name: "üîç Validation de la configuration d'environnement"
      block:
        - name: "V√©rification des variables d'environnement critiques"
          assert:
            that:
              - lions_environment is defined
              - lions_dns_domain_base is defined
              - lions_dns_full_domain is defined
              - target_environment in ['development', 'staging', 'production']
            fail_msg: "Variables d'environnement critiques manquantes ou invalides"
            success_msg: "‚úÖ Variables d'environnement valid√©es"

        - name: "V√©rification de la connectivit√© Kubernetes"
          k8s_info:
            api_version: v1
            kind: Node
          register: k8s_nodes
          failed_when: k8s_nodes.resources | length == 0

        - name: "Affichage des informations de d√©ploiement"
          debug:
            msg:
              - "üöÄ D√©marrage du d√©ploiement des services d'application"
              - "üìä Environnement: {{ target_environment }}"
              - "üåê Domaine de base: {{ base_domain }}"
              - "üåê Domaine complet: {{ full_domain }}"
              - "üîß Mode de d√©ploiement: {{ deployment_mode }}"
              - "üìÖ Horodatage: {{ deployment_timestamp }}"
              - "üéØ N≈ìuds Kubernetes: {{ k8s_nodes.resources | length }}"

      tags: ['validation', 'pre-checks']

    - name: "üì¶ Installation des d√©pendances Python requises"
      pip:
        name:
          - kubernetes>=24.2.0
          - PyYAML>=6.0
          - jsonpatch>=1.32
          - jmespath>=1.0.1
        state: present
        extra_args: "--upgrade"
      become: true
      tags: ['dependencies']

    - name: "üîß V√©rification des outils requis"
      command: "{{ item.command }}"
      register: tool_check
      failed_when: tool_check.rc != 0
      loop:
        - { name: "kubectl", command: "kubectl version --client" }
        - { name: "helm", command: "helm version" }
      loop_control:
        label: "{{ item.name }}"
      tags: ['tools-check']

  # =========================================================================
  # T√ÇCHES PRINCIPALES DE D√âPLOIEMENT
  # =========================================================================
  tasks:
    - name: "üèóÔ∏è Cr√©ation des namespaces pour les applications"
      include_tasks: "../tasks/create-namespace.yml"
      vars:
        namespace_name: "{{ item }}"
        namespace_labels:
          app.kubernetes.io/managed-by: "lions-infrastructure"
          lions.dev/environment: "{{ target_environment }}"
          lions.dev/component: "applications"
      loop:
        - "{{ application_namespace_prefix }}-backend"
        - "{{ application_namespace_prefix }}-frontend"
        - "{{ application_namespace_prefix }}-services"
      tags: ['namespaces']

    - name: "üöÄ D√©ploiement des applications m√©tier"
      include_tasks: "../tasks/deploy-application.yml"
      vars:
        app_config: "{{ item }}"
        app_environment: "{{ target_environment }}"
        app_resources: "{{ default_resources[item.resources] }}"
        app_tls_enabled: "{{ tls_enabled }}"
        app_tls_issuer: "{{ tls_issuer }}"
      loop: "{{ lions_applications }}"
      loop_control:
        label: "{{ item.name }}"
      when: item.enabled | default(true)
      tags: ['applications', 'deploy']

    - name: "üîß Configuration des services d'infrastructure expos√©s"
      include_tasks: "../tasks/configure-infrastructure-ingress.yml"
      vars:
        service_config:
          - name: "kubernetes-dashboard"
            namespace: "kubernetes-dashboard"
            domain: "k8s.{{ full_domain }}"
            service_name: "kubernetes-dashboard"
            service_port: 443
            path: "/"
            enabled: "{{ lions_k8s_dashboard_enabled | default(true) }}"

          - name: "gitea"
            namespace: "{{ lions_gitea_namespace }}"
            domain: "git.{{ full_domain }}"
            service_name: "{{ lions_gitea_service_name }}"
            service_port: "{{ lions_gitea_port }}"
            path: "/"
            enabled: "{{ lions_gitea_enabled }}"

          - name: "pgadmin"
            namespace: "{{ lions_postgres_namespace }}"
            domain: "pgadmin.{{ full_domain }}"
            service_name: "pgadmin"
            service_port: 80
            path: "/"
            enabled: "{{ lions_pgadmin_enabled | default(false) }}"

          - name: "keycloak"
            namespace: "{{ lions_keycloak_namespace }}"
            domain: "auth.{{ full_domain }}"
            service_name: "{{ lions_keycloak_service_name }}"
            service_port: "{{ lions_keycloak_port }}"
            path: "/"
            enabled: "{{ lions_keycloak_enabled }}"

          - name: "prometheus"
            namespace: "{{ lions_monitoring_namespace }}"
            domain: "prometheus.{{ full_domain }}"
            service_name: "prometheus-kube-prometheus-prometheus"
            service_port: 9090
            path: "/"
            enabled: "{{ lions_prometheus_enabled and lions_monitoring_enabled }}"

          - name: "grafana"
            namespace: "{{ lions_monitoring_namespace }}"
            domain: "grafana.{{ full_domain }}"
            service_name: "prometheus-grafana"
            service_port: 80
            path: "/"
            enabled: "{{ lions_grafana_enabled and lions_monitoring_enabled }}"

          - name: "vault"
            namespace: "{{ lions_vault_namespace }}"
            domain: "vault.{{ full_domain }}"
            service_name: "{{ lions_vault_service_name }}"
            service_port: "{{ lions_vault_port }}"
            path: "/"
            enabled: "{{ lions_vault_enabled }}"
      tags: ['infrastructure', 'ingress']

    - name: "üîç V√©rification du statut des d√©ploiements"
      include_tasks: "../tasks/verify-deployment.yml"
      vars:
        app_name: "{{ item.name }}"
        app_namespace: "{{ item.namespace }}"
        expected_replicas: "{{ item.replicas }}"
      loop: "{{ lions_applications }}"
      loop_control:
        label: "{{ item.name }}"
      when: item.enabled | default(true)
      tags: ['verification', 'health-check']

    - name: "üìä Configuration du monitoring des applications"
      include_tasks: "../tasks/configure-application-monitoring.yml"
      vars:
        monitoring_config:
          namespace: "{{ lions_monitoring_namespace }}"
          scrape_interval: "{{ lions_monitoring_scrape_interval | default('30s') }}"
          applications: "{{ lions_applications | selectattr('enabled', 'equalto', true) | list }}"
      when: lions_monitoring_enabled | default(true)
      tags: ['monitoring']

  # =========================================================================
  # T√ÇCHES DE POST-D√âPLOIEMENT
  # =========================================================================
  post_tasks:
    - name: "üìã G√©n√©ration du rapport de d√©ploiement"
      block:
        - name: "Collecte des informations de d√©ploiement"
          set_fact:
            deployment_summary:
              timestamp: "{{ deployment_timestamp }}"
              environment: "{{ target_environment }}"
              total_applications: "{{ lions_applications | length }}"
              enabled_applications: "{{ lions_applications | selectattr('enabled', 'equalto', true) | list | length }}"
              base_domain: "{{ base_domain }}"
              full_domain: "{{ full_domain }}"
              tls_enabled: "{{ tls_enabled }}"
              monitoring_enabled: "{{ lions_monitoring_enabled | default(true) }}"

        - name: "Affichage du r√©sum√© de d√©ploiement"
          debug:
            msg:
              - "üéâ D√©ploiement des services d'application termin√© avec succ√®s"
              - "üìä R√©sum√© du d√©ploiement:"
              - "  - Environnement: {{ deployment_summary.environment }}"
              - "  - Applications totales: {{ deployment_summary.total_applications }}"
              - "  - Applications activ√©es: {{ deployment_summary.enabled_applications }}"
              - "  - Domaine principal: {{ deployment_summary.full_domain }}"
              - "  - TLS activ√©: {{ deployment_summary.tls_enabled }}"
              - "  - Monitoring activ√©: {{ deployment_summary.monitoring_enabled }}"
              - "  - Horodatage: {{ deployment_summary.timestamp }}"

        - name: "Sauvegarde du rapport de d√©ploiement"
          copy:
            content: |
              # Rapport de D√©ploiement des Services d'Application
              ## Lions Infrastructure 5.0
              
              **Date de d√©ploiement:** {{ deployment_summary.timestamp }}
              **Environnement:** {{ deployment_summary.environment }}
              **Domaine principal:** {{ deployment_summary.full_domain }}
              
              ### R√©sum√©
              - Applications totales configur√©es: {{ deployment_summary.total_applications }}
              - Applications d√©ploy√©es: {{ deployment_summary.enabled_applications }}
              - TLS/SSL activ√©: {{ deployment_summary.tls_enabled }}
              - Monitoring activ√©: {{ deployment_summary.monitoring_enabled }}
              
              ### Applications d√©ploy√©es
              {% for app in lions_applications %}
              {% if app.enabled | default(true) %}
              - **{{ app.name }}**
                - Type: {{ app.type }}
                - Namespace: {{ app.namespace }}
                - Domaine: {{ app.domain }}
                - Port: {{ app.port }}
                - R√©pliques: {{ app.replicas }}
                - Ressources: {{ app.resources }}
              {% endif %}
              {% endfor %}
              
              ### URLs d'acc√®s
              {% for app in lions_applications %}
              {% if app.enabled | default(true) %}
              - {{ app.name }}: https://{{ app.domain }}{{ app.path | default('') }}
              {% endif %}
              {% endfor %}
              
              ---
              G√©n√©r√© automatiquement par Lions Infrastructure 5.0
            dest: "/tmp/lions-deployment-report-{{ ansible_date_time.epoch }}.md"
          delegate_to: localhost
          run_once: true

      rescue:
        - name: "‚ùå Erreur lors de la g√©n√©ration du rapport"
          debug:
            msg: "Impossible de g√©n√©rer le rapport de d√©ploiement complet"

      tags: ['reporting']

    - name: "üîî Notification de fin de d√©ploiement"
      uri:
        url: "{{ lions_webhook_notification_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          environment: "{{ target_environment }}"
          status: "success"
          message: "D√©ploiement des services d'application termin√© avec succ√®s"
          timestamp: "{{ deployment_timestamp }}"
          applications_deployed: "{{ lions_applications | selectattr('enabled', 'equalto', true) | list | length }}"
        status_code: [200, 201, 204]
      when: lions_webhook_notification_url is defined
      ignore_errors: true
      tags: ['notification']

  # =========================================================================
  # GESTION DES ERREURS GLOBALES
  # =========================================================================
  rescue:
    - name: "‚ùå √âchec du d√©ploiement des services d'application"
      debug:
        msg:
          - "‚ùå Le d√©ploiement a √©chou√©"
          - "üîç V√©rifiez les logs ci-dessus pour plus de d√©tails"
          - "üîÑ Vous pouvez relancer le d√©ploiement apr√®s correction des erreurs"

    - name: "üîî Notification d'√©chec de d√©ploiement"
      uri:
        url: "{{ lions_webhook_notification_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          environment: "{{ target_environment }}"
          status: "failure"
          message: "√âchec du d√©ploiement des services d'application"
          timestamp: "{{ deployment_timestamp }}"
          error: "{{ ansible_failed_result.msg | default('Erreur inconnue') }}"
        status_code: [200, 201, 204]
      when: lions_webhook_notification_url is defined
      ignore_errors: true

    - name: "üö® Arr√™t du playbook apr√®s √©chec"
      fail:
        msg: "D√©ploiement interrompu suite √† une erreur critique"

# =========================================================================
# INFORMATIONS ADDITIONNELLES
# =========================================================================
# Ce playbook peut √™tre ex√©cut√© avec les options suivantes:
#
# D√©ploiement standard:
# ansible-playbook deploy-application-services.yml -e target_environment=development
#
# D√©ploiement avec options avanc√©es:
# ansible-playbook deploy-application-services.yml \
#   -e target_environment=production \
#   -e lions_deployment_mode=ha \
#   -e lions_max_fail_percentage=10
#
# D√©ploiement d'applications sp√©cifiques:
# ansible-playbook deploy-application-services.yml \
#   -e target_environment=staging \
#   -e lions_site_principal_enabled=true \
#   -e lions_afterwork_app_enabled=false
#
# Mode dry-run (v√©rification sans d√©ploiement):
# ansible-playbook deploy-application-services.yml \
#   -e target_environment=development \
#   -e lions_dry_run=true \
#   --check
# =========================================================================